import { Logger, Injectable } from '@nestjs/common';
import { InjectModel } from '@nestjs/mongoose';
import { ObjectId } from 'mongodb';
import mongoose, { Model, Types } from 'mongoose';
import { newPosts, NewpostsDocument } from './schemas/newPost.schema';
import { PostContentService } from '../posts/postcontent.service';
import { Userbasicnew } from 'src/trans/userbasicnew/schemas/userbasicnew.schema';
import { UtilsService } from 'src/utils/utils.service';
import { LogapisService } from 'src/trans/logapis/logapis.service';
import { UserbasicnewService } from 'src/trans/userbasicnew/userbasicnew.service';
import { CreateNewPostDTO, PostResponseApps, PostData, Avatar, Metadata, TagPeople, Cat, Privacy, GetcontenteventsDto } from './dto/create-newPost.dto';
import { ContenteventsService } from '../contentevents/contentevents.service';
import { ErrorHandler } from 'src/utils/error.handler';
import { MediamusicService } from '../mediamusic/mediamusic.service';
import { GetusercontentsService } from 'src/trans/getusercontents/getusercontents.service';
import { PostchallengeService } from 'src/trans/postchallenge/postchallenge.service';
import { UserchallengesService } from 'src/trans/userchallenges/userchallenges.service';
import { Userchallenges } from 'src/trans/userchallenges/schemas/userchallenges.schema';
import { DisqusService } from '../disqus/disqus.service';
import { DisquslogsService } from '../disquslogs/disquslogs.service';
import { pipeline } from 'stream';

@Injectable()
export class NewPostService {
  private readonly logger = new Logger(NewPostService.name);

  constructor(
    @InjectModel(newPosts.name, 'SERVER_FULL')
    private readonly loaddata: Model<NewpostsDocument>,
    private readonly postContentService: PostContentService,
    private readonly utilService: UtilsService,
    private readonly logapiSS: LogapisService,
    private readonly errorHandler: ErrorHandler,
    private readonly basic2SS: UserbasicnewService,
    private readonly contentEventService: ContenteventsService,
    private readonly musicSS: MediamusicService,
    private readonly loadApsara: GetusercontentsService,
    private readonly postchallengeService: PostchallengeService,
    private readonly userchallengesService: UserchallengesService,
    private readonly utilsService: UtilsService,
    private readonly disquslogsService: DisquslogsService,
    private readonly disqusService: DisqusService,
  ) { }

  async create(CreatePostsDto: newPosts): Promise<newPosts> {
    const createPostsDto = await this.loaddata.create(CreatePostsDto);
    return createPostsDto;
  }

  async update(id: string, inputdata: newPosts): Promise<newPosts> {
    let data = await this.loaddata.findByIdAndUpdate(id, inputdata, { new: true });
    if (!data) {
      throw new Error('Data is not found!');
    }
    return data;
  }


  async updateByPostId(
    postID: string,
    CreateNewPostDTO: CreateNewPostDTO,
  ): Promise<Object> {
    return await this.loaddata.updateOne(
      { postID: postID },
      CreateNewPostDTO
    );
  }

  async findByPostId(postID: string): Promise<newPosts> {
    return this.loaddata.findOne({ postID: postID }).exec();
  }

  async findOne(id: string) {
    var data = await this.loaddata.findOne({ postID: id }).exec();
    return data;
  }

  async findid(id: string): Promise<newPosts> {
    return this.loaddata.findOne({ _id: id }).exec();
  }

  async findUserPost(email: string): Promise<number> {
    return this.loaddata.where('email', email).where('active', true).where('postType').ne('story').count();
  }

  async findNewpostid(id: string): Promise<newPosts> {
    return this.loaddata.findOne({ _id: id }).exec();
  }

  async databasenew(buy: string, report: string, iduser: Object, username: string, description: string, kepemilikan: any[], statusjual: any[], postType: any[], kategori: any[], hashtag: any[], startdate: string, enddate: string, startmount: number, endmount: number, descending: boolean, page: number, limit: number, popular: any) {

    try {
      var currentdate = new Date(new Date(enddate).setDate(new Date(enddate).getDate() + 1));

      var dateend = currentdate.toISOString();

      var dt = dateend.substring(0, 10);
    } catch (e) {
      dateend = "";
    }

    var order = null;

    if (descending === true) {
      order = -1;
    } else {
      order = 1;
    }

    var arrkategori = [];
    var idkategori = null;
    const mongoose = require('mongoose');
    var ObjectId = require('mongodb').ObjectId;
    var lengkategori = null;

    try {
      lengkategori = kategori.length;
    } catch (e) {
      lengkategori = 0;
    }
    if (lengkategori > 0) {

      for (let i = 0; i < lengkategori; i++) {
        let idkat = kategori[i];
        idkategori = mongoose.Types.ObjectId(idkat);
        arrkategori.push(idkategori);
      }
    }

    var pipeline = [];
    if (popular !== undefined && popular === true) {
      pipeline.push({
        $sort: {
          views: - 1,
          likes: - 1
        },

      },);
    } else {
      pipeline.push({
        $sort: {
          createdAt: order
        },

      },);
    }

    //start improvisasi disini

    var listmatchingand = [];

    listmatchingand.push({
      "active": true
    });

    //baru. search by hashtags
    if (hashtag && hashtag !== undefined) {
      var converthashtag = [];
      for (var i = 0; i < hashtag.length; i++) {
        converthashtag.push(hashtag[i].toLowerCase());
      }

      pipeline.push(
        {
          "$set": {
            "tag2": {
              "$map": {
                "input": "$tags",
                "as": "arrayElems",
                "in": {
                  "$toLower": "$$arrayElems"
                }
              }
            }
          }
        },
        {
          "$project": {
            "_id": 1,
            "postID": 1,
            "email": 1,
            "postType": 1,
            "description": 1,
            "active": 1,
            "createdAt": 1,
            "updated": 1,
            "expiration": 1,
            "visibility": 1,
            "location": 1,
            "tags": 1,
            "tag2": "$tag2",
            "allowComments": 1,
            "isSafe": 1,
            "isOwned": 1,
            "certified": 1,
            "saleAmount": 1,
            "saleLike": 1,
            "isShared": 1,
            "saleView": 1,
            "likes": 1,
            "views": 1,
            "shares": 1,
            "userProfile": 1,
            "contentMedias": 1,
            "category": 1,
            "tagPeople": 1,
            "tagDescription": 1,
            "reportedUser": 1,
            "reportedUserHandle": 1,
            "musicId": 1,
            "boosted": 1,
            "viewer": 1,
            "contentModeration": 1,
            "contentModerationDate": 1,
            "contentModerationResponse": 1,
            "moderationReason": 1,
            "reportedStatus": 1,
          }
        },
      );

      listmatchingand.push({
        tag2:
        {
          "$in": converthashtag

        }
      }
      );
    }

    if (description && description !== undefined) {

      listmatchingand.push({
        description: {
          $regex: description,
          $options: 'i'
        },
      },);

    }

    pipeline.push({
      "$match":
      {
        "$and": listmatchingand
      }
    }
    );

    //end improvisasi

    pipeline.push(
      {
        "$addFields":
        {
          "mediaSource":
          {
            "$arrayElemAt":
              [
                "$mediaSource", 0
              ]
          }
        }
      },
    );

    if (iduser && iduser !== undefined) {
      pipeline.push(
        {
          "$lookup": {
            "from": "newUserBasics",
            "as": "databasic",
            "let": {
              "local_id": "$idUser",

            },
            "pipeline": [
              {
                $match:
                {
                  $expr: {
                    $eq: ['$_id', '$$local_id']
                  }
                }
              },
              {
                $project: {
                  iduser: "$_id",
                  username: "$username",
                  pict: "$mediaEndpoint"
                }
              },

            ],

          },

        },
        {
          $unwind: {
            path: "$databasic",

          }
        },
        {
          $match: {
            'databasic.iduser': iduser,

          }
        },
        {
          $addFields: {

            salePrice: {
              $cmp: ["$saleAmount", 0]
            },
            sLike: {
              $cmp: ["$saleLike", 0]
            },
            sView: {
              $cmp: ["$saleView", 0]
            },
            certi: {
              $cmp: ["$certified", 0]
            },
            reportedCount: {
              $cmp: ["$reportedUserCount", 0]
            },

          }
        },
        {
          "$lookup": {
            "from": "transactions",
            "as": "trans",
            "let": {
              "local_id": "$postID",

            },
            "pipeline": [
              {
                $match:
                {
                  $expr: {
                    $eq: ['$postid', '$$local_id']
                  }
                }
              },
              {
                $project: {
                  iduserbuyer: 1,
                  idusersell: 1,
                  noinvoice: 1,
                  status: 1,
                  amount: 1,
                  timestamp: 1
                }
              },
              {
                $match: {
                  "iduserbuyer": iduser,
                  "status": "Success"
                }
              },
              {
                $sort: {
                  timestamp: - 1
                },

              },
              {
                $limit: 1
              },
              {
                "$lookup": {
                  "from": "newUserBasics",
                  "as": "penjual",
                  "let": {
                    "local_id": "$idusersell"
                  },
                  "pipeline": [
                    {
                      "$match": {
                        "$expr": {
                          "$eq": [
                            "$_id",
                            "$$local_id"
                          ]
                        }
                      }
                    },
                    {
                      $project: {
                        email: 1
                      }
                    },

                  ],

                }
              },
              {
                $project: {
                  penjual: {
                    $arrayElemAt: ['$penjual.username', 0]
                  },
                  amount: 1,
                  status: 1,
                  noinvoice: 1,
                  timestamp: 1
                }
              },

            ],

          },

        },
        {
          "$lookup": {
            "from": "interests_repo",
            "as": "kategori",
            "let": {
              "local_id": "$category.$id",

            },
            "pipeline": [
              {
                $match:
                {
                  $and: [
                    {
                      $expr: {

                        $in: ['$_id', {
                          $ifNull: ['$$local_id', []]
                        }]
                      }
                    },

                  ]
                }
              },
              {
                $project: {
                  interestName: 1,

                }
              },

            ],

          },

        },
        {
          $project: {
            username: "$databasic.username",
            iduser: "$databasic.iduser",
            createdAt: 1,
            updatedAt: 1,
            postID: 1,
            email: 1,
            postType: 1,
            views: 1,
            likes: 1,
            comments: 1,
            shares: 1,
            description: 1,
            title: 1,
            active: 1,
            kategori: 1,
            reportedUserCount: 1,
            tags: 1,
            trans:
            {
              $size: "$trans"
            },
            certified:
            {
              $cond: {
                if: {
                  $or: [{
                    $eq: ["$certi", - 1]
                  }, {
                    $eq: ["$certi", 0]
                  }]
                },
                then: false,
                else: "$certified"
              }
            },
            tr: "$trans",
            visibility: 1,
            saleAmount: {
              $cond: {
                if: {
                  $or: [{
                    $eq: ["$salePrice", - 1]
                  }, {
                    $eq: ["$salePrice", 0]
                  }]
                },
                then: 0,
                else: "$saleAmount"
              }
            },
            monetize: {
              $cond: {
                if: {
                  $or: [{
                    $eq: ["$salePrice", - 1]
                  }, {
                    $eq: ["$salePrice", 0]
                  }]
                },
                then: false,
                else: true
              }
            },
            reported: {
              $cond: {
                if: {
                  $or: [{
                    $eq: ["$reportedCount", - 1]
                  }, {
                    $eq: ["$reportedCount", 0]
                  }]
                },
                then: "TIDAK",
                else: "YA"
              }
            },
            mediaSource: 1,
          }
        },
        {
          $project: {
            username: 1,
            createdAt: 1,
            updatedAt: 1,
            postID: 1,
            postType: 1,
            iduser: 1,
            email: 1,
            reported: 1,
            views: 1,
            likes: 1,
            shares: 1,
            comments: 1,
            tags: 1,
            tr: 1,
            buy: {
              $cond: {
                if: {
                  $or: [{
                    $eq: ["$trans", 0]
                  }]
                },
                then: "TIDAK",
                else: "YA"
              }
            },
            type: {
              $switch: {
                branches: [
                  {
                    'case': {
                      '$eq': ['$postType', 'pict']
                    },
                    'then': "HyppePic"
                  },
                  {
                    'case': {
                      '$eq': ['$postType', 'vid']
                    },
                    'then': "HyppeVid"
                  },
                  {
                    'case': {
                      '$eq': ['$postType', 'diary']
                    },
                    'then': "HyppeDiary"
                  },
                  {
                    'case': {
                      '$eq': ['$postType', 'story']
                    },
                    'then': "HyppeStory"
                  },

                ],
                default: ''
              }
            },
            description: 1,
            title: 1,
            active: 1,
            kategori: 1,
            kepemilikan:
            {
              $cond: {
                if: {
                  $or: [{
                    $eq: ["$certified", false]
                  }, {
                    $eq: ["$certified", ""]
                  }]
                },
                then: "TIDAK",
                else: "YA"
              }
            },
            visibility: 1,
            saleAmount: 1,
            statusJual:
            {
              $cond: {
                if: {

                  $eq: ["$monetize", false]
                },
                then: "TIDAK",
                else: "YA"
              }
            },
            mediaSource: 1,
          }
        },
        {
          $project: {
            username: 1,
            createdAt: 1,
            updatedAt: 1,
            postID: 1,
            postType: 1,
            iduser: 1,
            email: 1,
            views: 1,
            likes: 1,
            shares: 1,
            comments: 1,
            type: 1,
            description: 1,
            title: 1,
            active: 1,
            kategori: 1,
            kepemilikan: 1,
            visibility: 1,
            amount: "$saleAmount",
            statusJual: 1,
            reported: 1,
            buy: 1,
            tr: 1,
            tags: 1,
            mediaSource: 1,
          }
        },
        {
          $addFields: {
            pict: {
              $replaceOne: {
                input: "$auth.mediaUri",
                find: "_0001.jpeg",
                replacement: ""
              }
            },
          },

        },
        {
          $project: {

            username: 1,
            createdAt: 1,
            updatedAt: 1,
            postID: 1,
            postType: 1,
            iduser: 1,
            tr: 1,
            email: 1,
            type: 1,
            description: 1,
            title: 1,
            active: 1,
            kategori: 1,
            kepemilikan: 1,
            visibility: 1,
            saleAmount: {
              $cond: {
                if: {
                  $or: [{
                    $eq: ["$buy", "TIDAK"]
                  },]
                },
                then: "$amount",
                else: {
                  $arrayElemAt: ['$tr.amount', 0]
                }
              }
            },
            penjual: {
              $arrayElemAt: ['$tr.penjual', 0]
            },
            statusJual: 1,
            reported: 1,
            buy: 1,
            views: 1,
            likes: 1,
            shares: 1,
            comments: 1,
            tags: 1,
            "mediaBasePath": "$mediaSource.mediaBasePath",
            "mediaUri": "$mediaSource.mediaUri",
            "mediaType": "$mediaSource.mediaType",
            "mediaThumbEndpoint": {
              "$switch": {
                "branches": [
                  {
                    "case": {
                      "$eq": [
                        "$type",
                        "HyppePic"
                      ]
                    },
                    "then": "$mediaSource.mediaThumb"
                  },
                  {
                    "case": {
                      "$eq": [
                        "$type",
                        "HyppeDiary"
                      ]
                    },
                    "then": {
                      "$concat": [
                        "/thumb/",
                        "$postID"
                      ]
                    }
                  },
                  {
                    "case": {
                      "$eq": [
                        "$type",
                        "HyppeVid"
                      ]
                    },
                    "then": {
                      "$concat": [
                        "/thumb/",
                        "$postID"
                      ]
                    }
                  },
                  {
                    "case": {
                      "$eq": [
                        "$type",
                        "HyppeDiary"
                      ]
                    },
                    "then": {
                      "$concat": [
                        "/thumb/",
                        "$postID"
                      ]
                    }
                  }
                ],
                "default": ""
              }
            },
            "mediaEndpoint": {
              "$switch": {
                "branches": [
                  {
                    "case": {
                      "$eq": [
                        "$type",
                        "HyppePic"
                      ]
                    },
                    "then": {
                      "$concat":
                        [
                          "/pict/",
                          "$postID"
                        ]
                    }
                  },
                  {
                    "case": {
                      "$eq": [
                        "$type",
                        "HyppeDiary"
                      ]
                    },
                    "then": {
                      "$concat": [
                        "/thumb/",
                        "$postID"
                      ]
                    }
                  },
                  {
                    "case": {
                      "$eq": [
                        "$type",
                        "HyppeVid"
                      ]
                    },
                    "then": {
                      "$concat": [
                        "/thumb/",
                        "$postID"
                      ]
                    }
                  },
                  {
                    "case": {
                      "$eq": [
                        "$type",
                        "HyppeDiary"
                      ]
                    },
                    "then": {
                      "$cond":
                      {
                        if:
                        {
                          "$eq":
                            [
                              "$mediaSource.mediaType",
                              "image"
                            ]
                        },
                        then:
                        {
                          "$concat":
                            [
                              "/pict/",
                              "$postID"
                            ]
                        },
                        else:
                        {
                          "$concat":
                            [
                              "/stream/",
                              "$postID"
                            ]
                        }
                      }
                    }
                  }
                ],
                "default": ""
              }
            },
            "mediaThumbUri": "$mediaSource.mediaThumb",
            "apsaraId": {
              "$ifNull":
                [
                  "$mediaSource.apsaraId",
                  false
                ]
            },
            "apsara": {
              "$ifNull":
                [
                  "$mediaSource.apsara",
                  false
                ]
            },

          }
        },
        {
          $project: {

            username: 1,
            createdAt: 1,
            updatedAt: 1,
            postID: 1,
            postType: 1,
            iduser: 1,
            email: 1,
            type: 1,
            description: 1,
            title: 1,
            active: 1,
            kategori: 1,
            kepemilikan: 1,
            visibility: 1,
            saleAmount: {
              $cond: {
                if: {
                  $or: [{
                    $eq: ["$saleAmount", null]
                  },]
                },
                then: 0,
                else: "$saleAmount"
              }
            },
            statusJual: 1,
            reported: 1,
            buy: 1,
            views: 1,
            likes: 1,
            shares: 1,
            comments: 1,
            mediaBasePath: 1,
            mediaUri: 1,
            mediaType: 1,
            mediaThumbEndpoint: 1,
            mediaEndpoint: 1,
            mediaThumbUri: 1,
            apsaraId: 1,
            apsara: 1,
            penjual: 1,
            tags: 1,
          }
        },
      );

    }
    else {
      pipeline.push(
        {
          $addFields: {

            salePrice: {
              $cmp: ["$saleAmount", 0]
            },
            sLike: {
              $cmp: ["$saleLike", 0]
            },
            sView: {
              $cmp: ["$saleView", 0]
            },
            certi: {
              $cmp: ["$certified", 0]
            },
            reportedCount: {
              $cmp: ["$reportedUserCount", 0]
            },

          }
        },

        {
          $lookup: {
            from: 'newUserBasics',
            localField: 'idUser',
            foreignField: '_id',
            as: 'authdata',

          }
        },

        {
          $addFields: {


            'auth': {
              $arrayElemAt: ['$authdata', 0]
            },

          }
        },
        {
          "$lookup": {
            "from": "interests_repo",
            "as": "kategori",
            "let": {
              "local_id": "$category.$id",

            },
            "pipeline": [
              {
                $match:
                {
                  $and: [
                    {
                      $expr: {

                        $in: ['$_id', {
                          $ifNull: ['$$local_id', []]
                        }]
                      }
                    },

                  ]
                }
              },
              {
                $project: {
                  interestName: 1,

                }
              },

            ],

          },

        },
        {
          $project: {
            "username": "$auth.username",
            "createdAt": 1,
            "updatedAt": 1,
            "postID": 1,
            "email": 1,
            "postType": 1,
            "type": {
              "$switch": {
                "branches": [
                  {
                    "case": {
                      "$eq": [
                        "$postType",
                        "pict"
                      ]
                    },
                    "then": "HyppePic"
                  },
                  {
                    "case": {
                      "$eq": [
                        "$postType",
                        "vid"
                      ]
                    },
                    "then": "HyppeVid"
                  },
                  {
                    "case": {
                      "$eq": [
                        "$postType",
                        "diary"
                      ]
                    },
                    "then": "HyppeDiary"
                  },
                  {
                    "case": {
                      "$eq": [
                        "$postType",
                        "story"
                      ]
                    },
                    "then": "HyppeStory"
                  }
                ],
                "default": ""
              }
            },
            "description": 1,
            "title": 1,
            "active": 1,
            "kategori": 1,
            "reportedUserCount": 1,
            "views": 1,
            "likes": 1,
            "shares": 1,
            "comments": 1,
            "certified": {
              "$cond": {
                "if": {
                  "$or": [
                    {
                      "$eq": [
                        "$certi",
                        -1
                      ]
                    },
                    {
                      "$eq": [
                        "$certi",
                        0
                      ]
                    }
                  ]
                },
                "then": false,
                "else": "$certified"
              }
            },
            "visibility": 1,
            "saleAmount": {
              "$cond": {
                "if": {
                  "$or": [
                    {
                      "$eq": [
                        "$salePrice",
                        -1
                      ]
                    },
                    {
                      "$eq": [
                        "$salePrice",
                        0
                      ]
                    }
                  ]
                },
                "then": 0,
                "else": "$saleAmount"
              }
            },
            "monetize": {
              "$cond": {
                "if": {
                  "$or": [
                    {
                      "$eq": [
                        "$salePrice",
                        -1
                      ]
                    },
                    {
                      "$eq": [
                        "$salePrice",
                        0
                      ]
                    }
                  ]
                },
                "then": false,
                "else": true
              }
            },
            "reported": {
              "$cond": {
                "if": {
                  "$or": [
                    {
                      "$eq": [
                        "$reportedCount",
                        -1
                      ]
                    },
                    {
                      "$eq": [
                        "$reportedCount",
                        0
                      ]
                    }
                  ]
                },
                "then": "TIDAK",
                "else": "YA"
              }
            },
            "tags": 1,
            "mediaSource": 1
          }
        },
        {
          $project: {
            "username": 1,
            "createdAt": 1,
            "updatedAt": 1,
            "postID": 1,
            "postType": 1,
            "email": 1,
            "reported": 1,
            "views": 1,
            "likes": 1,
            "shares": 1,
            "comments": 1,
            "type": 1,
            "description": 1,
            "title": 1,
            "active": 1,
            "kategori": 1,
            "kepemilikan": {
              "$cond": {
                "if": {
                  "$or": [
                    {
                      "$eq": [
                        "$certified",
                        false
                      ]
                    },
                    {
                      "$eq": [
                        "$certified",
                        ""
                      ]
                    }
                  ]
                },
                "then": "TIDAK",
                "else": "YA"
              }
            },
            "visibility": 1,
            "saleAmount": 1,
            "statusJual": {
              "$cond": {
                "if": {
                  "$eq": [
                    "$monetize",
                    false
                  ]
                },
                "then": "TIDAK",
                "else": "YA"
              }
            },
            "tags": 1,
            "mediaSource": 1
          }
        },
        {
          $addFields: {
            pict: {
              $replaceOne: {
                input: "$auth.mediaUri",
                find: "_0001.jpeg",
                replacement: ""
              }
            },
          },

        },
        {
          "$project": {
            "username": 1,
            "createdAt": 1,
            "updatedAt": 1,
            "postID": 1,
            "postType": 1,
            "email": 1,
            "type": 1,
            "description": 1,
            "title": 1,
            "active": 1,
            "kategori": 1,
            "kepemilikan": 1,
            "visibility": 1,
            "saleAmount": 1,
            "statusJual": 1,
            "reported": 1,
            "views": 1,
            "likes": 1,
            "shares": 1,
            "comments": 1,
            "tags": 1,
            "mediaBasePath": "$mediaSource.mediaBasePath",
            "mediaUri": "$mediaSource.mediaUri",
            "mediaType": "$mediaSource.mediaType",
            "mediaThumbEndpoint": {
              "$switch": {
                "branches": [
                  {
                    "case": {
                      "$eq": [
                        "$type",
                        "HyppePic"
                      ]
                    },
                    "then": "$mediaSource.mediaThumb"
                  },
                  {
                    "case": {
                      "$eq": [
                        "$type",
                        "HyppeDiary"
                      ]
                    },
                    "then": {
                      "$concat": [
                        "/thumb/",
                        "$postID"
                      ]
                    }
                  },
                  {
                    "case": {
                      "$eq": [
                        "$refs",
                        "mediavideos"
                      ]
                    },
                    "then": {
                      "$concat": [
                        "/thumb/",
                        "$postID"
                      ]
                    }
                  },
                  {
                    "case": {
                      "$eq": [
                        "$refs",
                        "mediastories"
                      ]
                    },
                    "then": {
                      "$concat": [
                        "/thumb/",
                        "$postID"
                      ]
                    }
                  }
                ],
                "default": ""
              }
            },
            "mediaEndpoint": {
              "$switch": {
                "branches": [
                  {
                    "case": {
                      "$eq": [
                        "$type",
                        "HyppePic"
                      ]
                    },
                    "then": {
                      "$concat":
                        [
                          "/pict/",
                          "$postID"
                        ]
                    }
                  },
                  {
                    "case": {
                      "$eq": [
                        "$type",
                        "HyppeDiary"
                      ]
                    },
                    "then": {
                      "$concat": [
                        "/thumb/",
                        "$postID"
                      ]
                    }
                  },
                  {
                    "case": {
                      "$eq": [
                        "$refs",
                        "mediavideos"
                      ]
                    },
                    "then": {
                      "$concat": [
                        "/thumb/",
                        "$postID"
                      ]
                    }
                  },
                  {
                    "case": {
                      "$eq": [
                        "$refs",
                        "mediastories"
                      ]
                    },
                    "then": {
                      "$cond":
                      {
                        if:
                        {
                          "$eq":
                            [
                              "$mediaSource.mediaType",
                              "image"
                            ]
                        },
                        then:
                        {
                          "$concat":
                            [
                              "/pict/",
                              "$postID"
                            ]
                        },
                        else:
                        {
                          "$concat":
                            [
                              "/stream/",
                              "$postID"
                            ]
                        }
                      }
                    }
                  }
                ],
                "default": ""
              }
            },
            "mediaThumbUri": "$mediaSource.mediaThumb",
            "apsaraId": {
              "$ifNull":
                [
                  "$mediaSource.apsaraId",
                  false
                ]
            },
            "apsara": {
              "$ifNull":
                [
                  "$mediaSource.apsara",
                  false
                ]
            },
          }
        },
      );
    }


    if (username && username !== undefined) {

      pipeline.push({
        $match: {
          username: {
            $regex: username,
            $options: 'i'
          },

        }
      },);

    }


    if (kepemilikan && kepemilikan !== undefined) {
      pipeline.push({
        $match: {
          $or: [
            {
              kepemilikan: {
                $in: kepemilikan
              }
            },

          ]
        }
      },);
    }

    if (statusjual && statusjual !== undefined) {
      pipeline.push({
        $match: {
          $or: [
            {
              statusJual: {
                $in: statusjual
              }
            },

          ]
        }
      },);
    }

    if (buy !== undefined && buy === "YA") {
      pipeline.push({
        $match: {
          buy: buy
        }
      },);
    }
    if (report && report !== undefined) {
      pipeline.push({
        $match: {
          reported: report
        }
      },);
    }

    if (kategori && kategori !== undefined) {
      pipeline.push({
        $match: {
          $or: [
            {
              'kategori._id': {
                $in: arrkategori
              }
            },

          ]
        }
      },);
    }
    if (postType && postType !== undefined) {
      pipeline.push({
        $match: {
          $or: [
            {
              type: {
                $in: postType
              }
            },

          ]
        }
      },);
    }
    if (startmount && startmount !== undefined) {
      pipeline.push({ $match: { saleAmount: { $gte: startmount } } });
    }
    if (endmount && endmount !== undefined) {
      pipeline.push({ $match: { saleAmount: { $lte: endmount } } });
    }
    if (startdate && startdate !== undefined) {
      pipeline.push({ $match: { createdAt: { $gte: startdate } } });
    }
    if (enddate && enddate !== undefined) {
      pipeline.push({ $match: { createdAt: { $lte: dt } } });
    }



    if (page > 0) {
      pipeline.push({ $skip: (page * limit) });
    }
    if (limit > 0) {
      pipeline.push({ $limit: limit });
    }


    let query = await this.loaddata.aggregate(pipeline);
    // console.log(query);

    var listdata = [];
    var tempresult = null;
    var tempdata = null;
    for (var i = 0; i < query.length; i++) {
      tempdata = query[i];
      if (tempdata.apsara == true) {
        listdata.push(tempdata.apsaraId);
      }
      else {
        listdata.push(undefined);
      }
    }

    //console.log(listdata);
    var apsaraimagedata = await this.postContentService.getImageApsara(listdata);
    // console.log(resultdata.ImageInfo[0]);
    tempresult = apsaraimagedata.ImageInfo;
    for (var i = 0; i < query.length; i++) {
      for (var j = 0; j < tempresult.length; j++) {
        if (tempresult[j].ImageId == query[i].apsaraId) {
          query[i].media =
          {
            "ImageInfo": [tempresult[j]]
          }
        }
        else if (query[i].apsara == false && (query[i].mediaType == "image" || query[i].mediaType == "images")) {
          query[i].media =
          {
            "ImageInfo": []
          }
        }
      }
    }

    var apsaravideodata = await this.postContentService.getVideoApsara(listdata);
    // console.log(apsaravideodata);
    // console.log(resultdata.ImageInfo[0]);
    tempresult = apsaravideodata.VideoList;
    for (var i = 0; i < query.length; i++) {
      for (var j = 0; j < tempresult.length; j++) {
        if (tempresult[j].VideoId == query[i].apsaraId) {
          query[i].media =
          {
            "VideoList": [tempresult[j]]
          }
        }
        else if (query[i].apsara == false && query[i].mediaType == "video") {
          query[i].media =
          {
            "VideoList": []
          }
        }
      }
    }

    return query;
  }

  async detailcontent(target: string, page: number, limit: number) {
    var query = await this.loaddata.aggregate([
      {
        "$match":
        {
          "postID": target
        }
      },
      {
        $addFields: {

          salePrice: {
            $cmp: ["$saleAmount", 0]
          },
          sLike: {
            $cmp: ["$saleLike", 0]
          },
          sView: {
            $cmp: ["$saleView", 0]
          },
          certi: {
            $cmp: ["$certified", 0]
          },

        }
      },
      {
        $lookup: {
          from: 'newUserBasics',
          localField: 'email',
          foreignField: 'email',
          as: 'authdata',

        }
      },
      {
        "$lookup": {
          "from": "mediamusic",
          "as": "music",
          "let": {
            "local_id": "$musicId",

          },
          "pipeline": [
            {
              $match:
              {
                _id: "$$local_id"
              }
            },
            {
              $project: {
                musicTitle: 1,
                albumName: 1
              }
            },

          ],

        },

      },
      {
        $addFields: {


          'auth': {
            $arrayElemAt: ['$authdata', 0]
          },
          'basic': {
            $arrayElemAt: ['$basicdata', 0]
          },

        }
      },
      {
        "$lookup": {
          "from": "interests_repo",
          "as": "kategori",
          "let": {
            "local_id": "$category.$id",

          },
          "pipeline": [
            {
              $match:
              {
                $and: [
                  {
                    $expr: {

                      $in: ['$_id', {
                        $ifNull: ['$$local_id', []]
                      }]
                    }
                  },

                ]
              }
            },
            {
              $project: {
                interestName: 1,

              }
            },

          ],

        },

      },
      {
        $project: {
          music: {
            $arrayElemAt: ['$music', 0]
          },
          userView: 1,
          username: "$auth.username",
          authdata: "$auth",
          createdAt: 1,
          updatedAt: 1,
          postID: 1,
          musicId: 1,
          email: 1,
          postType: 1,
          description: 1,
          title: 1,
          active: 1,
          likes: 1,
          views: 1,
          shares: 1,
          comments: 1,
          kategori: 1,
          tagPeople: 1,
          tagDescription: 1,
          visibility: 1,
          location: 1,
          tags: 1,
          allowComments: 1,
          certified:
          {
            $cond: {
              if: {
                $or: [{
                  $eq: ["$certi", - 1]
                }, {
                  $eq: ["$certi", 0]
                }]
              },
              then: false,
              else: "$certified"
            }
          },
          saleAmount: {
            $cond: {
              if: {
                $or: [{
                  $eq: ["$salePrice", - 1]
                }, {
                  $eq: ["$salePrice", 0]
                }]
              },
              then: 0,
              else: "$saleAmount"
            }
          },
          saleView: {
            $cond: {
              if: {
                $or: [{
                  $eq: ["$sView", - 1]
                }, {
                  $eq: ["$sView", 0]
                }]
              },
              then: false,
              else: "$saleView"
            }
          },
          saleLike: {
            $cond: {
              if: {
                $or: [{
                  $eq: ["$sLike", - 1]
                }, {
                  $eq: ["$sLike", 0]
                }]
              },
              then: false,
              else: "$saleLike"
            }
          },
          monetize: {
            $cond: {
              if: {
                $or: [{
                  $eq: ["$salePrice", - 1]
                }, {
                  $eq: ["$salePrice", 0]
                }]
              },
              then: false,
              else: true
            }
          },
          mediaSource:
          {
            "$arrayElemAt":
              [
                "$mediaSource", 0
              ]
          }

        }
      },
      {
        $project: {
          musicTitle: '$music.musicTitle',
          albumName: '$music.albumName',
          username: 1,
          userView: 1,
          authdata: 1,
          createdAt: 1,
          updatedAt: 1,
          postID: 1,
          musicId: 1,
          postType: 1,
          likes: 1,
          views: 1,
          shares: 1,
          saleView: 1,
          saleLike: 1,
          comments: 1,
          email: 1,
          tagPeople: 1,
          tagDescription: 1,
          visibility: 1,
          location: 1,
          tags: 1,
          allowComments: 1,
          type: {
            $switch: {
              branches: [
                {
                  'case': {
                    '$eq': ['$postType', 'pict']
                  },
                  'then': "HyppePic"
                },
                {
                  'case': {
                    '$eq': ['$postType', 'vid']
                  },
                  'then': "HyppeVid"
                },
                {
                  'case': {
                    '$eq': ['$postType', 'diary']
                  },
                  'then': "HyppeDiary"
                },
                {
                  'case': {
                    '$eq': ['$postType', 'story']
                  },
                  'then': "HyppeStory"
                },

              ],
              default: ''
            }
          },
          description: 1,
          title: 1,
          active: 1,
          kategori: 1,
          kepemilikan:
          {
            $cond: {
              if: {
                $or: [{
                  $eq: ["$certified", false]
                }, {
                  $eq: ["$certified", ""]
                }]
              },
              then: "TIDAK",
              else: "YA"
            }
          },
          saleAmount: 1,
          statusJual:
          {
            $cond: {
              if: {

                $eq: ["$monetize", false]
              },
              then: "TIDAK",
              else: "YA"
            }
          },
          mediaSource: 1

        }
      },
      {
        $project: {
          username: 1,
          authdata: 1,
          userView: 1,
          createdAt: 1,
          updatedAt: 1,
          postID: 1,
          musicId: 1,
          postType: 1,
          email: 1,
          type: 1,
          description: 1,
          title: 1,
          active: 1,
          likes: 1,
          views: 1,
          shares: 1,
          comments: 1,
          kategori: 1,
          kepemilikan: 1,
          visibility: 1,
          saleAmount: 1,
          statusJual: 1,
          saleView: 1,
          saleLike: 1,
          tagPeople: 1,
          tagDescription: 1,
          location: 1,
          tags: 1,
          allowComments: 1,
          musicTitle: 1,
          albumName: 1,
          mediaSource: 1
        }
      },
      {
        $addFields: {


          pict: {
            $replaceOne: {
              input: "$authdata.mediaUri",
              find: "_0001.jpeg",
              replacement: ""
            }
          },
        },

      },
      {
        $project: {
          authdata: 1,
          username: 1,
          userView: 1,
          createdAt: 1,
          updatedAt: 1,
          postID: 1,
          musicId: 1,
          postType: 1,
          email: 1,
          type: 1,
          description: 1,
          title: 1,
          active: 1,
          kategori: 1,
          kepemilikan: 1,
          visibility: 1,
          likes: 1,
          views: 1,
          shares: 1,
          comments: 1,
          saleAmount: 1,
          statusJual: 1,
          saleView: 1,
          saleLike: 1,
          tagPeople: 1,
          tagDescription: 1,
          location: 1,
          tags: 1,
          allowComments: 1,
          musicTitle: 1,
          albumName: 1,
          "mediaBasePath": "$mediaSource.mediaBasePath",
          "mediaUri": "$mediaSource.mediaUri",
          "mediaType": "$mediaSource.mediaType",
          "mediaThumbEndpoint": {
            "$switch": {
              "branches": [
                {
                  "case": {
                    "$eq": [
                      "$type",
                      "HyppePic"
                    ]
                  },
                  "then": "$mediaSource.mediaThumb"
                },
                {
                  "case": {
                    "$eq": [
                      "$type",
                      "HyppeDiary"
                    ]
                  },
                  "then": {
                    "$concat": [
                      "/thumb/",
                      "$postID"
                    ]
                  }
                },
                {
                  "case": {
                    "$eq": [
                      "$type",
                      "HyppeVid"
                    ]
                  },
                  "then": {
                    "$concat": [
                      "/thumb/",
                      "$postID"
                    ]
                  }
                },
                {
                  "case": {
                    "$eq": [
                      "$type",
                      "HyppeStory"
                    ]
                  },
                  "then": {
                    "$concat": [
                      "/thumb/",
                      "$postID"
                    ]
                  }
                }
              ],
              "default": ""
            }
          },
          "mediaEndpoint": {
            "$switch": {
              "branches": [
                {
                  "case": {
                    "$eq": [
                      "$type",
                      "HyppePic"
                    ]
                  },
                  "then": {
                    "$concat":
                      [
                        "/pict/",
                        "$postID"
                      ]
                  }
                },
                {
                  "case": {
                    "$eq": [
                      "$type",
                      "HyppeDiary"
                    ]
                  },
                  "then": {
                    "$concat": [
                      "/thumb/",
                      "$postID"
                    ]
                  }
                },
                {
                  "case": {
                    "$eq": [
                      "$type",
                      "HyppeVid"
                    ]
                  },
                  "then": {
                    "$concat": [
                      "/thumb/",
                      "$postID"
                    ]
                  }
                },
                {
                  "case": {
                    "$eq": [
                      "$type",
                      "HyppeDiary"
                    ]
                  },
                  "then": {
                    "$cond":
                    {
                      if:
                      {
                        "$eq":
                          [
                            "$mediaSource.mediaType",
                            "image"
                          ]
                      },
                      then:
                      {
                        "$concat":
                          [
                            "/pict/",
                            "$postID"
                          ]
                      },
                      else:
                      {
                        "$concat":
                          [
                            "/stream/",
                            "$postID"
                          ]
                      }
                    }
                  }
                }
              ],
              "default": ""
            }
          },
          "mediaThumbUri": "$mediaSource.mediaThumb",
          "apsaraId": {
            "$ifNull":
              [
                "$mediaSource.apsaraId",
                false
              ]
          },
          "apsara": {
            "$ifNull":
              [
                "$mediaSource.apsara",
                false
              ]
          },
          originalName: "$mediaSource.originalName",
          rotate: "$mediaSource.rotate"

        }
      },
      {
        "$lookup": {
          "from": "disquslogs",
          "as": "comment",
          "let": {
            "local_id": "$postID"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$eq": [
                    "$postID",
                    "$$local_id"
                  ]
                }
              }
            },
            {
              $project: {
                postID: 1,
                txtMessages: 1,
                sender: 1,
                receiver: 1,
                createdAt: 1,
                active: 1
              }
            },
            {
              $match: {
                active: true
              }
            },
            { $sort: { createdAt: -1 } },
            {
              $skip: (page * limit)
            },
            {
              $limit: (limit)
            },
            {
              "$lookup": {
                "from": "newUserBasics",
                "as": "authsender",
                "let": {
                  "local_id": "$sender"
                },
                "pipeline": [
                  {
                    "$match": {
                      "$expr": {
                        "$eq": [
                          "$email",
                          "$$local_id"
                        ]
                      }
                    }
                  },

                ],

              }
            },
            {
              $project: {

                emailsender:
                {
                  $arrayElemAt: ['$authsender.email', 0]
                },
                sender:
                {
                  $arrayElemAt: ['$authsender.username', 0]
                },
                profilePict:
                {
                  $arrayElemAt: ['$authsender.profilePict.$id', 0]
                },
                avatar:
                  [
                    {
                      mediaBasePath:
                      {
                        "$arrayElemAt":
                          [
                            "$authsender.mediaBasePath", 0
                          ]
                      },
                      mediaUri:
                      {
                        "$arrayElemAt":
                          [
                            "$authsender.mediaUri", 0
                          ]
                      },
                      mediaEndpoint:
                      {
                        "$arrayElemAt":
                          [
                            "$authsender.mediaEndpoint", 0
                          ]
                      }
                    }
                  ],
                receiver: 1,
                postID: 1,
                txtMessages: 1,
                createdAt: 1,
                active: 1
              }
            },

          ],

        }
      },
      {
        "$lookup": {
          "from": "transactions",
          "as": "riwayat",
          "let": {
            "local_id": "$postID",

          },
          "pipeline": [
            {
              $match:
              {

                $expr: {

                  $eq: ['$postid', '$$local_id']
                }
              }
            },
            {
              $project: {
                idusersell: 1,
                iduserbuyer: 1,
                postID: '$postid',
                amount: 1,
                status: 1,
                noinvoice: 1,
                timestamp: 1
              }
            },
            {
              $match: {
                status: "Success"
              }
            },
            { $sort: { timestamp: -1 } },
            {
              $skip: (page * limit)
            },
            {
              $limit: (limit)
            },
            {
              "$lookup": {
                "from": "newUserBasics",
                "as": "penjual",
                "let": {
                  "local_id": "$idusersell"
                },
                "pipeline": [
                  {
                    "$match": {
                      "$expr": {
                        "$eq": [
                          "$_id",
                          "$$local_id"
                        ]
                      }
                    }
                  },

                ],

              }
            },
            {
              "$lookup": {
                "from": "newUserBasics",
                "as": "pembeli",
                "let": {
                  "local_id": "$iduserbuyer"
                },
                "pipeline": [
                  {
                    "$match": {
                      "$expr": {
                        "$eq": [
                          "$_id",
                          "$$local_id"
                        ]
                      }
                    }
                  },

                ],

              }
            },
            {
              $project: {
                penjual: {
                  $arrayElemAt: ['$penjual.username', 0]
                },
                pembeli: {
                  $arrayElemAt: ['$pembeli.username', 0]
                },
                postID: 1,
                amount: 1,
                status: 1,
                noinvoice: 1,
                timestamp: 1
              }
            },

          ],

        },

      },
      {
        "$project":
        {
          _id: 1,
          postID: 1,
          email: 1,
          postType: 1,
          description: 1,
          active: 1,
          createdAt: 1,
          updatedAt: 1,
          visibility: 1,
          location: 1,
          tags: 1,
          allowComments: 1,
          likes: 1,
          views: 1,
          shares: 1,
          tagPeople: 1,
          tagDescription: 1,
          comments: 1,
          kategori: 1,
          username: 1,
          saleAmount: 1,
          saleView: 1,
          saleLike: 1,
          type: 1,
          kepemilikan: 1,
          statusJual: 1,
          mediaType: 1,
          mediaThumbEndpoint: 1,
          mediaEndpoint: 1,
          apsaraId: 1,
          apsara: 1,
          originalName: 1,
          comment: 1,
          riwayat: 1,
          userView: 1
        }
      },
      {
        "$facet":
        {
          "detail":
            [
              {
                "$project":
                {
                  _id: 1,
                  postID: 1,
                  email: 1,
                  postType: 1,
                  description: 1,
                  active: 1,
                  createdAt: 1,
                  updatedAt: 1,
                  visibility: 1,
                  location: 1,
                  tags: 1,
                  allowComments: 1,
                  likes: 1,
                  views: 1,
                  shares: 1,
                  tagPeople: 1,
                  tagDescription: 1,
                  comments: 1,
                  kategori: 1,
                  username: 1,
                  saleAmount: 1,
                  saleView: 1,
                  saleLike: 1,
                  type: 1,
                  kepemilikan: 1,
                  statusJual: 1,
                  mediaType: 1,
                  mediaThumbEndpoint: 1,
                  mediaEndpoint: 1,
                  apsaraId: 1,
                  apsara: 1,
                  originalName: 1,
                  comment: 1,
                  riwayat: 1,
                }
              }
            ],
          "age":
            [
              {
                "$unwind":
                {
                  path: "$userView"
                }
              },
              {
                "$project":
                {
                  userView: 1
                }
              },
              {
                "$lookup": {
                  "from": "newUserBasics",
                  "as": "basic_data",
                  "let": {
                    "local_id": "$userView"
                  },
                  "pipeline": [
                    {
                      "$match":
                      {
                        "$expr":
                        {
                          "$eq":
                            [
                              "$email", "$$local_id"
                            ]
                        }
                      }
                    },
                    {
                      "$project":
                      {
                        _id: 1,
                        ageQualication: {
                          "$switch": {
                            "branches": [{
                              "case": {
                                "$and": [{
                                  "$gte": [{
                                    "$cond": {
                                      "if": {
                                        "$and": ["$dob", {
                                          "$ne": ["$dob", ""]
                                        }]
                                      },
                                      "then": {
                                        "$toInt": {
                                          "$divide": [{
                                            "$subtract": [new Date(), {
                                              "$toDate": "$dob"
                                            }]
                                          }, 31536000000]
                                        }
                                      },
                                      "else": 0
                                    }
                                  }, 1]
                                }, {
                                  "$lte": [{
                                    "$cond": {
                                      "if": {
                                        "$and": ["$dob", {
                                          "$ne": ["$dob", ""]
                                        }]
                                      },
                                      "then": {
                                        "$toInt": {
                                          "$divide": [{
                                            "$subtract": [new Date(), {
                                              "$toDate": "$dob"
                                            }]
                                          }, 31536000000]
                                        }
                                      },
                                      "else": 0
                                    }
                                  }, 14]
                                }]
                              },
                              "then": "< 14 Tahun"
                            }, {
                              "case": {
                                "$and": [{
                                  "$gte": [{
                                    "$cond": {
                                      "if": {
                                        "$and": ["$dob", {
                                          "$ne": ["$dob", ""]
                                        }]
                                      },
                                      "then": {
                                        "$toInt": {
                                          "$divide": [{
                                            "$subtract": [new Date(), {
                                              "$toDate": "$dob"
                                            }]
                                          }, 31536000000]
                                        }
                                      },
                                      "else": 0
                                    }
                                  }, 14]
                                }, {
                                  "$lte": [{
                                    "$cond": {
                                      "if": {
                                        "$and": ["$dob", {
                                          "$ne": ["$dob", ""]
                                        }]
                                      },
                                      "then": {
                                        "$toInt": {
                                          "$divide": [{
                                            "$subtract": [new Date(), {
                                              "$toDate": "$dob"
                                            }]
                                          }, 31536000000]
                                        }
                                      },
                                      "else": 0
                                    }
                                  }, 24]
                                }]
                              },
                              "then": "14 - 24 Tahun"
                            }, {
                              "case": {
                                "$and": [{
                                  "$gte": [{
                                    "$cond": {
                                      "if": {
                                        "$and": ["$dob", {
                                          "$ne": ["$dob", ""]
                                        }]
                                      },
                                      "then": {
                                        "$toInt": {
                                          "$divide": [{
                                            "$subtract": [new Date(), {
                                              "$toDate": "$dob"
                                            }]
                                          }, 31536000000]
                                        }
                                      },
                                      "else": 0
                                    }
                                  }, 25]
                                }, {
                                  "$lte": [{
                                    "$cond": {
                                      "if": {
                                        "$and": ["$dob", {
                                          "$ne": ["$dob", ""]
                                        }]
                                      },
                                      "then": {
                                        "$toInt": {
                                          "$divide": [{
                                            "$subtract": [new Date(), {
                                              "$toDate": "$dob"
                                            }]
                                          }, 31536000000]
                                        }
                                      },
                                      "else": 0
                                    }
                                  }, 35]
                                }]
                              },
                              "then": "24 - 35 Tahun"
                            }, {
                              "case": {
                                "$and": [{
                                  "$gte": [{
                                    "$cond": {
                                      "if": {
                                        "$and": ["$dob", {
                                          "$ne": ["$dob", ""]
                                        }]
                                      },
                                      "then": {
                                        "$toInt": {
                                          "$divide": [{
                                            "$subtract": [new Date(), {
                                              "$toDate": "$dob"
                                            }]
                                          }, 31536000000]
                                        }
                                      },
                                      "else": 0
                                    }
                                  }, 35]
                                }, {
                                  "$lte": [{
                                    "$cond": {
                                      "if": {
                                        "$and": ["$dob", {
                                          "$ne": ["$dob", ""]
                                        }]
                                      },
                                      "then": {
                                        "$toInt": {
                                          "$divide": [{
                                            "$subtract": [new Date(), {
                                              "$toDate": "$dob"
                                            }]
                                          }, 31536000000]
                                        }
                                      },
                                      "else": 0
                                    }
                                  }, 44]
                                }]
                              },
                              "then": "35 - 44 Tahun"
                            }, {
                              "case": {
                                "$gt": [{
                                  "$cond": {
                                    "if": {
                                      "$and": ["$dob", {
                                        "$ne": ["$dob", ""]
                                      }]
                                    },
                                    "then": {
                                      "$toInt": {
                                        "$divide": [{
                                          "$subtract": [new Date(), {
                                            "$toDate": "$dob"
                                          }]
                                        }, 31536000000]
                                      }
                                    },
                                    "else": 0
                                  }
                                }, 43]
                              },
                              "then": "> 44 Tahun"
                            }],
                            "default": "OTHER"
                          }
                        },
                      }
                    },
                    {
                      "$project":
                      {
                        _id: 1,
                        ageQualication: 1
                      }
                    },
                  ]
                }
              },
              {
                "$project":
                {
                  age:
                  {
                    "$ifNull":
                      [
                        {
                          "$arrayElemAt":
                            [
                              "$basic_data.ageQualication", 0
                            ]
                        },
                        "OTHER"
                      ]
                  }
                }
              },
              {
                "$group":
                {
                  _id: "$age",
                  count:
                  {
                    "$sum": 1
                  }
                }
              },
              {
                "$sort":
                {
                  _id: -1
                }
              }
            ],
          "wilayah":
            [
              {
                "$unwind":
                {
                  path: "$userView"
                }
              },
              {
                "$project":
                {
                  userView: 1
                }
              },
              {
                "$lookup": {
                  "from": "newUserBasics",
                  "as": "basic_data",
                  "let": {
                    "local_id": "$userView"
                  },
                  "pipeline": [
                    {
                      "$match":
                      {
                        "$expr":
                        {
                          "$eq":
                            [
                              "$email", "$$local_id"
                            ]
                        }
                      }
                    },
                    {
                      "$project":
                      {
                        _id: 1,
                        statesName: 1,
                      }
                    },
                    // {
                    //     $lookup: 
                    //     {
                    //         from: 'areas',
                    //         localField: 'states.$id',
                    //         foreignField: '_id',
                    //         as: 'areas_data',
                    //     },
                    // },
                    {
                      "$project":
                      {
                        _id: 1,
                        stateName:
                        {
                          "$ifNull":
                            [
                              "$statesName",
                              "LAINNYA"
                            ]
                        }
                      }
                    }
                  ]
                }
              },
              {
                "$project":
                {
                  wilayah:
                  {
                    "$ifNull":
                      [
                        {
                          "$arrayElemAt":
                            [
                              "$basic_data.stateName", 0
                            ]
                        },
                        "LAINNYA"
                      ]
                  }
                }
              },
              {
                "$group":
                {
                  _id: "$wilayah",
                  count:
                  {
                    "$sum": 1
                  }
                }
              },
              {
                "$sort":
                {
                  _id: -1
                }
              }
            ],
          "gender":
            [
              {
                "$unwind":
                {
                  path: "$userView"
                }
              },
              {
                "$project":
                {
                  userView: 1
                }
              },
              {
                "$lookup": {
                  "from": "newUserBasics",
                  "as": "basic_data",
                  "let": {
                    "local_id": "$userView"
                  },
                  "pipeline": [
                    {
                      "$match":
                      {
                        "$expr":
                        {
                          "$eq":
                            [
                              "$email", "$$local_id"
                            ]
                        }
                      }
                    },
                    {
                      "$project":
                      {
                        _id: 1,
                        gender: {
                          $switch: {
                            branches: [
                              {
                                case: {
                                  $eq: ['$gender', 'FEMALE']
                                },
                                then: 'FEMALE',

                              },
                              {
                                case: {
                                  $eq: ['$gender', ' FEMALE']
                                },
                                then: 'FEMALE',

                              },
                              {
                                case: {
                                  $eq: ['$gender', 'Perempuan']
                                },
                                then: 'FEMALE',

                              },
                              {
                                case: {
                                  $eq: ['$gender', 'Wanita']
                                },
                                then: 'FEMALE',

                              },
                              {
                                case: {
                                  $eq: ['$gender', 'MALE']
                                },
                                then: 'MALE',

                              },
                              {
                                case: {
                                  $eq: ['$gender', ' MALE']
                                },
                                then: 'MALE',

                              },
                              {
                                case: {
                                  $eq: ['$gender', 'Laki-laki']
                                },
                                then: 'MALE',

                              },
                              {
                                case: {
                                  $eq: ['$gender', 'Pria']
                                },
                                then: 'MALE',

                              },

                            ],
                            default: "OTHER",
                          },
                        },
                      }
                    },
                    {
                      "$project":
                      {
                        _id: 1,
                        gender: 1,
                      }
                    },
                  ]
                }
              },
              {
                "$project":
                {
                  gender:
                  {
                    "$ifNull":
                      [
                        {
                          "$arrayElemAt":
                            [
                              "$basic_data.gender", 0
                            ]
                        },
                        "OTHER"
                      ]
                  }
                }
              },
              {
                "$group":
                {
                  _id: "$gender",
                  count:
                  {
                    "$sum": 1
                  }
                }
              },
              {
                "$sort":
                {
                  _id: -1
                }
              }
            ],
          "listtag":
            [
              {
                "$project":
                {
                  tagPeople: 1
                }
              },
              {
                "$unwind":
                {
                  path: "$tagPeople",
                }
              },
              {
                $lookup:
                {
                  from: 'newUserBasics',
                  let:
                  {
                    local: '$tagPeople.$id'
                  },
                  as: 'authdata',
                  pipeline:
                    [
                      {
                        "$match":
                        {
                          "$or":
                            [
                              {
                                "$expr":
                                {
                                  "$eq":
                                    [
                                      "$_idAuth", "$$local"
                                    ]
                                }
                              },
                              {
                                "$expr":
                                {
                                  "$eq":
                                    [
                                      "$_id", "$$local"
                                    ]
                                }
                              },
                            ]
                        }
                      }
                    ]
                }
              },
              {
                "$unwind":
                {
                  path: "$authdata"
                }
              },
              {
                "$project":
                {
                  username: "$authdata.username"
                }
              },
              {
                "$group":
                {
                  _id: null,
                  data:
                  {
                    "$push": "$username"
                  }
                }
              },
            ]
        }
      },
      {
        "$project":
        {
          _id:
          {
            "$arrayElemAt":
              [
                "$detail._id", 0
              ]
          },
          postID:
          {
            "$arrayElemAt":
              [
                "$detail.postID", 0
              ]
          },
          email:
          {
            "$arrayElemAt":
              [
                "$detail.email", 0
              ]
          },
          postType:
          {
            "$arrayElemAt":
              [
                "$detail.postType", 0
              ]
          },
          description:
          {
            "$arrayElemAt":
              [
                "$detail.description", 0
              ]
          },
          active:
          {
            "$arrayElemAt":
              [
                "$detail.active", 0
              ]
          },
          createdAt:
          {
            "$arrayElemAt":
              [
                "$detail.createdAt", 0
              ]
          },
          updatedAt:
          {
            "$arrayElemAt":
              [
                "$detail.updatedAt", 0
              ]
          },
          visibility:
          {
            "$arrayElemAt":
              [
                "$detail.visibility", 0
              ]
          },
          location:
          {
            "$arrayElemAt":
              [
                "$detail.location", 0
              ]
          },
          tags:
          {
            "$arrayElemAt":
              [
                "$detail.tags", 0
              ]
          },
          allowComments:
          {
            "$arrayElemAt":
              [
                "$detail.allowComments", 0
              ]
          },
          likes:
          {
            "$arrayElemAt":
              [
                "$detail.likes", 0
              ]
          },
          views:
          {
            "$arrayElemAt":
              [
                "$detail.views", 0
              ]
          },
          shares:
          {
            "$arrayElemAt":
              [
                "$detail.shares", 0
              ]
          },
          tagPeople:
          {
            "$arrayElemAt":
              [
                "$listtag.data", 0
              ]
          },
          tagDescription:
          {
            "$arrayElemAt":
              [
                "$detail.tagDescription", 0
              ]
          },
          kategori:
          {
            "$arrayElemAt":
              [
                "$detail.kategori", 0
              ]
          },
          username:
          {
            "$arrayElemAt":
              [
                "$detail.username", 0
              ]
          },
          saleAmount:
          {
            "$arrayElemAt":
              [
                "$detail.saleAmount", 0
              ]
          },
          saleView:
          {
            "$arrayElemAt":
              [
                "$detail.saleView", 0
              ]
          },
          saleLike:
          {
            "$arrayElemAt":
              [
                "$detail.saleLike", 0
              ]
          },
          type:
          {
            "$arrayElemAt":
              [
                "$detail.type", 0
              ]
          },
          kepemilikan:
          {
            "$arrayElemAt":
              [
                "$detail.kepemilikan", 0
              ]
          },
          statusJual:
          {
            "$arrayElemAt":
              [
                "$detail.statusJual", 0
              ]
          },
          mediaBasePath:
          {
            "$arrayElemAt":
              [
                "$detail.mediaBasePath", 0
              ]
          },
          mediaUri:
          {
            "$arrayElemAt":
              [
                "$detail.mediaUri", 0
              ]
          },
          mediaType:
          {
            "$arrayElemAt":
              [
                "$detail.mediaType", 0
              ]
          },
          mediaThumbEndpoint:
          {
            "$arrayElemAt":
              [
                "$detail.mediaThumbEndpoint", 0
              ]
          },
          mediaEndpoint:
          {
            "$arrayElemAt":
              [
                "$detail.mediaEndpoint", 0
              ]
          },
          apsaraId:
          {
            "$arrayElemAt":
              [
                "$detail.apsaraId", 0
              ]
          },
          apsara:
          {
            "$arrayElemAt":
              [
                "$detail.apsara", 0
              ]
          },
          originalName:
          {
            "$arrayElemAt":
              [
                "$detail.originalName", 0
              ]
          },
          comment:
          {
            "$arrayElemAt":
              [
                "$detail.comment", 0
              ]
          },
          riwayat:
          {
            "$arrayElemAt":
              [
                "$detail.riwayat", 0
              ]
          },
          age: "$age",
          wilayah: "$wilayah",
          gender: "$gender"
        }
      }
    ]);

    return query;
  }

  async findcontentbysearch(key: string, email: string, skip: number, limit: number, pict: any, vid: any, diary: any, user: any) {
    var pipeline = [];
    pipeline.push(
      {
        "$project":
        {
          "dedy": key
        }
      },
      {
        "$limit": 1
      }
    );

    var facet = {};
    if (user == true) {
      facet['user'] = [
        {
          "$lookup":
          {
            from: "newUserBasics",
            let:
            {
              name: "$dedy"
            },
            as: "userdata",
            pipeline:
              [
                {
                  "$match":
                  {
                    "$expr":
                    {
                      "$regexMatch":
                      {
                        input: "$username",
                        regex: "$$name",
                        options: "i"
                      }
                    }
                  }
                }
              ]
          }
        },
        {
          "$unwind":
          {
            path: "$userdata",
            // preserveNullAndEmptyArrays: true
          }
        },
        {
          "$project":
          {
            fullName: "$userdata.fullName",
            profilePict: "$userdata.profilePict",
            username: "$userdata.username",
            email: "$userdata.email",
            avatar:
            {
              mediaBasePath:
              {
                "$ifNull":
                  [
                    "$userdata.mediaBasePath",
                    null
                  ]
              },
              mediaUri:
              {
                "$ifNull":
                  [
                    "$userdata.mediaUri",
                    null
                  ]
              },
              mediaType:
              {
                "$ifNull":
                  [
                    "$userdata.mediaType",
                    null
                  ]
              },
              mediaEndpoint:
              {
                "$ifNull":
                  [
                    "$userdata.mediaEndpoint",
                    null
                  ]
              },
            },
            urluserBadge:
            {
              "$ifNull":
                [
                  {
                    "$filter":
                    {
                      input:
                      {
                        "$arrayElemAt":
                          [
                            "$userdata.userBadge", 0
                          ]
                      },
                      as: "listbadge",
                      cond:
                      {
                        "$and":
                          [
                            {
                              "$eq":
                                [
                                  "$$listbadge.isActive", true
                                ]
                            },
                            {
                              "$lte": [
                                {
                                  "$dateToString": {
                                    "format": "%Y-%m-%d %H:%M:%S",
                                    "date": {
                                      "$add": [
                                        new Date(),
                                        25200000
                                      ]
                                    }
                                  }
                                },
                                "$$listbadge.endDatetime"
                              ]
                            }
                          ]
                      }
                    }
                  },
                  []
                ]
            },
          }
        },
        {
          "$project":
          {
            fullName: 1,
            profilePict: 1,
            username: 1,
            email: 1,
            avatar: 1,
            urluserBadge:
            {
              "$ifNull":
                [
                  {
                    "$arrayElemAt":
                      [
                        "$urluserBadge", 0
                      ]
                  },
                  "$$REMOVE"
                ]
            }
          }
        },
        {
          "$skip": (skip * limit)
        },
        {
          "$limit": limit
        },
      ];
    }

    if (pict == true) {
      facet['pict'] = [
        {
          "$lookup":
          {
            from: "newPosts",
            let:
            {
              name: "$dedy"
            },
            as: "postdata",
            pipeline:
              [
                {
                  "$match":
                  {
                    "$and":
                      [
                        {
                          "$expr":
                          {
                            "$regexMatch":
                            {
                              input: "$description",
                              regex: "$$name",
                              options: "i"
                            }
                          }
                        },
                        {
                          "reportedStatus":
                          {
                            "$ne": "OWNED"
                          }
                        },
                        {
                          "visibility": "PUBLIC"
                        },
                        {
                          "active": true
                        },
                        {
                          "postType": "pict"
                        },
                        {
                          "reportedUser.email":
                          {
                            "$not":
                            {
                              "$regex": email
                            }
                          }
                        }
                      ]
                  }
                },
                {
                  "$project":
                  {
                    "boosted":
                    {
                      $cond: {
                        if: {
                          $gt: [{
                            "$dateToString": {
                              "format": "%Y-%m-%d %H:%M:%S",
                              "date": {
                                $add: [new Date(), 25200000]
                              }
                            }
                          }, "$boosted.boostSession.timeEnd"]
                        },
                        then: [],
                        else: '$boosted'
                      }
                    },
                    "reportedStatus": 1,
                    "insight": {
                      "shares": "$shares",
                      "comments": "$comments",
                      "views": "$views",
                      "likes": "$likes",

                    },
                    "_id": 1,
                    "postID": 1,
                    "createdAt": 1,
                    "updatedAt": 1,
                    "email": 1,
                    "postType": 1,
                    "description": 1,
                    "active": 1,
                    "metadata": 1,
                    "location": 1,
                    "isOwned": 1,
                    "visibility": 1,
                    "isViewed": 1,
                    "allowComments": 1,
                    "saleAmount": 1,
                    "certified": 1,
                    "mediaSource":
                    {
                      "$arrayElemAt":
                        [
                          "$mediaSource", 0
                        ]
                    },
                    "isLiked":
                    {
                      "$ifNull":
                        [
                          {
                            "$filter":
                            {
                              input: "$userLike",
                              as: "datalike",
                              cond:
                              {
                                "$eq":
                                  [
                                    "$$datalike",
                                    email
                                  ]
                              }
                            }
                          },
                          []
                        ]
                    },
                  }
                },
                {
                  "$lookup":
                  {
                    from: "newUserBasics",
                    localField: "email",
                    foreignField: "email",
                    as: "authdata"
                  }
                },
                {
                  "$addFields":
                  {
                    "cleanUri":
                    {
                      $replaceOne:
                      {
                        input: "$mediaSource.mediaUri",
                        find: "_0001.jpeg",
                        replacement: ""
                      }
                    }
                  }
                },
                {
                  "$project":
                  {
                    "boosted": 1,
                    "reportedStatus": 1,
                    "insight": 1,
                    "_id": 1,
                    "postID": 1,
                    "createdAt": 1,
                    "updatedAt": 1,
                    "email": 1,
                    "postType": 1,
                    "description": 1,
                    "active": 1,
                    "metadata": 1,
                    "location": 1,
                    "isOwned": 1,
                    "visibility": 1,
                    "isViewed": 1,
                    "allowComments": 1,
                    "saleAmount": 1,
                    "isLiked":
                    {
                      "$cond":
                      {
                        if:
                        {
                          "eq":
                            [
                              {
                                "$size": "$isLiked"
                              },
                              0
                            ]
                        },
                        then: false,
                        else: true
                      }
                    },
                    "certified": 1,
                    "username":
                    {
                      "$arrayElemAt":
                        [
                          "$authdata.username", 0
                        ]
                    },
                    "profilepictid":
                    {
                      "$arrayElemAt":
                        [
                          "$authdata.profilePict", 0
                        ]
                    },
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$filter":
                            {
                              input:
                              {
                                "$arrayElemAt":
                                  [
                                    "$authdata.userBadge", 0
                                  ]
                              },
                              as: "listbadge",
                              cond:
                              {
                                "$and":
                                  [
                                    {
                                      "$eq":
                                        [
                                          "$$listbadge.isActive", true
                                        ]
                                    },
                                    {
                                      "$lte": [
                                        {
                                          "$dateToString": {
                                            "format": "%Y-%m-%d %H:%M:%S",
                                            "date": {
                                              "$add": [
                                                new Date(),
                                                25200000
                                              ]
                                            }
                                          }
                                        },
                                        "$$listbadge.endDatetime"
                                      ]
                                    }
                                  ]
                              }
                            }
                          },
                          []
                        ]
                    },
                    "avatar":
                    {
                      "mediaEndpoint":
                      {
                        "$ifNull":
                          [
                            {
                              "$arrayElemAt":
                                [
                                  "$authdata.mediaEndpoint", 0
                                ]
                            },
                            null
                          ]
                      }
                    },
                    mediaBasePath:
                    {
                      "$ifNull":
                        [
                          "$mediaSource.mediaBasePath",
                          null
                        ]
                    },
                    mediaUri:
                    {
                      "$ifNull":
                        [
                          "$mediaSource.mediaUri",
                          null
                        ]
                    },
                    mediaType:
                    {
                      "$ifNull":
                        [
                          "$mediaSource.mediaType",
                          null
                        ]
                    },
                    mediaThumbEndpoint:
                    {
                      "$ifNull":
                        [
                          "$mediaSource.mediaThumbEndpoint",
                          {
                            "$concat":
                              [
                                "/thumb/",
                                "$cleanUri"
                              ]
                          }
                        ]
                    },
                    mediaEndpoint:
                    {
                      "$ifNull":
                        [
                          "$mediaSource.mediaEndpoint",
                          {
                            "$cond":
                            {
                              if:
                              {
                                "$eq":
                                  [
                                    "$postType", "pict"
                                  ]
                              },
                              then:
                              {
                                "$concat":
                                  [
                                    "/pict/",
                                    "$cleanUri"
                                  ]
                              },
                              else:
                              {
                                "$concat":
                                  [
                                    "/stream/",
                                    "$cleanUri"
                                  ]
                              }
                            }
                          }
                        ]
                    },
                    isApsara:
                    {
                      "$ifNull":
                        [
                          "$mediaSource.apsara",
                          false
                        ]
                    },
                    apsaraId:
                    {
                      "$ifNull":
                        [
                          "$mediaSource.apsaraId",
                          null
                        ]
                    }
                  }
                },
                {
                  "$skip": (skip * limit)
                },
                {
                  "$limit": limit
                }
              ]
          }
        },
        {
          "$unwind":
          {
            path: "$postdata",
            // preserveNullAndEmptyArrays: true
          }
        },
        {
          "$project":
          {
            boosted: "$postdata.boosted",
            reportedStatus: "$postdata.reportedStatus",
            insight: "$postdata.insight",
            _id: "$postdata._id",
            postID: "$postdata.postID",
            createdAt: "$postdata.createdAt",
            updatedAt: "$postdata.updatedAt",
            email: "$postdata.email",
            postType: "$postdata.postType",
            description: "$postdata.description",
            active: "$postdata.active",
            metadata: "$postdata.metadata",
            location: "$postdata.location",
            isOwned: "$postdata.isOwned",
            visibility: "$postdata.visibility",
            isViewed: "$postdata.isViewed",
            allowComments: "$postdata.allowComments",
            saleAmount: "$postdata.saleAmount",
            isLiked: "$postdata.isLiked",
            certified: "$postdata.certified",
            username: "$postdata.username",
            profilepictid: "$postdata.profilepictid",
            urluserBadge:
            {
              "$ifNull":
                [
                  {
                    "$arrayElemAt":
                      [
                        "$postdata.urluserBadge", 0
                      ]
                  },
                  null
                ]
            },
            avatar: "$postdata.avatar",
            mediaThumbEndpoint: "$postdata.mediaThumbEndpoint",
            mediaEndpoint: "$postdata.mediaEndpoint",
            mediaType: "$postdata.mediaType",
            isApsara: "$postdata.isApsara",
            apsaraId: "$postdata.apsaraId",
          }
        }
      ];
    }

    if (vid == true) {
      facet['vid'] = [
        {
          "$lookup":
          {
            from: "newPosts",
            let:
            {
              name: "$dedy"
            },
            as: "postdata",
            pipeline:
              [
                {
                  "$match":
                  {
                    "$and":
                      [
                        {
                          "$expr":
                          {
                            "$regexMatch":
                            {
                              input: "$description",
                              regex: "$$name",
                              options: "i"
                            }
                          }
                        },
                        {
                          "reportedStatus":
                          {
                            "$ne": "OWNED"
                          }
                        },
                        {
                          "visibility": "PUBLIC"
                        },
                        {
                          "active": true
                        },
                        {
                          "postType": "vid"
                        },
                        {
                          "reportedUser.email":
                          {
                            "$not":
                            {
                              "$regex": email
                            }
                          }
                        }
                      ]
                  }
                },
                {
                  "$project":
                  {
                    "boosted":
                    {
                      $cond: {
                        if: {
                          $gt: [{
                            "$dateToString": {
                              "format": "%Y-%m-%d %H:%M:%S",
                              "date": {
                                $add: [new Date(), 25200000]
                              }
                            }
                          }, "$boosted.boostSession.timeEnd"]
                        },
                        then: [],
                        else: '$boosted'
                      }
                    },
                    "reportedStatus": 1,
                    "insight": {
                      "shares": "$shares",
                      "comments": "$comments",
                      "views": "$views",
                      "likes": "$likes",

                    },
                    "_id": 1,
                    "postID": 1,
                    "createdAt": 1,
                    "updatedAt": 1,
                    "email": 1,
                    "postType": 1,
                    "description": 1,
                    "active": 1,
                    "metadata": 1,
                    "location": 1,
                    "isOwned": 1,
                    "visibility": 1,
                    "isViewed": 1,
                    "allowComments": 1,
                    "saleAmount": 1,
                    "certified": 1,
                    "mediaSource":
                    {
                      "$arrayElemAt":
                        [
                          "$mediaSource", 0
                        ]
                    },
                    "isLiked":
                    {
                      "$ifNull":
                        [
                          {
                            "$filter":
                            {
                              input: "$userLike",
                              as: "datalike",
                              cond:
                              {
                                "$eq":
                                  [
                                    "$$datalike",
                                    email
                                  ]
                              }
                            }
                          },
                          []
                        ]
                    }
                  }
                },
                {
                  "$lookup":
                  {
                    from: "newUserBasics",
                    localField: "email",
                    foreignField: "email",
                    as: "authdata"
                  }
                },
                {
                  "$addFields":
                  {
                    "cleanUri":
                    {
                      $replaceOne:
                      {
                        input: "$mediaSource.mediaUri",
                        find: "_0001.jpeg",
                        replacement: ""
                      }
                    }
                  }
                },
                {
                  "$project":
                  {
                    "boosted": 1,
                    "reportedStatus": 1,
                    "insight": 1,
                    "_id": 1,
                    "postID": 1,
                    "createdAt": 1,
                    "updatedAt": 1,
                    "email": 1,
                    "postType": 1,
                    "description": 1,
                    "active": 1,
                    "metadata": 1,
                    "location": 1,
                    "isOwned": 1,
                    "visibility": 1,
                    "isViewed": 1,
                    "allowComments": 1,
                    "saleAmount": 1,
                    "isLiked":
                    {
                      "$cond":
                      {
                        if:
                        {
                          "eq":
                            [
                              {
                                "$size": "$isLiked"
                              },
                              0
                            ]
                        },
                        then: false,
                        else: true
                      }
                    },
                    "certified": 1,
                    "username":
                    {
                      "$arrayElemAt":
                        [
                          "$authdata.username", 0
                        ]
                    },
                    "profilepictid":
                    {
                      "$arrayElemAt":
                        [
                          "$authdata.profilePict", 0
                        ]
                    },
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$filter":
                            {
                              input:
                              {
                                "$arrayElemAt":
                                  [
                                    "$authdata.userBadge", 0
                                  ]
                              },
                              as: "listbadge",
                              cond:
                              {
                                "$and":
                                  [
                                    {
                                      "$eq":
                                        [
                                          "$$listbadge.isActive", true
                                        ]
                                    },
                                    {
                                      "$lte": [
                                        {
                                          "$dateToString": {
                                            "format": "%Y-%m-%d %H:%M:%S",
                                            "date": {
                                              "$add": [
                                                new Date(),
                                                25200000
                                              ]
                                            }
                                          }
                                        },
                                        "$$listbadge.endDatetime"
                                      ]
                                    }
                                  ]
                              }
                            }
                          },
                          []
                        ]
                    },
                    "avatar":
                    {
                      "mediaEndpoint":
                      {
                        "$ifNull":
                          [
                            {
                              "$arrayElemAt":
                                [
                                  "$authdata.mediaEndpoint", 0
                                ]
                            },
                            null
                          ]
                      }
                    },
                    mediaBasePath:
                    {
                      "$ifNull":
                        [
                          "$mediaSource.mediaBasePath",
                          null
                        ]
                    },
                    mediaUri:
                    {
                      "$ifNull":
                        [
                          "$mediaSource.mediaUri",
                          null
                        ]
                    },
                    mediaType:
                    {
                      "$ifNull":
                        [
                          "$mediaSource.mediaType",
                          null
                        ]
                    },
                    mediaThumbEndpoint:
                    {
                      "$ifNull":
                        [
                          "$mediaSource.mediaThumbEndpoint",
                          {
                            "$concat":
                              [
                                "/thumb/",
                                "$cleanUri"
                              ]
                          }
                        ]
                    },
                    mediaEndpoint:
                    {
                      "$ifNull":
                        [
                          "$mediaSource.mediaEndpoint",
                          {
                            "$cond":
                            {
                              if:
                              {
                                "$eq":
                                  [
                                    "$postType", "pict"
                                  ]
                              },
                              then:
                              {
                                "$concat":
                                  [
                                    "/pict/",
                                    "$cleanUri"
                                  ]
                              },
                              else:
                              {
                                "$concat":
                                  [
                                    "/stream/",
                                    "$cleanUri"
                                  ]
                              }
                            }
                          }
                        ]
                    },
                    isApsara:
                    {
                      "$ifNull":
                        [
                          "$mediaSource.apsara",
                          false
                        ]
                    },
                    apsaraId:
                    {
                      "$ifNull":
                        [
                          "$mediaSource.apsaraId",
                          null
                        ]
                    }
                  }
                },
                {
                  "$skip": (skip * limit)
                },
                {
                  "$limit": limit
                }
              ]
          }
        },
        {
          "$unwind":
          {
            path: "$postdata",
            // preserveNullAndEmptyArrays: true
          }
        },
        {
          "$project":
          {
            boosted: "$postdata.boosted",
            reportedStatus: "$postdata.reportedStatus",
            insight: "$postdata.insight",
            _id: "$postdata._id",
            postID: "$postdata.postID",
            createdAt: "$postdata.createdAt",
            updatedAt: "$postdata.updatedAt",
            email: "$postdata.email",
            postType: "$postdata.postType",
            description: "$postdata.description",
            active: "$postdata.active",
            metadata: "$postdata.metadata",
            location: "$postdata.location",
            isOwned: "$postdata.isOwned",
            visibility: "$postdata.visibility",
            isViewed: "$postdata.isViewed",
            allowComments: "$postdata.allowComments",
            saleAmount: "$postdata.saleAmount",
            isLiked: "$postdata.isLiked",
            certified: "$postdata.certified",
            username: "$postdata.username",
            profilepictid: "$postdata.profilepictid",
            urluserBadge:
            {
              "$ifNull":
                [
                  {
                    "$arrayElemAt":
                      [
                        "$postdata.urluserBadge", 0
                      ]
                  },
                  null
                ]
            },
            avatar: "$postdata.avatar",
            mediaThumbEndpoint: "$postdata.mediaThumbEndpoint",
            mediaEndpoint: "$postdata.mediaEndpoint",
            mediaType: "$postdata.mediaType",
            isApsara: "$postdata.isApsara",
            apsaraId: "$postdata.apsaraId",
          }
        }
      ]
    }

    if (diary == true) {
      facet['diary'] = [
        {
          "$lookup":
          {
            from: "newPosts",
            let:
            {
              name: "$dedy"
            },
            as: "postdata",
            pipeline:
              [
                {
                  "$match":
                  {
                    "$and":
                      [
                        {
                          "$expr":
                          {
                            "$regexMatch":
                            {
                              input: "$description",
                              regex: "$$name",
                              options: "i"
                            }
                          }
                        },
                        {
                          "reportedStatus":
                          {
                            "$ne": "OWNED"
                          }
                        },
                        {
                          "visibility": "PUBLIC"
                        },
                        {
                          "active": true
                        },
                        {
                          "postType": "diary"
                        },
                        {
                          "reportedUser.email":
                          {
                            "$not":
                            {
                              "$regex": email
                            }
                          }
                        }
                      ]
                  }
                },
                {
                  "$project":
                  {
                    "boosted":
                    {
                      $cond: {
                        if: {
                          $gt: [{
                            "$dateToString": {
                              "format": "%Y-%m-%d %H:%M:%S",
                              "date": {
                                $add: [new Date(), 25200000]
                              }
                            }
                          }, "$boosted.boostSession.timeEnd"]
                        },
                        then: [],
                        else: '$boosted'
                      }
                    },
                    "reportedStatus": 1,
                    "insight": {
                      "shares": "$shares",
                      "comments": "$comments",
                      "views": "$views",
                      "likes": "$likes",

                    },
                    "_id": 1,
                    "postID": 1,
                    "createdAt": 1,
                    "updatedAt": 1,
                    "email": 1,
                    "postType": 1,
                    "description": 1,
                    "active": 1,
                    "metadata": 1,
                    "location": 1,
                    "isOwned": 1,
                    "visibility": 1,
                    "isViewed": 1,
                    "allowComments": 1,
                    "saleAmount": 1,
                    "certified": 1,
                    "mediaSource":
                    {
                      "$arrayElemAt":
                        [
                          "$mediaSource", 0
                        ]
                    },
                    "isLiked":
                    {
                      "$ifNull":
                        [
                          {
                            "$filter":
                            {
                              input: "$userLike",
                              as: "datalike",
                              cond:
                              {
                                "$eq":
                                  [
                                    "$$datalike",
                                    email
                                  ]
                              }
                            }
                          },
                          []
                        ]
                    }
                  }
                },
                {
                  "$lookup":
                  {
                    from: "newUserBasics",
                    localField: "email",
                    foreignField: "email",
                    as: "authdata"
                  }
                },
                {
                  "$addFields":
                  {
                    "cleanUri":
                    {
                      $replaceOne:
                      {
                        input: "$mediaSource.mediaUri",
                        find: "_0001.jpeg",
                        replacement: ""
                      }
                    }
                  }
                },
                {
                  "$project":
                  {
                    "boosted": 1,
                    "reportedStatus": 1,
                    "insight": 1,
                    "_id": 1,
                    "postID": 1,
                    "createdAt": 1,
                    "updatedAt": 1,
                    "email": 1,
                    "postType": 1,
                    "description": 1,
                    "active": 1,
                    "metadata": 1,
                    "location": 1,
                    "isOwned": 1,
                    "visibility": 1,
                    "isViewed": 1,
                    "allowComments": 1,
                    "saleAmount": 1,
                    "isLiked":
                    {
                      "$cond":
                      {
                        if:
                        {
                          "eq":
                            [
                              {
                                "$size": "$isLiked"
                              },
                              0
                            ]
                        },
                        then: false,
                        else: true
                      }
                    },
                    "certified": 1,
                    "username":
                    {
                      "$arrayElemAt":
                        [
                          "$authdata.username", 0
                        ]
                    },
                    "profilepictid":
                    {
                      "$arrayElemAt":
                        [
                          "$authdata.profilePict", 0
                        ]
                    },
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$filter":
                            {
                              input:
                              {
                                "$arrayElemAt":
                                  [
                                    "$authdata.userBadge", 0
                                  ]
                              },
                              as: "listbadge",
                              cond:
                              {
                                "$and":
                                  [
                                    {
                                      "$eq":
                                        [
                                          "$$listbadge.isActive", true
                                        ]
                                    },
                                    {
                                      "$lte": [
                                        {
                                          "$dateToString": {
                                            "format": "%Y-%m-%d %H:%M:%S",
                                            "date": {
                                              "$add": [
                                                new Date(),
                                                25200000
                                              ]
                                            }
                                          }
                                        },
                                        "$$listbadge.endDatetime"
                                      ]
                                    }
                                  ]
                              }
                            }
                          },
                          []
                        ]
                    },
                    "avatar":
                    {
                      "mediaEndpoint":
                      {
                        "$ifNull":
                          [
                            {
                              "$arrayElemAt":
                                [
                                  "$authdata.mediaEndpoint", 0
                                ]
                            },
                            null
                          ]
                      }
                    },
                    mediaBasePath:
                    {
                      "$ifNull":
                        [
                          "$mediaSource.mediaBasePath",
                          null
                        ]
                    },
                    mediaUri:
                    {
                      "$ifNull":
                        [
                          "$mediaSource.mediaUri",
                          null
                        ]
                    },
                    mediaType:
                    {
                      "$ifNull":
                        [
                          "$mediaSource.mediaType",
                          null
                        ]
                    },
                    mediaThumbEndpoint:
                    {
                      "$ifNull":
                        [
                          "$mediaSource.mediaThumbEndpoint",
                          {
                            "$concat":
                              [
                                "/thumb/",
                                "$cleanUri"
                              ]
                          }
                        ]
                    },
                    mediaEndpoint:
                    {
                      "$ifNull":
                        [
                          "$mediaSource.mediaEndpoint",
                          {
                            "$cond":
                            {
                              if:
                              {
                                "$eq":
                                  [
                                    "$postType", "pict"
                                  ]
                              },
                              then:
                              {
                                "$concat":
                                  [
                                    "/pict/",
                                    "$cleanUri"
                                  ]
                              },
                              else:
                              {
                                "$concat":
                                  [
                                    "/stream/",
                                    "$cleanUri"
                                  ]
                              }
                            }
                          }
                        ]
                    },
                    isApsara:
                    {
                      "$ifNull":
                        [
                          "$mediaSource.apsara",
                          false
                        ]
                    },
                    apsaraId:
                    {
                      "$ifNull":
                        [
                          "$mediaSource.apsaraId",
                          null
                        ]
                    }
                  }
                },
                {
                  "$skip": (skip * limit)
                },
                {
                  "$limit": limit
                }
              ]
          }
        },
        {
          "$unwind":
          {
            path: "$postdata",
            // preserveNullAndEmptyArrays: true
          }
        },
        {
          "$project":
          {
            boosted: "$postdata.boosted",
            reportedStatus: "$postdata.reportedStatus",
            insight: "$postdata.insight",
            _id: "$postdata._id",
            postID: "$postdata.postID",
            createdAt: "$postdata.createdAt",
            updatedAt: "$postdata.updatedAt",
            email: "$postdata.email",
            postType: "$postdata.postType",
            description: "$postdata.description",
            active: "$postdata.active",
            metadata: "$postdata.metadata",
            location: "$postdata.location",
            isOwned: "$postdata.isOwned",
            visibility: "$postdata.visibility",
            isViewed: "$postdata.isViewed",
            allowComments: "$postdata.allowComments",
            saleAmount: "$postdata.saleAmount",
            isLiked: "$postdata.isLiked",
            certified: "$postdata.certified",
            username: "$postdata.username",
            profilepictid: "$postdata.profilepictid",
            urluserBadge:
            {
              "$ifNull":
                [
                  {
                    "$arrayElemAt":
                      [
                        "$postdata.urluserBadge", 0
                      ]
                  },
                  null
                ]
            },
            avatar: "$postdata.avatar",
            mediaThumbEndpoint: "$postdata.mediaThumbEndpoint",
            mediaEndpoint: "$postdata.mediaEndpoint",
            mediaType: "$postdata.mediaType",
            isApsara: "$postdata.isApsara",
            apsaraId: "$postdata.apsaraId",
          }
        }
      ]
    }

    pipeline.push(
      {
        "$facet": facet
      }
    );

    var setutil = require('util');
    console.log(setutil.inspect(pipeline, { showHidden: false, depth: null }));

    var query = await this.loaddata.aggregate(pipeline);

    return query;
  }

  async findalldatakontenmultiple(userid: string, email: string, ownership: any, monetesisasi: boolean, buy: boolean, archived: boolean, reported: boolean, postType: string, startdate: string, enddate: string, skip: number, limit: number) {
    try {
      var currentdate = new Date(new Date(enddate).setDate(new Date(enddate).getDate() + 1));

      var dateend = currentdate.toISOString();
    } catch (e) {
      dateend = "";
    }

    var mongo = require('mongoose');
    var konvertid = mongo.Types.ObjectId(userid);

    var pipeline = [];
    if (buy && buy != undefined) {
      pipeline.push(
        {
          "$project":
          {
            "idUser": konvertid
          }
        },
        {
          "$limit": 1
        },
        {
          "$lookup":
          {
            from: "transactions",
            as: "trans_data",
            let:
            {
              trans_fk: "$idUser"
            },
            pipeline:
              [
                {
                  "$match":
                  {
                    "$and":
                      [
                        {
                          "$expr":
                          {
                            "$eq":
                              [
                                "$iduserbuyer", "$$trans_fk"
                              ]
                          }
                        },
                        {
                          "status": "Success"
                        }
                      ]
                  }
                }
              ]
          }
        },
        {
          "$unwind":
          {
            path: "$trans_data",
            preserveNullAndEmptyArrays: true
          }
        },
        {
          "$lookup":
          {
            "from": "newPosts",
            "localField": "trans_data.postid",
            "foreignField": "postID",
            "as": "post_data"
          }
        },
        {
          "$unwind":
          {
            path: "$post_data",
            // preserveNullAndEmptyArrays:true
          }
        },
        {
          "$lookup":
          {
            from: 'newUserBasics',
            localField: 'post_data.email',
            foreignField: 'email',
            as: 'basicdata',
          }
        },
        {
          "$addFields":
          {
            "auth":
            {
              "$arrayElemAt":
                [
                  "$basicdata", 0
                ]
            },
            "insight":
            {
              "$arrayElemAt":
                [
                  "$basicdata.insight.$id", 0
                ]
            },
            "cleanUri":
            {
              "$replaceOne":
              {
                input:
                {
                  "$arrayElemAt":
                    [
                      "$post_data.mediaSource.mediaUri", 0
                    ]
                },
                find: "_0001.jpeg",
                replacement: ""
              }
            },
            "tempmediaSource":
            {
              "$arrayElemAt":
                [
                  "$post_data.mediaSource", 0
                ]
            },
            "monetize": true,
            "trans_data": "$trans_data",
            "tempreportedUserCount":
            {
              "$ifNull":
                [
                  {
                    "$filter":
                    {
                      input: "$reportedUser",
                      as: "listuser",
                      cond:
                      {
                        "$eq":
                          [
                            "$$listuser.active",
                            true
                          ]
                      }
                    }
                  },
                  []
                ]
            }
          }
        },
        {
          "$lookup":
          {
            from: 'insights',
            localField: 'insight',
            foreignField: '_id',
            as: 'insight_data',
          }
        },
        {
          "$project":
          {
            trans: "$trans_data",
            _id: "$post_data._id",
            insight:
            {
              "shares":
              {
                "$arrayElemAt":
                  [
                    "$insight_data.shares", 0
                  ]
              },
              "followers":
              {
                "$arrayElemAt":
                  [
                    "$insight_data.followers", 0
                  ]
              },
              "comments":
              {
                "$arrayElemAt":
                  [
                    "$insight_data.comments", 0
                  ]
              },
              "followings":
              {
                "$arrayElemAt":
                  [
                    "$insight_data.followings", 0
                  ]
              },
              "reactions":
              {
                "$arrayElemAt":
                  [
                    "$insight_data.reactions", 0
                  ]
              },
              "posts":
              {
                "$arrayElemAt":
                  [
                    "$insight_data.posts", 0
                  ]
              },
              "views":
              {
                "$arrayElemAt":
                  [
                    "$insight_data.views", 0
                  ]
              },
              "likes":
              {
                "$arrayElemAt":
                  [
                    "$insight_data.likes", 0
                  ]
              },
            },
            "avatar":
            {
              mediaBasePath: "$auth.mediaBasePath",
              mediaUri: "$auth.mediaUri",
              mediaType: "$auth.mediaType",
              mediaEndpoint: "$auth.mediaEndpoint",
            },
            "fullName": "$auth.fullName",
            "username": "$auth.username",
            "createdAt": "$post_data.createdAt",
            "updatedAt": "$post_data.updatedAt",
            "postID": "$post_data.postID",
            "email": "$auth.email",
            "postType": "$post_data.postType",
            "description": "$post_data.description",
            "title": "$post_data.title",
            "active": "$post_data.action",
            "metadata": "$post_data.metadata",
            "location": "$post_data.location",
            "tags": "$post_data.tags",
            "likes": "$post_data.likes",
            "views": "$post_data.views",
            "shares": "$post_data.shares",
            "comments": "$post_data.comments",
            "isOwned": "$post_data.isOwned",
            "certified": "$post_data.certified",
            "privacy": {
              "isPostPrivate": "$auth.isPostPrivate",
              "isCelebrity": "$auth.isCelebrity",
              "isPrivate": "$auth.isPrivate"
            },
            "isViewed":
            {
              "$cond":
              {
                "if":
                {
                  "$eq":
                    [
                      "$post_data.views",
                      0
                    ]
                },
                "then": false,
                "else": true
              }
            },
            "allowComments": "$post_data.allowComments",
            "isSafe": "$post_data.isSafe",
            "saleLike": "$post_data.saleLike",
            "saleView": "$post_data.saleView",
            "monetize": "$monetize",
            "salePrice": "$post_data.salePrice",
            "rotate":
            {
              "$ifNull":
                [
                  "$tempmediaSource.rotate",
                  null
                ]
            },
            "mediaBasePath":
            {
              "$ifNull":
                [
                  "$tempmediaSource.mediaBasePath",
                  null
                ]
            },
            mediaUri:
            {
              "$ifNull":
                [
                  "$tempmediaSource.mediaUri",
                  null
                ]
            },
            mediaType:
            {
              "$ifNull":
                [
                  "$tempmediaSource.mediaType",
                  null
                ]
            },
            mediaThumbEndpoint:
            {
              "$ifNull":
                [
                  "$tempmediaSource.mediaThumbEndpoint",
                  {
                    "$concat":
                      [
                        "/thumb/",
                        "$cleanUri"
                      ]
                  }
                ]
            },
            mediaEndpoint:
            {
              "$ifNull":
                [
                  "$tempmediaSource.mediaEndpoint",
                  {
                    "$cond":
                    {
                      if:
                      {
                        "$eq":
                          [
                            "$postType", "pict"
                          ]
                      },
                      then:
                      {
                        "$concat":
                          [
                            "/pict/",
                            "$cleanUri"
                          ]
                      },
                      else:
                      {
                        "$concat":
                          [
                            "/stream/",
                            "$cleanUri"
                          ]
                      }
                    }
                  }
                ]
            },
            mediaThumbUri:
            {
              "$ifNull":
                [
                  "$tempmediaSource.mediaThumbUri",
                  null
                ]
            },
            apsaraId:
            {
              "$ifNull":
                [
                  "$tempmediaSource.apsaraId",
                  null
                ]
            },
            apsara:
            {
              "$ifNull":
                [
                  "$tempmediaSource.apsara",
                  false
                ]
            },
            reportedUserCount:
            {
              "$ifNull":
                [
                  "$reportedUserCount",
                  {
                    "$size": "$tempreportedUserCount"
                  }
                ]
            },
          }
        }
      );
    }
    else {
      pipeline.push(
        {
          $lookup: {
            from: 'newUserBasics',
            localField: 'email',
            foreignField: 'email',
            as: 'basicdata',
          }
        },
        {
          $addFields: {
            'basic': { $arrayElemAt: ['$basicdata', 0] },
            'insightid': { $arrayElemAt: ['$basicdata.insight.$id', 0] },
            'isViewed': {
              '$cond': { if: { '$eq': ['$views', 0] }, then: false, else: true }
            },
            salePrice: "$saleAmount",
            monetize: {
              $cond: { if: { $eq: ["$saleAmount", 0] }, then: false, else: true }
            },
            "tempmediaSource": { $arrayElemAt: ['$mediaSource', 0] }
          }
        },
        {
          $lookup: {
            from: 'insights',
            localField: 'insightid',
            foreignField: '_id',
            as: 'insightdata',
          }
        },
        {
          $addFields: {
            'avatar':
            {
              mediaBasePath: "$basic.mediaBasePath",
              mediaUri: "$basic.mediaUri",
              mediaType: "$basic.mediaType",
              mediaEndpoint: "$basic.mediaEndpoint"
            },
            'insight': { $arrayElemAt: ['$insightdata', 0] },
            "cleanUri":
            {
              "$replaceOne":
              {
                input: "$tempmediaSource.mediaUri",
                find: "_0001.jpeg",
                replacement: ""
              }
            },
            "tempreportedUserCount":
            {
              "$ifNull":
                [
                  {
                    "$filter":
                    {
                      input: "$reportedUser",
                      as: "listuser",
                      cond:
                      {
                        "$eq":
                          [
                            "$$listuser.active",
                            true
                          ]
                      }
                    }
                  },
                  []
                ]
            }
          }
        },
        {
          $project: {
            _id: 1,
            insight: {
              shares: '$insight.shares',
              followers: '$insight.followers',
              comments: '$insight.comments',
              followings: '$insight.followings',
              reactions: '$insight.reactions',
              posts: '$insight.posts',
              views: '$insight.views',
              likes: '$insight.likes'
            },
            avatar: "$avatar",
            fullName: "$basic.fullName",
            username: "$basic.username",
            createdAt: 1,
            updatedAt: 1,
            postID: 1,
            email: 1,
            postType: 1,
            description: 1,
            title: 1,
            active: 1,
            metadata: 1,
            location: 1,
            tags: 1,
            likes: 1,
            views: 1,
            shares: 1,
            comments: 1,
            isOwned: 1,
            certified: 1,
            privacy: {
              isPostPrivate: '$basic.isPostPrivate',
              isCelebrity: '$basic.isCelebrity',
              isPrivate: '$basic.isPrivate'
            },
            isViewed: '$isViewed',
            allowComments: 1,
            isSafe: 1,
            saleLike: 1,
            idUser: 1,
            saleView: 1,
            reportedUserCount:
            {
              "$ifNull":
                [
                  "$reportedUserCount",
                  {
                    "$size": "$tempreportedUserCount"
                  }
                ]
            },
            monetize: "$monetize",
            salePrice: "$salePrice",
            // mediaref: "$mediaref",
            "rotate":
            {
              "$ifNull":
                [
                  "$tempmediaSource.rotate",
                  null
                ]
            },
            "mediaBasePath":
            {
              "$ifNull":
                [
                  "$tempmediaSource.mediaBasePath",
                  null
                ]
            },
            mediaUri:
            {
              "$ifNull":
                [
                  "$tempmediaSource.mediaUri",
                  null
                ]
            },
            mediaType:
            {
              "$ifNull":
                [
                  "$tempmediaSource.mediaType",
                  null
                ]
            },
            mediaThumbEndpoint:
            {
              "$ifNull":
                [
                  "$tempmediaSource.mediaThumbEndpoint",
                  {
                    "$concat":
                      [
                        "/thumb/",
                        "$cleanUri"
                      ]
                  }
                ]
            },
            mediaEndpoint:
            {
              "$ifNull":
                [
                  "$tempmediaSource.mediaEndpoint",
                  {
                    "$cond":
                    {
                      if:
                      {
                        "$eq":
                          [
                            "$postType", "pict"
                          ]
                      },
                      then:
                      {
                        "$concat":
                          [
                            "/pict/",
                            "$cleanUri"
                          ]
                      },
                      else:
                      {
                        "$concat":
                          [
                            "/stream/",
                            "$cleanUri"
                          ]
                      }
                    }
                  }
                ]
            },
            mediaThumbUri:
            {
              "$ifNull":
                [
                  "$tempmediaSource.mediaThumbUri",
                  null
                ]
            },
            apsaraId:
            {
              "$ifNull":
                [
                  "$tempmediaSource.apsaraId",
                  null
                ]
            },
            apsara:
            {
              "$ifNull":
                [
                  "$tempmediaSource.apsara",
                  false
                ]
            },
          }
        },
        {
          "$match":
          {
            "$and":
              [
                {
                  idUser: konvertid
                },
                {
                  active: true
                },
              ]
          }
        }
      );

      if (ownership !== undefined && ownership === true) {
        pipeline.push({ $match: { certified: true } });
      }
      if (archived && archived !== undefined) {
        pipeline.push({ $match: { postType: "story" } });
      }
    }

    if (postType && postType !== undefined) {
      pipeline.push({ $match: { postType: postType } });
    }
    if (monetesisasi !== undefined) {
      pipeline.push({ $match: { monetize: monetesisasi } });
    }
    if (startdate && startdate !== undefined) {
      pipeline.push({ $match: { createdAt: { "$gte": startdate } } });
    }
    if (enddate && enddate !== undefined) {
      pipeline.push({ $match: { createdAt: { "$lte": dateend } } });
    }
    if (reported !== undefined) {
      if (reported)
        pipeline.push({ $match: { "reportedUserCount": { $gt: 0 } } })
      else
        pipeline.push({ $match: { "reportedUserCount": 0 } })
    }

    if (buy !== undefined) {
      pipeline.push({ $sort: { "trans.createdAt": -1 } });
    }
    else {
      pipeline.push({ $sort: { createdAt: -1 } });
    }

    pipeline.push({ $skip: skip });
    pipeline.push({ $limit: limit });

    var query = await this.loaddata.aggregate(pipeline);
    // var setutil = require('util');
    // console.log(setutil.inspect(pipeline, { showHidden: false, depth: null }));
    var listdata = [];
    var tempresult = null;
    var tempdata = null;
    for (var i = 0; i < query.length; i++) {
      tempdata = query[i];
      if (tempdata.apsara == true) {
        listdata.push(tempdata.apsaraId);
      }
      else {
        listdata.push(undefined);
      }
    }

    //console.log(listdata);
    var apsaraimagedata = await this.postContentService.getImageApsara(listdata);
    // console.log(apsaraimagedata);
    // console.log(resultdata.ImageInfo[0]);
    tempresult = apsaraimagedata.ImageInfo;
    for (var i = 0; i < query.length; i++) {
      for (var j = 0; j < tempresult.length; j++) {
        if (tempresult[j].ImageId == query[i].apsaraId) {
          query[i].media =
          {
            "ImageInfo": [tempresult[j]]
          }
        }
      }
      if (query[i].apsara == false && (query[i].mediaType == "image" || query[i].mediaType == "images")) {
        query[i].media =
        {
          "ImageInfo": []
        }
      }
    }

    var apsaravideodata = await this.postContentService.getVideoApsara(listdata);
    // console.log(apsaravideodata);
    // console.log(resultdata.ImageInfo[0]);
    tempresult = apsaravideodata.VideoList;
    for (var i = 0; i < query.length; i++) {
      for (var j = 0; j < tempresult.length; j++) {
        if (tempresult[j].VideoId == query[i].apsaraId) {
          query[i].media =
          {
            "VideoList": [tempresult[j]]
          }
        }
      }
      if (query[i].apsara == false && query[i].mediaType == "video") {
        query[i].media =
        {
          "VideoList": []
        }
      }
    }

    return query;
  }

  async findcountfilter(email: string) {
    const data = await this.loaddata.aggregate([
      {
        "$match":
        {
          "email": email
        }
      },
      {
        "$group":
        {
          _id: "$email",
          totalpost: {
            "$sum": 1
          }
        }
      }
    ]);

    return data;
  }

  async boostdetail2(postID: string, startdate: string, enddate: string, page: number, limit: number) {
    try {
      var currentdate = new Date(new Date(enddate).setDate(new Date(enddate).getDate() + 1));

      var dateend = currentdate.toISOString();

      var dt = dateend.substring(0, 10);
    } catch (e) {
      dt = "";
    }
    var query = await this.loaddata.aggregate(
      [
        {

          $match: {
            $and: [{
              boosted: {
                $ne: []
              }
            }, {
              boosted: {
                $ne: null
              }
            }],
            active: true,
            postID: postID
          }
        },
        {
          $set: {
            datenow:
            {
              "$dateToString": {
                "format": "%Y-%m-%d %H:%M:%S",
                "date": {
                  $add: [new Date(), + 25200000]
                }
              }
            },
            salePrice: {
              $cmp: ["$saleAmount", 0]
            },
            sComments: {
              $cmp: ["$comments", 0]
            },

          }
        },
        {
          $facet: {
            "data": [
              {
                "$lookup": {
                  "from": "interests_repo",
                  "as": "kategori",
                  "let": {
                    "local_id": "$category.$id",

                  },
                  "pipeline": [
                    {
                      $match:
                      {
                        $and: [
                          {
                            $expr: {

                              $in: ['$_id', {
                                $ifNull: ['$$local_id', []]
                              }]
                            }
                          },

                        ]
                      }
                    },
                    {
                      $project: {
                        interestName: 1,

                      }
                    },

                  ],

                },

              },
              {
                $project: {
                  refs: {
                    $arrayElemAt: ['$contentMedias', 0]
                  },
                  createdAt: 1,
                  updatedAt: 1,
                  postID: 1,
                  email: 1,
                  postType: 1,
                  description: 1,
                  title: 1,
                  likes: 1,
                  views: 1,
                  active: 1,
                  datenow: 1,
                  kategori: 1,
                  jangkauan: {
                    $size: {
                      $arrayElemAt: ['$boosted.boostViewer', 0]
                    },

                  },
                  typeboost: {
                    $arrayElemAt: ['$boosted.type', 0]
                  },
                  interval: {
                    $arrayElemAt: ['$boosted.boostInterval.value', 0]
                  },
                  start: {
                    $arrayElemAt: ['$boosted.boostSession.start', 0]
                  },
                  end: {
                    $arrayElemAt: ['$boosted.boostSession.end', 0]
                  },
                  boostSessionid: {
                    $arrayElemAt: ['$boosted.boostSession.id', 0]
                  },
                  saleAmount: {
                    $cond: {
                      if: {
                        $or: [{
                          $eq: ["$salePrice", - 1]
                        }, {
                          $eq: ["$salePrice", 0]
                        }]
                      },
                      then: 0,
                      else: "$saleAmount"
                    }
                  },
                  monetize: {
                    $cond: {
                      if: {
                        $or: [{
                          $eq: ["$salePrice", - 1]
                        }, {
                          $eq: ["$salePrice", 0]
                        }]
                      },
                      then: false,
                      else: true
                    }
                  },
                  comments: {
                    $cond: {
                      if: {
                        $or: [{
                          $eq: ["$sComments", - 1]
                        }, {
                          $eq: ["$sComments", 0]
                        }]
                      },
                      then: 0,
                      else: "$sComments"
                    }
                  },
                  mediaSource: {
                    "$arrayElemAt":
                      [
                        "$mediaSource", 0
                      ]
                  }
                }
              },
              {
                $lookup: {
                  from: 'newUserBasics',
                  localField: 'email',
                  foreignField: 'email',
                  as: 'databasic',

                },

              },
              {
                $unwind: {
                  path: "$databasic",

                }
              },
              {
                $lookup: {
                  from: 'boostSession',
                  localField: 'boostSessionid',
                  foreignField: '_id',
                  as: 'boostSesidata',

                },

              },
              {
                "$lookup": {
                  "from": "transactions",
                  "as": "trans",
                  "let": {
                    "local_id": "$postID",

                  },
                  "pipeline": [
                    {
                      $match:
                      {
                        $expr: {
                          $eq: ['$postid', '$$local_id']
                        }
                      }
                    },
                    {
                      $project: {
                        iduserbuyer: 1,
                        idusersell: 1,
                        noinvoice: 1,
                        status: 1,
                        amount: 1,
                        timestamp: 1,
                        postid: 1
                      }
                    },
                    {
                      $match: {
                        idusersell: '$databasic._id',
                        status: "Success"
                      }
                    },

                  ],

                },

              },
              {
                $project: {
                  refs: '$refs.$ref',
                  idmedia: '$refs.$id',
                  iduser: '$databasic._id',
                  createdAt: 1,
                  updatedAt: 1,
                  postID: 1,
                  postType: 1,
                  email: 1,
                  likes: 1,
                  views: 1,
                  comments: 1,
                  jangkauan: 1,
                  interval: 1,
                  start: 1,
                  end: 1,
                  typeboost: 1,
                  kategori: 1,
                  saleAmount: 1,
                  statusJual:
                  {
                    $cond: {
                      if: {

                        $eq: ["$monetize", false]
                      },
                      then: "TIDAK",
                      else: "YA"
                    }
                  },
                  sessionName: {
                    $arrayElemAt: ['$boostSesidata.name', 0]
                  },
                  sessionType: {
                    $arrayElemAt: ['$boostSesidata.type', 0]
                  },
                  sessionStart: {
                    $arrayElemAt: ['$boostSesidata.start', 0]
                  },
                  sessionEnd: {
                    $arrayElemAt: ['$boostSesidata.end', 0]
                  },
                  type: {
                    $switch: {
                      branches: [
                        {
                          'case': {
                            '$eq': ['$postType', 'pict']
                          },
                          'then': "HyppePic"
                        },
                        {
                          'case': {
                            '$eq': ['$postType', 'vid']
                          },
                          'then': "HyppeVid"
                        },
                        {
                          'case': {
                            '$eq': ['$postType', 'diary']
                          },
                          'then': "HyppeDiary"
                        },
                        {
                          'case': {
                            '$eq': ['$postType', 'story']
                          },
                          'then': "HyppeStory"
                        },

                      ],
                      default: ''
                    }
                  },
                  description: 1,
                  title: 1,
                  active: 1,
                  datenow: 1,
                  trans: 1,
                  boostSessionid: 1,
                  mediaSource: 1
                }
              },
              {
                $project: {
                  refs: 1,
                  idmedia: 1,
                  iduser: 1,
                  createdAt: 1,
                  updatedAt: 1,
                  postID: 1,
                  postType: 1,
                  email: 1,
                  type: 1,
                  description: 1,
                  title: 1,
                  active: 1,
                  jangkauan: 1,
                  interval: 1,
                  likes: 1,
                  views: 1,
                  comments: 1,
                  start: 1,
                  end: 1,
                  sessionName: 1,
                  sessionType: 1,
                  sessionStart: 1,
                  sessionEnd: 1,
                  datenow: 1,
                  typeboost: 1,
                  boostSessionid: 1,
                  kategori: 1,
                  saleAmount: 1,
                  dataview: 1,
                  statusJual: 1,
                  keterangan:
                  {
                    $cond: {
                      if: {

                        $eq: ["$trans", []]
                      },
                      then: 'Belum Terjual',
                      else: 'Terjual',

                    }
                  },
                  statusPengajuan: {
                    $switch: {
                      branches: [
                        {
                          'case': {
                            '$lt': ['$datenow', '$start'],

                          },
                          'then': 'Dijadwalkan'
                        },
                        {
                          'case': {
                            $and: [
                              {
                                '$gt': ['$datenow', '$start'],

                              },
                              {
                                '$lt': ['$datenow', '$end'],

                              }
                            ]
                          },
                          'then': 'Sedang Berlangsung'
                        },
                        {
                          'case': {
                            '$gt': ['$datenow', '$end'],

                          },
                          'then': 'Selesai'
                        },

                      ],
                      default: 'Dijadwalkan'
                    }
                  },
                  trans: 1,
                  mediaSource: 1
                }
              },
              {
                "$addFields":
                {
                  "cleanUri":
                  {
                    $replaceOne:
                    {
                      input: "$mediaSource.mediaUri",
                      find: "_0001.jpeg",
                      replacement: ""
                    }
                  }
                }
              },
              {
                $project: {
                  iduser: 1,
                  createdAt: 1,
                  updatedAt: 1,
                  postID: 1,
                  postType: 1,
                  email: 1,
                  type: 1,
                  description: 1,
                  title: 1,
                  active: 1,
                  jangkauan: 1,
                  interval: 1,
                  likes: 1,
                  views: 1,
                  comments: 1,
                  start: 1,
                  end: 1,
                  sessionName: 1,
                  sessionType: 1,
                  sessionStart: 1,
                  sessionEnd: 1,
                  statusPengajuan: 1,
                  datenow: 1,
                  keterangan: 1,
                  typeboost: 1,
                  boostSessionid: 1,
                  kategori: 1,
                  saleAmount: 1,
                  statusJual: 1,
                  dataview: 1,
                  mediaBasePath:
                  {
                    "$ifNull":
                      [
                        "$mediaSource.mediaBasePath",
                        null
                      ]
                  },
                  mediaUri:
                  {
                    "$ifNull":
                      [
                        "$mediaSource.mediaUri",
                        null
                      ]
                  },
                  mediaType:
                  {
                    "$ifNull":
                      [
                        "$mediaSource.mediaType",
                        null
                      ]
                  },
                  mediaThumbEndpoint:
                  {
                    "$ifNull":
                      [
                        "$mediaSource.mediaThumbEndpoint",
                        {
                          "$concat":
                            [
                              "/thumb/",
                              "$cleanUri"
                            ]
                        }
                      ]
                  },
                  mediaEndpoint:
                  {
                    "$ifNull":
                      [
                        "$mediaSource.mediaEndpoint",
                        {
                          "$cond":
                          {
                            if:
                            {
                              "$eq":
                                [
                                  "$postType", "pict"
                                ]
                            },
                            then:
                            {
                              "$concat":
                                [
                                  "/pict/",
                                  "$cleanUri"
                                ]
                            },
                            else:
                            {
                              "$concat":
                                [
                                  "/stream/",
                                  "$cleanUri"
                                ]
                            }
                          }
                        }
                      ]
                  },
                  mediaThumbUri:
                  {
                    "$ifNull":
                      [
                        "$mediaSource.mediaThumbUri",
                        null
                      ]
                  },
                  apsaraId:
                  {
                    "$ifNull":
                      [
                        "$mediaSource.apsaraId",
                        null
                      ]
                  },
                  apsara:
                  {
                    "$ifNull":
                      [
                        "$mediaSource.apsara",
                        false
                      ]
                  },
                }
              },

            ],
            "gender": [
              {
                $unwind: {
                  path: "$boosted",
                  preserveNullAndEmptyArrays: true
                }
              },
              {
                $unwind: {
                  path: "$boosted.boostViewer",
                  preserveNullAndEmptyArrays: true
                }
              },
              {
                $project: {
                  userEmail: "$boosted.boostViewer.email",

                }
              },
              {
                "$lookup": {
                  "from": "newUserBasics",
                  "as": "dataview",
                  let: {
                    localID: '$userEmail'
                  },
                  "pipeline": [
                    {
                      $match:
                      {
                        $and: [
                          {
                            $expr: {
                              $eq: ["$email", "$$localID"]
                            }
                          },

                        ],

                      }
                    },
                    {
                      $project: {

                        gender: 1,

                      }
                    },

                  ],

                },

              },
              {
                $unwind: {
                  path: "$dataview",
                  preserveNullAndEmptyArrays: true
                }
              },
              {
                $project: {
                  gender: {
                    "$ifNull":
                      [
                        "$dataview.gender",
                        "Other"
                      ]
                  },

                }
              },
              {
                "$group": {
                  "_id": "$gender",
                  "count": {
                    "$sum": 1
                  }
                }
              },
              {
                "$project":
                {
                  _id:
                  {
                    "$switch":
                    {
                      branches:
                        [
                          {
                            case:
                            {
                              "$eq":
                                [
                                  "$_id", "Laki-laki"
                                ]
                            },
                            then: "MALE"
                          },
                          {
                            case:
                            {
                              "$eq":
                                [
                                  "$_id", "Perempuan"
                                ]
                            },
                            then: "FEMALE"
                          }
                        ],
                      default: "OTHER"
                    }
                  },
                  count: 1
                }
              }
            ],
            "wilayah": [
              {
                $unwind: {
                  path: "$boosted",
                  preserveNullAndEmptyArrays: true
                }
              },
              {
                $unwind: {
                  path: "$boosted.boostViewer",
                  preserveNullAndEmptyArrays: true
                }
              },
              {
                $project: {
                  userEmail: "$boosted.boostViewer.email",

                }
              },
              {
                "$lookup": {
                  "from": "newUserBasics",
                  "as": "dataview",
                  let: {
                    localID: '$userEmail'
                  },
                  "pipeline": [
                    {
                      $match:
                      {
                        $and: [
                          {
                            $expr: {
                              $eq: ["$email", "$$localID"]
                            }
                          },

                        ],

                      }
                    },
                    {
                      $project: {

                        statesName: 1,

                      }
                    },

                  ],

                },

              },
              {
                $unwind: {
                  path: "$dataview",
                  preserveNullAndEmptyArrays: true
                }
              },
              {
                $project: {
                  stateName: '$dataview.statesName'
                }
              },
              {
                "$group": {
                  "_id": "$stateName",
                  "count": {
                    "$sum": 1
                  }
                }
              }
            ],
            "age": [
              {
                $unwind: {
                  path: "$boosted",
                  preserveNullAndEmptyArrays: true
                }
              },
              {
                $unwind: {
                  path: "$boosted.boostViewer",
                  preserveNullAndEmptyArrays: true
                }
              },
              {
                $project: {
                  userEmail: "$boosted.boostViewer.email",

                }
              },
              {
                "$lookup": {
                  "from": "newUserBasics",
                  "as": "dataview",
                  let: {
                    localID: '$userEmail'
                  },
                  "pipeline": [
                    {
                      $match:
                      {
                        $and: [
                          {
                            $expr: {
                              $eq: ["$email", "$$localID"]
                            }
                          },

                        ],

                      }
                    },
                    {
                      $project: {
                        dob: 1,

                      }
                    },
                    {
                      $project: {

                        age: {
                          $cond: {
                            if: {
                              $and: [
                                '$dob',
                                {
                                  $ne: ["$dob", ""]
                                }
                              ]
                            },
                            then: {
                              $toInt: {
                                $divide: [{
                                  $subtract: [new Date(), {
                                    $toDate: "$dob"
                                  }]
                                }, (365 * 24 * 60 * 60 * 1000)]
                              }
                            },
                            else: 0
                          }
                        },

                      }
                    },

                  ],

                },

              },
              {
                $unwind: {
                  path: "$dataview",
                  preserveNullAndEmptyArrays: true
                }
              },
              {
                $project: {
                  _id: 1,
                  userID: "$dataview._id",
                  age: "$dataview.age",

                }
              },
              {
                $project: {

                  ageQualication: {
                    $switch: {
                      branches: [
                        {
                          case: {
                            $gt: ["$age", 44]
                          },
                          then: "< 44 Tahun"
                        },
                        {
                          case: {
                            $and: [{
                              $gte: ["$age", 36]
                            }, {
                              $lte: ["$age", 44]
                            }]
                          },
                          then: "35-44 Tahun"
                        },
                        {
                          case: {
                            $and: [{
                              $gte: ["$age", 25]
                            }, {
                              $lte: ["$age", 35]
                            }]
                          },
                          then: "24-35 Tahun"
                        },
                        {
                          case: {
                            $and: [{
                              $gte: ["$age", 14]
                            }, {
                              $lte: ["$age", 24]
                            }]
                          },
                          then: "14-24 Tahun"
                        },
                        {
                          case: {
                            $and: [{
                              $gte: ["$age", 1]
                            }, {
                              $lt: ["$age", 14]
                            }]
                          },
                          then: "< 14 Tahun"
                        }
                      ],
                      "default": "other"
                    }
                  },

                }
              },
              {
                "$group": {
                  "_id": "$ageQualication",
                  "count": {
                    "$sum": 1
                  }
                }
              }
            ],
            "summary": [
              {
                $unwind: {
                  path: "$boosted",
                  preserveNullAndEmptyArrays: true
                }
              },
              {
                $unwind: {
                  path: "$boosted.boostViewer",
                  preserveNullAndEmptyArrays: true
                }
              },
              {
                $project: {
                  userEmail: "$boosted.boostViewer.email",
                  createAt: "$boosted.boostViewer.createAt",

                }
              },
              {
                $match: {
                  createAt: { $gte: startdate, $lt: dt }
                }
              },
              {
                $group: {
                  _id: {
                    tgl: {
                      $substrCP: ['$createAt', 0, 10]
                    }
                  },
                  count: {
                    $sum: 1
                  },

                },

              },
              {
                $project: {
                  _id: 0,
                  date: "$_id.tgl",
                  jangkauan: "$count"
                }
              },
              {
                $sort: { date: 1 }
              }
            ],

          }
        },
      ]

    );

    return query;
  }

  async countReportStatus(startdate: string, enddate: string) {
    try {
      var currentdate = new Date(new Date(enddate).setDate(new Date(enddate).getDate() + 1));

      var dateend = currentdate.toISOString();
    } catch (e) {
      dateend = "";
    }

    var pipeline = [];

    if (startdate === undefined && enddate === undefined) {
      pipeline.push(
        {
          $addFields: {

            statusLast: {
              $cond: {
                if: {
                  $or: [{
                    $eq: ["$reportedUserHandle", null]
                  }, {
                    $eq: ["$reportedUserHandle", ""]
                  }, {
                    $eq: ["$reportedUserHandle", []]
                  }]
                },
                then: "BARU",
                else: {
                  $last: "$reportedUserHandle.status"
                }
              },

            },

          }
        },
        {
          $facet: {
            "moderation": [
              {
                $addFields: {
                  createdAtReportLast: "$createdAt",

                  reportStatusLast: {
                    $cond: {
                      if: {
                        $or: [{
                          $eq: ["$statusLast", null]
                        }, {
                          $eq: ["$statusLast", ""]
                        }, {
                          $eq: ["$statusLast", []]
                        }, {
                          $eq: ["$statusLast", "BARU"]
                        }]
                      },
                      then: "BARU",
                      else: {
                        $last: "$reportedUserHandle.status"
                      }
                    },

                  },

                }
              },
              {
                $match: {


                  active: true,
                  contentModeration: true
                }
              },

              {
                $group: {
                  _id: "$reportStatusLast",
                  myCount: {
                    $sum: 1
                  },

                }
              },

            ],

            "report": [
              {
                "$unwind":
                {
                  path: "$reportedUser"
                }
              },
              {
                $addFields: {
                  createdAtReportLast: "$reportedUser.createdAt",
                  reportStatusLast: {
                    $cond: {
                      if: {
                        $or: [{
                          $eq: ["$statusLast", null]
                        }, {
                          $eq: ["$statusLast", ""]
                        }, {
                          $eq: ["$statusLast", []]
                        }, {
                          $eq: ["$statusLast", "BARU"]
                        }]
                      },
                      then: "BARU",
                      else: {
                        $last: "$reportedUserHandle.status"
                      }
                    },

                  },

                }
              },
              {
                $match:
                {
                  "$and":
                    [
                      {
                        reportedUser: {
                          $ne: null
                        },
                      },
                      {
                        "reportedUser.active": true
                      },
                      {
                        active: true,
                      },
                      // {
                      //   contentModeration: false
                      // }
                    ]
                }
              },
              // {
              //   $match: {

              //     reportedUser: {
              //       $ne: null
              //     },
              //     active: true,
              //     // contentModeration: false
              //   }
              // },
              // {
              //   $match: {
              //     reportedUser: {
              //       $ne: []
              //     },
              //     active: true,
              //     // contentModeration: false
              //   }
              // },

              {
                $group: {
                  _id: "$reportStatusLast",
                  myCount: {
                    $sum: 1
                  },

                }
              },

            ],
            "appeal": [
              {
                $addFields: {
                  createdAtReportLast: {
                    $last: "$reportedUserHandle.createdAt"
                  },
                  reportStatusLast: {
                    $cond: {
                      if: {
                        $or: [{
                          $eq: ["$statusLast", null]
                        }, {
                          $eq: ["$statusLast", ""]
                        }, {
                          $eq: ["$statusLast", []]
                        }, {
                          $eq: ["$statusLast", "BARU"]
                        }]
                      },
                      then: "BARU",
                      else: {
                        $last: "$reportedUserHandle.status"
                      }
                    },

                  },

                }
              },
              {
                $match: {

                  reportedUserHandle: {
                    $ne: null
                  },
                  active: true,

                }
              },
              {
                $match: {
                  reportedUserHandle: {
                    $ne: []
                  },
                  active: true,
                }
              },

              {
                $group: {
                  _id: "$reportStatusLast",
                  myCount: {
                    $sum: 1
                  }
                }
              },

            ]
          },

        }
      );
    }
    else if (startdate !== undefined && enddate !== undefined) {
      pipeline.push({
        $addFields: {

          statusLast: {
            $cond: {
              if: {
                $or: [{
                  $eq: ["$reportedUserHandle", null]
                }, {
                  $eq: ["$reportedUserHandle", ""]
                }, {
                  $eq: ["$reportedUserHandle", []]
                }]
              },
              then: "BARU",
              else: {
                $last: "$reportedUserHandle.status"
              }
            },

          },

        }
      },
        {
          $facet: {
            "moderation": [
              {
                $addFields: {
                  createdAtReportLast: "$createdAt",

                  reportStatusLast: {
                    $cond: {
                      if: {
                        $or: [{
                          $eq: ["$statusLast", null]
                        }, {
                          $eq: ["$statusLast", ""]
                        }, {
                          $eq: ["$statusLast", []]
                        }, {
                          $eq: ["$statusLast", "BARU"]
                        }]
                      },
                      then: "BARU",
                      else: {
                        $last: "$reportedUserHandle.status"
                      }
                    },

                  },

                }
              },
              {
                $match: {


                  active: true,
                  contentModeration: true
                }
              },
              { $match: { createdAtReportLast: { "$gte": startdate, "$lte": dateend } } },
              {
                $group: {
                  _id: "$reportStatusLast",
                  myCount: {
                    $sum: 1
                  },

                }
              },

            ],

            "report": [
              {
                "$unwind":
                {
                  path: "$reportedUser"
                }
              },
              {
                $addFields: {
                  createdAtReportLast: "$reportedUser.createdAt",
                  reportStatusLast: {
                    $cond: {
                      if: {
                        $or: [{
                          $eq: ["$statusLast", null]
                        }, {
                          $eq: ["$statusLast", ""]
                        }, {
                          $eq: ["$statusLast", []]
                        }, {
                          $eq: ["$statusLast", "BARU"]
                        }]
                      },
                      then: "BARU",
                      else: {
                        $last: "$reportedUserHandle.status"
                      }
                    },

                  },

                }
              },
              {
                $match:
                {
                  "$and":
                    [
                      {
                        reportedUser: {
                          $ne: null
                        },
                      },
                      {
                        "reportedUser.active": true
                      },
                      {
                        active: true,
                      },
                      // {
                      //   contentModeration: false
                      // }
                    ]
                }
              },
              // {
              //   $match: {

              //     reportedUser: {
              //       $ne: null
              //     },
              //     active: true,
              //     contentModeration: false
              //   }
              // },
              // {
              //   $match: {
              //     reportedUser: {
              //       $ne: []
              //     },
              //     active: true,
              //     contentModeration: false
              //   }
              // },
              { $match: { createdAtReportLast: { "$gte": startdate, "$lte": dateend } } },
              {
                $group: {
                  _id: "$reportStatusLast",
                  myCount: {
                    $sum: 1
                  },

                }
              },

            ],
            "appeal": [
              {
                $addFields: {
                  createdAtReportLast: {
                    $last: "$reportedUserHandle.createdAt"
                  },
                  reportStatusLast: {
                    $cond: {
                      if: {
                        $or: [{
                          $eq: ["$statusLast", null]
                        }, {
                          $eq: ["$statusLast", ""]
                        }, {
                          $eq: ["$statusLast", []]
                        }, {
                          $eq: ["$statusLast", "BARU"]
                        }]
                      },
                      then: "BARU",
                      else: {
                        $last: "$reportedUserHandle.status"
                      }
                    },

                  },

                }
              },
              {
                $match: {

                  reportedUserHandle: {
                    $ne: null
                  },
                  active: true,
                  contentModeration: false
                }
              },
              {
                $match: {
                  reportedUserHandle: {
                    $ne: []
                  },
                  active: true,
                  contentModeration: false
                }
              },
              { $match: { createdAtReportLast: { "$gte": startdate, "$lte": dateend } } },
              {
                $group: {
                  _id: "$reportStatusLast",
                  myCount: {
                    $sum: 1
                  }
                }
              },

            ]
          },

        });
    }

    let query = await this.loaddata.aggregate(pipeline);

    return query;
  }

  async findreport(keys: string, postType: string, startdate: string, enddate: string, page: number, limit: number, startreport: number, endreport: number, status: any[], reason: any[], descending: boolean, reasonAppeal: any[], username: string, jenis: string, email: string) {
    try {
      var currentdate = new Date(new Date(enddate).setDate(new Date(enddate).getDate() + 1));

      var dateend = currentdate.toISOString();
    } catch (e) {
      dateend = "";
    }
    const mongoose = require('mongoose');
    var ObjectId = require('mongodb').ObjectId;
    var order = null;

    if (descending === true) {
      order = -1;
    } else {
      order = 1;
    }
    var pipeline = [];


    pipeline = [
      {
        '$lookup': {
          from: 'newUserBasics',
          localField: 'email',
          foreignField: 'email',
          as: 'basicdata'
        }
      },
      {
        "$addFields":
        {
          basic: { '$arrayElemAt': ['$basicdata', 0] },
          mediaSource: { '$arrayElemAt': ['$mediaSource', 0] }
        }
      },
      {
        "$project":
        {
          createdAt: 1,
          updatedAt: 1,
          postID: 1,
          email: 1,
          postType: 1,
          description: 1,
          title: 1,
          active: 1,
          contentModeration: 1,
          contentModerationResponse: 1,
          reportedStatus: 1,
          reportedUserCount: {
            '$ifNull': [
              {
                '$filter': {
                  input: '$reportedUser',
                  as: 'listuser',
                  cond:
                  {
                    '$eq': ['$$listuser.active', true]
                  }
                }
              },
              []
            ]
          },
          reportedUserHandle: 1,
          reportedUser: 1,
          fullName: '$basic.fullName',
          username: '$basic.username',
          avatar:
          {
            mediaBasePath:
            {
              "$ifNull":
                [
                  '$basic.mediaBasePath',
                  null
                ]
            },
            mediaUri:
            {
              "$ifNull":
                [
                  '$basic.mediaUri',
                  null
                ]
            },
            mediaType:
            {
              "$ifNull":
                [
                  '$basic.mediaType',
                  null
                ]
            },
            mediaEndpoint:
            {
              "$ifNull":
                [
                  '$basic.mediaEndpoint',
                  null
                ]
            },
          },
          mediaSource: 1
        }
      },
      {
        "$addFields":
        {
          "cleanUri":
          {
            "$cond": 
            {
              if:
              {
                  "$eq":
                  [
                      "$mediaSource.apsara",
                      true
                  ]
              },
              then: null,
              else:
              {
                  "$substr":
                  [
                      "$mediaSource.mediaUri",
                      0,
                      36
                  ]
              }
            }
          }
        }
      },
      {
        "$project":
        {
          createdAt: 1,
          updatedAt: 1,
          postID: 1,
          email: 1,
          postType: 1,
          description: 1,
          title: 1,
          active: 1,
          contentModeration: 1,
          contentModerationResponse: 1,
          reportedStatus: 1,
          reportedUserCount: { '$size': '$reportedUserCount' },
          reportedUserHandle: 1,
          reportedUser: 1,
          fullName: 1,
          username: 1,
          avatar: 1,
          rotate:
          {
            "$ifNull":
              [
                "$mediaSource.rotate",
                null
              ]
          },
          mediaBasePath:
          {
            "$ifNull":
              [
                "$mediaSource.mediaBasePath",
                null
              ]
          },
          mediaUri:
          {
            "$ifNull":
              [
                "$mediaSource.mediaUri",
                null
              ]
          },
          mediaType:
          {
            "$ifNull":
              [
                "$mediaSource.mediaType",
                null
              ]
          },
          mediaThumbEndpoint:
          {
            "$ifNull":
              [
                "$mediaSource.mediaThumbEndpoint",
                {
                  "$concat":
                    [
                      "/thumb/",
                      "$cleanUri"
                    ]
                }
              ]
          },
          mediaEndpoint:
          {
            "$ifNull":
              [
                "$mediaSource.mediaEndpoint",
                {
                  "$cond":
                  {
                    if:
                    {
                      "$eq":
                        [
                          "$postType", "pict"
                        ]
                    },
                    then:
                    {
                      "$concat":
                        [
                          "/pict/",
                          "$cleanUri"
                        ]
                    },
                    else:
                    {
                      "$concat":
                        [
                          "/stream/",
                          "$cleanUri"
                        ]
                    }
                  }
                }
              ]
          },
          mediaThumbUri:
          {
            "$ifNull":
              [
                "$mediaSource.mediaThumbUri",
                null
              ]
          },
          apsaraId:
          {
            "$ifNull":
              [
                "$mediaSource.apsaraId",
                null
              ]
          },
          apsara:
          {
            "$ifNull":
              [
                "$mediaSource.apsara",
                false
              ]
          },
          reportReasonIdLast:
          {
            '$last': '$reportedUser.reportReasonId'
          },
          reasonLast:
          {
            '$last': '$reportedUser.description'
          },
          lastAppeal:
          {
            '$cond': {
              if: {
                '$and': [
                  { '$eq': ['$reportedUserHandle.reason', null] },
                  { '$eq': ['$reportedUserHandle.reason', ''] },
                  { '$eq': ['$reportedUserHandle.reason', 'Lainnya'] }
                ]
              },
              then: 'Lainnya',
              else: {
                '$last': '$reportedUserHandle.reason'
              }
            }
          },
          createdAtReportLast:
          {
            '$last': '$reportedUser.createdAt'
          },
          createdAtAppealLast:
          {
            '$last': '$reportedUserHandle.createdAt'
          },
          statusLast:
          {
            '$cond': {
              if: {
                '$or': [
                  { '$eq': ['$reportedUserHandle', null] },
                  { '$eq': ['$reportedUserHandle', ''] },
                  { '$eq': ['$reportedUserHandle', []] }
                ]
              },
              then: 'BARU',
              else: {
                '$last': '$reportedUserHandle.status'
              }
            }
          }
        }
      },
      {
        "$project":
        {
          createdAt: 1,
          updatedAt: 1,
          postID: 1,
          email: 1,
          postType: 1,
          description: 1,
          title: 1,
          active: 1,
          contentModeration: 1,
          contentModerationResponse: 1,
          reportedStatus: 1,
          reportedUserCount: 1,
          reportedUserHandle: 1,
          reportedUser: 1,
          fullName: 1,
          username: 1,
          avatar: 1,
          rotate: 1,
          mediaBasePath: 1,
          mediaUri: 1,
          mediaType: 1,
          mediaThumbEndpoint: 1,
          mediaEndpoint: 1,
          mediaThumbUri: 1,
          apsaraId: 1,
          apsara: 1,
          reportReasonIdLast: 1,
          reasonLast: 1,
          lastAppeal: 1,
          createdAtReportLast: 1,
          createdAtAppealLast: 1,
          statusLast: 1,
          reasonLastAppeal: {
            '$cond': {
              if: {
                '$or': [
                  { '$eq': ['$lastAppeal', null] },
                  { '$eq': ['$lastAppeal', ''] },
                  { '$eq': ['$lastAppeal', 'Lainnya'] }
                ]
              },
              then: 'Lainnya',
              else: { '$last': '$reportedUserHandle.reason' }
            }
          },
          reportStatusLast: {
            '$cond': {
              if: {
                '$or': [
                  { '$eq': ['$statusLast', null] },
                  { '$eq': ['$statusLast', ''] },
                  { '$eq': ['$statusLast', []] },
                  { '$eq': ['$statusLast', 'BARU'] }
                ]
              },
              then: 'BARU',
              else: { '$last': '$reportedUserHandle.status' }
            }
          }
        }
      },
    ];

    if (jenis === "report") {
      pipeline.push(
        {
          $match: {
            $and: [
              {
                reportedUser: {
                  $ne: null
                }, active: true
              },
              {
                reportedUser: {
                  $ne: []
                }, active: true
              },

            ]
          }
        },

      );
    } else if (jenis === "appeal") {
      pipeline.push({
        $match: {
          $and: [
            {
              reportedUserHandle: {
                $ne: []
              },
            },
            {
              reportedUserHandle: {
                $ne: null
              },
            },

          ]
        }
      },);
    }

    if (email && email !== undefined) {
      pipeline.push({ $match: { email: email } });
    }
    if (keys && keys !== undefined) {

      pipeline.push({
        $match: {
          description: {
            $regex: keys,
            $options: 'i'
          },

        }
      },);

    }
    if (username && username !== undefined) {

      pipeline.push({
        $match: {
          username: {
            $regex: username,
            $options: 'i'
          },

        }
      },);

    }

    if (postType && postType !== undefined) {
      pipeline.push({
        $match: {
          postType: postType

        }
      },);
    }
    if (startdate && startdate !== undefined) {
      if (jenis === "report") {
        pipeline.push({ $match: { createdAtReportLast: { "$gte": startdate } } });
      }
      else if (jenis === "appeal") {
        pipeline.push({ $match: { createdAtAppealLast: { "$gte": startdate } } });
      }
    }
    if (enddate && enddate !== undefined) {


      if (jenis === "report") {
        pipeline.push({ $match: { createdAtReportLast: { "$lte": dateend } } });
      }
      else if (jenis === "appeal") {
        pipeline.push({ $match: { createdAtAppealLast: { "$lte": dateend } } });
      }
    }
    if (startreport && startreport !== undefined) {
      pipeline.push({ $match: { reportedUserCount: { "$gte": startreport } } });
    }
    if (endreport && endreport !== undefined) {
      pipeline.push({ $match: { reportedUserCount: { "$lte": endreport } } });
    }

    if (status && status !== undefined) {

      pipeline.push(
        {
          $match: {
            $or: [
              {
                reportStatusLast: {
                  $in: status
                }
              },

            ]
          }
        },
      );

    }
    if (reason && reason !== undefined) {

      let reasonsleng = reason.length;
      let arrayReason = [];
      for (var i = 0; i < reasonsleng; i++) {
        var id = reason[i];
        var idreason = mongoose.Types.ObjectId(id);
        arrayReason.push(idreason);
      }
      pipeline.push(
        {
          $match: {
            $or: [
              {
                reportReasonIdLast: {
                  $in: arrayReason
                }
              },

            ]
          }
        });

    }
    if (reasonAppeal && reasonAppeal !== undefined) {

      pipeline.push(
        {
          $match: {
            $or: [
              {
                reasonLastAppeal: {
                  $in: reasonAppeal
                }
              },

            ]
          }
        });

    }
    if (jenis === "report") {
      pipeline.push({
        $sort: {
          createdAtReportLast: order
        },

      });
    }
    else if (jenis === "appeal") {
      pipeline.push({
        $sort: {
          createdAtAppealLast: order
        },

      });
    }
    if (page > 0) {
      pipeline.push({ $skip: (page * limit) });
    }
    if (limit > 0) {
      pipeline.push({ $limit: limit });
    }

    // console.log(JSON.stringify(pipeline))

    let query = await this.loaddata.aggregate(pipeline);

    return query;
  }

  async find200(value: number): Promise<newPosts[]> {
    return this.loaddata.aggregate([
      {
        "$match":
        {
          "$and":
            [
              {
                "reportedUser":
                {
                  "$ne": null
                }
              },
              {
                "reportedUser":
                {
                  "$ne": ""
                }
              },
              {
                "$expr":
                {
                  "$gte":
                    [
                      {
                        "$size": "$reportedUser"
                      },
                      value
                    ]
                }
              }
            ]
        }
      },
    ]).exec();
  }

  async updateStatusOwned(id: string, updatedAt: string) {
    let data = await this.loaddata.updateMany({ "_id": id },
      { $set: { "reportedStatus": "OWNED", "updatedAt": updatedAt, "reportedUserHandle.$[].status": "DITANGGUHKAN", "reportedUserHandle.$[].updatedAt": updatedAt } });
    return data;
  }

  async getmusicCard() {
    var query = await this.loaddata.aggregate(
      [
        {
          "$match":
          {
            musicId:
            {
              "$exists": true
            }
          }
        },
        {
          "$group":
          {
            _id: "$musicId",
            total:
            {
              "$sum": 1
            }
          }
        },
        {
          $lookup:
          {
            from: 'mediamusic',
            localField: '_id',
            foreignField: '_id',
            as: 'music_data',
          },
        },
        {
          "$unwind":
          {
            path: "$music_data"
          }
        },
        {
          $lookup:
          {
            from: 'theme',
            localField: 'music_data.theme',
            foreignField: '_id',
            as: 'theme_data',
          },
        },
        {
          $lookup:
          {
            from: 'genre',
            localField: 'music_data.genre',
            foreignField: '_id',
            as: 'genre_data',
          },
        },
        {
          $lookup:
          {
            from: 'mood',
            localField: 'music_data.mood',
            foreignField: '_id',
            as: 'mood_data',
          },
        },
        {
          $project:
          {
            musicTitle: '$music_data.musicTitle',
            artistName: '$music_data.artistName',
            albumName: '$music_data.albumName',
            genre:
            {
              "$arrayElemAt":
                [
                  '$genre_data', 0
                ]
            },
            theme:
            {
              "$arrayElemAt":
                [
                  '$theme_data', 0
                ]
            },
            mood:
            {
              "$arrayElemAt":
                [
                  '$mood_data', 0
                ]
            },
            releaseDate: '$music_data.releaseDate',
            apsaraMusic: '$music_data.apsaraMusic',
            apsaraThumnail: '$music_data.apsaraThumnail',
            _id: 1,
            total: 1
          }
        },
        {
          "$facet":
          {
            "artistPopuler":
              [
                {
                  "$group":
                  {
                    _id: "$artistName",
                    apsaraMusic:
                    {
                      "$first": "$apsaraMusic"
                    },
                    apsaraThumnail:
                    {
                      "$first": "$apsaraThumnail"
                    },
                    count:
                    {
                      "$sum": "$total"
                    }
                  }
                },
                {
                  $sort:
                  {
                    count: -1,
                    _id: 1
                  }
                },
                {
                  $skip: 0
                },
                {
                  $limit: 5
                },
                {
                  "$project":
                  {
                    _id:
                    {
                      artistName: "$_id",
                      apsaraMusic: "$apsaraMusic",
                      apsaraThumnail: "$apsaraThumnail"
                    },
                    count: 1
                  }
                }
              ],
            "musicPopuler":
              [
                {
                  "$group":
                  {
                    _id:
                    {
                      "musicTitle": "$musicTitle",
                      "apsaraMusic": "$apsaraMusic",
                      "apsaraThumnail": "$apsaraThumnail"
                    },
                    count:
                    {
                      "$sum": "$total"
                    }
                  }
                },
                {
                  $sort:
                  {
                    count: -1,
                    _id: 1
                  }
                },
                {
                  $skip: 0
                },
                {
                  $limit: 5
                },
              ],
            "genrePopuler":
              [
                {
                  "$group":
                  {
                    _id: "$genre",
                    count:
                    {
                      "$sum": "$total"
                    }
                  }
                },
                {
                  $sort:
                  {
                    count: -1,
                    _id: 1
                  }
                },
                {
                  $skip: 0
                },
                {
                  $limit: 5
                },
              ],
            "themePopuler":
              [
                {
                  "$group":
                  {
                    _id: "$theme",
                    count:
                    {
                      "$sum": "$total"
                    }
                  }
                },
                {
                  $sort:
                  {
                    count: -1,
                    _id: 1
                  }
                },
                {
                  $skip: 0
                },
                {
                  $limit: 5
                },
              ],
            "moodPopuler":
              [
                {
                  "$group":
                  {
                    _id: "$mood",
                    count:
                    {
                      "$sum": "$total"
                    }
                  }
                },
                {
                  $sort:
                  {
                    count: -1,
                    _id: 1
                  }
                },
                {
                  $skip: 0
                },
                {
                  $limit: 5
                },
              ],
          }
        }
      ]
    );

    return query;
  }

  async findreportuserdetail(target: string) {
    var result = await this.loaddata.aggregate([
      {
        $match: { postID: target }
      },
      {
        "$lookup":
        {
          from: "newUserBasics",
          localField: "email",
          foreignField: "email",
          as: "basicdata",
        }
      },
      {
        "$addFields":
        {
          'salePrice': {
            $cmp: ["$saleAmount", 0]
          },
          'komen': {
            $cmp: ["$comments", 0]
          },
          'basic': {
            $arrayElemAt: ['$basicdata', 0]
          },
          // 'profilepictid': {
          //     $arrayElemAt: ['$basicdata.profilePict.$id', 0]
          // },
          // 'proofpictid': {
          //     $arrayElemAt: ['$basicdata.proofPict.$id', 0]
          // },
          'insightid': {
            $arrayElemAt: ['$basicdata.insight.$id', 0]
          },
          // 'mediaid': {
          //     $arrayElemAt: ['$contentMedias.$id', 0]
          // },
          // 'mediaref': {
          //     $arrayElemAt: ['$contentMedias.$ref', 0]
          // },
          'isViewed': {
            '$cond': {
              if: {
                '$eq': ['$views', 0]
              },
              then: false,
              else: true
            }
          },
          'mediaSource': {
            '$arrayElemAt': ['$mediaSource', 0]
          },
          'listTag':
          {
            "$ifNull":
              [
                '$tagPeople.$id',
                []
              ]
          }
        }
      },
      {
        "$lookup":
        {
          from: "insights",
          localField: "insightid",
          foreignField: "_id",
          as: "insightdata",
        }
      },
      {
        "$lookup":
        {
          from: "newUserBasics",
          as: "tagpeople_data",
          let:
          {
            local: "$listTag"
          },
          pipeline:
            [
              {
                "$match":
                {
                  "$or":
                    [
                      {
                        "$expr":
                        {
                          "$in":
                            [
                              "$_idAuth", "$$local"
                            ]
                        }
                      },
                      {
                        "$expr":
                        {
                          "$in":
                            [
                              "$_id", "$$local"
                            ]
                        }
                      },
                    ]
                }
              },
              {
                "$project":
                {
                  username: 1
                }
              },
              {
                "$group":
                {
                  _id: null,
                  username:
                  {
                    "$push": "$username"
                  }
                }
              }
            ]
        }
      },
      {
        "$addFields":
        {
          'insight': {
            '$arrayElemAt': ['$insightdata', 0]
          },
          'avatar': {
            mediaBasePath:
            {
              "$ifNull":
                [
                  '$basic.mediaBasePath',
                  null
                ]
            },
            mediaUri:
            {
              "$ifNull":
                [
                  '$basic.mediaUri',
                  null
                ]
            },
            mediaType:
            {
              "$ifNull":
                [
                  '$basic.mediaType',
                  null
                ]
            },
            mediaEndpoint:
            {
              "$ifNull":
                [
                  '$basic.mediaEndpoint',
                  null
                ]
            }
          },
          'cleanUri':
          {
            "$replaceOne":
            {
              input: "$mediaSource.mediaUri",
              find: "_0001.jpeg",
              replacement: ""
            }
          },
        }
      },
      {
        "$project":
        {
          _id: 1,
          insight:
          {
            shares: '$insight.shares',
            followers: '$insight.followers',
            comments: '$insight.comments',
            followings: '$insight.followings',
            reactions: '$insight.reactions',
            posts: '$insight.posts',
            views: '$insight.views',
            likes: '$insight.likes'
          },
          avatar: 1,
          fullName: "$basic.fullName",
          username: "$basic.username",
          privacy: {
            isPostPrivate: '$basic.isPostPrivate',
            isCelebrity: '$basic.isCelebrity',
            isPrivate: '$basic.isPrivate'
          },
          createdAt: 1,
          updatedAt: 1,
          postID: 1,
          email: 1,
          postType: 1,
          description: 1,
          title: 1,
          active: 1,
          metadata: 1,
          location: 1,
          visibility: 1,
          tags: 1,
          likes: 1,
          views: 1,
          shares: 1,
          komen: 1,
          isOwned: 1,
          tagPeople:
          {
            "$ifNull":
              [
                {
                  "$arrayElemAt":
                    [
                      "$tagpeople_data.username", 0
                    ]
                },
                []
              ]
          },
          reportedUserCount:
          {
            "$ifNull":
              [
                {
                  "$filter":
                  {
                    input: "$reportedUser",
                    as: "listuser",
                    cond:
                    {
                      "$eq":
                        [
                          "$$listuser.active",
                          true
                        ]
                    }
                  }
                },
                []
              ]
          },
          reportedUser: 1,
          isIdVerified: '$basic.isIdVerified',
          reportedUserHandle: 1,
          reportedStatus: 1,
          statusUser:
          {
            $cond: {
              if: {
                $eq: ["$basic.isIdVerified", true]
              },
              then: "PREMIUM",
              else: "BASIC"
            }
          },
          isViewed: '$isViewed',
          allowComments: 1,
          isSafe: 1,
          saleLike: 1,
          saleView: 1,
          monetize: {
            $cond: {
              if: {
                $eq: ["$salePrice", - 1]
              },
              then: false,
              else: true
            }
          },
          comments: {
            $cond: {
              if: {
                $eq: ["$komen", - 1]
              },
              then: 0,
              else: '$comments'
            }
          },
          salePrice: '$salePrice',
          saleAmount: {
            $cond: {
              if: {
                $eq: ["$salePrice", - 1]
              },
              then: 0,
              else: "$saleAmount"
            }
          },
          rotate:
          {
            "$ifNull":
              [
                "$mediaSource.rotate",
                null
              ]
          },
          mediaBasePath:
          {
            "$ifNull":
              [
                "$mediaSource.mediaBasePath",
                null
              ]
          },
          mediaUri:
          {
            "$ifNull":
              [
                "$mediaSource.mediaUri",
                null
              ]
          },
          mediaType:
          {
            "$ifNull":
              [
                "$mediaSource.mediaType",
                null
              ]
          },
          mediaThumbEndpoint:
          {
            "$ifNull":
              [
                "$mediaSource.mediaThumbEndpoint",
                {
                  "$concat":
                    [
                      "/thumb/",
                      "$cleanUri"
                    ]
                }
              ]
          },
          mediaEndpoint:
          {
            "$ifNull":
              [
                "$mediaSource.mediaEndpoint",
                {
                  "$cond":
                  {
                    if:
                    {
                      "$eq":
                        [
                          "$postType", "pict"
                        ]
                    },
                    then:
                    {
                      "$concat":
                        [
                          "/pict/",
                          "$cleanUri"
                        ]
                    },
                    else:
                    {
                      "$concat":
                        [
                          "/stream/",
                          "$cleanUri"
                        ]
                    }
                  }
                }
              ]
          },
          mediaThumbUri:
          {
            "$ifNull":
              [
                "$mediaSource.mediaThumbUri",
                null
              ]
          },
          apsaraId:
          {
            "$ifNull":
              [
                "$mediaSource.apsaraId",
                null
              ]
          },
          apsara:
          {
            "$ifNull":
              [
                "$mediaSource.apsara",
                false
              ]
          },
          proofpict:
            [
              {
                _id: "$basic._id",
                createdAt:
                {
                  "$arrayElemAt":
                    [
                      "$basic.kyc.createdAt", 0
                    ]
                },
                nama:
                {
                  "$arrayElemAt":
                    [
                      "$basic.kyc.nama", 0
                    ]
                }
              }
            ]
        }
      },
      {
        "$project":
        {
          _id: 1,
          insight: 1,
          avatar: 1,
          fullName: 1,
          proofpict: 1,
          username: 1,
          createdAt: 1,
          updatedAt: 1,
          postID: 1,
          email: 1,
          postType: 1,
          description: 1,
          title: 1,
          active: 1,
          metadata: 1,
          location: 1,
          visibility: 1,
          isIdVerified: 1,
          statusUser: 1,
          tags: 1,
          likes: 1,
          views: 1,
          shares: 1,
          comments: 1,
          isOwned: 1,
          privacy: 1,
          isViewed: 1,
          allowComments: 1,
          isSafe: 1,
          saleLike: 1,
          saleView: 1,
          monetize: 1,
          saleAmount: 1,
          mediaref: 1,
          rotate: 1,
          mediaBasePath: 1,
          mediaUri: 1,
          mediaType: 1,
          mediaThumbEndpoint: 1,
          mediaEndpoint: 1,
          mediaThumbUri: 1,
          apsaraId: 1,
          apsara: 1,
          tagPeople: 1,
          reportedUserCount:
          {
            "$size": "$reportedUserCount"
          },
          reportedUserHandle: 1,
          reportedUser: 1,
          reportedStatus: 1,
          lastReasonReport: {
            $cond: {
              if: {
                $or: [{
                  $eq: ["$reportedUser", null]
                }, {
                  $eq: ["$reportedUser", ""]
                }, {
                  $eq: ["$reportedUser", []]
                },]
              },
              then: "Lainnya",
              else: {
                $last: "$reportedUser.description"
              }
            },

          },
          lastAppeal: {
            $cond: {
              if: {
                $or: [{
                  $eq: ["$reportedUserHandle", null]
                }, {
                  $eq: ["$reportedUserHandle", ""]
                }, {
                  $eq: ["$reportedUserHandle", []]
                },]
              },
              then: "Lainnya",
              else: {
                $last: "$reportedUserHandle.reason"
              }
            },

          },
          lastAppealAdmin: {
            $cond: {
              if: {
                $or: [{
                  $eq: ["$reportedUserHandle", null]
                }, {
                  $eq: ["$reportedUserHandle", ""]
                }, {
                  $eq: ["$reportedUserHandle", []]
                },]
              },
              then: "Lainnya",
              else: {
                $last: "$reportedUserHandle.reasonAdmin"
              }
            },

          },
          createdAtReportLast: {
            $last: "$reportedUser.createdAt"
          },
          createdAtAppealLast: {
            $last: "$reportedUserHandle.createdAt"
          },
          statusLast: {
            $cond: {
              if: {
                $or: [{
                  $eq: ["$reportedUserHandle", null]
                }, {
                  $eq: ["$reportedUserHandle", ""]
                }, {
                  $eq: ["$reportedUserHandle", []]
                }]
              },
              then: "BARU",
              else: {
                $last: "$reportedUserHandle.status"
              }
            },

          },
        }
      },
      {
        "$project":
        {
          _id: 1,
          insight: 1,
          avatar: 1,
          fullName: 1,
          proofpict: 1,
          username: 1,
          createdAt: 1,
          updatedAt: 1,
          postID: 1,
          email: 1,
          postType: 1,
          description: 1,
          title: 1,
          active: 1,
          metadata: 1,
          location: 1,
          visibility: 1,
          isIdVerified: 1,
          statusUser: 1,
          tags: 1,
          likes: 1,
          views: 1,
          shares: 1,
          comments: 1,
          isOwned: 1,
          privacy: 1,
          isViewed: 1,
          allowComments: 1,
          isSafe: 1,
          saleLike: 1,
          saleView: 1,
          monetize: 1,
          saleAmount: 1,
          mediaref: 1,
          rotate: 1,
          mediaBasePath: 1,
          mediaUri: 1,
          mediaType: 1,
          mediaThumbEndpoint: 1,
          mediaEndpoint: 1,
          mediaThumbUri: 1,
          apsaraId: 1,
          apsara: 1,
          tagPeople: 1,
          reportedUserCount: 1,
          reportedUserHandle: 1,
          reportedUser: 1,
          reportedStatus: 1,
          createdAtReportLast: 1,
          createdAtAppealLast: 1,
          lastAppeal: 1,
          lastAppealAdmin: 1,
          lastReasonReport: 1,
          statusLast: 1,
          reasonLastReport: {
            $cond: {
              if: {
                $or: [{
                  $eq: ["$lastReasonReport", null]
                }, {
                  $eq: ["$lastReasonReport", ""]
                }, {
                  $eq: ["$lastReasonReport", "Lainnya"]
                }]
              },
              then: "Lainnya",
              else: {
                $last: "$reportedUser.description"
              }
            },

          },
          reasonLastAppeal: {
            $cond: {
              if: {
                $or: [{
                  $eq: ["$lastAppeal", null]
                }, {
                  $eq: ["$lastAppeal", ""]
                }, {
                  $eq: ["$lastAppeal", "Lainnya"]
                }]
              },
              then: "Lainnya",
              else: {
                $last: "$reportedUserHandle.reason"
              }
            },

          },
          reasonLastAppealAdmin: {
            $cond: {
              if: {
                $or: [{
                  $eq: ["$lastAppealAdmin", null]
                }, {
                  $eq: ["$lastAppealAdmin", ""]
                }, {
                  $eq: ["$lastAppealAdmin", "Lainnya"]
                }]
              },
              then: "Lainnya",
              else: {
                $last: "$reportedUserHandle.reasonAdmin"
              }
            },

          },
          reportStatusLast: {
            $cond: {
              if: {
                $or: [{
                  $eq: ["$statusLast", null]
                }, {
                  $eq: ["$statusLast", ""]
                }, {
                  $eq: ["$statusLast", []]
                }, {
                  $eq: ["$statusLast", "BARU"]
                }]
              },
              then: "BARU",
              else: {
                $last: "$reportedUserHandle.status"
              }
            },

          },
        }
      },
    ]);
    return result;
  }

  async countReason(postID: string) {
    let query = await this.loaddata.aggregate([
      {
        $match: {

          postID: postID
        }
      },
      {
        $unwind: "$reportedUser"
      },
      {
        $match: {

          'reportedUser.active': true
        }
      },
      {
        $group: {
          _id: "$reportedUser.description",

          myCount: {
            $sum: 1
          }
        }
      },
      {
        $project: {
          _id: "$_id",
          "myCount": "$myCount",

        }
      }

    ]);
    return query;
  }

  async detailuserreport(target: string) {
    var result = await this.loaddata.aggregate([
      {
        "$match":
        {
          "postID": target
        }
      },
      {
        $lookup:
        {
          from: 'newUserBasics',
          localField: 'email',
          foreignField: 'email',
          as: 'basicdata',
        }
      },
      {
        "$addFields":
        {
          'salePrice': {
            $cmp: ["$saleAmount", 0]
          },
          'komen': {
            $cmp: ["$comments", 0]
          },
          'basic': {
            $arrayElemAt: ['$basicdata', 0]
          },
          // 'profilepictid': {
          // $arrayElemAt: ['$basicdata.profilePict.$id', 0]
          // },
          // 'proofpictid': {
          // $arrayElemAt: ['$basicdata.proofPict.$id', 0]
          // },
          'insightid': {
            $arrayElemAt: ['$basicdata.insight.$id', 0]
          },
          // 'mediaid': {
          // $arrayElemAt: ['$contentMedias.$id', 0]
          // },
          // 'mediaref': {
          // $arrayElemAt: ['$contentMedias.$ref', 0]
          // },
          'isViewed': {
            '$cond': {
              if: {
                '$eq': ['$views', 0]
              },
              then: false,
              else: true
            }
          },
          'tempmediaSource': {
            '$arrayElemAt': [
              '$mediaSource', 0
            ]
          }
        }
      },
      {
        $lookup:
        {
          from: 'insights',
          localField: 'insightid',
          foreignField: '_id',
          as: 'insightdata',
        }
      },
      {
        "$addFields":
        {
          "insight":
          {
            "$arrayElemAt":
              [
                "$insightdata", 0
              ]
          },
          "cleanUri":
          {
            $replaceOne:
            {
              input: "$tempmediaSource.mediaUri",
              find: "_0001.jpeg",
              replacement: ""
            }
          },
          "tempkyc":
          {
            "$arrayElemAt":
              [
                "$basic.kyc", 0
              ]
          }
        }
      },
      {
        "$project":
        {
          _id: 1,
          insight:
          {
            shares: '$insight.shares',
            followers: '$insight.followers',
            comments: '$insight.comments',
            followings: '$insight.followings',
            reactions: '$insight.reactions',
            posts: '$insight.posts',
            views: '$insight.views',
            likes: '$insight.likes'
          },
          avatar:
          {
            mediaBasePath:
            {
              "$ifNull":
                [
                  '$basic.mediaBasePath',
                  null
                ]
            },
            mediaUri:
            {
              "$ifNull":
                [
                  '$basic.mediaUri',
                  null
                ]
            },
            mediaType:
            {
              "$ifNull":
                [
                  '$basic.mediaType',
                  null
                ]
            },
            mediaEndpoint:
            {
              "$ifNull":
                [
                  '$basic.mediaEndpoint',
                  null
                ]
            },
            medreplace:
            {
              $replaceOne:
              {
                input: "$basic.mediaUri",
                find: "_0001.jpeg",
                replacement: ""
              }
            },
          },
          fullName: "$basic.fullName",
          username: "$basic.username",
          privacy:
          {
            isPostPrivate: '$basic.isPostPrivate',
            isCelebrity: '$basic.isCelebrity',
            isPrivate: '$basic.isPrivate'
          },
          proofpict:
            [
              {
                _id: "$basic._id",
                createdAt: "$tempkyc.createdAt",
                nama: "$tempkyc.nama"
              }
            ],
          createdAt: 1,
          updatedAt: 1,
          postID: 1,
          email: 1,
          postType: 1,
          description: 1,
          visibility: 1,
          title: 1,
          likes: 1,
          views: 1,
          active: 1,
          location: 1,
          tags: 1,
          shares: 1,
          komen: 1,
          isOwned: 1,
          tagPeople: 1,
          reportedUser: 1,
          reportedUserCount:
          {
            "$ifNull":
              [
                {
                  "$filter":
                  {
                    input: "$reportedUser",
                    as: "listuser",
                    cond:
                    {
                      "$eq":
                        [
                          "$$listuser.active",
                          true
                        ]
                    }
                  }
                },
                []
              ]
          },
          isIdVerified: '$basic.isIdVerified',
          reportedUserHandle: 1,
          reportedStatus: 1,
          statusUser:
          {
            $cond: {
              if: {
                $eq: ["$basic.isIdVerified", true]
              },
              then: "PREMIUM",
              else: "BASIC"
            }
          },
          lastReasonReport: {
            $cond: {
              if: {
                $or: [{
                  $eq: ["$reportedUser", null]
                }, {
                  $eq: ["$reportedUser", ""]
                }, {
                  $eq: ["$reportedUser", []]
                },]
              },
              then: "Lainnya",
              else:
              {
                $last: "$reportedUser.description"
              }
            },
          },
          lastAppeal: {
            $cond: {
              if: {
                $or: [{
                  $eq: ["$reportedUserHandle", null]
                }, {
                  $eq: ["$reportedUserHandle", ""]
                }, {
                  $eq: ["$reportedUserHandle", []]
                },]
              },
              then: "Lainnya",
              else: {
                $last: "$reportedUserHandle.reason"
              }
            },
          },
          lastAppealAdmin: {
            $cond: {
              if: {
                $or: [{
                  $eq: ["$reportedUserHandle", null]
                }, {
                  $eq: ["$reportedUserHandle", ""]
                }, {
                  $eq: ["$reportedUserHandle", []]
                },]
              },
              then: "Lainnya",
              else: {
                $last: "$reportedUserHandle.reasonAdmin"
              }
            },
          },
          createdAtReportLast: {
            $last: "$reportedUser.createdAt"
          },
          createdAtAppealLast: {
            $last: "$reportedUserHandle.createdAt"
          },
          statusLast: {
            $cond: {
              if: {
                $or: [{
                  $eq: ["$reportedUserHandle", null]
                }, {
                  $eq: ["$reportedUserHandle", ""]
                }, {
                  $eq: ["$reportedUserHandle", []]
                }]
              },
              then: "BARU",
              else: {
                $last: "$reportedUserHandle.status"
              }
            },
          },
          isViewed: '$isViewed',
          allowComments: 1,
          isSafe: 1,
          saleLike: 1,
          saleView: 1,
          monetize: {
            $cond: {
              if: {
                $eq: ["$salePrice", - 1]
              },
              then: false,
              else: true
            }
          },
          comments: {
            $cond: {
              if: {
                $eq: ["$komen", - 1]
              },
              then: 0,
              else: '$comments'
            }
          },
          salePrice: '$salePrice',
          saleAmount: {
            $cond: {
              if: {
                $eq: ["$salePrice", - 1]
              },
              then: 0,
              else: "$saleAmount"
            }
          },
          rotate:
          {
            "$ifNull":
              [
                "$tempmediaSource.rotate",
                null
              ]
          },
          mediaBasePath:
          {
            "$ifNull":
              [
                "$tempmediaSource.mediaBasePath",
                null
              ]
          },
          mediaUri:
          {
            "$ifNull":
              [
                "$tempmediaSource.mediaUri",
                null
              ]
          },
          mediaType:
          {
            "$ifNull":
              [
                "$tempmediaSource.mediaType",
                null
              ]
          },
          mediaThumbEndpoint:
          {
            "$ifNull":
              [
                "$tempmediaSource.mediaThumbEndpoint",
                {
                  "$concat":
                    [
                      "/thumb/",
                      "$cleanUri"
                    ]
                }
              ]
          },
          mediaEndpoint:
          {
            "$ifNull":
              [
                "$tempmediaSource.mediaEndpoint",
                {
                  "$cond":
                  {
                    if:
                    {
                      "$eq":
                        [
                          "$postType", "pict"
                        ]
                    },
                    then:
                    {
                      "$concat":
                        [
                          "/pict/",
                          "$cleanUri"
                        ]
                    },
                    else:
                    {
                      "$concat":
                        [
                          "/stream/",
                          "$cleanUri"
                        ]
                    }
                  }
                }
              ]
          },
          mediaThumbUri:
          {
            "$ifNull":
              [
                "$tempmediaSource.mediaThumbUri",
                null
              ]
          },
          apsaraId:
          {
            "$ifNull":
              [
                "$tempmediaSource.apsaraId",
                null
              ]
          },
          apsara:
          {
            "$ifNull":
              [
                "$tempmediaSource.apsara",
                false
              ]
          },
        }
      },
      {
        "$project":
        {
          _id: 1,
          insight: 1,
          avatar: 1,
          fullName: 1,
          username: 1,
          privacy: 1,
          createdAt: 1,
          updatedAt: 1,
          postID: 1,
          email: 1,
          proofpict: 1,
          postType: 1,
          description: 1,
          title: 1,
          likes: 1,
          views: 1,
          active: 1,
          shares: 1,
          visibility: 1,
          isOwned: 1,
          location: 1,
          tagPeople: 1,
          reportedUser: 1,
          reportedUserCount:
          {
            "$size": "$reportedUserCount"
          },
          isIdVerified: 1,
          reportedUserHandle: 1,
          reportedStatus: 1,
          statusUser: 1,
          lastReasonReport: 1,
          lastAppeal: 1,
          lastAppealAdmin: 1,
          reasonLastReport: {
            $cond: {
              if: {
                $or: [{
                  $eq: ["$lastReasonReport", null]
                }, {
                  $eq: ["$lastReasonReport", ""]
                }, {
                  $eq: ["$lastReasonReport", "Lainnya"]
                }]
              },
              then: "Lainnya",
              else: {
                $last: "$reportedUser.description"
              }
            },
          },
          reasonLastAppeal: {
            $cond: {
              if: {
                $or: [{
                  $eq: ["$lastAppeal", null]
                }, {
                  $eq: ["$lastAppeal", ""]
                }, {
                  $eq: ["$lastAppeal", "Lainnya"]
                }]
              },
              then: "Lainnya",
              else: {
                $last: "$reportedUserHandle.reason"
              }
            },
          },
          reasonLastAppealAdmin: {
            $cond: {
              if: {
                $or: [{
                  $eq: ["$lastAppealAdmin", null]
                }, {
                  $eq: ["$lastAppealAdmin", ""]
                }, {
                  $eq: ["$lastAppealAdmin", "Lainnya"]
                }]
              },
              then: "Lainnya",
              else: {
                $last: "$reportedUserHandle.reasonAdmin"
              }
            },

          },
          createdAtReportLast: 1,
          createdAtAppealLast: 1,
          statusLast: 1,
          reportStatusLast: {
            $cond: {
              if: {
                $or: [{
                  $eq: ["$statusLast", null]
                }, {
                  $eq: ["$statusLast", ""]
                }, {
                  $eq: ["$statusLast", []]
                }, {
                  $eq: ["$statusLast", "BARU"]
                }]
              },
              then: "BARU",
              else: {
                $last: "$reportedUserHandle.status"
              }
            },

          },
          isViewed: 1,
          allowComments: 1,
          isSafe: 1,
          saleLike: 1,
          saleView: 1,
          monetize: 1,
          comments: 1,
          salePrice: 1,
          saleAmount: 1,
          rotate: 1,
          mediaBasePath: 1,
          mediaUri: 1,
          mediaType: 1,
          mediaThumbEndpoint: 1,
          mediaEndpoint: 1,
          mediaThumbUri: 1,
          apsaraId: 1,
          apsara: 1,
        }
      }
    ]);
    return result;
  }

  async findByMusicId(postid: string) {
    var mongo = require('mongoose');
    var result = await this.loaddata.aggregate([
      {
        $match: {
          $expr:
          {
            $eq: ["$musicId", new mongo.Types.ObjectId(postid)]
          },

        }
      },
      {
        $project: {
          _id: "sean",
          postID: 1,
          viewer: 1
        }
      },
      {
        $group: {
          _id: "$_id",
          postMusic: {
            $push: "$postID"
          },
          "count": {
            "$sum": 1
          },
          "viewerdata": {
            "$push": "$viewer"
          }
        }
      },
      {
        $facet: {
          posted: [
            {
              $project:
              {
                _id: "rere ahoy",
                postID: "$count",

              }
            }
          ],
          user: [
            //opsi 1
            //   {
            //     "$lookup": {
            //       "from": "contentevents",
            //       "let": {
            //         "postID": "$postMusic",
            //         //"countPost":"$postMusic"
            //       },
            //       as: "event",
            //       "pipeline": [
            //         {
            //           "$match": {
            //             "$expr": {
            //               "$and": [
            //                 {
            //                   "$in": ["$postID", "$$postID"]
            //                 },
            //                 {
            //                   "$eq": ["$eventType", "VIEW"]
            //                 },
            //                 {
            //                   "$eq": ["$event", "ACCEPT"]
            //                 }
            //               ]
            //             }
            //           }
            //         },

            //       ]
            //     }
            //   },
            //   {
            //     $project: {
            //       _id: "$kampret",
            //       email: "$event.senderParty",
            //       //countPost:"$postID"
            //     }
            //   },
            //   {
            //     $unwind: {
            //       path: "$email"
            //     }
            //   },
            //   {
            //     $group: {
            //       _id: "$email",
            //       "totEmail": {
            //         "$sum": 1
            //       },
            //       //postID:{ $push:"$postID"}
            //     }
            //   },

            //opsi 2
            {
              "$unwind":
              {
                path: "$userView"
              }
            },
            {
              "$group":
              {
                _id: "$userView",
                totEmail: {
                  "$sum": 1
                }
              }
            },

            {
              "$lookup": {
                "from": "newUserBasics",
                "as": "userbasics_data",
                "let": {
                  "local_id": "$_id"
                },
                "pipeline": [
                  {
                    "$match": {
                      "$expr": {
                        "$eq": ["$email", "$$local_id"]
                      }
                    }
                  },
                  {
                    "$project": {
                      "_id": 1,
                      "email": 1,
                      "fullName": 1,
                      "username": 1,
                      "gender": {
                        "$cond": {
                          "if": {
                            "$ne": ["$gender", null]
                          },
                          "then": {
                            "$switch": {
                              "branches": [{
                                "case": {
                                  "$or": [{
                                    "$eq": ["$gender", "Male"]
                                  }, {
                                    "$eq": ["$gender", "Laki-laki"]
                                  }, {
                                    "$eq": ["$gender", "MALE"]
                                  }]
                                },
                                "then": "FEMALE"
                              }, {
                                "case": {
                                  "$or": [{
                                    "$eq": ["$gender", " Perempuan"]
                                  }, {
                                    "$eq": ["$gender", "Perempuan"]
                                  }, {
                                    "$eq": ["$gender", "PEREMPUAN"]
                                  }, {
                                    "$eq": ["$gender", "FEMALE"]
                                  }, {
                                    "$eq": ["$gender", " FEMALE"]
                                  }]
                                },
                                "then": "MALE"
                              }, {
                                "case": {
                                  "$or": [{
                                    "$eq": ["$gender", null]
                                  }]
                                },
                                "then": "OTHER"
                              }],
                              "default": "OTHER"
                            }
                          },
                          "else": "OTHER"
                        }
                      },
                      "age": {
                        "$cond": {
                          "if": {
                            "$and": ["$dob", {
                              "$ne": ["$dob", ""]
                            }]
                          },
                          "then": {
                            "$toInt": {
                              "$divide": [{
                                "$subtract": [new Date(), {
                                  "$toDate": "$dob"
                                }]
                              }, 31536000000]
                            }
                          },
                          "else": 0
                        }
                      },
                      "ageQualication": {
                        "$switch": {
                          "branches": [{
                            "case": {
                              "$and": [{
                                "$gte": [{
                                  "$cond": {
                                    "if": {
                                      "$and": ["$dob", {
                                        "$ne": ["$dob", ""]
                                      }]
                                    },
                                    "then": {
                                      "$toInt": {
                                        "$divide": [{
                                          "$subtract": [new Date(), {
                                            "$toDate": "$dob"
                                          }]
                                        }, 31536000000]
                                      }
                                    },
                                    "else": 0
                                  }
                                }, 1]
                              }, {
                                "$lte": [{
                                  "$cond": {
                                    "if": {
                                      "$and": ["$dob", {
                                        "$ne": ["$dob", ""]
                                      }]
                                    },
                                    "then": {
                                      "$toInt": {
                                        "$divide": [{
                                          "$subtract": [new Date(), {
                                            "$toDate": "$dob"
                                          }]
                                        }, 31536000000]
                                      }
                                    },
                                    "else": 0
                                  }
                                }, 14]
                              }]
                            },
                            "then": "< 14 Tahun"
                          }, {
                            "case": {
                              "$and": [{
                                "$gte": [{
                                  "$cond": {
                                    "if": {
                                      "$and": ["$dob", {
                                        "$ne": ["$dob", ""]
                                      }]
                                    },
                                    "then": {
                                      "$toInt": {
                                        "$divide": [{
                                          "$subtract": [new Date(), {
                                            "$toDate": "$dob"
                                          }]
                                        }, 31536000000]
                                      }
                                    },
                                    "else": 0
                                  }
                                }, 14]
                              }, {
                                "$lte": [{
                                  "$cond": {
                                    "if": {
                                      "$and": ["$dob", {
                                        "$ne": ["$dob", ""]
                                      }]
                                    },
                                    "then": {
                                      "$toInt": {
                                        "$divide": [{
                                          "$subtract": [new Date(), {
                                            "$toDate": "$dob"
                                          }]
                                        }, 31536000000]
                                      }
                                    },
                                    "else": 0
                                  }
                                }, 24]
                              }]
                            },
                            "then": "14 - 24 Tahun"
                          }, {
                            "case": {
                              "$and": [{
                                "$gte": [{
                                  "$cond": {
                                    "if": {
                                      "$and": ["$dob", {
                                        "$ne": ["$dob", ""]
                                      }]
                                    },
                                    "then": {
                                      "$toInt": {
                                        "$divide": [{
                                          "$subtract": [new Date(), {
                                            "$toDate": "$dob"
                                          }]
                                        }, 31536000000]
                                      }
                                    },
                                    "else": 0
                                  }
                                }, 25]
                              }, {
                                "$lte": [{
                                  "$cond": {
                                    "if": {
                                      "$and": ["$dob", {
                                        "$ne": ["$dob", ""]
                                      }]
                                    },
                                    "then": {
                                      "$toInt": {
                                        "$divide": [{
                                          "$subtract": [new Date(), {
                                            "$toDate": "$dob"
                                          }]
                                        }, 31536000000]
                                      }
                                    },
                                    "else": 0
                                  }
                                }, 35]
                              }]
                            },
                            "then": "24 - 35 Tahun"
                          }, {
                            "case": {
                              "$and": [{
                                "$gte": [{
                                  "$cond": {
                                    "if": {
                                      "$and": ["$dob", {
                                        "$ne": ["$dob", ""]
                                      }]
                                    },
                                    "then": {
                                      "$toInt": {
                                        "$divide": [{
                                          "$subtract": [new Date(), {
                                            "$toDate": "$dob"
                                          }]
                                        }, 31536000000]
                                      }
                                    },
                                    "else": 0
                                  }
                                }, 35]
                              }, {
                                "$lte": [{
                                  "$cond": {
                                    "if": {
                                      "$and": ["$dob", {
                                        "$ne": ["$dob", ""]
                                      }]
                                    },
                                    "then": {
                                      "$toInt": {
                                        "$divide": [{
                                          "$subtract": [new Date(), {
                                            "$toDate": "$dob"
                                          }]
                                        }, 31536000000]
                                      }
                                    },
                                    "else": 0
                                  }
                                }, 44]
                              }]
                            },
                            "then": "35 - 44 Tahun"
                          }, {
                            "case": {
                              "$gt": [{
                                "$cond": {
                                  "if": {
                                    "$and": ["$dob", {
                                      "$ne": ["$dob", ""]
                                    }]
                                  },
                                  "then": {
                                    "$toInt": {
                                      "$divide": [{
                                        "$subtract": [new Date(), {
                                          "$toDate": "$dob"
                                        }]
                                      }, 31536000000]
                                    }
                                  },
                                  "else": 0
                                }
                              }, 43]
                            },
                            "then": "> 44 Tahun"
                          }],
                          "default": "OTHER"
                        }
                      },
                      "userInterests_array": {
                        "$map": {
                          "input": {
                            "$map": {
                              "input": "$userInterests",
                              "in": {
                                "$arrayElemAt": [{
                                  "$objectToArray": "$$this"
                                }, 1]
                              }
                            }
                          },
                          "in": "$$this.v"
                        }
                      },
                      "statesName": 1
                    }
                  },
                  {
                    "$lookup": {
                      "from": "interests_repo",
                      "localField": "userInterests_array",
                      "foreignField": "_id",
                      "as": "interests"
                    }
                  },
                  // {
                  //   "$lookup": {
                  //     "from": "areas",
                  //     "as": "areas",
                  //     "let": {
                  //       "local_id": "$states.$id"
                  //     },
                  //     "pipeline": [
                  //       {
                  //         "$match": {
                  //           "$expr": {
                  //             "$eq": ["$_id", "$$local_id"]
                  //           }
                  //         }
                  //       }
                  //     ]
                  //   }
                  // }
                ]
              },

            },
            {
              "$project": {
                _id: "$kampret",
                email: "$_id",
                totEmail: 1,
                "senderParty": 1,
                "gender": {
                  "$ifNull": [{
                    "$let": {
                      "vars": {
                        "tmp": {
                          "$arrayElemAt": ["$userbasics_data", 0]
                        }
                      },
                      "in": "$$tmp.gender"
                    }
                  }, "OTHER"]
                },
                "ageQualication": {
                  "$ifNull": [{
                    "$let": {
                      "vars": {
                        "tmp": {
                          "$arrayElemAt": ["$userbasics_data", 0]
                        }
                      },
                      "in": "$$tmp.ageQualication"
                    }
                  }, "OTHER"]
                },
                "interest": {
                  "$map": {
                    "input": {
                      "$map": {
                        "input": {
                          "$let": {
                            "vars": {
                              "tmp": {
                                "$arrayElemAt": ["$userbasics_data", 0]
                              }
                            },
                            "in": "$$tmp.interests"
                          }
                        },
                        "in": {
                          "$arrayElemAt": [{
                            "$objectToArray": "$$this"
                          }, 1]
                        }
                      }
                    },
                    "in": "$$this.v"
                  }
                },
                "areas": {
                  "$ifNull":
                    [
                      {
                        "$arrayElemAt":
                          [
                            "$userbasics_data.statesName", 0
                          ]
                      },
                      "OTHER"
                    ]
                }
              }
            }
          ],

        }
      },
      {
        $project: {
          _id: "rere",
          posted: 1,
          user: 1,

        }
      },
      {
        "$unwind": {
          "path": "$posted"
        }
      },
      {
        "$facet": {
          "wilayah": [

            {
              "$unwind": {
                "path": "$user"
              }
            },
            {
              "$group": {
                "_id": "$user.areas",
                "count": {
                  "$sum": 1,//"$user.totEmail"
                },
                //tot:{ $push: "$user.totEmail"},
                //emaik:{ $push: "$user.email"}
              }
            }
          ],
          "gender": [{
            "$unwind": {
              "path": "$user"
            }
          },
          {
            "$group": {
              "_id": "$user.gender",
              "count": {
                "$sum": 1
              },
              //tot:{ $push: "$user.totEmail"}
            }
          }
          ],
          "age": [
            {
              "$unwind": {
                "path": "$user"
              }
            },
            {
              "$group": {
                "_id": "$user.ageQualication",
                "count": {
                  "$sum": 1,//"$user.totEmail"
                },
                //tot:{ $push: "$user.totEmail"}
              }
            }
          ],
          "view": [
            {
              "$unwind": {
                "path": "$user"
              }
            },
            {
              "$project": {
                "_id": "$user.email",
                "count": {
                  "$sum": 1
                },
                //tot:{ $push: "$user.totEmail"}
              }
            },
            {
              $group: {
                _id: "total user",
                "count": {
                  "$sum": "$count"
                },
              }
            }
          ],
          "used": [
            {
              "$unwind": {
                "path": "$posted"
              }
            },
            {
              "$project": {
                "_id": "$posted._id",
                "count": "$posted.postID",
                //tot:{ $push: "$user.totEmail"}
              }
            }
          ]
        }
      },
      {
        $project: {
          wilayah: 1,
          gender: 1,
          age: 1,
          view: {
            "$let": {
              "vars": {
                "tmp": {
                  "$arrayElemAt": ["$view", 0]
                }
              },
              "in": "$$tmp.count"
            }
          },
          used: {
            "$let": {
              "vars": {
                "tmp": {
                  "$arrayElemAt": ["$used", 0]
                }
              },
              "in": "$$tmp.count"
            }
          },
        }

      }
    ]);

    return result
  }

  async findcontenbuy(postID: string) {
    const query = await this.loaddata.aggregate([
      { $match: { postID: postID } },
      {
        $addFields: {
          salePrice: { $cmp: ["$saleAmount", 0] }

        },
      },
      {
        $lookup: {
          from: 'newUserBasics',
          localField: 'email',
          foreignField: 'email',
          as: 'userbasics_data',
        },
      },

      {
        $project: {
          user: { $arrayElemAt: ['$userbasics_data', 0] },

          insight_id: '$user.insight.$id',
          fullName: '$user.fullName',
          username: '$user.username',
          createdAt: '$createdAt',
          updatedAt: '$updatedAt',
          postID: '$postID',
          email: '$email',
          postType: '$postType',
          description: '$description',
          title: '$description',
          active: '$active',
          metadata: '$metadata',
          location: '$location',
          tags: '$tags',
          likes: '$likes',
          shares: '$shares',
          comments: '$comments',
          isOwned: '$isOwned',
          views: '$views',
          isPostPrivate: '$user.isPostPrivate',
          privacy: {
            isPostPrivate: '$user.isPostPrivate',
            isCelebrity: '$user.isCelebrity',
            isPrivate: '$user.isPrivate',
          },
          isViewed:
          {
            $cond: { if: { $eq: ["$views", 0] }, then: false, else: true }
          },
          allowComments: '$allowComments',
          certified: '$certified',
          saleLike: {
            $cond: { if: { $eq: ["$saleLike", -1] }, then: false, else: "$saleLike" }
          },
          saleView: {
            $cond: { if: { $eq: ["$saleView", -1] }, then: false, else: "$saleView" }
          },
          saleAmount: {
            $cond: { if: { $eq: ["$salePrice", -1] }, then: 0, else: "$saleAmount" }
          },
          monetize: {
            $cond: { if: { $eq: ["$salePrice", -1] }, then: false, else: true }
          },
          mediaSource: {
            "$arrayElemAt": [
              "$mediaSource", 0
            ]
          }
        }
      },
      {
        $project: {
          user: "$user",
          insight_id: '$user.insight.$id',
          fullName: '$user.fullName',
          username: '$user.username',
          createdAt: '$createdAt',
          updatedAt: '$updatedAt',
          postID: '$postID',
          email: '$email',
          postType: '$postType',
          description: '$description',
          title: '$description',
          active: '$active',
          metadata: '$metadata',
          location: '$location',
          tags: '$tags',
          likes: '$likes',
          shares: '$shares',
          comments: '$comments',
          isOwned: '$isOwned',
          views: '$views',
          isPostPrivate: '$user.isPostPrivate',
          privacy: {
            isPostPrivate: '$user.isPostPrivate',
            isCelebrity: '$user.isCelebrity',
            isPrivate: '$user.isPrivate',
          },
          isViewed: '$isViewed',
          allowComments: '$allowComments',
          certified: '$certified',
          saleLike: '$saleLike',
          saleView: '$saleView',
          saleAmount: '$saleAmount',
          monetize: '$monetize',
          refe: '$refs.ref',
          mediaSource: "$mediaSource"
        }
      },
      {
        "$addFields":
        {
          'cleanUri':
          {
            "$replaceOne":
            {
              input: "$mediaSource.mediaUri",
              find: "_0001.jpeg",
              replacement: ""
            }
          },
        }
      },
      {
        $project: {
          fullName: '$fullName',
          username: '$username',
          createdAt: '$createdAt',
          updatedAt: '$updatedAt',
          postID: '$postID',
          email: '$email',
          postType: '$postType',
          description: '$description',
          title: '$description',
          active: '$active',
          metadata: '$metadata',
          location: '$location',
          tags: '$tags',
          likes: '$likes',
          shares: '$shares',
          comments: '$comments',
          isOwned: '$isOwned',
          views: '$views',
          privacy: '$privacy',
          isViewed: '$isViewed',
          allowComments: '$allowComments',
          certified: '$certified',
          saleLike: '$saleLike',
          saleView: '$saleView',
          saleAmount: '$saleAmount',
          monetize: '$monetize',
          rotate:
          {
            "$ifNull":
              [
                "$mediaSource.rotate",
                null
              ]
          },
          mediaBasePath:
          {
            "$ifNull":
              [
                "$mediaSource.mediaBasePath",
                null
              ]
          },
          mediaUri:
          {
            "$ifNull":
              [
                "$mediaSource.mediaUri",
                null
              ]
          },
          mediaType:
          {
            "$ifNull":
              [
                "$mediaSource.mediaType",
                null
              ]
          },
          mediaThumbEndpoint:
          {
            "$ifNull":
              [
                "$mediaSource.mediaThumbEndpoint",
                {
                  "$concat":
                    [
                      "/thumb/",
                      "$cleanUri"
                    ]
                }
              ]
          },
          mediaEndpoint:
          {
            "$ifNull":
              [
                "$mediaSource.mediaEndpoint",
                {
                  "$cond":
                  {
                    if:
                    {
                      "$eq":
                        [
                          "$postType", "pict"
                        ]
                    },
                    then:
                    {
                      "$concat":
                        [
                          "/pict/",
                          "$cleanUri"
                        ]
                    },
                    else:
                    {
                      "$concat":
                        [
                          "/stream/",
                          "$cleanUri"
                        ]
                    }
                  }
                }
              ]
          },
          mediaThumbUri:
          {
            "$ifNull":
              [
                "$mediaSource.mediaThumbUri",
                null
              ]
          }

          // belum diganti!!
          // insight: {
          //   shares: '$insights.shares',
          //   followers: '$insights.followers',
          //   comments: '$insights.comments',
          //   followings: '$insights.followings',
          //   reactions: '$insights.reactions',
          //   posts: '$insights.posts',
          //   views: '$insights.views',
          //   likes: '$insights.likes'
          // },
          // avatar: {
          //   mediaBasePath: '$profilpict.mediaBasePath',
          //   mediaUri: '$profilpict.mediaUri',
          //   mediaType: '$profilpict.mediaType',
          //   mediaEndpoint: '$profilpict.fsTargetUri',
          //   medreplace: { $replaceOne: { input: "$profilpict.mediaUri", find: "_0001.jpeg", replacement: "" } },

          // },

        }
      },

    ]);
    return query;
  }

  async updateNoneActive(email: string) {
    this.loaddata.updateMany(
      {
        email: email,
      },
      {
        $set: {
          "active": false,
          "email": email + '_noneactive'
        }
      },
      function (err, docs) {
        if (err) {
          //console.log(err);
        } else {
          //console.log(docs);
        }
      },
    );
  }

  async getUserPostBoost(pageNumber: number, pageRow: number, headers: any) {
    var timestamps_start = await this.utilService.getDateTimeString();
    var fullurl = headers.host + "/api/posts/getboost/v2";
    var setdata = {
      "pageNumber": pageNumber,
      "pageRow": pageRow,
    };
    var reqbody = JSON.parse(JSON.stringify(setdata));

    var token = headers['x-auth-token'];
    var auth = JSON.parse(Buffer.from(token.split('.')[1], 'base64').toString());
    if (headers['x-auth-user'] == undefined || headers['x-auth-token'] == undefined) {
      await this.errorHandler.generateNotAcceptableException(
        'Unauthorized',
      );
    }
    if (!(await this.utilService.validasiTokenEmail(headers))) {
      await this.errorHandler.generateNotAcceptableException(
        'Unabled to proceed email header dan token not match',
      );
    }

    let res = new PostResponseApps();
    res.response_code = 202;
    let pd = await this.doGetUserPostBoost2(pageNumber, pageRow, auth.email);
    res.data = pd;

    var timestamps_end = await this.utilService.getDateTimeString();
    this.logapiSS.create2(fullurl, timestamps_start, timestamps_end, auth.email, null, null, reqbody);

    return res;
  }

  private async doGetUserPostBoost2(pageNumber: number, pageRow: number, whoami: string): Promise<PostData[]> {
    // var currentDateString = await this.utilService.getDateTimeISOString();
    // var currentDate = new Date(currentDateString);
    // var currentDateFormat = currentDate.toISOString().split('T')[0] + " " + currentDate.toISOString().split('T')[1].split('.')[0];
    var perPage = Math.max(0, pageRow), page = Math.max(0, pageNumber);

    const query = await this.loaddata.aggregate([
      {
        "$match":
        {
          "$and":
            [
              {
                email: whoami
              },
              {
                active: true
              },
              {
                boosted:
                {
                  "$exists": true
                }
              },
              {
                "$expr":
                {
                  "$gt":
                    [
                      {
                        "$size": "$boosted"
                      },
                      0
                    ]
                }
              }
            ]
        }
      },
      {
        $lookup:
        {
          from: 'newUserBasics',
          localField: 'email',
          foreignField: 'email',
          as: 'basic_data',
        },
      },
      {
        $lookup:
        {
          from: 'mediamusic',
          localField: 'musicId',
          foreignField: '_id',
          as: 'music_data',
        },
      },
      {
        $set:
        {
          nowDate:
          {
            "$dateToString":
            {
              "format": "%Y-%m-%d %H:%M:%S",
              "date":
              {
                $add:
                  [
                    new Date(), 25200000
                  ]
              }
            }
          }
        }
      },
      {
        "$addFields":
        {
          "tempmediasource":
          {
            "$arrayElemAt":
              [
                "$mediaSource", 0
              ]
          },
          "tempinterest": "$category.$id",
          "tempboost":
          {
            "$arrayElemAt":
              [
                "$boosted", 0
              ]
          },
          "tempuser":
          {
            "$arrayElemAt":
              [
                "$basic_data", 0
              ]
          },
          "tempmusic":
          {
            "$ifNull":
              [
                {
                  "$arrayElemAt":
                    [
                      "$music_data", 0
                    ]
                },
                {}
              ]
          }
        }
      },
      {
        $lookup:
        {
          from: 'interests',
          as: 'cats',
          let:
          {
            catid: "$tempinterest"
          },
          pipeline:
            [
              {
                "$match":
                {
                  "$expr":
                  {
                    "$in":
                      [
                        "$_id", "$$catid"
                      ]
                  }
                }
              }
            ]
        },
      },
      {
        $lookup:
        {
          from: 'contentevents',
          as: "isLike",
          let:
          {
            email: "$email",
            post: "$postID"
          },
          pipeline:
            [
              {
                "$match":
                {
                  "$and":
                    [
                      {
                        "$expr":
                        {
                          "$eq":
                            [
                              "$email", "$$email"
                            ]
                        }
                      },
                      {
                        "$expr":
                        {
                          "$eq":
                            [
                              "$postID", "$$post"
                            ]
                        }
                      },
                      {
                        "active": true
                      },
                      {
                        "eventType": "LIKE"
                      },
                      {
                        "event": "DONE"
                      }
                    ]
                }
              }
            ]
        }
      },
      {
        $lookup:
        {
          from: 'contentevents',
          as: "isView",
          let:
          {
            email: "$email",
            post: "$postID"
          },
          pipeline:
            [
              {
                "$match":
                {
                  "$and":
                    [
                      {
                        "$expr":
                        {
                          "$eq":
                            [
                              "$email", "$$email"
                            ]
                        }
                      },
                      {
                        "$expr":
                        {
                          "$eq":
                            [
                              "$postID", "$$post"
                            ]
                        }
                      },
                      {
                        "active": true
                      },
                      {
                        "eventType": "VIEW"
                      },
                      {
                        "event": "DONE"
                      }
                    ]
                }
              }
            ]
        }
      },
      {
        $lookup:
        {
          from: 'contentevents',
          as: "isLike",
          let:
          {
            email: "$email",
            post: "$postID"
          },
          pipeline:
            [
              {
                "$match":
                {
                  "$and":
                    [
                      {
                        "$expr":
                        {
                          "$eq":
                            [
                              "$email", "$$email"
                            ]
                        }
                      },
                      {
                        "$expr":
                        {
                          "$eq":
                            [
                              "$postID", "$$post"
                            ]
                        }
                      },
                      {
                        "active": true
                      },
                      {
                        "eventType": "LIKE"
                      },
                      {
                        "event": "DONE"
                      }
                    ]
                }
              }
            ]
        }
      },
      {
        "$project":
        {
          "active": 1,
          "allowComments": 1,
          "certified": 1,
          "createdAt": 1,
          "updatedAt": 1,
          "description": 1,
          "email": 1,
          "boosted": 1,
          "boostDate": "$tempboost.boostDate",
          "isBoost": 1,
          "boostJangkauan":
          {
            "$size": "$tempboost.boostViewer"
          },
          "statusBoost":
          {
            $switch:
            {
              branches:
                [
                  {
                    case:
                    {
                      $and:
                        [
                          {
                            $lte:
                              [
                                "$tempboost.boostSession.start", "$nowDate"
                              ]
                          },
                          {
                            $gte:
                              [
                                "$tempboost.boostSession.end", "$nowDate"
                              ]
                          }
                        ]
                    },
                    then: "BERLANGSUNG"
                  },
                  {
                    case:
                    {
                      $and:
                        [
                          {
                            $gte:
                              [
                                "$tempboost.boostSession.start", "$nowDate"
                              ]
                          },
                          {
                            $gte:
                              [
                                "$tempboost.boostSession.end", "$nowDate"
                              ]
                          }
                        ]
                    },
                    then: "AKAN DATANG"
                  },
                ],
              "default": "SELESAI"
            }
          },
          "reportedStatus": 1,
          "username": "$tempuser.username",
          "avatar":
          {
            "mediaBasePath":
            {
              "$ifNull":
                [
                  "$tempuser.mediaBasePath",
                  null,
                ]
            },
            "mediaType":
            {
              "$ifNull":
                [
                  "$tempuser.mediaType",
                  null,
                ]
            },
            "mediaUri":
            {
              "$ifNull":
                [
                  "$tempuser.mediaUri",
                  null,
                ]
            },
            "mediaEndpoint":
            {
              "$ifNull":
                [
                  "$tempuser.mediaEndpoint",
                  null,
                ]
            },
          },
          "location": 1,
          "visibility": 1,
          "postID": 1,
          "postType": 1,
          "saleAmount": 1,
          "saleLike": 1,
          "saleView": 1,
          "cats": "$cats",
          "privacy":
          {
            "isPostPrivate": "$tempuser.isPostPrivate",
            "isPrivate": "$tempuser.isPrivate",
            "isCelebrity": "$tempuser.isCelebrity"
          },
          "music":
          {
            "$cond":
            {
              if:
              {
                "$eq":
                  [
                    "$tempmusic", {}
                  ]
              },
              then: {},
              else:
              {
                _id: "$tempmusic._id",
                musicTitle: "$tempmusic.musicTitle",
                artistName: "$tempmusic.artistName",
                albumName: "$tempmusic.albumName",
                apsaraMusic: "$tempmusic.apsaraMusic",
                apsaraThumnail: "$tempmusic.apsaraThumnail"
              }
            }
          },
          "isApsara":
          {
            "$ifNull":
              [
                "$tempmediasource.apsara",
                false
              ]
          },
          "apsaraId":
          {
            "$ifNull":
              [
                "$tempmediasource.apsaraId",
                ""
              ]
          },
          "mediaEndpoint":
          {
            "$ifNull":
              [
                "$tempmediasource.mediaEndpoint",
                null
              ]
          },
          "mediaUri":
          {
            "$ifNull":
              [
                "$tempmediasource.mediaUri",
                null
              ]
          },
          "mediaType":
          {
            "$ifNull":
              [
                "$tempmediasource.mediaType",
                null
              ]
          },
          "isViewed":
          {
            "$cond":
            {
              if:
              {
                "$eq":
                  [
                    "$isView",
                    []
                  ]
              },
              then: false,
              else: true
            }
          },
          "isLiked":
          {
            "$cond":
            {
              if:
              {
                "$eq":
                  [
                    "$isLike",
                    []
                  ]
              },
              then: false,
              else: true
            }
          },
        }
      },
      {
        $sort:
        {
          status: -1,
          boostDate: -1
        }
      },
      {
        $skip: (perPage * page)
      },
      {
        $limit: perPage
      },
      {
        "$project":
        {
          "active": 1,
          "allowComments": 1,
          "certified": 1,
          "createdAt": 1,
          "updatedAt": 1,
          "description": 1,
          "email": 1,
          "boosted": 1,
          "boostDate": 1,
          "isBoost": 1,
          "boostJangkauan": 1,
          "statusBoost": 1,
          "reportedStatus": 1,
          "username": 1,
          "avatar": 1,
          "location": 1,
          "visibility": 1,
          "postID": 1,
          "postType": 1,
          "saleAmount": 1,
          "saleLike": 1,
          "saleView": 1,
          "cats": 1,
          "privacy": 1,
          "music": 1,
          "isApsara": 1,
          "apsaraId": 1,
          "mediaEndpoint": 1,
          "mediaUri": 1,
          "mediaType": 1,
          "isViewed": 1,
          "isLiked": 1
        }
      }
    ]);

    // console.log(query);

    var listdata = [];
    var listmusic = [];
    var tempresult = null;
    var tempdata = null;
    for (var i = 0; i < query.length; i++) {
      tempdata = query[i];
      if (tempdata.isApsara == true) {
        listdata.push(tempdata.apsaraId);
      }
      else {
        listdata.push(undefined);
      }

      var getmusicapsara = null;
      try {
        getmusicapsara = tempdata.music.apsaraThumnail;
      }
      catch (e) {
        getmusicapsara = undefined;
      }
      listmusic.push(getmusicapsara);
    }

    //console.log(listdata);
    var apsaraimagedata = await this.postContentService.getImageApsara(listdata);
    // console.log(apsaraimagedata);
    // console.log(resultdata.ImageInfo[0]);
    tempresult = apsaraimagedata.ImageInfo;
    for (var i = 0; i < query.length; i++) {
      for (var j = 0; j < tempresult.length; j++) {
        if (tempresult[j].ImageId == query[i].apsaraId) {
          query[i].apsaraThumbId = tempresult[j].apsaraThumbId;
        }
      }
      if (query[i].apsara == false && (query[i].mediaType == "image" || query[i].mediaType == "images")) {
        query[i].apsaraThumbId = '/thumb/' + query[i].postID;
      }
    }

    var apsaravideodata = await this.postContentService.getVideoApsara(listdata);
    // console.log(apsaravideodata);
    // console.log(resultdata.ImageInfo[0]);
    tempresult = apsaravideodata.VideoList;
    for (var i = 0; i < query.length; i++) {
      for (var j = 0; j < tempresult.length; j++) {
        if (tempresult[j].VideoId == query[i].apsaraId) {
          query[i].mediaThumbEndpoint = tempresult[j].CoverURL;
        }
      }
      if (query[i].apsara == false && query[i].mediaType == "video") {
        query[i].mediaThumbEndpoint = '/thumb/' + query[i].postID;
      }
    }

    // console.log(listmusic);
    var apsaramusic = await this.musicSS.getImageApsara(listmusic);
    // var setutil = require('util');
    // console.log(setutil.inspect(apsaramusic, { depth:null, showHidden:false }));
    tempresult = apsaramusic.ImageInfo;
    for (var i = 0; i < query.length; i++) {
      try {
        for (var j = 0; j < tempresult.length; j++) {
          if (tempresult[j].ImageId == query[i].music.apsaraThumnail) {
            query[i].music.apsaraThumnailUrl = tempresult[j].URL;
          }
        }
        if (query[i].apsara == false && query[i].mediaType == "video") {
          query[i].music.apsaraThumnailUrl = null;
        }
      }
      catch (e) {
        query[i].music.apsaraThumnailUrl = null;
      }
    }

    return query;
  }

  async getPostByDate(startdate: string) {
    var before = new Date(startdate).toISOString().split("T")[0];
    var input = new Date();
    input.setDate(input.getDate() + 1);
    var today = new Date(input).toISOString().split("T")[0];
    //kalo error, coba ganti jadi set dan jadi object
    var query = await this.loaddata.aggregate([
      {
        "$match":
        {
          createdAt:
          {
            "$gte": before,
            "$lte": today
          },
        }
      },
      {
        "$project":
        {
          createdAt:
          {
            "$substr":
              [
                "$createdAt", 0, 10
              ]
          }
        }
      },
      {
        "$group":
        {
          _id:
          {
            "$dateFromString":
            {
              "format": "%Y-%m-%d",
              "dateString": "$createdAt"

            }
          },
          totalperhari:
          {
            "$sum": 1
          }
        }
      },
      {
        "$project":
        {
          _id: 1,
          totalperhari: 1
        }
      },
      {
        "$unwind":
        {
          path: "$_id"
        }
      },
      {
        "$sort":
        {
          _id: 1
        }
      },
      {
        "$group":
        {
          _id: null,
          total:
          {
            "$sum": "$totalperhari"
          },
          resultdata:
          {
            "$push":
            {
              _id:
              {
                "$substr":
                  [
                    {
                      "$toString": "$_id"
                    }, 0, 10
                  ]
              },
              totaldata: "$totalperhari"
            }
          }
        }
      }
    ]);

    return query;
  }

  async getAllSertifikasiChart() {
    var query = await this.loaddata.aggregate([
      {
        "$project":
        {
          certified:
          {
            "$ifNull":
              [
                "$certified", false
              ]
          }
        }
      },
      {
        "$group":
        {
          _id: "$certified",
          totaldata:
          {
            "$sum": 1
          },
        }
      },
      {
        "$project":
        {
          _id:
          {
            "$cond":
            {
              if:
              {
                "$eq": ["$_id", true]
              },
              then: "BERSERTIFIKAT",
              else: "TIDAK BERSERTIFIKAT"
            }
          },
          totaldata: 1
        }
      },
      {
        "$unwind":
        {
          path: "$_id"
        }
      },
      {
        "$group":
        {
          _id: null,
          totaldata:
          {
            "$sum": "$totaldata"
          },
          resultdata:
          {
            "$push":
            {
              _id: "$_id",
              total: "$totaldata"
            }
          }
        }
      },
      {
        "$unwind":
        {
          path: "$resultdata"
        }
      },
      {
        "$group":
        {
          _id: null,
          data:
          {
            "$push":
            {
              id: "$resultdata._id",
              total: "$resultdata.total",
              persentase:
              {
                $multiply:
                  [
                    {
                      $divide:
                        [
                          "$resultdata.total", "$totaldata"
                        ]
                    }, 100
                  ]
              }
            }
          }
        }
      }
    ]);

    return query;
  }

  async analiticPost(startdate: string, enddate: string) {
    try {
      var currentdate = new Date(new Date(enddate).setDate(new Date(enddate).getDate() + 1));

      var dateend = currentdate.toISOString();

      var dt = dateend.substring(0, 10);
    } catch (e) {
      dt = "";
    }
    var query = await this.loaddata.aggregate(
      [
        {
          "$match":
          {
            createdAt:
            {
              "$gte": startdate,
              "$lte": dt
            },
            postType:
            {
              "$in": ["pict", "vid", "diary", "story"]
            }
          }
        },
        {
          "$project":
          {
            createdAt:
            {
              "$substr":
                [
                  "$createdAt", 0, 10
                ]
            },
            postType: 1
          }
        },

        {
          "$group":
          {
            _id: "$createdAt",
            pict:
            {
              "$sum":
              {
                "$switch":
                {
                  branches:
                    [
                      {
                        "case":
                        {
                          "$eq": ["$postType", "pict"]
                        },
                        "then": 1
                      }
                    ],
                  "default": 0
                }
              }
            },
            vid:
            {
              "$sum":
              {
                "$switch":
                {
                  branches:
                    [
                      {
                        "case":
                        {
                          "$eq": ["$postType", "vid"]
                        },
                        "then": 1
                      }
                    ],
                  "default": 0
                }
              }
            },
            story:
            {
              "$sum":
              {
                "$switch":
                {
                  branches:
                    [
                      {
                        "case":
                        {
                          "$eq": ["$postType", "story"]
                        },
                        "then": 1
                      }
                    ],
                  "default": 0
                }
              }
            },
            diary:
            {
              "$sum":
              {
                "$switch":
                {
                  branches:
                    [
                      {
                        "case":
                        {
                          "$eq": ["$postType", "diary"]
                        },
                        "then": 1
                      }
                    ],
                  "default": 0
                }
              }
            },
          }
        },

        {
          $project: {
            _id: 0,
            date: "$_id",
            diary: "$diary",
            pict: "$pict",
            vid: "$vid",
            story: "$story"
          }
        },

        {
          "$sort":
          {
            date: 1
          }
        }
      ]
    );
    return query;

  }

  async analitycview(startdate: string, enddate: string) {
    try {
      var currentdate = new Date(new Date(enddate).setDate(new Date(enddate).getDate() + 1));

      var dateend = currentdate.toISOString();

      var dt = dateend.substring(0, 10);
    } catch (e) {
      dt = "";
    }
    var query = await this.loaddata.aggregate([
      {
        "$match":
        {
          createdAt: {
            $gte: startdate,
            $lte: dt

          }

        }
      },
      {
        "$project":
        {
          createdAt:
          {
            "$substr":
              [
                "$createdAt",
                0,
                10
              ]
          },
          views: 1,
          likes: 1,
          comments: 1
        }
      },
      {
        "$group":
        {
          _id: "$createdAt",
          views:
          {
            "$sum": "$views"

          },
          likes:
          {
            "$sum": "$likes"

          },
          comments:
          {
            "$sum": "$comments"

          },

        }
      },
      {
        $project: {
          _id: 0,
          date: "$_id",
          views: "$views",
          likes: "$likes",
          comments: "$comments"
        }
      },
      {
        "$sort":
        {
          date: 1
        }
      }
    ]);
    return query;
  }

  async boostconsolebawah2(email: string, startdate: string, enddate: string, type: string, sessionId: any[], statusPengajuan: any[], descending: boolean, page: number, limit: number) {
    var pipeline = [];
    var order = null;
    try {
      var currentdate = new Date(new Date(enddate).setDate(new Date(enddate).getDate() + 1));

      var dateend = currentdate.toISOString();

      var dt = dateend.substring(0, 10);
    } catch (e) {
      dt = "";
    }

    var arrsessionId = [];
    var idsessionId = null;
    const mongoose = require('mongoose');
    var ObjectId = require('mongodb').ObjectId;
    var lengsessionId = null;

    try {
      lengsessionId = sessionId.length;
    } catch (e) {
      lengsessionId = 0;
    }
    if (lengsessionId > 0) {

      for (let i = 0; i < lengsessionId; i++) {
        let idses = sessionId[i];
        idsessionId = mongoose.Types.ObjectId(idses);
        arrsessionId.push(idsessionId);
      }
    }

    if (descending === true) {
      order = -1;
    } else {
      order = 1;
    }
    if (email && email !== undefined) {
      pipeline.push(
        {

          $match: {

            email: email
          }
        },
      );
    }

    pipeline.push(
      {

        $match: {
          $and: [{
            boosted: {
              $ne: []
            }
          }, {
            boosted: {
              $ne: null
            }
          }],
          active: true,

        }
      },
      {
        $set: {
          "datenow":
          {
            "$dateToString": {
              "format": "%Y-%m-%d %H:%M:%S",
              "date": {
                $add: [new Date(), + 25200000]
              }
            }
          }
        }
      },
      {
        $project: {
          createdAt: 1,
          updatedAt: 1,
          postID: 1,
          email: 1,
          postType: 1,
          description: 1,
          title: 1,
          active: 1,
          datenow: 1,

          jangkauan: {
            $size: {
              $arrayElemAt: ['$boosted.boostViewer', 0]
            },

          },
          typeboost: {
            $arrayElemAt: ['$boosted.type', 0]
          },
          start: {
            $arrayElemAt: ['$boosted.boostSession.start', 0]
          },
          end: {
            $arrayElemAt: ['$boosted.boostSession.end', 0]
          },
          boostSessionid: {
            $arrayElemAt: ['$boosted.boostSession.id', 0]
          },
          tempmedia: {
            $arrayElemAt: ['$mediaSource', 0]
          },

        }
      },
      {
        $lookup: {
          from: 'newUserBasics',
          localField: 'email',
          foreignField: 'email',
          as: 'databasic',

        },

      },
      {
        $unwind: {
          path: "$databasic",

        }
      },
      {
        $lookup: {
          from: 'boostSession',
          localField: 'boostSessionid',
          foreignField: '_id',
          as: 'boostSesidata',

        },

      },
      {
        "$lookup": {
          "from": "transactions",
          "as": "trans",
          "let": {
            "local_id": "$postID",

          },
          "pipeline": [
            {
              $match:
              {
                $expr: {
                  $eq: ['$postid', '$$local_id']
                }
              }
            },
            {
              $project: {
                iduserbuyer: 1,
                idusersell: 1,
                noinvoice: 1,
                status: 1,
                amount: 1,
                timestamp: 1,
                postid: 1
              }
            },
            {
              $match: {
                idusersell: '$databasic._id',
                status: "Success"
              }
            },

          ],

        },

      },
      {
        $project: {
          iduser: '$databasic._id',
          createdAt: 1,
          updatedAt: 1,
          postID: 1,
          postType: 1,
          email: 1,
          jangkauan: 1,
          start: 1,
          end: 1,
          typeboost: 1,
          sessionName: {
            $arrayElemAt: ['$boostSesidata.name', 0]
          },
          sessionType: {
            $arrayElemAt: ['$boostSesidata.type', 0]
          },
          sessionStart: {
            $arrayElemAt: ['$boostSesidata.start', 0]
          },
          sessionEnd: {
            $arrayElemAt: ['$boostSesidata.end', 0]
          },
          type: {
            $switch: {
              branches: [
                {
                  'case': {
                    '$eq': ['$postType', 'pict']
                  },
                  'then': "HyppePic"
                },
                {
                  'case': {
                    '$eq': ['$postType', 'vid']
                  },
                  'then': "HyppeVid"
                },
                {
                  'case': {
                    '$eq': ['$postType', 'diary']
                  },
                  'then': "HyppeDiary"
                },
                {
                  'case': {
                    '$eq': ['$postType', 'story']
                  },
                  'then': "HyppeStory"
                },

              ],
              default: ''
            }
          },
          description: 1,
          title: 1,
          active: 1,
          datenow: 1,
          trans: 1,
          boostSessionid: 1,
          tempmedia: 1,
          statusPengajuan: {
            $switch: {
              branches: [
                {
                  'case': {
                    '$lt': ['$datenow', '$start'],

                  },
                  'then': 'Dijadwalkan'
                },
                {
                  'case': {
                    $and: [
                      {
                        '$gt': ['$datenow', '$start'],

                      },
                      {
                        '$lt': ['$datenow', '$end'],

                      }
                    ]
                  },
                  'then': 'Sedang Berlangsung'
                },
                {
                  'case': {
                    '$gt': ['$datenow', '$end'],

                  },
                  'then': 'Selesai'
                },

              ],
              default: 'Dijadwalkan'
            }
          },
          keterangan:
          {
            $cond: {
              if: {

                $eq: ["$trans", []]
              },
              then: 'Belum Terjual',
              else: 'Terjual',

            }
          },
        }
      },
      {
        "$addFields":
        {
          "cleanUri":
          {
            $replaceOne:
            {
              input: "$tempmedia.mediaUri",
              find: "_0001.jpeg",
              replacement: ""
            }
          }
        }
      },
      {
        $project: {
          iduser: 1,
          createdAt: 1,
          updatedAt: 1,
          postID: 1,
          postType: 1,
          email: 1,
          type: 1,
          description: 1,
          title: 1,
          active: 1,
          jangkauan: 1,
          start: 1,
          end: 1,
          sessionName: 1,
          sessionType: 1,
          sessionStart: 1,
          sessionEnd: 1,
          statusPengajuan: 1,
          datenow: 1,
          keterangan: 1,
          typeboost: 1,
          boostSessionid: 1,
          mediaBasePath:
          {
            "$ifNull":
              [
                "$tempmedia.mediaBasePath",
                null
              ]
          },
          mediaUri:
          {
            "$ifNull":
              [
                "$tempmedia.mediaUri",
                null
              ]
          },
          mediaType:
          {
            "$ifNull":
              [
                "$tempmedia.mediaType",
                null
              ]
          },
          mediaThumbEndpoint:
          {
            "$ifNull":
              [
                "$tempmedia.mediaThumbEndpoint",
                {
                  "$concat":
                    [
                      "/thumb/",
                      "$cleanUri"
                    ]
                }
              ]
          },
          mediaEndpoint:
          {
            "$ifNull":
              [
                "$tempmedia.mediaEndpoint",
                {
                  "$cond":
                  {
                    if:
                    {
                      "$eq":
                        [
                          "$postType", "pict"
                        ]
                    },
                    then:
                    {
                      "$concat":
                        [
                          "/pict/",
                          "$cleanUri"
                        ]
                    },
                    else:
                    {
                      "$concat":
                        [
                          "/stream/",
                          "$cleanUri"
                        ]
                    }
                  }
                }
              ]
          },
          mediaThumbUri:
          {
            "$ifNull":
              [
                "$tempmedia.mediaThumbUri",
                null
              ]
          },
          apsara:
          {
            "$ifNull":
              [
                "$tempmedia.apsara",
                false
              ]
          },
          apsaraId:
          {
            "$ifNull":
              [
                "$tempmedia.apsaraId",
                false
              ]
          },

        }
      },
    );

    if (type && type !== undefined) {
      pipeline.push({
        $match: {
          typeboost: type
        }
      },);
    }
    if (statusPengajuan && statusPengajuan !== undefined) {
      pipeline.push({
        $match: {
          $or: [
            {
              statusPengajuan: {
                $in: statusPengajuan
              }
            },

          ]
        }
      },);
    }
    if (sessionId && sessionId !== undefined) {
      pipeline.push({
        $match: {
          $or: [
            {
              boostSessionid: {
                $in: arrsessionId
              }
            },

          ]
        }
      },);
    }
    if (startdate && startdate !== undefined) {
      pipeline.push({ $match: { start: { $gte: startdate } } });
    }
    if (enddate && enddate !== undefined) {
      pipeline.push({ $match: { start: { $lte: dt } } });
    }
    pipeline.push({
      $sort: {
        start: order
      },

    },);
    if (page > 0) {
      pipeline.push({ $skip: (page * limit) });
    }
    if (limit > 0) {
      pipeline.push({ $limit: limit });
    }

    var setutil = require('util');
    var query = await this.loaddata.aggregate(pipeline);

    var data = [];

    for (var i = 0; i < query.length; i++) {
      let dataconten = await this.loadApsara.getapsaraDatabase(query, i);

      data.push(dataconten[i]);
    }

    console.log(data);

    return data;

  }

  async boostlistconsole() {
    var query = await this.loaddata.aggregate([
      {
        $match: {
          $and: [{
            boosted: {
              $ne: []
            }
          }, {
            boosted: {
              $ne: null
            }
          }]
        }
      },
      {
        $facet: {
          "totalpost": [

            {
              $group: {
                _id: null,
                totalpost: {
                  $sum: 1
                }
              }
            }
          ],
          "jangkauan": [

            {
              $project: {

                view: {
                  $arrayElemAt: ["$boosted.boostViewer", 0]
                },

              }
            },
            {
              $project: {

                view: {
                  $size: '$view'
                },

              }
            },
            {
              $unwind: '$view'
            },
            {
              $group: {
                _id: null,
                "total": {
                  $sum: "$view"
                }
              }
            }
          ],
          "post": [

            {

              $match: {

                active: true
              }
            },
            {
              $project: {
                createdAt: 1,
                updatedAt: 1,
                postID: 1,
                email: 1,
                postType: 1,
                description: 1,
                title: 1,
                active: 1,
                jangkauan: {
                  $size: {
                    $arrayElemAt: ['$boosted.boostViewer', 0]
                  },

                },
                tempmedia: {
                  $arrayElemAt: ['$mediaSource', 0]
                },

              }
            },
            {
              $project: {
                createdAt: 1,
                updatedAt: 1,
                postID: 1,
                postType: 1,
                email: 1,
                jangkauan: 1,
                type: {
                  $switch: {
                    branches: [
                      {
                        'case': {
                          '$eq': ['$postType', 'pict']
                        },
                        'then': "HyppePic"
                      },
                      {
                        'case': {
                          '$eq': ['$postType', 'vid']
                        },
                        'then': "HyppeVid"
                      },
                      {
                        'case': {
                          '$eq': ['$postType', 'diary']
                        },
                        'then': "HyppeDiary"
                      },
                      {
                        'case': {
                          '$eq': ['$postType', 'story']
                        },
                        'then': "HyppeStory"
                      },

                    ],
                    default: ''
                  }
                },
                description: 1,
                title: 1,
                active: 1,
                tempmedia: 1,
              }
            },
            {
              $project: {
                refs: 1,
                idmedia: 1,
                createdAt: 1,
                updatedAt: 1,
                postID: 1,
                postType: 1,
                email: 1,
                type: 1,
                description: 1,
                title: 1,
                active: 1,
                jangkauan: 1,
                tempmedia: 1,
              }
            },
            {
              $addFields: {
                "cleanUri":
                {
                  $replaceOne:
                  {
                    input: "$tempmedia.mediaUri",
                    find: "_0001.jpeg",
                    replacement: ""
                  }
                }
              },
            },
            {
              $project: {

                createdAt: 1,
                updatedAt: 1,
                postID: 1,
                postType: 1,
                email: 1,
                type: 1,
                description: 1,
                title: 1,
                active: 1,
                jangkauan: 1,
                mediaBasePath:
                {
                  "$ifNull":
                    [
                      "$tempmedia.mediaBasePath",
                      null
                    ]
                },
                mediaUri:
                {
                  "$ifNull":
                    [
                      "$tempmedia.mediaUri",
                      null
                    ]
                },
                mediaType:
                {
                  "$ifNull":
                    [
                      "$tempmedia.mediaType",
                      null
                    ]
                },
                mediaThumbEndpoint:
                {
                  "$ifNull":
                    [
                      "$tempmedia.mediaThumbEndpoint",
                      {
                        "$concat":
                          [
                            "/thumb/",
                            "$cleanUri"
                          ]
                      }
                    ]
                },
                mediaEndpoint:
                {
                  "$ifNull":
                    [
                      "$tempmedia.mediaEndpoint",
                      {
                        "$cond":
                        {
                          if:
                          {
                            "$eq":
                              [
                                "$postType", "pict"
                              ]
                          },
                          then:
                          {
                            "$concat":
                              [
                                "/pict/",
                                "$cleanUri"
                              ]
                          },
                          else:
                          {
                            "$concat":
                              [
                                "/stream/",
                                "$cleanUri"
                              ]
                          }
                        }
                      }
                    ]
                },
                mediaThumbUri:
                {
                  "$ifNull":
                    [
                      "$tempmedia.mediaThumbUri",
                      null
                    ]
                },
                apsaraId:
                {
                  "$ifNull":
                    [
                      "$tempmedia.apsaraId",
                      null
                    ]
                },
                apsara:
                {
                  "$ifNull":
                    [
                      "$tempmedia.apsara",
                      false
                    ]
                },
              }
            },
            { $sort: { jangkauan: -1 } },
            { $limit: 5 }

          ]
        }
      },
      {
        $project: {

          totalpost: {
            $arrayElemAt: ["$totalpost.totalpost", 0]
          },
          jangkauan: {
            $arrayElemAt: ["$jangkauan.total", 0]
          },
          post: 1
        }
      },

    ]);

    var data = [];

    for (var i = 0; i < query[0].post.length; i++) {
      let dataconten = await this.loadApsara.getapsaraDatabase(query[0].post, i);

      data.push(dataconten[i]);
    }

    var totalpost = 0;
    var jangkauan = 0;
    var sumtotal = 0;

    try {
      totalpost = query[0].totalpost;
    } catch (e) {
      totalpost = 0;
    }
    try {
      jangkauan = query[0].jangkauan;
    } catch (e) {
      jangkauan = 0;
    }

    sumtotal = totalpost + jangkauan;
    var persentotalpost = (totalpost * 100) / sumtotal;
    var persenjangkauan = (jangkauan * 100) / sumtotal;

    return {
      "totalpost": totalpost,
      "persentotalpost": persentotalpost.toFixed(2),
      "jangkauan": jangkauan,
      "persenjangkauan": persenjangkauan.toFixed(2),
      "post": data

    };
  }
  async databasenew2(buy: string, report: string, iduser: Object, username: string, description: string, kepemilikan: any[], statusjual: any[], postType: any[], kategori: any[], hashtag: any[], startdate: string, enddate: string, startmount: number, endmount: number, descending: boolean, page: number, limit: number, popular: any) {

    try {
      var currentdate = new Date(new Date(enddate).setDate(new Date(enddate).getDate() + 1));

      var dateend = currentdate.toISOString();

      var dt = dateend.substring(0, 10);
    } catch (e) {
      dateend = "";
    }

    var order = null;

    if (descending === true) {
      order = -1;
    } else {
      order = 1;
    }

    var arrkategori = [];
    var idkategori = null;
    const mongoose = require('mongoose');
    var ObjectId = require('mongodb').ObjectId;
    var lengkategori = null;

    try {
      lengkategori = kategori.length;
    } catch (e) {
      lengkategori = 0;
    }
    if (lengkategori > 0) {

      for (let i = 0; i < lengkategori; i++) {
        let idkat = kategori[i];
        idkategori = mongoose.Types.ObjectId(idkat);
        arrkategori.push(idkategori);
      }
    }

    var pipeline = [];
    if (popular !== undefined && popular === true) {
      pipeline.push({
        $sort: {
          views: - 1,
          likes: - 1
        },

      },);
    } else {
      pipeline.push({
        $sort: {
          createdAt: order
        },

      },);
    }

    //start improvisasi disini

    var listmatchingand = [];

    listmatchingand.push({
      "active": true
    });

    //baru. search by hashtags
    if (hashtag && hashtag !== undefined) {
      var converthashtag = [];
      for (var i = 0; i < hashtag.length; i++) {
        converthashtag.push(hashtag[i].toLowerCase());
      }

      pipeline.push({
        "$set":
        {
          "tag2":
          {
            "$map": {
              "input": "$tags",
              "as": "arrayElems",
              "in": {
                "$toLower": "$$arrayElems"
              }
            }
          }
        }
      },
        {
          "$project":
          {
            _id: 1,
            postID: 1,
            email: 1,
            postType: 1,
            description: 1,
            active: 1,
            createdAt: 1,
            updated: 1,
            expiration: 1,
            visibility: 1,
            location: 1,
            tags: 1,
            tag2: "$tag2",
            allowComments: 1,
            isSafe: 1,
            isOwned: 1,
            certified: 1,
            saleAmount: 1,
            saleLike: 1,
            isShared: 1,
            saleView: 1,
            likes: 1,
            views: 1,
            shares: 1,
            userProfile: 1,
            contentMedias: 1,
            category: 1,
            tagPeople: 1,
            tagDescription: 1,
            reportedUser: 1,
            reportedUserHandle: 1,
            musicId: 1,
            boosted: 1,
            viewer: 1,
            contentModeration: 1,
            contentModerationDate: 1,
            contentModerationResponse: 1,
            moderationReason: 1,
            reportedStatus: 1,
            mediaSource: {
              $arrayElemAt: ['$mediaSource', 0]
            }
          }
        }
      );

      listmatchingand.push({
        tag2:
        {
          "$in": converthashtag

        }
      }
      );
    }

    if (description && description !== undefined) {

      listmatchingand.push({
        description: {
          $regex: description,
          $options: 'i'
        },
      },);

    }

    pipeline.push({
      "$match":
      {
        "$and": listmatchingand
      }
    }
    );

    //end improvisasi

    if (iduser && iduser !== undefined) {
      pipeline.push(
        {
          "$lookup": {
            "from": "newUserBasics",
            "as": "databasic",
            "let": {
              "local_id": "$email",

            },
            "pipeline": [
              {
                $match:
                {
                  $expr: {
                    $eq: ['$email', '$$local_id']
                  }
                }
              },
              {
                $project: {
                  iduser: "$_id",
                  username: 1

                }
              },

            ],

          },

        },
        {
          $unwind: {
            path: "$databasic",

          }
        },
        {
          $match: {
            'databasic.iduser': iduser,

          }
        },
        {
          $addFields: {

            salePrice: {
              $cmp: ["$saleAmount", 0]
            },
            sLike: {
              $cmp: ["$saleLike", 0]
            },
            sView: {
              $cmp: ["$saleView", 0]
            },
            certi: {
              $cmp: ["$certified", 0]
            },
            reportedCount: {
              $cmp: ["$reportedUserCount", 0]
            },

          }
        },
        // {
        //   $lookup: {
        //     from: 'newUserBasics',
        //     localField: 'email',
        //     foreignField: 'email',
        //     as: 'authdata',

        //   }
        // },
        // {
        //   "$lookup": {
        //     "from": "newUserBasics",
        //     "as": "basicdata",
        //     "let": {
        //       "local_id": "$email",

        //     },
        //     "pipeline": [
        //       {
        //         $match:
        //         {
        //           $expr: {
        //             $eq: ['$email', '$$local_id']
        //           }
        //         }
        //       },
        //       {
        //         $project: {
        //           iduser: "$_id",

        //         }
        //       },

        //     ],

        //   },

        // },
        {
          "$lookup": {
            "from": "transactions",
            "as": "trans",
            "let": {
              "local_id": "$postID",

            },
            "pipeline": [
              {
                $match:
                {
                  $expr: {
                    $eq: ['$postid', '$$local_id']
                  }
                }
              },
              {
                $project: {
                  iduserbuyer: 1,
                  idusersell: 1,
                  noinvoice: 1,
                  status: 1,
                  amount: 1,
                  timestamp: 1
                }
              },
              {
                $match: {
                  "iduserbuyer": iduser,
                  "status": "Success"
                }
              },
              {
                $sort: {
                  timestamp: - 1
                },

              },
              {
                $limit: 1
              },
              {
                "$lookup": {
                  "from": "newUserBasics",
                  "as": "penjual",
                  "let": {
                    "local_id": "$idusersell"
                  },
                  "pipeline": [
                    {
                      "$match": {
                        "$expr": {
                          "$eq": [
                            "$_id",
                            "$$local_id"
                          ]
                        }
                      }
                    },
                    {
                      $project: {
                        email: 1
                      }
                    },

                  ],

                }
              },
              {
                $project: {
                  emailpenjual: {
                    $arrayElemAt: ['$penjual.email', 0]
                  },
                  amount: 1,
                  status: 1,
                  noinvoice: 1,
                  timestamp: 1
                }
              },
              // {
              //   "$lookup": {
              //     "from": "newUserBasics",
              //     "as": "authpenjual",
              //     "let": {
              //       "local_id": "$emailpenjual"
              //     },
              //     "pipeline": [
              //       {
              //         "$match": {
              //           "$expr": {
              //             "$eq": [
              //               "$email",
              //               "$$local_id"
              //             ]
              //           }
              //         }
              //       },

              //     ],

              //   }
              // },
              {
                $project: {
                  penjual: {
                    $arrayElemAt: ['$penjual.username', 0]
                  },
                  amount: 1,
                  status: 1,
                  noinvoice: 1,
                  timestamp: 1
                }
              },

            ],

          },

        },
        {
          $addFields: {


            // 'auth': {
            //   $arrayElemAt: ['$authdata', 0]
            // },
            'iduser': '$databasic.iduser'

          }
        },
        {
          "$lookup": {
            "from": "interests_repo",
            "as": "kategori",
            "let": {
              "local_id": "$category.$id",

            },
            "pipeline": [
              {
                $match:
                {
                  $and: [
                    {
                      $expr: {

                        $in: ['$_id', {
                          $ifNull: ['$$local_id', []]
                        }]
                      }
                    },

                  ]
                }
              },
              {
                $project: {
                  interestName: 1,

                }
              },

            ],

          },

        },
        {
          $project: {
            refs: {
              $arrayElemAt: ['$contentMedias', 0]
            },
            username: "$databasic.username",
            createdAt: 1,
            updatedAt: 1,
            postID: 1,
            iduser: 1,
            email: 1,
            postType: 1,
            views: 1,
            likes: 1,
            comments: 1,
            shares: 1,
            description: 1,
            title: 1,
            active: 1,
            kategori: 1,
            reportedUserCount: 1,
            tags: 1,
            trans:
            {
              $size: "$trans"
            },
            certified:
            {
              $cond: {
                if: {
                  $or: [{
                    $eq: ["$certi", - 1]
                  }, {
                    $eq: ["$certi", 0]
                  }]
                },
                then: false,
                else: "$certified"
              }
            },
            tr: "$trans",
            visibility: 1,
            saleAmount: {
              $cond: {
                if: {
                  $or: [{
                    $eq: ["$salePrice", - 1]
                  }, {
                    $eq: ["$salePrice", 0]
                  }]
                },
                then: 0,
                else: "$saleAmount"
              }
            },
            monetize: {
              $cond: {
                if: {
                  $or: [{
                    $eq: ["$salePrice", - 1]
                  }, {
                    $eq: ["$salePrice", 0]
                  }]
                },
                then: false,
                else: true
              }
            },
            reported: {
              $cond: {
                if: {
                  $or: [{
                    $eq: ["$reportedCount", - 1]
                  }, {
                    $eq: ["$reportedCount", 0]
                  }]
                },
                then: "TIDAK",
                else: "YA"
              }
            },
            mediaSource: 1

          }
        },
        {
          $project: {
            refs: '$refs.$ref',
            idmedia: '$refs.$id',
            username: 1,
            createdAt: 1,
            updatedAt: 1,
            postID: 1,
            postType: 1,
            iduser: 1,
            email: 1,
            reported: 1,
            views: 1,
            likes: 1,
            shares: 1,
            comments: 1,
            tags: 1,
            tr: 1,
            buy: {
              $cond: {
                if: {
                  $or: [{
                    $eq: ["$trans", 0]
                  }]
                },
                then: "TIDAK",
                else: "YA"
              }
            },
            type: {
              $switch: {
                branches: [
                  {
                    'case': {
                      '$eq': ['$postType', 'pict']
                    },
                    'then': "HyppePic"
                  },
                  {
                    'case': {
                      '$eq': ['$postType', 'vid']
                    },
                    'then': "HyppeVid"
                  },
                  {
                    'case': {
                      '$eq': ['$postType', 'diary']
                    },
                    'then': "HyppeDiary"
                  },
                  {
                    'case': {
                      '$eq': ['$postType', 'story']
                    },
                    'then': "HyppeStory"
                  },

                ],
                default: ''
              }
            },
            description: 1,
            title: 1,
            active: 1,
            kategori: 1,
            kepemilikan:
            {
              $cond: {
                if: {
                  $or: [{
                    $eq: ["$certified", false]
                  }, {
                    $eq: ["$certified", ""]
                  }]
                },
                then: "TIDAK",
                else: "YA"
              }
            },
            visibility: 1,
            saleAmount: 1,
            statusJual:
            {
              $cond: {
                if: {

                  $eq: ["$monetize", false]
                },
                then: "TIDAK",
                else: "YA"
              }
            },
            mediaSource: 1

          }
        },
        // {
        //   $lookup: {
        //     from: 'mediapicts',
        //     localField: 'idmedia',
        //     foreignField: '_id',
        //     as: 'mediaPict_data',

        //   },

        // },
        // {
        //   $lookup: {
        //     from: 'mediadiaries',
        //     localField: 'idmedia',
        //     foreignField: '_id',
        //     as: 'mediadiaries_data',

        //   },

        // },
        // {
        //   $lookup: {
        //     from: 'mediavideos',
        //     localField: 'idmedia',
        //     foreignField: '_id',
        //     as: 'mediavideos_data',

        //   },

        // },
        // {
        //   $lookup: {
        //     from: 'mediastories',
        //     localField: 'idmedia',
        //     foreignField: '_id',
        //     as: 'mediastories_data',

        //   },

        // },
        {
          $project: {
            // mediapict: {
            //   $arrayElemAt: ['$mediaPict_data', 0]
            // },
            // mediadiaries: {
            //   $arrayElemAt: ['$mediadiaries_data', 0]
            // },
            // mediavideos: {
            //   $arrayElemAt: ['$mediavideos_data', 0]
            // },
            // mediastories: {
            //   $arrayElemAt: ['$mediastories_data', 0]
            // },
            refs: 1,
            idmedia: 1,
            username: 1,
            createdAt: 1,
            updatedAt: 1,
            postID: 1,
            postType: 1,
            iduser: 1,
            email: 1,
            views: 1,
            likes: 1,
            shares: 1,
            comments: 1,
            type: 1,
            description: 1,
            title: 1,
            active: 1,
            kategori: 1,
            kepemilikan: 1,
            visibility: 1,
            amount: "$saleAmount",
            statusJual: 1,
            reported: 1,
            buy: 1,
            tr: 1,
            tags: 1,
            mediaSource: 1
          }
        },
        // {
        //   $addFields: {


        //     pict: {
        //       $replaceOne: {
        //         input: "$profilpict.mediaUri",
        //         find: "_0001.jpeg",
        //         replacement: ""
        //       }
        //     },
        //     concatmediapict: '/pict',
        //     media_pict: {
        //       $replaceOne: {
        //         input: "$mediapict.mediaUri",
        //         find: "_0001.jpeg",
        //         replacement: ""
        //       }
        //     },
        //     concatmediadiari: '/stream',
        //     concatthumbdiari: '/thumb',
        //     media_diari: '$mediadiaries.mediaUri',
        //     concatmediavideo: '/stream',
        //     concatthumbvideo: '/thumb',
        //     media_video: '$mediavideos.mediaUri',
        //     concatmediastory:
        //     {
        //       $cond: {
        //         if: {

        //           $eq: ["$mediastories.mediaType", "image"]
        //         },
        //         then: '/pict',
        //         else: '/stream',

        //       }
        //     },
        //     concatthumbstory: '/thumb',
        //     media_story: '$mediastories.mediaUri'
        //   },

        // },
        {
          $project: {

            username: 1,
            createdAt: 1,
            updatedAt: 1,
            postID: 1,
            postType: 1,
            iduser: 1,
            tr: 1,
            email: 1,
            type: 1,
            description: 1,
            title: 1,
            active: 1,
            kategori: 1,
            kepemilikan: 1,
            visibility: 1,
            saleAmount: {
              $cond: {
                if: {
                  $or: [{
                    $eq: ["$buy", "TIDAK"]
                  },]
                },
                then: "$amount",
                else: {
                  $arrayElemAt: ['$tr.amount', 0]
                }
              }
            },
            penjual: {
              $arrayElemAt: ['$tr.penjual', 0]
            },
            statusJual: 1,
            reported: 1,
            buy: 1,
            views: 1,
            likes: 1,
            shares: 1,
            comments: 1,
            tags: 1,
            mediaBasePath:
            {
              "$ifNull":
                [
                  {
                    $arrayElemAt: ["$mediaSource.mediaBasePath", 0]
                  },
                  null
                ]
            },
            mediaUri:
            {
              "$ifNull":
                [
                  {
                    $arrayElemAt: ["$mediaSource.mediaUri", 0]
                  },
                  null
                ]
            },
            mediaType:
            {
              "$ifNull":
                [
                  {
                    $arrayElemAt: ["$mediaSource.mediaType", 0]
                  },
                  null
                ]
            },
            mediaThumbEndpoint:
            {
              "$ifNull":
                [
                  {
                    $arrayElemAt: ["$mediaSource.mediaThumbEndpoint", 0]
                  },
                  {
                    "$concat":
                      [
                        "/thumb/",
                        "$postID"
                      ]
                  }
                ]
            },
            mediaEndpoint:
            {
              "$ifNull":
                [
                  {
                    $arrayElemAt: ["$mediaSource.mediaEndpoint", 0]
                  },
                  {
                    "$cond":
                    {
                      if:
                      {
                        "$eq":
                          [
                            "$postType", "pict"
                          ]
                      },
                      then:
                      {
                        "$concat":
                          [
                            "/pict/",
                            "$postID"
                          ]
                      },
                      else:
                      {
                        "$concat":
                          [
                            "/stream/",
                            "$postID"
                          ]
                      }
                    }
                  }
                ]
            },
            mediaThumbUri:
            {
              "$ifNull":
                [
                  {
                    $arrayElemAt: ["$mediaSource.mediaThumbUri", 0]
                  },
                  null
                ]
            },
            apsaraId: {
              $arrayElemAt: ["$mediaSource.apsaraId", 0]
            },
            apsara: {
              $arrayElemAt: ["$mediaSource.apsara", 0]
            }

          }
        },
        {
          $project: {

            username: 1,
            createdAt: 1,
            updatedAt: 1,
            postID: 1,
            postType: 1,
            iduser: 1,
            email: 1,
            type: 1,
            description: 1,
            title: 1,
            active: 1,
            kategori: 1,
            kepemilikan: 1,
            visibility: 1,
            saleAmount: {
              $cond: {
                if: {
                  $or: [{
                    $eq: ["$saleAmount", null]
                  },]
                },
                then: 0,
                else: "$saleAmount"
              }
            },
            statusJual: 1,
            reported: 1,
            buy: 1,
            views: 1,
            likes: 1,
            shares: 1,
            comments: 1,
            mediaBasePath: 1,
            mediaUri: 1,
            mediaType: 1,
            mediaThumbEndpoint: 1,
            mediaEndpoint: 1,
            mediaThumbUri: 1,
            apsaraId: 1,
            apsara: 1,
            penjual: 1,
            tags: 1,
          }
        },
      );

    }
    else {
      pipeline.push(
        {
          $addFields: {

            salePrice: {
              $cmp: ["$saleAmount", 0]
            },
            sLike: {
              $cmp: ["$saleLike", 0]
            },
            sView: {
              $cmp: ["$saleView", 0]
            },
            certi: {
              $cmp: ["$certified", 0]
            },
            reportedCount: {
              $cmp: ["$reportedUserCount", 0]
            },

          }
        },

        {
          $lookup: {
            from: 'newUserBasics',
            localField: 'email',
            foreignField: 'email',
            as: 'authdata',

          }
        },

        {
          $addFields: {


            'auth': {
              $arrayElemAt: ['$authdata', 0]
            },

          }
        },
        {
          "$lookup": {
            "from": "interests_repo",
            "as": "kategori",
            "let": {
              "local_id": "$category.$id",

            },
            "pipeline": [
              {
                $match:
                {
                  $and: [
                    {
                      $expr: {

                        $in: ['$_id', {
                          $ifNull: ['$$local_id', []]
                        }]
                      }
                    },

                  ]
                }
              },
              {
                $project: {
                  interestName: 1,

                }
              },

            ],

          },

        },
        {
          $project: {
            refs: {
              $arrayElemAt: ['$contentMedias', 0]
            },
            username: "$auth.username",
            createdAt: 1,
            updatedAt: 1,
            postID: 1,
            email: 1,
            postType: 1,
            description: 1,
            title: 1,
            active: 1,
            kategori: 1,
            reportedUserCount: 1,
            views: 1,
            likes: 1,
            shares: 1,
            comments: 1,
            certified:
            {
              $cond: {
                if: {
                  $or: [{
                    $eq: ["$certi", - 1]
                  }, {
                    $eq: ["$certi", 0]
                  }]
                },
                then: false,
                else: "$certified"
              }
            },
            visibility: 1,
            saleAmount: {
              $cond: {
                if: {
                  $or: [{
                    $eq: ["$salePrice", - 1]
                  }, {
                    $eq: ["$salePrice", 0]
                  }]
                },
                then: 0,
                else: "$saleAmount"
              }
            },
            monetize: {
              $cond: {
                if: {
                  $or: [{
                    $eq: ["$salePrice", - 1]
                  }, {
                    $eq: ["$salePrice", 0]
                  }]
                },
                then: false,
                else: true
              }
            },
            reported: {
              $cond: {
                if: {
                  $or: [{
                    $eq: ["$reportedCount", - 1]
                  }, {
                    $eq: ["$reportedCount", 0]
                  }]
                },
                then: "TIDAK",
                else: "YA"
              }
            },
            tags: 1,
            mediaSource: 1
          }
        },
        {
          $project: {
            refs: '$refs.$ref',
            idmedia: '$refs.$id',
            username: 1,
            createdAt: 1,
            updatedAt: 1,
            postID: 1,
            postType: 1,
            email: 1,
            reported: 1,
            views: 1,
            likes: 1,
            shares: 1,
            comments: 1,
            type: {
              $switch: {
                branches: [
                  {
                    'case': {
                      '$eq': ['$postType', 'pict']
                    },
                    'then': "HyppePic"
                  },
                  {
                    'case': {
                      '$eq': ['$postType', 'vid']
                    },
                    'then': "HyppeVid"
                  },
                  {
                    'case': {
                      '$eq': ['$postType', 'diary']
                    },
                    'then': "HyppeDiary"
                  },
                  {
                    'case': {
                      '$eq': ['$postType', 'story']
                    },
                    'then': "HyppeStory"
                  },

                ],
                default: ''
              }
            },
            description: 1,
            title: 1,
            active: 1,
            kategori: 1,
            kepemilikan:
            {
              $cond: {
                if: {
                  $or: [{
                    $eq: ["$certified", false]
                  }, {
                    $eq: ["$certified", ""]
                  }]
                },
                then: "TIDAK",
                else: "YA"
              }
            },
            visibility: 1,
            saleAmount: 1,
            statusJual:
            {
              $cond: {
                if: {

                  $eq: ["$monetize", false]
                },
                then: "TIDAK",
                else: "YA"
              }
            },
            tags: 1,
            mediaSource: 1
          }
        },
        // {
        //   $lookup: {
        //     from: 'mediapicts',
        //     localField: 'idmedia',
        //     foreignField: '_id',
        //     as: 'mediaPict_data',

        //   },

        // },
        // {
        //   $lookup: {
        //     from: 'mediadiaries',
        //     localField: 'idmedia',
        //     foreignField: '_id',
        //     as: 'mediadiaries_data',

        //   },

        // },
        // {
        //   $lookup: {
        //     from: 'mediavideos',
        //     localField: 'idmedia',
        //     foreignField: '_id',
        //     as: 'mediavideos_data',

        //   },

        // },
        // {
        //   $lookup: {
        //     from: 'mediastories',
        //     localField: 'idmedia',
        //     foreignField: '_id',
        //     as: 'mediastories_data',

        //   },

        // },
        {
          $project: {
            // mediapict: {
            //   $arrayElemAt: ['$mediaPict_data', 0]
            // },
            // mediadiaries: {
            //   $arrayElemAt: ['$mediadiaries_data', 0]
            // },
            // mediavideos: {
            //   $arrayElemAt: ['$mediavideos_data', 0]
            // },
            // mediastories: {
            //   $arrayElemAt: ['$mediastories_data', 0]
            // },
            refs: 1,
            idmedia: 1,
            username: 1,
            createdAt: 1,
            updatedAt: 1,
            postID: 1,
            postType: 1,
            iduser: 1,
            email: 1,
            type: 1,
            description: 1,
            title: 1,
            active: 1,
            kategori: 1,
            kepemilikan: 1,
            visibility: 1,
            saleAmount: 1,
            statusJual: 1,
            reported: 1,
            views: 1,
            likes: 1,
            shares: 1,
            comments: 1,
            tags: 1,
            mediaSource: 1
          }
        },
        // {
        //   $addFields: {


        //     pict: {
        //       $replaceOne: {
        //         input: "$profilpict.mediaUri",
        //         find: "_0001.jpeg",
        //         replacement: ""
        //       }
        //     },
        //     concatmediapict: '/pict',
        //     media_pict: {
        //       $replaceOne: {
        //         input: "$mediapict.mediaUri",
        //         find: "_0001.jpeg",
        //         replacement: ""
        //       }
        //     },
        //     concatmediadiari: '/stream',
        //     concatthumbdiari: '/thumb',
        //     media_diari: '$mediadiaries.mediaUri',
        //     concatmediavideo: '/stream',
        //     concatthumbvideo: '/thumb',
        //     media_video: '$mediavideos.mediaUri',
        //     concatmediastory:
        //     {
        //       $cond: {
        //         if: {

        //           $eq: ["$mediastories.mediaType", "image"]
        //         },
        //         then: '/pict',
        //         else: '/stream',

        //       }
        //     },
        //     concatthumbstory: '/thumb',
        //     media_story: '$mediastories.mediaUri'
        //   },

        // },
        {
          $project: {

            username: 1,
            createdAt: 1,
            updatedAt: 1,
            postID: 1,
            postType: 1,
            email: 1,
            type: 1,
            description: 1,
            title: 1,
            active: 1,
            kategori: 1,
            kepemilikan: 1,
            visibility: 1,
            saleAmount: 1,
            statusJual: 1,
            reported: 1,
            views: 1,
            likes: 1,
            shares: 1,
            comments: 1,
            tags: 1,
            mediaBasePath:
            {
              "$ifNull":
                [
                  {
                    $arrayElemAt: ["$mediaSource.mediaBasePath", 0]
                  },
                  null
                ]
            },
            mediaUri:
            {
              "$ifNull":
                [
                  {
                    $arrayElemAt: ["$mediaSource.mediaUri", 0]
                  },
                  null
                ]
            },
            mediaType:
            {
              "$ifNull":
                [
                  {
                    $arrayElemAt: ["$mediaSource.mediaType", 0]
                  },
                  null
                ]
            },
            mediaThumbEndpoint:
            {
              "$ifNull":
                [
                  {
                    $arrayElemAt: ["$mediaSource.mediaThumbEndpoint", 0]
                  },
                  {
                    "$concat":
                      [
                        "/thumb/",
                        "$postID"
                      ]
                  }
                ]
            },
            mediaEndpoint:
            {
              "$ifNull":
                [
                  {
                    $arrayElemAt: ["$mediaSource.mediaEndpoint", 0]
                  },
                  {
                    "$cond":
                    {
                      if:
                      {
                        "$eq":
                          [
                            "$postType", "pict"
                          ]
                      },
                      then:
                      {
                        "$concat":
                          [
                            "/pict/",
                            "$postID"
                          ]
                      },
                      else:
                      {
                        "$concat":
                          [
                            "/stream/",
                            "$postID"
                          ]
                      }
                    }
                  }
                ]
            },
            mediaThumbUri:
            {
              "$ifNull":
                [
                  {
                    $arrayElemAt: ["$mediaSource.mediaThumbUri", 0]
                  },
                  null
                ]
            },
            apsaraId: {
              $arrayElemAt: ["$mediaSource.apsaraId", 0]
            },
            apsara: {
              $arrayElemAt: ["$mediaSource.apsara", 0]
            }

          }
        },
      );
    }


    if (username && username !== undefined) {

      pipeline.push({
        $match: {
          "$or":
            [
              {
                username: {
                  $regex: username,
                  $options: 'i'
                }
              },
              {
                email: {
                  $regex: username,
                  $options: "i"
                }
              }
            ],

        }
      },);

    }


    if (kepemilikan && kepemilikan !== undefined) {
      pipeline.push({
        $match: {
          $or: [
            {
              kepemilikan: {
                $in: kepemilikan
              }
            },

          ]
        }
      },);
    }

    if (statusjual && statusjual !== undefined) {
      pipeline.push({
        $match: {
          $or: [
            {
              statusJual: {
                $in: statusjual
              }
            },

          ]
        }
      },);
    }

    if (buy !== undefined && buy === "YA") {
      pipeline.push({
        $match: {
          buy: buy
        }
      },);
    }
    if (report && report !== undefined) {
      pipeline.push({
        $match: {
          reported: report
        }
      },);
    }

    if (kategori && kategori !== undefined) {
      pipeline.push({
        $match: {
          $or: [
            {
              'kategori._id': {
                $in: arrkategori
              }
            },

          ]
        }
      },);
    }
    if (postType && postType !== undefined) {
      pipeline.push({
        $match: {
          $or: [
            {
              type: {
                $in: postType
              }
            },

          ]
        }
      },);
    }
    if (startmount && startmount !== undefined) {
      pipeline.push({ $match: { saleAmount: { $gte: startmount } } });
    }
    if (endmount && endmount !== undefined) {
      pipeline.push({ $match: { saleAmount: { $lte: endmount } } });
    }
    if (startdate && startdate !== undefined) {
      pipeline.push({ $match: { createdAt: { $gte: startdate } } });
    }
    if (enddate && enddate !== undefined) {
      pipeline.push({ $match: { createdAt: { $lte: dt } } });
    }



    if (page > 0) {
      pipeline.push({ $skip: (page * limit) });
    }
    if (limit > 0) {
      pipeline.push({ $limit: limit });
    }

    console.log(JSON.stringify(pipeline));

    let query = await this.loaddata.aggregate(pipeline);
    // console.log(query);

    var listdata = [];
    var tempresult = null;
    var tempdata = null;
    for (var i = 0; i < query.length; i++) {
      tempdata = query[i];
      if (tempdata.apsara == true) {
        listdata.push(tempdata.apsaraId);
      }
      else {
        listdata.push(undefined);
      }
    }

    //console.log(listdata);
    var apsaraimagedata = await this.postContentService.getImageApsara(listdata);
    // console.log(resultdata.ImageInfo[0]);
    tempresult = apsaraimagedata.ImageInfo;
    for (var i = 0; i < query.length; i++) {
      for (var j = 0; j < tempresult.length; j++) {
        if (tempresult[j].ImageId == query[i].apsaraId) {
          query[i].media =
          {
            "ImageInfo": [tempresult[j]]
          }
        }
        else if (query[i].apsara == false && (query[i].mediaType == "image" || query[i].mediaType == "images")) {
          query[i].media =
          {
            "ImageInfo": []
          }
        }
      }
    }

    var apsaravideodata = await this.postContentService.getVideoApsara(listdata);
    // console.log(apsaravideodata);
    // console.log(resultdata.ImageInfo[0]);
    tempresult = apsaravideodata.VideoList;
    for (var i = 0; i < query.length; i++) {
      for (var j = 0; j < tempresult.length; j++) {
        if (tempresult[j].VideoId == query[i].apsaraId) {
          query[i].media =
          {
            "VideoList": [tempresult[j]]
          }
        }
        else if (query[i].apsara == false && query[i].mediaType == "video") {
          query[i].media =
          {
            "VideoList": []
          }
        }
      }
    }

    return query;
  }

  async countTemppost(email: string, tipe: string) {
    var pipeline = [];
    var firstmatch = [];
    if (tipe == "like") {
      firstmatch.push(
        {
          "tempLike": email
        }
      );
    }
    else {
      firstmatch.push(
        {
          "tempView": email
        }
      );
    }

    firstmatch.push(
      {
        "active": true
      }
    );

    pipeline.push(
      {
        "$unwind":
        {
          path: (tipe == "like" ? "$tempLike" : "$tempView")
        }
      },
      {
        "$match":
        {
          "$and": firstmatch
        }
      },
      {
        "$group":
        {
          _id: null,
          total:
          {
            "$sum": 1
          },
          data:
          {
            "$push": "$postID"
          }
        }
      }
    );

    var data = await this.loaddata.aggregate(pipeline);
    return data;
  }

  async findById(list: any[]) {
    var data = await this.loaddata.aggregate([
      {
        "$match":
        {
          "postID":
          {
            "$in": list
          }
        }
      }
    ]);

    return data;
  }

  async detaildasborv2(email: string) {
    const query = await this.loaddata.aggregate([
      {
        $match: {
          email: email
        }
      },
      {
        $addFields: {

          salePrice: {
            $cmp: ["$saleAmount", 0]
          },
          sLike: {
            $cmp: ["$saleLike", 0]
          },
          sView: {
            $cmp: ["$saleView", 0]
          },
          certi: {
            $cmp: ["$certified", 0]
          },
          reportCount: {
            $cmp: ["$reportedUserCount", 0]
          },

        }
      },
      {
        $facet: {
          "popular": [
            {
              $project: {
                refs: {
                  $arrayElemAt: ['$contentMedias', 0]
                },
                createdAt: 1,
                updatedAt: 1,
                postID: 1,
                email: 1,
                postType: 1,
                description: 1,
                title: 1,
                active: 1,
                likes: 1,
                views: 1,
                shares: 1,
                comments: 1,
                jenis: "POPULAR",
                countReport:
                {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$reportCount", - 1]
                      }, {
                        $eq: ["$reportCount", 0]
                      }]
                    },
                    then: 0,
                    else: "$reportedUserCount"
                  }
                },
                certified:
                {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$certi", - 1]
                      }, {
                        $eq: ["$certi", 0]
                      }]
                    },
                    then: false,
                    else: "$certified"
                  }
                },
                visibility: 1,
                saleAmount: {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$salePrice", - 1]
                      }, {
                        $eq: ["$salePrice", 0]
                      }]
                    },
                    then: 0,
                    else: "$saleAmount"
                  }
                },
                monetize: {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$salePrice", - 1]
                      }, {
                        $eq: ["$salePrice", 0]
                      }]
                    },
                    then: false,
                    else: true
                  }
                },
                mediaSource: {
                  $arrayElemAt: ['$mediaSource', 0]
                }

              }
            },
            {
              $project: {
                refs: '$refs.$ref',
                idmedia: '$refs.$id',
                createdAt: 1,
                updatedAt: 1,
                postID: 1,
                postType: 1,
                email: 1,
                likes: 1,
                views: 1,
                shares: 1,
                comments: 1,
                countReport: 1,
                jenis: 1,
                type: {
                  $switch: {
                    branches: [
                      {
                        'case': {
                          '$eq': ['$postType', 'pict']
                        },
                        'then': "HyppePic"
                      },
                      {
                        'case': {
                          '$eq': ['$postType', 'vid']
                        },
                        'then': "HyppeVid"
                      },
                      {
                        'case': {
                          '$eq': ['$postType', 'diary']
                        },
                        'then': "HyppeDiary"
                      },
                      {
                        'case': {
                          '$eq': ['$postType', 'story']
                        },
                        'then': "HyppeStory"
                      },

                    ],
                    default: ''
                  }
                },
                description: 1,
                title: 1,
                active: 1,
                kepemilikan:
                {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$certified", false]
                      }, {
                        $eq: ["$certified", ""]
                      }]
                    },
                    then: "TIDAK",
                    else: "YA"
                  }
                },
                visibility: 1,
                saleAmount: 1,
                statusJual:
                {
                  $cond: {
                    if: {

                      $eq: ["$monetize", false]
                    },
                    then: "TIDAK",
                    else: "YA"
                  }
                },
                mediaSource: 1

              }
            },
            // {
            //   $lookup: {
            //     from: 'mediapicts',
            //     localField: 'idmedia',
            //     foreignField: '_id',
            //     as: 'mediaPict_data',

            //   },

            // },
            // {
            //   $lookup: {
            //     from: 'mediadiaries',
            //     localField: 'idmedia',
            //     foreignField: '_id',
            //     as: 'mediadiaries_data',

            //   },

            // },
            // {
            //   $lookup: {
            //     from: 'mediavideos',
            //     localField: 'idmedia',
            //     foreignField: '_id',
            //     as: 'mediavideos_data',

            //   },

            // },
            // {
            //   $lookup: {
            //     from: 'mediastories',
            //     localField: 'idmedia',
            //     foreignField: '_id',
            //     as: 'mediastories_data',

            //   },

            // },
            // {
            // $project: {
            // mediapict: {
            //   $arrayElemAt: ['$mediaPict_data', 0]
            // },
            // mediadiaries: {
            //   $arrayElemAt: ['$mediadiaries_data', 0]
            // },
            // mediavideos: {
            //   $arrayElemAt: ['$mediavideos_data', 0]
            // },
            // mediastories: {
            //   $arrayElemAt: ['$mediastories_data', 0]
            // },
            //     refs: 1,
            //     idmedia: 1,
            //     createdAt: 1,
            //     updatedAt: 1,
            //     postID: 1,
            //     postType: 1,
            //     email: 1,
            //     type: 1,
            //     description: 1,
            //     title: 1,
            //     active: 1,
            //     kepemilikan: 1,
            //     visibility: 1,
            //     saleAmount: 1,
            //     statusJual: 1,
            //     likes: 1,
            //     views: 1,
            //     shares: 1,
            //     comments: 1,
            //     countReport: 1,
            //     jenis: 1,
            //     mediaSource: 1
            //   }
            // },
            // {
            //   $addFields: {


            //     concatmediapict: '/pict',
            //     media_pict: {
            //       $replaceOne: {
            //         input: "$mediapict.mediaUri",
            //         find: "_0001.jpeg",
            //         replacement: ""
            //       }
            //     },
            //     concatmediadiari: '/stream',
            //     concatthumbdiari: '/thumb',
            //     media_diari: '$mediadiaries.mediaUri',
            //     concatmediavideo: '/stream',
            //     concatthumbvideo: '/thumb',
            //     media_video: '$mediavideos.mediaUri',
            //     concatmediastory:
            //     {
            //       $cond: {
            //         if: {

            //           $eq: ["$mediastories.mediaType", "image"]
            //         },
            //         then: '/pict',
            //         else: '/stream',

            //       }
            //     },
            //     concatthumbstory: '/thumb',
            //     media_story: '$mediastories.mediaUri'
            //   },

            // },
            {
              $project: {

                createdAt: 1,
                updatedAt: 1,
                postID: 1,
                postType: 1,
                email: 1,
                type: 1,
                description: 1,
                title: 1,
                active: 1,
                kepemilikan: 1,
                visibility: 1,
                saleAmount: 1,
                statusJual: 1,
                likes: 1,
                views: 1,
                shares: 1,
                comments: 1,
                countReport: 1,
                jenis: 1,
                mediaBasePath:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaBasePath",
                      null
                    ]
                },
                mediaUri:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaUri",
                      null
                    ]
                },
                mediaType:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaType",
                      null
                    ]
                },
                mediaThumbEndpoint:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaThumbEndpoint",
                      {
                        "$concat":
                          [
                            "/thumb/",
                            "$postID"
                          ]
                      }
                    ]
                },
                mediaEndpoint:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaEndpoint",
                      {
                        "$cond":
                        {
                          if:
                          {
                            "$eq":
                              [
                                "$postType", "pict"
                              ]
                          },
                          then:
                          {
                            "$concat":
                              [
                                "/pict/",
                                "$postID"
                              ]
                          },
                          else:
                          {
                            "$concat":
                              [
                                "/stream/",
                                "$postID"
                              ]
                          }
                        }
                      }
                    ]
                },
                mediaThumbUri:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaThumbUri",
                      null
                    ]
                },
                apsaraId: "$mediaSource.apsaraId",
                apsara: "$mediaSource.apsara"

              }
            },
            {
              $sort: {
                views: - 1,
                likes: - 1
              },

            },
            {
              $skip: 0
            },
            {
              $limit: 1
            },

          ],
          "likes": [
            {
              $project: {
                refs: {
                  $arrayElemAt: ['$contentMedias', 0]
                },
                createdAt: 1,
                updatedAt: 1,
                postID: 1,
                email: 1,
                postType: 1,
                description: 1,
                title: 1,
                active: 1,
                likes: 1,
                views: 1,
                shares: 1,
                comments: 1,
                jenis: "MOSTLIKES",
                countReport:
                {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$reportCount", - 1]
                      }, {
                        $eq: ["$reportCount", 0]
                      }]
                    },
                    then: 0,
                    else: "$reportedUserCount"
                  }
                },
                certified:
                {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$certi", - 1]
                      }, {
                        $eq: ["$certi", 0]
                      }]
                    },
                    then: false,
                    else: "$certified"
                  }
                },
                visibility: 1,
                saleAmount: {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$salePrice", - 1]
                      }, {
                        $eq: ["$salePrice", 0]
                      }]
                    },
                    then: 0,
                    else: "$saleAmount"
                  }
                },
                monetize: {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$salePrice", - 1]
                      }, {
                        $eq: ["$salePrice", 0]
                      }]
                    },
                    then: false,
                    else: true
                  }
                },
                mediaSource: {
                  $arrayElemAt: ['$mediaSource', 0]
                }

              }
            },
            {
              $project: {
                refs: '$refs.$ref',
                idmedia: '$refs.$id',
                createdAt: 1,
                updatedAt: 1,
                postID: 1,
                postType: 1,
                email: 1,
                likes: 1,
                views: 1,
                shares: 1,
                comments: 1,
                countReport: 1,
                jenis: 1,
                type: {
                  $switch: {
                    branches: [
                      {
                        'case': {
                          '$eq': ['$postType', 'pict']
                        },
                        'then': "HyppePic"
                      },
                      {
                        'case': {
                          '$eq': ['$postType', 'vid']
                        },
                        'then': "HyppeVid"
                      },
                      {
                        'case': {
                          '$eq': ['$postType', 'diary']
                        },
                        'then': "HyppeDiary"
                      },
                      {
                        'case': {
                          '$eq': ['$postType', 'story']
                        },
                        'then': "HyppeStory"
                      },

                    ],
                    default: ''
                  }
                },
                description: 1,
                title: 1,
                active: 1,
                kepemilikan:
                {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$certified", false]
                      }, {
                        $eq: ["$certified", ""]
                      }]
                    },
                    then: "TIDAK",
                    else: "YA"
                  }
                },
                visibility: 1,
                saleAmount: 1,
                statusJual:
                {
                  $cond: {
                    if: {

                      $eq: ["$monetize", false]
                    },
                    then: "TIDAK",
                    else: "YA"
                  }
                },
                mediaSource: 1

              }
            },
            // {
            //   $lookup: {
            //     from: 'mediapicts',
            //     localField: 'idmedia',
            //     foreignField: '_id',
            //     as: 'mediaPict_data',

            //   },

            // },
            // {
            //   $lookup: {
            //     from: 'mediadiaries',
            //     localField: 'idmedia',
            //     foreignField: '_id',
            //     as: 'mediadiaries_data',

            //   },

            // },
            // {
            //   $lookup: {
            //     from: 'mediavideos',
            //     localField: 'idmedia',
            //     foreignField: '_id',
            //     as: 'mediavideos_data',

            //   },

            // },
            // {
            //   $lookup: {
            //     from: 'mediastories',
            //     localField: 'idmedia',
            //     foreignField: '_id',
            //     as: 'mediastories_data',

            //   },

            // },
            // {
            //   $project: {
            // mediapict: {
            //   $arrayElemAt: ['$mediaPict_data', 0]
            // },
            // mediadiaries: {
            //   $arrayElemAt: ['$mediadiaries_data', 0]
            // },
            // mediavideos: {
            //   $arrayElemAt: ['$mediavideos_data', 0]
            // },
            // mediastories: {
            //   $arrayElemAt: ['$mediastories_data', 0]
            // },
            //     refs: 1,
            //     idmedia: 1,
            //     createdAt: 1,
            //     updatedAt: 1,
            //     postID: 1,
            //     postType: 1,
            //     email: 1,
            //     type: 1,
            //     description: 1,
            //     title: 1,
            //     active: 1,
            //     kepemilikan: 1,
            //     visibility: 1,
            //     saleAmount: 1,
            //     statusJual: 1,
            //     likes: 1,
            //     views: 1,
            //     shares: 1,
            //     comments: 1,
            //     countReport: 1,
            //     jenis: 1,
            //     mediaSource: 1
            //   }
            // },
            // {
            //   $addFields: {


            //     concatmediapict: '/pict',
            //     media_pict: {
            //       $replaceOne: {
            //         input: "$mediapict.mediaUri",
            //         find: "_0001.jpeg",
            //         replacement: ""
            //       }
            //     },
            //     concatmediadiari: '/stream',
            //     concatthumbdiari: '/thumb',
            //     media_diari: '$mediadiaries.mediaUri',
            //     concatmediavideo: '/stream',
            //     concatthumbvideo: '/thumb',
            //     media_video: '$mediavideos.mediaUri',
            //     concatmediastory:
            //     {
            //       $cond: {
            //         if: {

            //           $eq: ["$mediastories.mediaType", "image"]
            //         },
            //         then: '/pict',
            //         else: '/stream',

            //       }
            //     },
            //     concatthumbstory: '/thumb',
            //     media_story: '$mediastories.mediaUri'
            //   },

            // },
            {
              $project: {

                createdAt: 1,
                updatedAt: 1,
                postID: 1,
                postType: 1,
                email: 1,
                type: 1,
                description: 1,
                title: 1,
                active: 1,
                kepemilikan: 1,
                visibility: 1,
                saleAmount: 1,
                statusJual: 1,
                likes: 1,
                views: 1,
                shares: 1,
                comments: 1,
                countReport: 1,
                jenis: 1,
                mediaBasePath:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaBasePath",
                      null
                    ]
                },
                mediaUri:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaUri",
                      null
                    ]
                },
                mediaType:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaType",
                      null
                    ]
                },
                mediaThumbEndpoint:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaThumbEndpoint",
                      {
                        "$concat":
                          [
                            "/thumb/",
                            "$postID"
                          ]
                      }
                    ]
                },
                mediaEndpoint:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaEndpoint",
                      {
                        "$cond":
                        {
                          if:
                          {
                            "$eq":
                              [
                                "$postType", "pict"
                              ]
                          },
                          then:
                          {
                            "$concat":
                              [
                                "/pict/",
                                "$postID"
                              ]
                          },
                          else:
                          {
                            "$concat":
                              [
                                "/stream/",
                                "$postID"
                              ]
                          }
                        }
                      }
                    ]
                },
                mediaThumbUri:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaThumbUri",
                      null
                    ]
                },
                apsaraId: "$mediaSource.apsaraId",
                apsara: "$mediaSource.apsara"

              }
            },
            {
              $sort: {
                likes: - 1
              },

            },
            {
              $skip: 0
            },
            {
              $limit: 1
            },

          ],
          "shares": [
            {
              $project: {
                refs: {
                  $arrayElemAt: ['$contentMedias', 0]
                },
                createdAt: 1,
                updatedAt: 1,
                postID: 1,
                email: 1,
                postType: 1,
                description: 1,
                title: 1,
                active: 1,
                likes: 1,
                views: 1,
                shares: 1,
                comments: 1,
                jenis: "MOSTSHARES",
                countReport:
                {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$reportCount", - 1]
                      }, {
                        $eq: ["$reportCount", 0]
                      }]
                    },
                    then: 0,
                    else: "$reportedUserCount"
                  }
                },
                certified:
                {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$certi", - 1]
                      }, {
                        $eq: ["$certi", 0]
                      }]
                    },
                    then: false,
                    else: "$certified"
                  }
                },
                visibility: 1,
                saleAmount: {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$salePrice", - 1]
                      }, {
                        $eq: ["$salePrice", 0]
                      }]
                    },
                    then: 0,
                    else: "$saleAmount"
                  }
                },
                monetize: {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$salePrice", - 1]
                      }, {
                        $eq: ["$salePrice", 0]
                      }]
                    },
                    then: false,
                    else: true
                  }
                },
                mediaSource: {
                  $arrayElemAt: ['$mediaSource', 0]
                }

              }
            },
            {
              $project: {
                refs: '$refs.$ref',
                idmedia: '$refs.$id',
                createdAt: 1,
                updatedAt: 1,
                postID: 1,
                postType: 1,
                email: 1,
                likes: 1,
                views: 1,
                shares: 1,
                comments: 1,
                countReport: 1,
                jenis: 1,
                type: {
                  $switch: {
                    branches: [
                      {
                        'case': {
                          '$eq': ['$postType', 'pict']
                        },
                        'then': "HyppePic"
                      },
                      {
                        'case': {
                          '$eq': ['$postType', 'vid']
                        },
                        'then': "HyppeVid"
                      },
                      {
                        'case': {
                          '$eq': ['$postType', 'diary']
                        },
                        'then': "HyppeDiary"
                      },
                      {
                        'case': {
                          '$eq': ['$postType', 'story']
                        },
                        'then': "HyppeStory"
                      },

                    ],
                    default: ''
                  }
                },
                description: 1,
                title: 1,
                active: 1,
                kepemilikan:
                {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$certified", false]
                      }, {
                        $eq: ["$certified", ""]
                      }]
                    },
                    then: "TIDAK",
                    else: "YA"
                  }
                },
                visibility: 1,
                saleAmount: 1,
                statusJual:
                {
                  $cond: {
                    if: {

                      $eq: ["$monetize", false]
                    },
                    then: "TIDAK",
                    else: "YA"
                  }
                },
                mediaSource: 1

              }
            },
            // {
            //   $lookup: {
            //     from: 'mediapicts',
            //     localField: 'idmedia',
            //     foreignField: '_id',
            //     as: 'mediaPict_data',

            //   },

            // },
            // {
            //   $lookup: {
            //     from: 'mediadiaries',
            //     localField: 'idmedia',
            //     foreignField: '_id',
            //     as: 'mediadiaries_data',

            //   },

            // },
            // {
            //   $lookup: {
            //     from: 'mediavideos',
            //     localField: 'idmedia',
            //     foreignField: '_id',
            //     as: 'mediavideos_data',

            //   },

            // },
            // {
            //   $lookup: {
            //     from: 'mediastories',
            //     localField: 'idmedia',
            //     foreignField: '_id',
            //     as: 'mediastories_data',

            //   },

            // },
            // {
            //   $project: {
            // mediapict: {
            //   $arrayElemAt: ['$mediaPict_data', 0]
            // },
            // mediadiaries: {
            //   $arrayElemAt: ['$mediadiaries_data', 0]
            // },
            // mediavideos: {
            //   $arrayElemAt: ['$mediavideos_data', 0]
            // },
            // mediastories: {
            //   $arrayElemAt: ['$mediastories_data', 0]
            // },
            //     refs: 1,
            //     idmedia: 1,
            //     createdAt: 1,
            //     updatedAt: 1,
            //     postID: 1,
            //     postType: 1,
            //     email: 1,
            //     type: 1,
            //     description: 1,
            //     title: 1,
            //     active: 1,
            //     kepemilikan: 1,
            //     visibility: 1,
            //     saleAmount: 1,
            //     statusJual: 1,
            //     likes: 1,
            //     views: 1,
            //     shares: 1,
            //     comments: 1,
            //     countReport: 1,
            //     jenis: 1,
            //     mediaSource: 1
            //   }
            // },
            // {
            //   $addFields: {


            //     concatmediapict: '/pict',
            //     media_pict: {
            //       $replaceOne: {
            //         input: "$mediapict.mediaUri",
            //         find: "_0001.jpeg",
            //         replacement: ""
            //       }
            //     },
            //     concatmediadiari: '/stream',
            //     concatthumbdiari: '/thumb',
            //     media_diari: '$mediadiaries.mediaUri',
            //     concatmediavideo: '/stream',
            //     concatthumbvideo: '/thumb',
            //     media_video: '$mediavideos.mediaUri',
            //     concatmediastory:
            //     {
            //       $cond: {
            //         if: {

            //           $eq: ["$mediastories.mediaType", "image"]
            //         },
            //         then: '/pict',
            //         else: '/stream',

            //       }
            //     },
            //     concatthumbstory: '/thumb',
            //     media_story: '$mediastories.mediaUri'
            //   },

            // },
            {
              $project: {

                createdAt: 1,
                updatedAt: 1,
                postID: 1,
                postType: 1,
                email: 1,
                type: 1,
                description: 1,
                title: 1,
                active: 1,
                kepemilikan: 1,
                visibility: 1,
                saleAmount: 1,
                statusJual: 1,
                likes: 1,
                views: 1,
                shares: 1,
                comments: 1,
                countReport: 1,
                jenis: 1,
                mediaBasePath:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaBasePath",
                      null
                    ]
                },
                mediaUri:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaUri",
                      null
                    ]
                },
                mediaType:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaType",
                      null
                    ]
                },
                mediaThumbEndpoint:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaThumbEndpoint",
                      {
                        "$concat":
                          [
                            "/thumb/",
                            "$postID"
                          ]
                      }
                    ]
                },
                mediaEndpoint:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaEndpoint",
                      {
                        "$cond":
                        {
                          if:
                          {
                            "$eq":
                              [
                                "$postType", "pict"
                              ]
                          },
                          then:
                          {
                            "$concat":
                              [
                                "/pict/",
                                "$postID"
                              ]
                          },
                          else:
                          {
                            "$concat":
                              [
                                "/stream/",
                                "$postID"
                              ]
                          }
                        }
                      }
                    ]
                },
                mediaThumbUri:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaThumbUri",
                      null
                    ]
                },
                apsaraId: "$mediaSource.apsaraId",
                apsara: "$mediaSource.apsara"

              }
            },
            {
              $sort: {
                shares: - 1
              },

            },
            {
              $skip: 0
            },
            {
              $limit: 1
            },

          ],
          "lastPost": [
            {
              $project: {
                refs: {
                  $arrayElemAt: ['$contentMedias', 0]
                },
                createdAt: 1,
                updatedAt: 1,
                postID: 1,
                email: 1,
                postType: 1,
                description: 1,
                title: 1,
                active: 1,
                likes: 1,
                views: 1,
                shares: 1,
                comments: 1,
                jenis: "LASTPOST",
                countReport:
                {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$reportCount", - 1]
                      }, {
                        $eq: ["$reportCount", 0]
                      }]
                    },
                    then: 0,
                    else: "$reportedUserCount"
                  }
                },
                certified:
                {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$certi", - 1]
                      }, {
                        $eq: ["$certi", 0]
                      }]
                    },
                    then: false,
                    else: "$certified"
                  }
                },
                visibility: 1,
                saleAmount: {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$salePrice", - 1]
                      }, {
                        $eq: ["$salePrice", 0]
                      }]
                    },
                    then: 0,
                    else: "$saleAmount"
                  }
                },
                monetize: {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$salePrice", - 1]
                      }, {
                        $eq: ["$salePrice", 0]
                      }]
                    },
                    then: false,
                    else: true
                  }
                },
                mediaSource: {
                  $arrayElemAt: ['$mediaSource', 0]
                }

              }
            },
            {
              $project: {
                refs: '$refs.$ref',
                idmedia: '$refs.$id',
                createdAt: 1,
                updatedAt: 1,
                postID: 1,
                postType: 1,
                email: 1,
                likes: 1,
                views: 1,
                shares: 1,
                comments: 1,
                countReport: 1,
                jenis: 1,
                type: {
                  $switch: {
                    branches: [
                      {
                        'case': {
                          '$eq': ['$postType', 'pict']
                        },
                        'then': "HyppePic"
                      },
                      {
                        'case': {
                          '$eq': ['$postType', 'vid']
                        },
                        'then': "HyppeVid"
                      },
                      {
                        'case': {
                          '$eq': ['$postType', 'diary']
                        },
                        'then': "HyppeDiary"
                      },
                      {
                        'case': {
                          '$eq': ['$postType', 'story']
                        },
                        'then': "HyppeStory"
                      },

                    ],
                    default: ''
                  }
                },
                description: 1,
                title: 1,
                active: 1,
                kepemilikan:
                {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$certified", false]
                      }, {
                        $eq: ["$certified", ""]
                      }]
                    },
                    then: "TIDAK",
                    else: "YA"
                  }
                },
                visibility: 1,
                saleAmount: 1,
                statusJual:
                {
                  $cond: {
                    if: {

                      $eq: ["$monetize", false]
                    },
                    then: "TIDAK",
                    else: "YA"
                  }
                },
                mediaSource: 1

              }
            },
            // {
            //   $lookup: {
            //     from: 'mediapicts',
            //     localField: 'idmedia',
            //     foreignField: '_id',
            //     as: 'mediaPict_data',

            //   },

            // },
            // {
            //   $lookup: {
            //     from: 'mediadiaries',
            //     localField: 'idmedia',
            //     foreignField: '_id',
            //     as: 'mediadiaries_data',

            //   },

            // },
            // {
            //   $lookup: {
            //     from: 'mediavideos',
            //     localField: 'idmedia',
            //     foreignField: '_id',
            //     as: 'mediavideos_data',

            //   },

            // },
            // {
            //   $lookup: {
            //     from: 'mediastories',
            //     localField: 'idmedia',
            //     foreignField: '_id',
            //     as: 'mediastories_data',

            //   },

            // },
            // {
            //   $project: {
            // mediapict: {
            //   $arrayElemAt: ['$mediaPict_data', 0]
            // },
            // mediadiaries: {
            //   $arrayElemAt: ['$mediadiaries_data', 0]
            // },
            // mediavideos: {
            //   $arrayElemAt: ['$mediavideos_data', 0]
            // },
            // mediastories: {
            //   $arrayElemAt: ['$mediastories_data', 0]
            // },
            //     refs: 1,
            //     idmedia: 1,
            //     createdAt: 1,
            //     updatedAt: 1,
            //     postID: 1,
            //     postType: 1,
            //     email: 1,
            //     type: 1,
            //     description: 1,
            //     title: 1,
            //     active: 1,
            //     kepemilikan: 1,
            //     visibility: 1,
            //     saleAmount: 1,
            //     statusJual: 1,
            //     likes: 1,
            //     views: 1,
            //     shares: 1,
            //     comments: 1,
            //     countReport: 1,
            //     jenis: 1,
            //     mediaSource: 1
            //   }
            // },
            // {
            //   $addFields: {


            //     concatmediapict: '/pict',
            //     media_pict: {
            //       $replaceOne: {
            //         input: "$mediapict.mediaUri",
            //         find: "_0001.jpeg",
            //         replacement: ""
            //       }
            //     },
            //     concatmediadiari: '/stream',
            //     concatthumbdiari: '/thumb',
            //     media_diari: '$mediadiaries.mediaUri',
            //     concatmediavideo: '/stream',
            //     concatthumbvideo: '/thumb',
            //     media_video: '$mediavideos.mediaUri',
            //     concatmediastory:
            //     {
            //       $cond: {
            //         if: {

            //           $eq: ["$mediastories.mediaType", "image"]
            //         },
            //         then: '/pict',
            //         else: '/stream',

            //       }
            //     },
            //     concatthumbstory: '/thumb',
            //     media_story: '$mediastories.mediaUri'
            //   },

            // },
            {
              $project: {

                createdAt: 1,
                updatedAt: 1,
                postID: 1,
                postType: 1,
                email: 1,
                type: 1,
                description: 1,
                title: 1,
                active: 1,
                kepemilikan: 1,
                visibility: 1,
                saleAmount: 1,
                statusJual: 1,
                likes: 1,
                views: 1,
                shares: 1,
                comments: 1,
                countReport: 1,
                jenis: 1,
                mediaBasePath:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaBasePath",
                      null
                    ]
                },
                mediaUri:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaUri",
                      null
                    ]
                },
                mediaType:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaType",
                      null
                    ]
                },
                mediaThumbEndpoint:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaThumbEndpoint",
                      {
                        "$concat":
                          [
                            "/thumb/",
                            "$postID"
                          ]
                      }
                    ]
                },
                mediaEndpoint:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaEndpoint",
                      {
                        "$cond":
                        {
                          if:
                          {
                            "$eq":
                              [
                                "$postType", "pict"
                              ]
                          },
                          then:
                          {
                            "$concat":
                              [
                                "/pict/",
                                "$postID"
                              ]
                          },
                          else:
                          {
                            "$concat":
                              [
                                "/stream/",
                                "$postID"
                              ]
                          }
                        }
                      }
                    ]
                },
                mediaThumbUri:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaThumbUri",
                      null
                    ]
                },
                apsaraId: "$mediaSource.apsaraId",
                apsara: "$mediaSource.apsara"

              }
            },
            {
              $sort: {
                createdAt: - 1
              },

            },
            {
              $skip: 0
            },
            {
              $limit: 1
            },

          ],
          "ownership": [
            {
              $project: {
                refs: {
                  $arrayElemAt: ['$contentMedias', 0]
                },
                createdAt: 1,
                updatedAt: 1,
                postID: 1,
                email: 1,
                postType: 1,
                description: 1,
                title: 1,
                active: 1,
                likes: 1,
                views: 1,
                shares: 1,
                comments: 1,
                jenis: "OWNERSHIP",
                countReport:
                {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$reportCount", - 1]
                      }, {
                        $eq: ["$reportCount", 0]
                      }]
                    },
                    then: 0,
                    else: "$reportedUserCount"
                  }
                },
                certified:
                {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$certi", - 1]
                      }, {
                        $eq: ["$certi", 0]
                      }]
                    },
                    then: false,
                    else: "$certified"
                  }
                },
                visibility: 1,
                saleAmount: {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$salePrice", - 1]
                      }, {
                        $eq: ["$salePrice", 0]
                      }]
                    },
                    then: 0,
                    else: "$saleAmount"
                  }
                },
                monetize: {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$salePrice", - 1]
                      }, {
                        $eq: ["$salePrice", 0]
                      }]
                    },
                    then: false,
                    else: true
                  }
                },
                mediaSource: {
                  $arrayElemAt: ['$mediaSource', 0]
                }

              }
            },
            {
              $project: {
                refs: '$refs.$ref',
                idmedia: '$refs.$id',
                createdAt: 1,
                updatedAt: 1,
                postID: 1,
                postType: 1,
                email: 1,
                likes: 1,
                views: 1,
                shares: 1,
                comments: 1,
                countReport: 1,
                jenis: 1,
                type: {
                  $switch: {
                    branches: [
                      {
                        'case': {
                          '$eq': ['$postType', 'pict']
                        },
                        'then': "HyppePic"
                      },
                      {
                        'case': {
                          '$eq': ['$postType', 'vid']
                        },
                        'then': "HyppeVid"
                      },
                      {
                        'case': {
                          '$eq': ['$postType', 'diary']
                        },
                        'then': "HyppeDiary"
                      },
                      {
                        'case': {
                          '$eq': ['$postType', 'story']
                        },
                        'then': "HyppeStory"
                      },

                    ],
                    default: ''
                  }
                },
                description: 1,
                title: 1,
                active: 1,
                kepemilikan:
                {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$certified", false]
                      }, {
                        $eq: ["$certified", ""]
                      }]
                    },
                    then: "TIDAK",
                    else: "YA"
                  }
                },
                visibility: 1,
                saleAmount: 1,
                statusJual:
                {
                  $cond: {
                    if: {

                      $eq: ["$monetize", false]
                    },
                    then: "TIDAK",
                    else: "YA"
                  }
                },
                mediaSource: 1

              }
            },
            // {
            //   $lookup: {
            //     from: 'mediapicts',
            //     localField: 'idmedia',
            //     foreignField: '_id',
            //     as: 'mediaPict_data',

            //   },

            // },
            // {
            //   $lookup: {
            //     from: 'mediadiaries',
            //     localField: 'idmedia',
            //     foreignField: '_id',
            //     as: 'mediadiaries_data',

            //   },

            // },
            // {
            //   $lookup: {
            //     from: 'mediavideos',
            //     localField: 'idmedia',
            //     foreignField: '_id',
            //     as: 'mediavideos_data',

            //   },

            // },
            // {
            //   $lookup: {
            //     from: 'mediastories',
            //     localField: 'idmedia',
            //     foreignField: '_id',
            //     as: 'mediastories_data',

            //   },

            // },
            // {
            //   $project: {
            // mediapict: {
            //   $arrayElemAt: ['$mediaPict_data', 0]
            // },
            // mediadiaries: {
            //   $arrayElemAt: ['$mediadiaries_data', 0]
            // },
            // mediavideos: {
            //   $arrayElemAt: ['$mediavideos_data', 0]
            // },
            // mediastories: {
            //   $arrayElemAt: ['$mediastories_data', 0]
            // },
            //     refs: 1,
            //     idmedia: 1,
            //     createdAt: 1,
            //     updatedAt: 1,
            //     postID: 1,
            //     postType: 1,
            //     email: 1,
            //     type: 1,
            //     description: 1,
            //     title: 1,
            //     active: 1,
            //     kepemilikan: 1,
            //     visibility: 1,
            //     saleAmount: 1,
            //     statusJual: 1,
            //     likes: 1,
            //     views: 1,
            //     shares: 1,
            //     comments: 1,
            //     countReport: 1,
            //     jenis: 1,
            //     mediaSource: 1
            //   }
            // },
            // {
            //   $addFields: {


            //     concatmediapict: '/pict',
            //     media_pict: {
            //       $replaceOne: {
            //         input: "$mediapict.mediaUri",
            //         find: "_0001.jpeg",
            //         replacement: ""
            //       }
            //     },
            //     concatmediadiari: '/stream',
            //     concatthumbdiari: '/thumb',
            //     media_diari: '$mediadiaries.mediaUri',
            //     concatmediavideo: '/stream',
            //     concatthumbvideo: '/thumb',
            //     media_video: '$mediavideos.mediaUri',
            //     concatmediastory:
            //     {
            //       $cond: {
            //         if: {

            //           $eq: ["$mediastories.mediaType", "image"]
            //         },
            //         then: '/pict',
            //         else: '/stream',

            //       }
            //     },
            //     concatthumbstory: '/thumb',
            //     media_story: '$mediastories.mediaUri'
            //   },

            // },
            {
              $project: {

                createdAt: 1,
                updatedAt: 1,
                postID: 1,
                postType: 1,
                email: 1,
                type: 1,
                description: 1,
                title: 1,
                active: 1,
                kepemilikan: 1,
                visibility: 1,
                saleAmount: 1,
                statusJual: 1,
                likes: 1,
                views: 1,
                shares: 1,
                comments: 1,
                countReport: 1,
                jenis: 1,
                mediaBasePath:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaBasePath",
                      null
                    ]
                },
                mediaUri:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaUri",
                      null
                    ]
                },
                mediaType:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaType",
                      null
                    ]
                },
                mediaThumbEndpoint:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaThumbEndpoint",
                      {
                        "$concat":
                          [
                            "/thumb/",
                            "$postID"
                          ]
                      }
                    ]
                },
                mediaEndpoint:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaEndpoint",
                      {
                        "$cond":
                        {
                          if:
                          {
                            "$eq":
                              [
                                "$postType", "pict"
                              ]
                          },
                          then:
                          {
                            "$concat":
                              [
                                "/pict/",
                                "$postID"
                              ]
                          },
                          else:
                          {
                            "$concat":
                              [
                                "/stream/",
                                "$postID"
                              ]
                          }
                        }
                      }
                    ]
                },
                mediaThumbUri:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaThumbUri",
                      null
                    ]
                },
                apsaraId: "$mediaSource.apsaraId",
                apsara: "$mediaSource.apsara"

              }
            },
            {
              $match: {
                kepemilikan: "YA"
              }
            },
            {
              $sort: {
                createdAt: - 1
              },

            },
            {
              $skip: 0
            },
            {
              $limit: 1
            },

          ],
          "monetize": [
            {
              $project: {
                refs: {
                  $arrayElemAt: ['$contentMedias', 0]
                },
                createdAt: 1,
                updatedAt: 1,
                postID: 1,
                email: 1,
                postType: 1,
                description: 1,
                title: 1,
                active: 1,
                likes: 1,
                views: 1,
                shares: 1,
                comments: 1,
                jenis: "MONETIZE",
                countReport:
                {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$reportCount", - 1]
                      }, {
                        $eq: ["$reportCount", 0]
                      }]
                    },
                    then: 0,
                    else: "$reportedUserCount"
                  }
                },
                certified:
                {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$certi", - 1]
                      }, {
                        $eq: ["$certi", 0]
                      }]
                    },
                    then: false,
                    else: "$certified"
                  }
                },
                visibility: 1,
                saleAmount: {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$salePrice", - 1]
                      }, {
                        $eq: ["$salePrice", 0]
                      }]
                    },
                    then: 0,
                    else: "$saleAmount"
                  }
                },
                monetize: {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$salePrice", - 1]
                      }, {
                        $eq: ["$salePrice", 0]
                      }]
                    },
                    then: false,
                    else: true
                  }
                },
                mediaSource: {
                  $arrayElemAt: ['$mediaSource', 0]
                }

              }
            },
            {
              $project: {
                refs: '$refs.$ref',
                idmedia: '$refs.$id',
                createdAt: 1,
                updatedAt: 1,
                postID: 1,
                postType: 1,
                email: 1,
                likes: 1,
                views: 1,
                shares: 1,
                comments: 1,
                countReport: 1,
                jenis: 1,
                type: {
                  $switch: {
                    branches: [
                      {
                        'case': {
                          '$eq': ['$postType', 'pict']
                        },
                        'then': "HyppePic"
                      },
                      {
                        'case': {
                          '$eq': ['$postType', 'vid']
                        },
                        'then': "HyppeVid"
                      },
                      {
                        'case': {
                          '$eq': ['$postType', 'diary']
                        },
                        'then': "HyppeDiary"
                      },
                      {
                        'case': {
                          '$eq': ['$postType', 'story']
                        },
                        'then': "HyppeStory"
                      },

                    ],
                    default: ''
                  }
                },
                description: 1,
                title: 1,
                active: 1,
                kepemilikan:
                {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$certified", false]
                      }, {
                        $eq: ["$certified", ""]
                      }]
                    },
                    then: "TIDAK",
                    else: "YA"
                  }
                },
                visibility: 1,
                saleAmount: 1,
                statusJual:
                {
                  $cond: {
                    if: {

                      $eq: ["$monetize", false]
                    },
                    then: "TIDAK",
                    else: "YA"
                  }
                },
                mediaSource: 1

              }
            },
            // {
            //   $lookup: {
            //     from: 'mediapicts',
            //     localField: 'idmedia',
            //     foreignField: '_id',
            //     as: 'mediaPict_data',

            //   },

            // },
            // {
            //   $lookup: {
            //     from: 'mediadiaries',
            //     localField: 'idmedia',
            //     foreignField: '_id',
            //     as: 'mediadiaries_data',

            //   },

            // },
            // {
            //   $lookup: {
            //     from: 'mediavideos',
            //     localField: 'idmedia',
            //     foreignField: '_id',
            //     as: 'mediavideos_data',

            //   },

            // },
            // {
            //   $lookup: {
            //     from: 'mediastories',
            //     localField: 'idmedia',
            //     foreignField: '_id',
            //     as: 'mediastories_data',

            //   },

            // },
            // {
            //   $project: {
            // mediapict: {
            //   $arrayElemAt: ['$mediaPict_data', 0]
            // },
            // mediadiaries: {
            //   $arrayElemAt: ['$mediadiaries_data', 0]
            // },
            // mediavideos: {
            //   $arrayElemAt: ['$mediavideos_data', 0]
            // },
            // mediastories: {
            //   $arrayElemAt: ['$mediastories_data', 0]
            // },
            //     refs: 1,
            //     idmedia: 1,
            //     createdAt: 1,
            //     updatedAt: 1,
            //     postID: 1,
            //     postType: 1,
            //     email: 1,
            //     type: 1,
            //     description: 1,
            //     title: 1,
            //     active: 1,
            //     kepemilikan: 1,
            //     visibility: 1,
            //     saleAmount: 1,
            //     statusJual: 1,
            //     likes: 1,
            //     views: 1,
            //     shares: 1,
            //     comments: 1,
            //     countReport: 1,
            //     jenis: 1,
            //     mediaSource: 1
            //   }
            // },
            // {
            //   $addFields: {


            //     concatmediapict: '/pict',
            //     media_pict: {
            //       $replaceOne: {
            //         input: "$mediapict.mediaUri",
            //         find: "_0001.jpeg",
            //         replacement: ""
            //       }
            //     },
            //     concatmediadiari: '/stream',
            //     concatthumbdiari: '/thumb',
            //     media_diari: '$mediadiaries.mediaUri',
            //     concatmediavideo: '/stream',
            //     concatthumbvideo: '/thumb',
            //     media_video: '$mediavideos.mediaUri',
            //     concatmediastory:
            //     {
            //       $cond: {
            //         if: {

            //           $eq: ["$mediastories.mediaType", "image"]
            //         },
            //         then: '/pict',
            //         else: '/stream',

            //       }
            //     },
            //     concatthumbstory: '/thumb',
            //     media_story: '$mediastories.mediaUri'
            //   },

            // },
            {
              $project: {

                createdAt: 1,
                updatedAt: 1,
                postID: 1,
                postType: 1,
                email: 1,
                type: 1,
                description: 1,
                title: 1,
                active: 1,
                kepemilikan: 1,
                visibility: 1,
                saleAmount: 1,
                statusJual: 1,
                likes: 1,
                views: 1,
                shares: 1,
                comments: 1,
                countReport: 1,
                jenis: 1,
                mediaBasePath:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaBasePath",
                      null
                    ]
                },
                mediaUri:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaUri",
                      null
                    ]
                },
                mediaType:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaType",
                      null
                    ]
                },
                mediaThumbEndpoint:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaThumbEndpoint",
                      {
                        "$concat":
                          [
                            "/thumb/",
                            "$postID"
                          ]
                      }
                    ]
                },
                mediaEndpoint:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaEndpoint",
                      {
                        "$cond":
                        {
                          if:
                          {
                            "$eq":
                              [
                                "$postType", "pict"
                              ]
                          },
                          then:
                          {
                            "$concat":
                              [
                                "/pict/",
                                "$postID"
                              ]
                          },
                          else:
                          {
                            "$concat":
                              [
                                "/stream/",
                                "$postID"
                              ]
                          }
                        }
                      }
                    ]
                },
                mediaThumbUri:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaThumbUri",
                      null
                    ]
                },
                apsaraId: "$mediaSource.apsaraId",
                apsara: "$mediaSource.apsara"

              }
            },
            {
              $match: {
                statusJual: "YA"
              }
            },
            {
              $sort: {
                createdAt: - 1
              },

            },
            {
              $skip: 0
            },
            {
              $limit: 1
            },

          ],
          "lastreportContent": [
            {
              $project: {
                refs: {
                  $arrayElemAt: ['$contentMedias', 0]
                },
                createdAt: 1,
                updatedAt: 1,
                postID: 1,
                email: 1,
                postType: 1,
                description: 1,
                title: 1,
                active: 1,
                likes: 1,
                views: 1,
                shares: 1,
                comments: 1,
                jenis: "LASTREPORT",
                countReport:
                {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$reportCount", - 1]
                      }, {
                        $eq: ["$reportCount", 0]
                      }]
                    },
                    then: 0,
                    else: "$reportedUserCount"
                  }
                },
                certified:
                {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$certi", - 1]
                      }, {
                        $eq: ["$certi", 0]
                      }]
                    },
                    then: false,
                    else: "$certified"
                  }
                },
                visibility: 1,
                saleAmount: {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$salePrice", - 1]
                      }, {
                        $eq: ["$salePrice", 0]
                      }]
                    },
                    then: 0,
                    else: "$saleAmount"
                  }
                },
                monetize: {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$salePrice", - 1]
                      }, {
                        $eq: ["$salePrice", 0]
                      }]
                    },
                    then: false,
                    else: true
                  }
                },
                mediaSource: {
                  $arrayElemAt: ['$mediaSource', 0]
                }

              }
            },
            {
              $project: {
                refs: '$refs.$ref',
                idmedia: '$refs.$id',
                createdAt: 1,
                updatedAt: 1,
                postID: 1,
                postType: 1,
                email: 1,
                likes: 1,
                views: 1,
                shares: 1,
                comments: 1,
                countReport: 1,
                jenis: 1,
                type: {
                  $switch: {
                    branches: [
                      {
                        'case': {
                          '$eq': ['$postType', 'pict']
                        },
                        'then': "HyppePic"
                      },
                      {
                        'case': {
                          '$eq': ['$postType', 'vid']
                        },
                        'then': "HyppeVid"
                      },
                      {
                        'case': {
                          '$eq': ['$postType', 'diary']
                        },
                        'then': "HyppeDiary"
                      },
                      {
                        'case': {
                          '$eq': ['$postType', 'story']
                        },
                        'then': "HyppeStory"
                      },

                    ],
                    default: ''
                  }
                },
                description: 1,
                title: 1,
                active: 1,
                kepemilikan:
                {
                  $cond: {
                    if: {
                      $or: [{
                        $eq: ["$certified", false]
                      }, {
                        $eq: ["$certified", ""]
                      }]
                    },
                    then: "TIDAK",
                    else: "YA"
                  }
                },
                visibility: 1,
                saleAmount: 1,
                statusJual:
                {
                  $cond: {
                    if: {

                      $eq: ["$monetize", false]
                    },
                    then: "TIDAK",
                    else: "YA"
                  }
                },
                mediaSource: 1

              }
            },
            // {
            //   $lookup: {
            //     from: 'mediapicts',
            //     localField: 'idmedia',
            //     foreignField: '_id',
            //     as: 'mediaPict_data',

            //   },

            // },
            // {
            //   $lookup: {
            //     from: 'mediadiaries',
            //     localField: 'idmedia',
            //     foreignField: '_id',
            //     as: 'mediadiaries_data',

            //   },

            // },
            // {
            //   $lookup: {
            //     from: 'mediavideos',
            //     localField: 'idmedia',
            //     foreignField: '_id',
            //     as: 'mediavideos_data',

            //   },

            // },
            // {
            //   $lookup: {
            //     from: 'mediastories',
            //     localField: 'idmedia',
            //     foreignField: '_id',
            //     as: 'mediastories_data',

            //   },

            // },
            // {
            //   $project: {
            // mediapict: {
            //   $arrayElemAt: ['$mediaPict_data', 0]
            // },
            // mediadiaries: {
            //   $arrayElemAt: ['$mediadiaries_data', 0]
            // },
            // mediavideos: {
            //   $arrayElemAt: ['$mediavideos_data', 0]
            // },
            // mediastories: {
            //   $arrayElemAt: ['$mediastories_data', 0]
            // },
            //     refs: 1,
            //     idmedia: 1,
            //     createdAt: 1,
            //     updatedAt: 1,
            //     postID: 1,
            //     postType: 1,
            //     email: 1,
            //     type: 1,
            //     description: 1,
            //     title: 1,
            //     active: 1,
            //     kepemilikan: 1,
            //     visibility: 1,
            //     saleAmount: 1,
            //     statusJual: 1,
            //     likes: 1,
            //     views: 1,
            //     shares: 1,
            //     comments: 1,
            //     countReport: 1,
            //     jenis: 1,
            //     mediaSource: 1
            //   }
            // },
            // {
            //   $addFields: {


            //     concatmediapict: '/pict',
            //     media_pict: {
            //       $replaceOne: {
            //         input: "$mediapict.mediaUri",
            //         find: "_0001.jpeg",
            //         replacement: ""
            //       }
            //     },
            //     concatmediadiari: '/stream',
            //     concatthumbdiari: '/thumb',
            //     media_diari: '$mediadiaries.mediaUri',
            //     concatmediavideo: '/stream',
            //     concatthumbvideo: '/thumb',
            //     media_video: '$mediavideos.mediaUri',
            //     concatmediastory:
            //     {
            //       $cond: {
            //         if: {

            //           $eq: ["$mediastories.mediaType", "image"]
            //         },
            //         then: '/pict',
            //         else: '/stream',

            //       }
            //     },
            //     concatthumbstory: '/thumb',
            //     media_story: '$mediastories.mediaUri'
            //   },

            // },
            {
              $project: {

                createdAt: 1,
                updatedAt: 1,
                postID: 1,
                postType: 1,
                email: 1,
                type: 1,
                description: 1,
                title: 1,
                active: 1,
                kepemilikan: 1,
                visibility: 1,
                saleAmount: 1,
                statusJual: 1,
                likes: 1,
                views: 1,
                shares: 1,
                comments: 1,
                countReport: 1,
                jenis: 1,
                mediaBasePath:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaBasePath",
                      null
                    ]
                },
                mediaUri:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaUri",
                      null
                    ]
                },
                mediaType:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaType",
                      null
                    ]
                },
                mediaThumbEndpoint:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaThumbEndpoint",
                      {
                        "$concat":
                          [
                            "/thumb/",
                            "$postID"
                          ]
                      }
                    ]
                },
                mediaEndpoint:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaEndpoint",
                      {
                        "$cond":
                        {
                          if:
                          {
                            "$eq":
                              [
                                "$postType", "pict"
                              ]
                          },
                          then:
                          {
                            "$concat":
                              [
                                "/pict/",
                                "$postID"
                              ]
                          },
                          else:
                          {
                            "$concat":
                              [
                                "/stream/",
                                "$postID"
                              ]
                          }
                        }
                      }
                    ]
                },
                mediaThumbUri:
                {
                  "$ifNull":
                    [
                      "$mediaSource.mediaThumbUri",
                      null
                    ]
                },
                apsaraId: "$mediaSource.apsaraId",
                apsara: "$mediaSource.apsara"

              }
            },
            {
              $match: {
                countReport: {
                  $ne: 0
                }
              }
            },
            {
              $sort: {
                createdAt: - 1
              },

            },
            {
              $skip: 0
            },
            {
              $limit: 1
            },

          ],

        }
      },
      {
        $project: {

          data: { $concatArrays: ["$popular", "$likes", "$shares", "$lastPost", "$ownership", "$monetize", "$lastreportContent"] }

        }
      }
    ]);

    var leng = null;
    var arrayData = [];
    leng = query[0].data.length;

    for (let i = 0; i < leng; i++) {
      let data = await this.getapsaraDatabase(query[0].data, i);
      arrayData.push(data[i])
    }

    // persentase 
    var genderChart = await this.contentEventService.genderChartbyEmail(email);
    //OTHER -> FEMALE -> MALE
    var arrGenderChart = [];
    var total = parseInt('0');
    genderChart.forEach(function (data) {
      total = total + parseInt(data.count);
    });

    genderChart.forEach(function (data) {
      var temparray = {};

      temparray['gender'] = data._id;
      temparray['total'] = data.count;
      var temptotal = (parseInt(data.count) / total) * 100;
      temparray['persentase'] = temptotal.toFixed(2);
      arrGenderChart.push(temparray);
    });
    var data = [{
      arrayData, "genderViewer": arrGenderChart

    }];

    return data;
  }

  async getapsaraDatabase(obj: object, n: number) {
    let idapsara = null;
    let apsara = null;
    let apsaradefine = null;
    let idapsaradefine = null;
    let pict = null;
    var mediaType = null;
    try {
      idapsara = obj[n].apsaraId;
    } catch (e) {
      idapsara = "";
    }
    try {
      apsara = obj[n].apsara;
    } catch (e) {
      apsara = false;
    }

    if (apsara === undefined || apsara === "" || apsara === null || apsara === false) {
      apsaradefine = false;
    } else {
      apsaradefine = true;
    }

    if (idapsara === undefined || idapsara === "" || idapsara === null || idapsara === "other") {
      idapsaradefine = "";
    } else {
      idapsaradefine = idapsara;
    }
    var type = obj[n].postType;
    var mediaType = obj[n].mediaType;
    pict = [idapsara];

    if (idapsara === "") {

    } else {
      if (type === "pict") {

        try {
          obj[n].apsaraId = idapsaradefine;
          obj[n].apsara = apsaradefine;
          obj[n].media = await this.postContentService.getImageApsara(pict);
        } catch (e) {
          obj[n].media = {};
        }
      }
      else if (type === "vid") {
        try {
          obj[n].apsaraId = idapsaradefine;
          obj[n].apsara = apsaradefine;
          obj[n].media = await this.postContentService.getVideoApsara(pict);
        } catch (e) {
          obj[n].media = {};
        }

      }
      else if (type === "story") {
        if (mediaType === "image") {

          try {
            obj[n].apsaraId = idapsaradefine;
            obj[n].apsara = apsaradefine;
            obj[n].media = await this.postContentService.getImageApsara(pict);
          } catch (e) {
            obj[n].media = {};
          }
        } else {
          try {
            obj[n].apsaraId = idapsaradefine;
            obj[n].apsara = apsaradefine;
            obj[n].media = await this.postContentService.getVideoApsara(pict);
          } catch (e) {
            obj[n].media = {};
          }
        }
      }
      else if (type === "diary") {
        try {
          obj[n].apsaraId = idapsaradefine;
          obj[n].apsara = apsaradefine;
          obj[n].media = await this.postContentService.getVideoApsara(pict);
        } catch (e) {
          obj[n].media = {};

        }
      }
    }

    return obj;
  }

  async getactivitygraphv2(email: string) {
    var getdate = new Date();
    var firsttanggal = [];
    var lasttanggal = [];

    for (var i = 5; i >= 0; i--) {
      var temp = new Date(getdate.getFullYear(), getdate.getMonth() - i, getdate.getDate() + 1).toISOString().split('T')[0];
      lasttanggal.push(temp.toString() + " 23:59:59");
      var tambahbulan = i + 1;
      var temp = new Date(getdate.getFullYear(), getdate.getMonth() - tambahbulan, getdate.getDate() + 1).toISOString().split('T')[0];
      firsttanggal.push(temp.toString() + " 00:00:00");
    }

    const query = await this.loaddata.aggregate([
      {
        $facet:
        {
          "0":
            [
              {
                $match:
                {
                  $and:
                    [
                      {
                        email: email,
                      },
                      {
                        $expr:
                        {
                          $gt: ["$views", 0,]
                        },
                      },
                      {
                        $expr:
                        {
                          $gte: ["$createdAt", firsttanggal[0],]
                        },
                      },
                      {
                        $expr:
                        {
                          $lt: ["$createdAt", lasttanggal[0],]
                        },
                      },
                    ]
                }
              },
              {
                $group:
                {
                  "_id": lasttanggal[0],
                  "count":
                  {
                    "$sum": 1
                  }
                }
              },
            ],
          "1":
            [
              {
                $match:
                {
                  $and:
                    [
                      {
                        email: email,
                      },
                      {
                        $expr:
                        {
                          $gt: ["$views", 0,]
                        },
                      },
                      {
                        $expr:
                        {
                          $gte: ["$createdAt", firsttanggal[1],]
                        },
                      },
                      {
                        $expr:
                        {
                          $lt: ["$createdAt", lasttanggal[1],]
                        },
                      },
                    ]
                }
              },
              {
                $group:
                {
                  "_id": lasttanggal[1],
                  "count":
                  {
                    "$sum": 1
                  }
                }
              },
            ],
          "2":
            [
              {
                $match:
                {
                  $and:
                    [
                      {
                        email: email,
                      },
                      {
                        $expr:
                        {
                          $gt: ["$views", 0,]
                        },
                      },
                      {
                        $expr:
                        {
                          $gte: ["$createdAt", firsttanggal[2],]
                        },
                      },
                      {
                        $expr:
                        {
                          $lt: ["$createdAt", lasttanggal[2],]
                        },
                      },
                    ]
                }
              },
              {
                $group:
                {
                  "_id": lasttanggal[2],
                  "count":
                  {
                    "$sum": 1
                  }
                }
              },
            ],
          "3":
            [
              {
                $match:
                {
                  $and:
                    [
                      {
                        email: email,
                      },
                      {
                        $expr:
                        {
                          $gt: ["$views", 0,]
                        },
                      },
                      {
                        $expr:
                        {
                          $gte: ["$createdAt", firsttanggal[3],]
                        },
                      },
                      {
                        $expr:
                        {
                          $lt: ["$createdAt", lasttanggal[3],]
                        },
                      },
                    ]
                }
              },
              {
                $group:
                {
                  "_id": lasttanggal[3],
                  "count":
                  {
                    "$sum": 1
                  }
                }
              },
            ],
          "4":
            [
              {
                $match:
                {
                  $and:
                    [
                      {
                        email: email,
                      },
                      {
                        $expr:
                        {
                          $gt: ["$views", 0,]
                        },
                      },
                      {
                        $expr:
                        {
                          $gte: ["$createdAt", firsttanggal[4],]
                        },
                      },
                      {
                        $expr:
                        {
                          $lt: ["$createdAt", lasttanggal[4],]
                        },
                      },
                    ]
                }
              },
              {
                $group:
                {
                  "_id": lasttanggal[4],
                  "count":
                  {
                    "$sum": 1
                  }
                }
              },
            ],
          "5":
            [
              {
                $match:
                {
                  $and:
                    [
                      {
                        email: email,
                      },
                      {
                        $expr:
                        {
                          $gt: ["$views", 0,]
                        },
                      },
                      {
                        $expr:
                        {
                          $gte: ["$createdAt", firsttanggal[5],]
                        },
                      },
                      {
                        $expr:
                        {
                          $lt: ["$createdAt", lasttanggal[5],]
                        },
                      },
                    ]
                }
              },
              {
                $group:
                {
                  "_id": lasttanggal[5],
                  "count":
                  {
                    "$sum": 1
                  },
                }
              },
            ],
        },
      },
      {
        $project:
        {
          arrayData:
          {
            $concatArrays:
              [
                "$0", "$1", "$2", "$3", "$4", "$5"
              ]
          }
        }
      }
    ]);

    //console.log(query[0].arrayData);

    //cek apabila data kosong atau ada yang kosong di antara hasil result database
    var tempobj = query[0].arrayData;
    var newobject = [];
    for (var i = 0; i < 6; i++) {
      const cekexist = tempobj.find(({ _id }) => _id === lasttanggal[i]);
      const temp = {};
      Object.assign(temp, { _id: lasttanggal[i].toString() });
      if (cekexist == undefined) {
        Object.assign(temp, { count: 0 });
      }
      else {
        Object.assign(temp, { count: cekexist.count });
      }

      var gettanggal = new Date(lasttanggal[i]);
      Object.assign(temp, { bulan: gettanggal.toDateString().split(" ")[1] });

      newobject.push(temp);
    }

    query[0].arrayData = newobject;

    return query;
  }

  async deletePostChalenge(postId: string, idChallenge: string, idSubChallenge: string,) {
    const postchallengeData = await this.postchallengeService.findBypostIDnew(postId, idChallenge, idSubChallenge);
    if (await this.utilsService.ceckData(postchallengeData)) {
      let postScore = 0;

      if (postchallengeData.score != undefined) {
        postScore = Number(postchallengeData.score);
      }

      var dt = new Date(Date.now());
      dt.setHours(dt.getHours() + 7); // timestamp
      dt = new Date(dt);

      var strdate = dt.toISOString();
      var repdate = strdate.replace('T', ' ');
      var splitdate = repdate.split('.');
      var timedate = splitdate[0];
      var datauserchallengeNew = null;
      var scorenegatif = null;
      let userchallenges = new Userchallenges();
      userchallenges.idUser = new mongoose.Types.ObjectId(postchallengeData.idUser.toString());
      userchallenges.idChallenge = new mongoose.Types.ObjectId(idChallenge);
      userchallenges.idSubChallenge = new mongoose.Types.ObjectId(idSubChallenge);
      var UserchallengesData = await this.userchallengesService.findData(userchallenges);


      if (UserchallengesData.length > 0) {

        let score = 0;
        let scrdata = 0;
        try {
          scrdata = Number(UserchallengesData[0].score);
        } catch (e) {
          scrdata = 0;
        }

        if (scrdata > 0) {
          score = Number(UserchallengesData[0].score);
          score = score - postScore;
          let userchallenges_ = new Userchallenges();
          userchallenges_.score = score;
          await this.userchallengesService.updateByUSer(UserchallengesData[0]._id.toString(), UserchallengesData[0].idSubChallenge.toString(), userchallenges_);

          //update score if negative
          try {
            datauserchallengeNew = await this.userchallengesService.findOneByid(UserchallengesData[0]._id.toString(), UserchallengesData[0].idSubChallenge.toString());
          } catch (e) {
            datauserchallengeNew = null;
          }

          if (datauserchallengeNew !== null && datauserchallengeNew !== undefined) {
            scorenegatif = datauserchallengeNew.score;
          } else {
            scorenegatif = 0;
          }

          if (scorenegatif < 0) {
            await this.userchallengesService.updateScoreNull(UserchallengesData[0]._id.toString(), timedate);
          }

        }
        await this.postchallengeService.updateByUSer(postchallengeData._id.toString(), idSubChallenge.toString(), idChallenge.toString(), postId)
        // var datauschall = await this.userchallengesService.datauserchallbyidchall(idChallenge, idSubChallenge);

        // if (datauschall.length > 0) {
        //   for (let x = 0; x < datauschall.length; x++) {

        //     let iducall = datauschall[x]._id;
        //     // let start = new Date(datauschall[x].startDatetime);
        //     // let end = new Date(datauschall[x].endDatetime);
        //     // let datenow = new Date(Date.now());
        //     // let idChallenges2 = datauschall[x].idChallenge;
        //     let rank = x + 1;
        //     await this.userchallengesService.updateRangking(iducall.toString(), rank, timedate);


        //   }
        // }




      }

    }
  }

  async getUserEvent(CreateGetcontenteventsDto_: GetcontenteventsDto) {
    let pipeline = [];
    pipeline.push(
      {
        "$match":
        {
          "postID": CreateGetcontenteventsDto_.postID
        }
      },
    )
    if (CreateGetcontenteventsDto_.eventType == "VIEW") {
      pipeline.push(
        {
          "$lookup":
          {
            from: "newUserBasics",
            as: "basic_data",
            let:
            {
              email_fk: "$userView"
            },
            pipeline:
              [
                {
                  "$match":
                  {
                    "$expr": { '$in': ['$email', '$$email_fk'] },
                  }
                },
                {
                  "$project":
                  {
                    "_id": 1,
                    "email": 1,
                    "fullName": 1,
                    "username": 1,
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$arrayElemAt":
                              [
                                {
                                  "$filter":
                                  {
                                    input: "$userBadge",
                                    as: "listbadge",
                                    cond:
                                    {
                                      "$and":
                                        [
                                          {
                                            "$eq":
                                              [
                                                "$$listbadge.isActive", true
                                              ]
                                          },
                                          {
                                            "$lte":
                                              [
                                                {
                                                  "$dateToString": {
                                                    "format": "%Y-%m-%d %H:%M:%S",
                                                    "date": {
                                                      "$add": [
                                                        new Date(),
                                                        25200000
                                                      ]
                                                    }
                                                  }
                                                },
                                                "$$listbadge.endDatetime"
                                              ]
                                          }
                                        ]
                                    }
                                  }
                                }, 0
                              ]
                          },
                          []
                        ]
                    },
                    "avatar": {
                      "$cond":
                      {
                        if:
                        {
                          "$eq":
                            [
                              "$_idAvatar",
                              null
                            ]
                        },
                        then: null,
                        else:
                        {
                          "mediaBasePath": "$mediaBasePath",
                          "mediaUri": "$mediaUri",
                          "mediaType": "$mediaType",
                          "mediaEndpoint": "$mediaEndpoint"
                        }
                      }
                    },
                    "following": {
                      "$ifNull":
                        [
                          {
                            "$cond":
                            {
                              if:
                              {
                                "$eq":
                                  [
                                    {
                                      "$size": "$follower"
                                    },
                                    0
                                  ]
                              },
                              then: false,
                              else:
                              {
                                "$in": [
                                  CreateGetcontenteventsDto_.emailView,
                                  "$follower"
                                ]
                              }
                            }
                          },
                          false
                        ]
                    },
                    "guest": {
                      "$ifNull":
                        [
                          "$guestMode",
                          false
                        ]
                    }
                  }
                }
              ]
          }
        },
      )
    }
    if (CreateGetcontenteventsDto_.eventType == "LIKE") {
      pipeline.push(
        {
          "$lookup":
          {
            from: "newUserBasics",
            as: "basic_data",
            let:
            {
              email_fk: "$userLike"
            },
            pipeline:
              [
                {
                  "$match":
                  {
                    "$expr": { '$in': ['$email', '$$email_fk'] },
                  }
                },
                {
                  "$project":
                  {
                    "_id": 1,
                    "email": 1,
                    "fullName": 1,
                    "username": 1,
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$arrayElemAt":
                              [
                                {
                                  "$filter":
                                  {
                                    input: "$userBadge",
                                    as: "listbadge",
                                    cond:
                                    {
                                      "$and":
                                        [
                                          {
                                            "$eq":
                                              [
                                                "$$listbadge.isActive", true
                                              ]
                                          },
                                          {
                                            "$lte":
                                              [
                                                {
                                                  "$dateToString": {
                                                    "format": "%Y-%m-%d %H:%M:%S",
                                                    "date": {
                                                      "$add": [
                                                        new Date(),
                                                        25200000
                                                      ]
                                                    }
                                                  }
                                                },
                                                "$$listbadge.endDatetime"
                                              ]
                                          }
                                        ]
                                    }
                                  }
                                }, 0
                              ]
                          },
                          []
                        ]
                    },
                    "avatar": {
                      "$cond":
                      {
                        if:
                        {
                          "$eq":
                            [
                              "$_idAvatar",
                              null
                            ]
                        },
                        then: null,
                        else:
                        {
                          "mediaBasePath": "$mediaBasePath",
                          "mediaUri": "$mediaUri",
                          "mediaType": "$mediaType",
                          "mediaEndpoint": "$mediaEndpoint"
                        }
                      }
                    },
                    "following": {
                      "$ifNull":
                        [
                          {
                            "$cond":
                            {
                              if:
                              {
                                "$eq":
                                  [
                                    {
                                      "$size": "$follower"
                                    },
                                    0
                                  ]
                              },
                              then: false,
                              else:
                              {
                                "$in": [
                                  CreateGetcontenteventsDto_.emailView,
                                  "$follower"
                                ]
                              }
                            }
                          },
                          false
                        ]
                    },
                    "guest": {
                      "$ifNull":
                        [
                          "$guestMode",
                          false
                        ]
                    }
                  }
                }
              ]
          }
        },
      )
    }
    pipeline.push(
      {
        $unwind: {
          path: "$basic_data",
          preserveNullAndEmptyArrays: false
        }
      },
      {
        $project: {
          _id: "$basic_data._id",
          email: "$basic_data.email",
          fullName: "$basic_data.fullName",
          username: "$basic_data.username",
          urluserBadge: "$basic_data.urluserBadge",
          avatar: "$basic_data.avatar",
          following: "$basic_data.following",
          guest: "$basic_data.guest"
        }
      },
      {
        $facet:
        {
          user: [
            {
              "$match":
              {
                "guest": false
              }
            },
            {
              "$skip": (CreateGetcontenteventsDto_.skip * CreateGetcontenteventsDto_.limit)
            },
            {
              "$limit": CreateGetcontenteventsDto_.limit
            },
          ],
          guest: [
            {
              "$match":
              {
                "guest": true
              }
            },
          ],
        }
      },
      {
        $project: {
          user: 1,
          guest: { "$size": "$guest" }
        }
      },
    );
    const getData = await this.loaddata.aggregate(pipeline);
    return getData;
  }

  async finddatasearchcontenNewv2(key: string, email: string, skip: number, limit: number, pict: any, vid: any, diary: any, user: any, tag: any) {


    var pipeline = [];

    pipeline.push({
      $project: {
        "dedy": key
      }
    },
      {
        $limit: 1
      },);

    if (pict === true && vid === false && diary === false && user === true && tag === false) {
      pipeline.push(
        {
          $facet:
          {
            "user":
              [
                {
                  $lookup: {
                    from: "newUserBasics",
                    let: {
                      name: "$dedy"
                    },
                    pipeline: [
                      {
                        $match: {
                          $expr: {
                            $regexMatch: {
                              input: "$username",
                              regex: "$$name",
                              options: "i"
                            }
                          }
                        }
                      }
                    ],
                    as: "userAuth"
                  },

                },
                {
                  $unwind: {
                    path: "$userAuth",
                    preserveNullAndEmptyArrays: true
                  }
                },
                {
                  $project: {
                    "fullName": "$userAuth.fullName",
                    "profilePict": "$userAuth.profilePict",
                    "username": "$userAuth.username",
                    "email": "$userAuth.email",
                    "avatar":
                      [{
                        "mediaBasePath": "$userAuth.mediaBasePath",
                        "mediaUri": "$userAuth.mediaUri",
                        "originalName": "$userAuth.originalName",
                        "fsSourceUri": "$userAuth.fsSourceUri",
                        "fsSourceName": "$userBasic.fsSourceName",
                        "fsTargetUri": "$userAuth.fsTargetUri",
                        "mediaType": "$userAuth.mediaType",
                        //"mediaEndpoint": {
                        //"$concat": ["/profilepict/", "$mediaUri"]
                        //}
                      }],
                    //"idUserAuth": "$userAuth._id",
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$filter":
                            {
                              input:
                              {
                                "$arrayElemAt":
                                  [
                                    "$userAuth.userBadge",
                                    0
                                  ]
                              },
                              as: "listbadge",
                              cond:
                              {
                                "$and":
                                  [
                                    {
                                      "$eq":
                                        [
                                          "$$listbadge.isActive",
                                          true
                                        ]
                                    },
                                    {
                                      "$lte": [
                                        {
                                          "$dateToString": {
                                            "format": "%Y-%m-%d %H:%M:%S",
                                            "date": {
                                              "$add": [
                                                new Date(),
                                                25200000
                                              ]
                                            }
                                          }
                                        },
                                        "$$listbadge.endDatetime"
                                      ]
                                    }
                                  ]
                              }
                            }
                          },
                          []
                        ]
                    },
                  }
                },
                {
                  $project: {
                    "fullName": 1,
                    "profilePict": 1,
                    "username": 1,
                    "email": 1,
                    "avatar": 1,
                    //"idUserAuth": "$userAuth._id",
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$arrayElemAt":
                              [
                                "$urluserBadge",
                                0
                              ]
                          },
                          null
                        ]
                    }
                  }
                },
                {
                  $skip: skip
                },
                {
                  $limit: limit
                },
              ],

             //pict
             "pict": 
             [
                 {
                     $lookup: {
                         from: "newPosts",
                         pipeline: [
                             {
                                 $match: 
                                 {
                                     $and: [
                                         {
                                             $text: {
                                                 $search: key,
                                                 
                                             }
                                         },
                                         {
                                             "reportedStatus": {
                                                 $ne: "OWNED"
                                             }
                                         },
                                         {
                                             "visibility": "PUBLIC"
                                         },
                                         {
                                             "active": true
                                         },
                                         {
                                             "postType": "pict"
                                         },
                                         {
                                             "reportedUser.email": {
                                                 $not: {
                                                     $regex: email
                                                 }
                                             }
                                         },
                                         
                                     ]
                                 },
                                 
                             },
                             {
                                 $set: {
                                     scorePict: {
                                         $meta: "textScore"
                                     }
                                 }
                             },
                             {
                                 $project: {
                                     mediaSource:1,
                                     "boosted": 
                                     {
                                         $cond: {
                                             if : {
                                                 $gt: [{
                                                     "$dateToString": {
                                                         "format": "%Y-%m-%d %H:%M:%S",
                                                         "date": {
                                                             $add: [new Date(), 25200000]
                                                         }
                                                     }
                                                 }, "$boosted.boostSession.timeEnd"]
                                             },
                                             then: [],
                                             else : '$boosted'
                                         }
                                     },
                                     "reportedStatus": 1,
                                     "insight": {
                                         "shares": "$shares",
                                         "comments": "$comments",
                                         "views": "$views",
                                         "likes": "$likes",
                                         
                                     },
                                      "views": "$views",
                                     "comments": "$comments",
                                     "likes": "$likes",
                                     "scorePict": 1,
                                     "_id": 1,
                                     "postID": 1,
                                     "createdAt": 1,
                                     "updatedAt": 1,
                                     "email": 1,
                                     "postType": 1,
                                     "description": 1,
                                     "active": 1,
                                     "metadata": 1,
                                     "location": 1,
                                     "isOwned": 1,
                                     "visibility": 1,
                                     "isViewed": 1,
                                     "allowComments": 1,
                                     "saleAmount": 1,
                                     
                                 }
                             },
                             {
                                   $sort: {
                                       scorePict: - 1,
                                       comments: - 1,
                                       likes: - 1,
                                       views:  -1
                                   }
                               },
                               {
                                $skip: skip
                              },
                              {
                                $limit: limit
                              },
                         ],
                         as: "pict"
                     },
                     
                 },
               
                 {
                     $unwind: {
                         path: "$pict",
                         preserveNullAndEmptyArrays: true
                     }
                 },
                 
                 {
                     $project: {
                         "scorePict": "$pict.scorePict",
                         "boosted": "$pict.boosted",
                         "reportedStatus": "$pict.reportedStatus",
                         "_id": "$pict._id",
                          "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                         {
                             "$concat": ["/thumb/", "$pict.postID"]
                         },
                         mediaEndpoint:{
                          "$cond":
                          {
                              if:
                              {
                                  "$eq":
                                      [
                                        "$pict.postType", "pict"
                                      ]
                              },
                              then:
                              {
                                  "$concat":
                                      [
                                          "/pict/",
                                          "$pict.postID"
                                      ]
                              },
                              else:
                              {
                                  "$concat":
                                      [
                                          "/stream/",
                                          "$pict.postID"
                                      ]
                              }
                          }
                      },
                         "mediaType": {
                             $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                         },
                         "createdAt": "$pict.createdAt",
                         "updatedAt": "$pict.updatedAt",
                         "postID": "$pict.postID",
                         "email": "$pict.email",
                         "postType": "$pict.postType",
                         "description": "$pict.description",
                         "active": "$pict.active",
                         "metadata": "$pict.metadata",
                         "location": "$pict.location",
                         "isOwned": "$pict.isOwned",
                         "visibility": "$pict.visibility",
                         "isViewed": "$pict.isViewed",
                         "allowComments": "$pict.allowComments",
                         "saleAmount": "$pict.saleAmount",
                         "monetize": 
                         {
                             $cond: {
                                 if : {
                                     $gte: ["$pict.saleAmount", 1]
                                 },
                                 then: true,
                                 else : "$taslimKONAG"
                             }
                         },
                         "comments": "$pict.comments",
                         "likes": "$pict.likes",
                         "insight": 
                         {
                             $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                         },
                         "apsaraId": {
                             $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                         },
                         "isApsara": {
                             $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                         },
                         "viewed": "$pict.insight.views",
                     }
                 },
                 {
                     $sort: {
                         scorePict: - 1,
                         comments: - 1,
                         likes: - 1,
                         viewed:  -1
                     }
                 },
                 
             ],

          },

        },
        {
          $project: {
            user:
            {
              $cond: {
                if: {
                  $eq: [{
                    $arrayElemAt: ["$user.dodol", 0]
                  }, "kosong"]
                },
                then: "$saassaas",
                else: "$user"
              }
            },
            pict: "$pict",

          }
        }
      );
    }
    else if (pict === false && vid === true && diary === false && user === true && tag === false) {
      pipeline.push(

        {
          $facet:
          {
            "user":
              [
                {
                  $lookup: {
                    from: "newUserBasics",
                    let: {
                      name: "$dedy"
                    },
                    pipeline: [
                      {
                        $match: {
                          $expr: {
                            $regexMatch: {
                              input: "$username",
                              regex: "$$name",
                              options: "i"
                            }
                          }
                        }
                      }
                    ],
                    as: "userAuth"
                  },

                },
                {
                  $unwind: {
                    path: "$userAuth",
                    preserveNullAndEmptyArrays: true
                  }
                },
                {
                  $project: {
                    "fullName": "$userAuth.fullName",
                    "profilePict": "$userAuth.profilePict",
                    "username": "$userAuth.username",
                    "email": "$userAuth.email",
                    "avatar":
                      [{
                        "mediaBasePath": "$userAuth.mediaBasePath",
                        "mediaUri": "$userAuth.mediaUri",
                        "originalName": "$userAuth.originalName",
                        "fsSourceUri": "$userAuth.fsSourceUri",
                        "fsSourceName": "$userBasic.fsSourceName",
                        "fsTargetUri": "$userAuth.fsTargetUri",
                        "mediaType": "$userAuth.mediaType",
                        //"mediaEndpoint": {
                        //"$concat": ["/profilepict/", "$mediaUri"]
                        //}
                      }],
                    //"idUserAuth": "$userAuth._id",
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$filter":
                            {
                              input:
                              {
                                "$arrayElemAt":
                                  [
                                    "$userAuth.userBadge",
                                    0
                                  ]
                              },
                              as: "listbadge",
                              cond:
                              {
                                "$and":
                                  [
                                    {
                                      "$eq":
                                        [
                                          "$$listbadge.isActive",
                                          true
                                        ]
                                    },
                                    {
                                      "$lte": [
                                        {
                                          "$dateToString": {
                                            "format": "%Y-%m-%d %H:%M:%S",
                                            "date": {
                                              "$add": [
                                                new Date(),
                                                25200000
                                              ]
                                            }
                                          }
                                        },
                                        "$$listbadge.endDatetime"
                                      ]
                                    }
                                  ]
                              }
                            }
                          },
                          []
                        ]
                    },
                  }
                },
                {
                  $project: {
                    "fullName": 1,
                    "profilePict": 1,
                    "username": 1,
                    "email": 1,
                    "avatar": 1,
                    //"idUserAuth": "$userAuth._id",
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$arrayElemAt":
                              [
                                "$urluserBadge",
                                0
                              ]
                          },
                          null
                        ]
                    }
                  }
                },
                {
                  $skip: skip
                },
                {
                  $limit: limit
                },
              ],
              "vid": 
              [
                  {
                      $lookup: {
                          from: "newPosts",
                          pipeline: [
                              {
                                  $match: 
                                  {
                                      $and: [
                                          {
                                              $text: {
                                                  $search: key,
                                                  
                                              }
                                          },
                                          {
                                              "reportedStatus": {
                                                  $ne: "OWNED"
                                              }
                                          },
                                          {
                                              "visibility": "PUBLIC"
                                          },
                                          {
                                              "active": true
                                          },
                                          {
                                              "postType": "vid"
                                          },
                                          {
                                              "reportedUser.email": {
                                                  $not: {
                                                      $regex: email
                                                  }
                                              }
                                          },
                                          
                                      ]
                                  },
                                  
                              },
                              {
                                  $set: {
                                      scorePict: {
                                          $meta: "textScore"
                                      }
                                  }
                              },
                              {
                                  $project: {
                                      mediaSource:1,
                                      "boosted": 
                                      {
                                          $cond: {
                                              if : {
                                                  $gt: [{
                                                      "$dateToString": {
                                                          "format": "%Y-%m-%d %H:%M:%S",
                                                          "date": {
                                                              $add: [new Date(), 25200000]
                                                          }
                                                      }
                                                  }, "$boosted.boostSession.timeEnd"]
                                              },
                                              then: [],
                                              else : '$boosted'
                                          }
                                      },
                                      "reportedStatus": 1,
                                      "insight": {
                                          "shares": "$shares",
                                          "comments": "$comments",
                                          "views": "$views",
                                          "likes": "$likes",
                                          
                                      },
                                       "views": "$views",
                                      "comments": "$comments",
                                      "likes": "$likes",
                                      "scorePict": 1,
                                      "_id": 1,
                                      "postID": 1,
                                      "createdAt": 1,
                                      "updatedAt": 1,
                                      "email": 1,
                                      "postType": 1,
                                      "description": 1,
                                      "active": 1,
                                      "metadata": 1,
                                      "location": 1,
                                      "isOwned": 1,
                                      "visibility": 1,
                                      "isViewed": 1,
                                      "allowComments": 1,
                                      "saleAmount": 1,
                                      
                                  }
                              },
                              {
                                    $sort: {
                                        scorePict: - 1,
                                        comments: - 1,
                                        likes: - 1,
                                        views:  -1
                                    }
                                },
                                {
                                    $skip: skip
                                },
                                {
                                    $limit: limit
                                },
                          ],
                          as: "pict"
                      },
                      
                  },
                
                  {
                      $unwind: {
                          path: "$pict",
                          preserveNullAndEmptyArrays: true
                      }
                  },
                  
                  {
                      $project: {
                          "scorePict": "$pict.scorePict",
                          "boosted": "$pict.boosted",
                          "reportedStatus": "$pict.reportedStatus",
                          "_id": "$pict._id",
                          "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                          {
                              "$concat": ["/thumb/", "$pict.postID"]
                          },
                          mediaEndpoint:{
                           "$cond":
                           {
                               if:
                               {
                                   "$eq":
                                       [
                                         "$pict.postType", "pict"
                                       ]
                               },
                               then:
                               {
                                   "$concat":
                                       [
                                           "/pict/",
                                           "$pict.postID"
                                       ]
                               },
                               else:
                               {
                                   "$concat":
                                       [
                                           "/stream/",
                                           "$pict.postID"
                                       ]
                               }
                           }
                       },
                          "mediaType": {
                              $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                          },
                          "createdAt": "$pict.createdAt",
                          "updatedAt": "$pict.updatedAt",
                          "postID": "$pict.postID",
                          "email": "$pict.email",
                          "postType": "$pict.postType",
                          "description": "$pict.description",
                          "active": "$pict.active",
                          "metadata": "$pict.metadata",
                          "location": "$pict.location",
                          "isOwned": "$pict.isOwned",
                          "visibility": "$pict.visibility",
                          "isViewed": "$pict.isViewed",
                          "allowComments": "$pict.allowComments",
                          "saleAmount": "$pict.saleAmount",
                          "monetize": 
                          {
                              $cond: {
                                  if : {
                                      $gte: ["$pict.saleAmount", 1]
                                  },
                                  then: true,
                                  else : "$taslimKONAG"
                              }
                          },
                          "comments": "$pict.comments",
                          "likes": "$pict.likes",
                          "insight": 
                          {
                              $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                          },
                          "apsaraId": {
                              $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                          },
                          "isApsara": {
                              $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                          },
                          "viewed": "$pict.insight.views",
                      }
                  },
                  {
                      $sort: {
                          scorePict: - 1,
                          comments: - 1,
                          likes: - 1,
                          viewed:  -1
                      }
                  },
                  
              ],

          },

        },
        {
          $project: {
            user:
            {
              $cond: {
                if: {
                  $eq: [{
                    $arrayElemAt: ["$user.dodol", 0]
                  }, "kosong"]
                },
                then: "$saassaas",
                else: "$user"
              }
            },
            vid: "$vid",

          }
        });
    }
    else if (pict === false && vid === false && diary === true && user === true && tag === false) {
      pipeline.push(

        {
          $facet:
          {
            "user":
              [
                {
                  $lookup: {
                    from: "newUserBasics",
                    let: {
                      name: "$dedy"
                    },
                    pipeline: [
                      {
                        $match: {
                          $expr: {
                            $regexMatch: {
                              input: "$username",
                              regex: "$$name",
                              options: "i"
                            }
                          }
                        }
                      }
                    ],
                    as: "userAuth"
                  },

                },
                {
                  $unwind: {
                    path: "$userAuth",
                    preserveNullAndEmptyArrays: true
                  }
                },
                {
                  $project: {
                    "fullName": "$userAuth.fullName",
                    "profilePict": "$userAuth.profilePict",
                    "username": "$userAuth.username",
                    "email": "$userAuth.email",
                    "avatar":
                      [{
                        "mediaBasePath": "$userAuth.mediaBasePath",
                        "mediaUri": "$userAuth.mediaUri",
                        "originalName": "$userAuth.originalName",
                        "fsSourceUri": "$userAuth.fsSourceUri",
                        "fsSourceName": "$userBasic.fsSourceName",
                        "fsTargetUri": "$userAuth.fsTargetUri",
                        "mediaType": "$userAuth.mediaType",
                        //"mediaEndpoint": {
                        //"$concat": ["/profilepict/", "$mediaUri"]
                        //}
                      }],
                    //"idUserAuth": "$userAuth._id",
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$filter":
                            {
                              input:
                              {
                                "$arrayElemAt":
                                  [
                                    "$userAuth.userBadge",
                                    0
                                  ]
                              },
                              as: "listbadge",
                              cond:
                              {
                                "$and":
                                  [
                                    {
                                      "$eq":
                                        [
                                          "$$listbadge.isActive",
                                          true
                                        ]
                                    },
                                    {
                                      "$lte": [
                                        {
                                          "$dateToString": {
                                            "format": "%Y-%m-%d %H:%M:%S",
                                            "date": {
                                              "$add": [
                                                new Date(),
                                                25200000
                                              ]
                                            }
                                          }
                                        },
                                        "$$listbadge.endDatetime"
                                      ]
                                    }
                                  ]
                              }
                            }
                          },
                          []
                        ]
                    },
                  }
                },
                {
                  $project: {
                    "fullName": 1,
                    "profilePict": 1,
                    "username": 1,
                    "email": 1,
                    "avatar": 1,
                    //"idUserAuth": "$userAuth._id",
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$arrayElemAt":
                              [
                                "$urluserBadge",
                                0
                              ]
                          },
                          null
                        ]
                    }
                  }
                },
                {
                  $skip: skip
                },
                {
                  $limit: limit
                },
              ],
              "diary": 
              [
                  {
                      $lookup: {
                          from: "newPosts",
                          pipeline: [
                              {
                                  $match: 
                                  {
                                      $and: [
                                          {
                                              $text: {
                                                  $search: key,
                                                  
                                              }
                                          },
                                          {
                                              "reportedStatus": {
                                                  $ne: "OWNED"
                                              }
                                          },
                                          {
                                              "visibility": "PUBLIC"
                                          },
                                          {
                                              "active": true
                                          },
                                          {
                                              "postType": "diary"
                                          },
                                          {
                                              "reportedUser.email": {
                                                  $not: {
                                                      $regex: email
                                                  }
                                              }
                                          },
                                          
                                      ]
                                  },
                                  
                              },
                              {
                                  $set: {
                                      scorePict: {
                                          $meta: "textScore"
                                      }
                                  }
                              },
                              {
                                  $project: {
                                      mediaSource:1,
                                      "boosted": 
                                      {
                                          $cond: {
                                              if : {
                                                  $gt: [{
                                                      "$dateToString": {
                                                          "format": "%Y-%m-%d %H:%M:%S",
                                                          "date": {
                                                              $add: [new Date(), 25200000]
                                                          }
                                                      }
                                                  }, "$boosted.boostSession.timeEnd"]
                                              },
                                              then: [],
                                              else : '$boosted'
                                          }
                                      },
                                      "reportedStatus": 1,
                                      "insight": {
                                          "shares": "$shares",
                                          "comments": "$comments",
                                          "views": "$views",
                                          "likes": "$likes",
                                          
                                      },
                                       "views": "$views",
                                      "comments": "$comments",
                                      "likes": "$likes",
                                      "scorePict": 1,
                                      "_id": 1,
                                      "postID": 1,
                                      "createdAt": 1,
                                      "updatedAt": 1,
                                      "email": 1,
                                      "postType": 1,
                                      "description": 1,
                                      "active": 1,
                                      "metadata": 1,
                                      "location": 1,
                                      "isOwned": 1,
                                      "visibility": 1,
                                      "isViewed": 1,
                                      "allowComments": 1,
                                      "saleAmount": 1,
                                      
                                  }
                              },
                              {
                                    $sort: {
                                        scorePict: - 1,
                                        comments: - 1,
                                        likes: - 1,
                                        views:  -1
                                    }
                                },
                                {
                                    $skip:skip
                                },
                                {
                                    $limit: limit
                                },
                          ],
                          as: "pict"
                      },
                      
                  },
                
                  {
                      $unwind: {
                          path: "$pict",
                          preserveNullAndEmptyArrays: true
                      }
                  },
                  
                  {
                      $project: {
                          "scorePict": "$pict.scorePict",
                          "boosted": "$pict.boosted",
                          "reportedStatus": "$pict.reportedStatus",
                          "_id": "$pict._id",
                          "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                          {
                              "$concat": ["/thumb/", "$pict.postID"]
                          },
                          mediaEndpoint:{
                           "$cond":
                           {
                               if:
                               {
                                   "$eq":
                                       [
                                         "$pict.postType", "pict"
                                       ]
                               },
                               then:
                               {
                                   "$concat":
                                       [
                                           "/pict/",
                                           "$pict.postID"
                                       ]
                               },
                               else:
                               {
                                   "$concat":
                                       [
                                           "/stream/",
                                           "$pict.postID"
                                       ]
                               }
                           }
                       },
                          "mediaType": {
                              $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                          },
                          "createdAt": "$pict.createdAt",
                          "updatedAt": "$pict.updatedAt",
                          "postID": "$pict.postID",
                          "email": "$pict.email",
                          "postType": "$pict.postType",
                          "description": "$pict.description",
                          "active": "$pict.active",
                          "metadata": "$pict.metadata",
                          "location": "$pict.location",
                          "isOwned": "$pict.isOwned",
                          "visibility": "$pict.visibility",
                          "isViewed": "$pict.isViewed",
                          "allowComments": "$pict.allowComments",
                          "saleAmount": "$pict.saleAmount",
                          "monetize": 
                          {
                              $cond: {
                                  if : {
                                      $gte: ["$pict.saleAmount", 1]
                                  },
                                  then: true,
                                  else : "$taslimKONAG"
                              }
                          },
                          "comments": "$pict.comments",
                          "likes": "$pict.likes",
                          "insight": 
                          {
                              $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                          },
                          "apsaraId": {
                              $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                          },
                          "isApsara": {
                              $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                          },
                          "viewed": "$pict.insight.views",
                      }
                  },
                  {
                      $sort: {
                          scorePict: - 1,
                          comments: - 1,
                          likes: - 1,
                          viewed:  -1
                      }
                  },
                  
              ],
          },

        },
        {
          $project: {
            user:
            {
              $cond: {
                if: {
                  $eq: [{
                    $arrayElemAt: ["$user.dodol", 0]
                  }, "kosong"]
                },
                then: "$saassaas",
                else: "$user"
              }
            },
            diary: "$diary"
          }
        });
    }
    else if (pict === true && vid === true && diary === false && user === true && tag === false) {
      pipeline.push(

        {
          $facet:
          {
            "user":
              [
                {
                  $lookup: {
                    from: "newUserBasics",
                    let: {
                      name: "$dedy"
                    },
                    pipeline: [
                      {
                        $match: {
                          $expr: {
                            $regexMatch: {
                              input: "$username",
                              regex: "$$name",
                              options: "i"
                            }
                          }
                        }
                      }
                    ],
                    as: "userAuth"
                  },

                },
                {
                  $unwind: {
                    path: "$userAuth",
                    preserveNullAndEmptyArrays: true
                  }
                },
                {
                  $project: {
                    "fullName": "$userAuth.fullName",
                    "profilePict": "$userAuth.profilePict",
                    "username": "$userAuth.username",
                    "email": "$userAuth.email",
                    "avatar":
                      [{
                        "mediaBasePath": "$userAuth.mediaBasePath",
                        "mediaUri": "$userAuth.mediaUri",
                        "originalName": "$userAuth.originalName",
                        "fsSourceUri": "$userAuth.fsSourceUri",
                        "fsSourceName": "$userBasic.fsSourceName",
                        "fsTargetUri": "$userAuth.fsTargetUri",
                        "mediaType": "$userAuth.mediaType",
                        //"mediaEndpoint": {
                        //"$concat": ["/profilepict/", "$mediaUri"]
                        //}
                      }],
                    //"idUserAuth": "$userAuth._id",
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$filter":
                            {
                              input:
                              {
                                "$arrayElemAt":
                                  [
                                    "$userAuth.userBadge",
                                    0
                                  ]
                              },
                              as: "listbadge",
                              cond:
                              {
                                "$and":
                                  [
                                    {
                                      "$eq":
                                        [
                                          "$$listbadge.isActive",
                                          true
                                        ]
                                    },
                                    {
                                      "$lte": [
                                        {
                                          "$dateToString": {
                                            "format": "%Y-%m-%d %H:%M:%S",
                                            "date": {
                                              "$add": [
                                                new Date(),
                                                25200000
                                              ]
                                            }
                                          }
                                        },
                                        "$$listbadge.endDatetime"
                                      ]
                                    }
                                  ]
                              }
                            }
                          },
                          []
                        ]
                    },
                  }
                },
                {
                  $project: {
                    "fullName": 1,
                    "profilePict": 1,
                    "username": 1,
                    "email": 1,
                    "avatar": 1,
                    //"idUserAuth": "$userAuth._id",
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$arrayElemAt":
                              [
                                "$urluserBadge",
                                0
                              ]
                          },
                          null
                        ]
                    }
                  }
                },
                {
                  $skip: skip
                },
                {
                  $limit: limit
                },
              ],
           //pict
           "pict": 
           [
               {
                   $lookup: {
                       from: "newPosts",
                       pipeline: [
                           {
                               $match: 
                               {
                                   $and: [
                                       {
                                           $text: {
                                               $search: key,
                                               
                                           }
                                       },
                                       {
                                           "reportedStatus": {
                                               $ne: "OWNED"
                                           }
                                       },
                                       {
                                           "visibility": "PUBLIC"
                                       },
                                       {
                                           "active": true
                                       },
                                       {
                                           "postType": "pict"
                                       },
                                       {
                                           "reportedUser.email": {
                                               $not: {
                                                   $regex: email
                                               }
                                           }
                                       },
                                       
                                   ]
                               },
                               
                           },
                           {
                               $set: {
                                   scorePict: {
                                       $meta: "textScore"
                                   }
                               }
                           },
                           {
                               $project: {
                                   mediaSource:1,
                                   "boosted": 
                                   {
                                       $cond: {
                                           if : {
                                               $gt: [{
                                                   "$dateToString": {
                                                       "format": "%Y-%m-%d %H:%M:%S",
                                                       "date": {
                                                           $add: [new Date(), 25200000]
                                                       }
                                                   }
                                               }, "$boosted.boostSession.timeEnd"]
                                           },
                                           then: [],
                                           else : '$boosted'
                                       }
                                   },
                                   "reportedStatus": 1,
                                   "insight": {
                                       "shares": "$shares",
                                       "comments": "$comments",
                                       "views": "$views",
                                       "likes": "$likes",
                                       
                                   },
                                    "views": "$views",
                                   "comments": "$comments",
                                   "likes": "$likes",
                                   "scorePict": 1,
                                   "_id": 1,
                                   "postID": 1,
                                   "createdAt": 1,
                                   "updatedAt": 1,
                                   "email": 1,
                                   "postType": 1,
                                   "description": 1,
                                   "active": 1,
                                   "metadata": 1,
                                   "location": 1,
                                   "isOwned": 1,
                                   "visibility": 1,
                                   "isViewed": 1,
                                   "allowComments": 1,
                                   "saleAmount": 1,
                                   
                               }
                           },
                           {
                                 $sort: {
                                     scorePict: - 1,
                                     comments: - 1,
                                     likes: - 1,
                                     views:  -1
                                 }
                             },
                             {
                              $skip: skip
                            },
                            {
                              $limit: limit
                            },
                       ],
                       as: "pict"
                   },
                   
               },
             
               {
                   $unwind: {
                       path: "$pict",
                       preserveNullAndEmptyArrays: true
                   }
               },
               
               {
                   $project: {
                       "scorePict": "$pict.scorePict",
                       "boosted": "$pict.boosted",
                       "reportedStatus": "$pict.reportedStatus",
                       "_id": "$pict._id",
                       "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                       {
                           "$concat": ["/thumb/", "$pict.postID"]
                       },
                       mediaEndpoint:{
                        "$cond":
                        {
                            if:
                            {
                                "$eq":
                                    [
                                      "$pict.postType", "pict"
                                    ]
                            },
                            then:
                            {
                                "$concat":
                                    [
                                        "/pict/",
                                        "$pict.postID"
                                    ]
                            },
                            else:
                            {
                                "$concat":
                                    [
                                        "/stream/",
                                        "$pict.postID"
                                    ]
                            }
                        }
                    },
                       "mediaType": {
                           $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                       },
                       "createdAt": "$pict.createdAt",
                       "updatedAt": "$pict.updatedAt",
                       "postID": "$pict.postID",
                       "email": "$pict.email",
                       "postType": "$pict.postType",
                       "description": "$pict.description",
                       "active": "$pict.active",
                       "metadata": "$pict.metadata",
                       "location": "$pict.location",
                       "isOwned": "$pict.isOwned",
                       "visibility": "$pict.visibility",
                       "isViewed": "$pict.isViewed",
                       "allowComments": "$pict.allowComments",
                       "saleAmount": "$pict.saleAmount",
                       "monetize": 
                       {
                           $cond: {
                               if : {
                                   $gte: ["$pict.saleAmount", 1]
                               },
                               then: true,
                               else : "$taslimKONAG"
                           }
                       },
                       "comments": "$pict.comments",
                       "likes": "$pict.likes",
                       "insight": 
                       {
                           $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                       },
                       "apsaraId": {
                           $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                       },
                       "isApsara": {
                           $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                       },
                       "viewed": "$pict.insight.views",
                   }
               },
               {
                   $sort: {
                       scorePict: - 1,
                       comments: - 1,
                       likes: - 1,
                       viewed:  -1
                   }
               },
               
           ],
           "vid": 
           [
               {
                   $lookup: {
                       from: "newPosts",
                       pipeline: [
                           {
                               $match: 
                               {
                                   $and: [
                                       {
                                           $text: {
                                               $search: key,
                                               
                                           }
                                       },
                                       {
                                           "reportedStatus": {
                                               $ne: "OWNED"
                                           }
                                       },
                                       {
                                           "visibility": "PUBLIC"
                                       },
                                       {
                                           "active": true
                                       },
                                       {
                                           "postType": "vid"
                                       },
                                       {
                                           "reportedUser.email": {
                                               $not: {
                                                   $regex: email
                                               }
                                           }
                                       },
                                       
                                   ]
                               },
                               
                           },
                           {
                               $set: {
                                   scorePict: {
                                       $meta: "textScore"
                                   }
                               }
                           },
                           {
                               $project: {
                                   mediaSource:1,
                                   "boosted": 
                                   {
                                       $cond: {
                                           if : {
                                               $gt: [{
                                                   "$dateToString": {
                                                       "format": "%Y-%m-%d %H:%M:%S",
                                                       "date": {
                                                           $add: [new Date(), 25200000]
                                                       }
                                                   }
                                               }, "$boosted.boostSession.timeEnd"]
                                           },
                                           then: [],
                                           else : '$boosted'
                                       }
                                   },
                                   "reportedStatus": 1,
                                   "insight": {
                                       "shares": "$shares",
                                       "comments": "$comments",
                                       "views": "$views",
                                       "likes": "$likes",
                                       
                                   },
                                    "views": "$views",
                                   "comments": "$comments",
                                   "likes": "$likes",
                                   "scorePict": 1,
                                   "_id": 1,
                                   "postID": 1,
                                   "createdAt": 1,
                                   "updatedAt": 1,
                                   "email": 1,
                                   "postType": 1,
                                   "description": 1,
                                   "active": 1,
                                   "metadata": 1,
                                   "location": 1,
                                   "isOwned": 1,
                                   "visibility": 1,
                                   "isViewed": 1,
                                   "allowComments": 1,
                                   "saleAmount": 1,
                                   
                               }
                           },
                           {
                                 $sort: {
                                     scorePict: - 1,
                                     comments: - 1,
                                     likes: - 1,
                                     views:  -1
                                 }
                             },
                             {
                                 $skip: skip
                             },
                             {
                                 $limit: limit
                             },
                       ],
                       as: "pict"
                   },
                   
               },
             
               {
                   $unwind: {
                       path: "$pict",
                       preserveNullAndEmptyArrays: true
                   }
               },
               
               {
                   $project: {
                       "scorePict": "$pict.scorePict",
                       "boosted": "$pict.boosted",
                       "reportedStatus": "$pict.reportedStatus",
                       "_id": "$pict._id",
                       "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                       {
                           "$concat": ["/thumb/", "$pict.postID"]
                       },
                       mediaEndpoint:{
                        "$cond":
                        {
                            if:
                            {
                                "$eq":
                                    [
                                      "$pict.postType", "pict"
                                    ]
                            },
                            then:
                            {
                                "$concat":
                                    [
                                        "/pict/",
                                        "$pict.postID"
                                    ]
                            },
                            else:
                            {
                                "$concat":
                                    [
                                        "/stream/",
                                        "$pict.postID"
                                    ]
                            }
                        }
                    },
                       "mediaType": {
                           $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                       },
                       "createdAt": "$pict.createdAt",
                       "updatedAt": "$pict.updatedAt",
                       "postID": "$pict.postID",
                       "email": "$pict.email",
                       "postType": "$pict.postType",
                       "description": "$pict.description",
                       "active": "$pict.active",
                       "metadata": "$pict.metadata",
                       "location": "$pict.location",
                       "isOwned": "$pict.isOwned",
                       "visibility": "$pict.visibility",
                       "isViewed": "$pict.isViewed",
                       "allowComments": "$pict.allowComments",
                       "saleAmount": "$pict.saleAmount",
                       "monetize": 
                       {
                           $cond: {
                               if : {
                                   $gte: ["$pict.saleAmount", 1]
                               },
                               then: true,
                               else : "$taslimKONAG"
                           }
                       },
                       "comments": "$pict.comments",
                       "likes": "$pict.likes",
                       "insight": 
                       {
                           $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                       },
                       "apsaraId": {
                           $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                       },
                       "isApsara": {
                           $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                       },
                       "viewed": "$pict.insight.views",
                   }
               },
               {
                   $sort: {
                       scorePict: - 1,
                       comments: - 1,
                       likes: - 1,
                       viewed:  -1
                   }
               },
               
           ],

          },

        },
        {
          $project: {
            user:
            {
              $cond: {
                if: {
                  $eq: [{
                    $arrayElemAt: ["$user.dodol", 0]
                  }, "kosong"]
                },
                then: "$saassaas",
                else: "$user"
              }
            },
            pict: "$pict",
            vid: "$vid",

          }
        });

    }
    else if (pict === true && vid === false && diary === true && user === true && tag === false) {
      pipeline.push(

        {
          $facet:
          {
            "user":
              [
                {
                  $lookup: {
                    from: "newUserBasics",
                    let: {
                      name: "$dedy"
                    },
                    pipeline: [
                      {
                        $match: {
                          $expr: {
                            $regexMatch: {
                              input: "$username",
                              regex: "$$name",
                              options: "i"
                            }
                          }
                        }
                      }
                    ],
                    as: "userAuth"
                  },

                },
                {
                  $unwind: {
                    path: "$userAuth",
                    preserveNullAndEmptyArrays: true
                  }
                },
                {
                  $project: {
                    "fullName": "$userAuth.fullName",
                    "profilePict": "$userAuth.profilePict",
                    "username": "$userAuth.username",
                    "email": "$userAuth.email",
                    "avatar":
                      [{
                        "mediaBasePath": "$userAuth.mediaBasePath",
                        "mediaUri": "$userAuth.mediaUri",
                        "originalName": "$userAuth.originalName",
                        "fsSourceUri": "$userAuth.fsSourceUri",
                        "fsSourceName": "$userBasic.fsSourceName",
                        "fsTargetUri": "$userAuth.fsTargetUri",
                        "mediaType": "$userAuth.mediaType",
                        //"mediaEndpoint": {
                        //"$concat": ["/profilepict/", "$mediaUri"]
                        //}
                      }],
                    //"idUserAuth": "$userAuth._id",
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$filter":
                            {
                              input:
                              {
                                "$arrayElemAt":
                                  [
                                    "$userAuth.userBadge",
                                    0
                                  ]
                              },
                              as: "listbadge",
                              cond:
                              {
                                "$and":
                                  [
                                    {
                                      "$eq":
                                        [
                                          "$$listbadge.isActive",
                                          true
                                        ]
                                    },
                                    {
                                      "$lte": [
                                        {
                                          "$dateToString": {
                                            "format": "%Y-%m-%d %H:%M:%S",
                                            "date": {
                                              "$add": [
                                                new Date(),
                                                25200000
                                              ]
                                            }
                                          }
                                        },
                                        "$$listbadge.endDatetime"
                                      ]
                                    }
                                  ]
                              }
                            }
                          },
                          []
                        ]
                    },
                  }
                },
                {
                  $project: {
                    "fullName": 1,
                    "profilePict": 1,
                    "username": 1,
                    "email": 1,
                    "avatar": 1,
                    //"idUserAuth": "$userAuth._id",
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$arrayElemAt":
                              [
                                "$urluserBadge",
                                0
                              ]
                          },
                          null
                        ]
                    }
                  }
                },
                {
                  $skip: skip
                },
                {
                  $limit: limit
                },
              ],
           //pict
           "pict": 
           [
               {
                   $lookup: {
                       from: "newPosts",
                       pipeline: [
                           {
                               $match: 
                               {
                                   $and: [
                                       {
                                           $text: {
                                               $search: key,
                                               
                                           }
                                       },
                                       {
                                           "reportedStatus": {
                                               $ne: "OWNED"
                                           }
                                       },
                                       {
                                           "visibility": "PUBLIC"
                                       },
                                       {
                                           "active": true
                                       },
                                       {
                                           "postType": "pict"
                                       },
                                       {
                                           "reportedUser.email": {
                                               $not: {
                                                   $regex: email
                                               }
                                           }
                                       },
                                       
                                   ]
                               },
                               
                           },
                           {
                               $set: {
                                   scorePict: {
                                       $meta: "textScore"
                                   }
                               }
                           },
                           {
                               $project: {
                                   mediaSource:1,
                                   "boosted": 
                                   {
                                       $cond: {
                                           if : {
                                               $gt: [{
                                                   "$dateToString": {
                                                       "format": "%Y-%m-%d %H:%M:%S",
                                                       "date": {
                                                           $add: [new Date(), 25200000]
                                                       }
                                                   }
                                               }, "$boosted.boostSession.timeEnd"]
                                           },
                                           then: [],
                                           else : '$boosted'
                                       }
                                   },
                                   "reportedStatus": 1,
                                   "insight": {
                                       "shares": "$shares",
                                       "comments": "$comments",
                                       "views": "$views",
                                       "likes": "$likes",
                                       
                                   },
                                    "views": "$views",
                                   "comments": "$comments",
                                   "likes": "$likes",
                                   "scorePict": 1,
                                   "_id": 1,
                                   "postID": 1,
                                   "createdAt": 1,
                                   "updatedAt": 1,
                                   "email": 1,
                                   "postType": 1,
                                   "description": 1,
                                   "active": 1,
                                   "metadata": 1,
                                   "location": 1,
                                   "isOwned": 1,
                                   "visibility": 1,
                                   "isViewed": 1,
                                   "allowComments": 1,
                                   "saleAmount": 1,
                                   
                               }
                           },
                           {
                                 $sort: {
                                     scorePict: - 1,
                                     comments: - 1,
                                     likes: - 1,
                                     views:  -1
                                 }
                             },
                             {
                              $skip: skip
                            },
                            {
                              $limit: limit
                            },
                       ],
                       as: "pict"
                   },
                   
               },
             
               {
                   $unwind: {
                       path: "$pict",
                       preserveNullAndEmptyArrays: true
                   }
               },
               
               {
                   $project: {
                       "scorePict": "$pict.scorePict",
                       "boosted": "$pict.boosted",
                       "reportedStatus": "$pict.reportedStatus",
                       "_id": "$pict._id",
                       "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                       {
                           "$concat": ["/thumb/", "$pict.postID"]
                       },
                       mediaEndpoint:{
                        "$cond":
                        {
                            if:
                            {
                                "$eq":
                                    [
                                      "$pict.postType", "pict"
                                    ]
                            },
                            then:
                            {
                                "$concat":
                                    [
                                        "/pict/",
                                        "$pict.postID"
                                    ]
                            },
                            else:
                            {
                                "$concat":
                                    [
                                        "/stream/",
                                        "$pict.postID"
                                    ]
                            }
                        }
                    },
                       "mediaType": {
                           $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                       },
                       "createdAt": "$pict.createdAt",
                       "updatedAt": "$pict.updatedAt",
                       "postID": "$pict.postID",
                       "email": "$pict.email",
                       "postType": "$pict.postType",
                       "description": "$pict.description",
                       "active": "$pict.active",
                       "metadata": "$pict.metadata",
                       "location": "$pict.location",
                       "isOwned": "$pict.isOwned",
                       "visibility": "$pict.visibility",
                       "isViewed": "$pict.isViewed",
                       "allowComments": "$pict.allowComments",
                       "saleAmount": "$pict.saleAmount",
                       "monetize": 
                       {
                           $cond: {
                               if : {
                                   $gte: ["$pict.saleAmount", 1]
                               },
                               then: true,
                               else : "$taslimKONAG"
                           }
                       },
                       "comments": "$pict.comments",
                       "likes": "$pict.likes",
                       "insight": 
                       {
                           $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                       },
                       "apsaraId": {
                           $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                       },
                       "isApsara": {
                           $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                       },
                       "viewed": "$pict.insight.views",
                   }
               },
               {
                   $sort: {
                       scorePict: - 1,
                       comments: - 1,
                       likes: - 1,
                       viewed:  -1
                   }
               },
               
           ],
           "diary": 
              [
                  {
                      $lookup: {
                          from: "newPosts",
                          pipeline: [
                              {
                                  $match: 
                                  {
                                      $and: [
                                          {
                                              $text: {
                                                  $search: key,
                                                  
                                              }
                                          },
                                          {
                                              "reportedStatus": {
                                                  $ne: "OWNED"
                                              }
                                          },
                                          {
                                              "visibility": "PUBLIC"
                                          },
                                          {
                                              "active": true
                                          },
                                          {
                                              "postType": "diary"
                                          },
                                          {
                                              "reportedUser.email": {
                                                  $not: {
                                                      $regex: email
                                                  }
                                              }
                                          },
                                          
                                      ]
                                  },
                                  
                              },
                              {
                                  $set: {
                                      scorePict: {
                                          $meta: "textScore"
                                      }
                                  }
                              },
                              {
                                  $project: {
                                      mediaSource:1,
                                      "boosted": 
                                      {
                                          $cond: {
                                              if : {
                                                  $gt: [{
                                                      "$dateToString": {
                                                          "format": "%Y-%m-%d %H:%M:%S",
                                                          "date": {
                                                              $add: [new Date(), 25200000]
                                                          }
                                                      }
                                                  }, "$boosted.boostSession.timeEnd"]
                                              },
                                              then: [],
                                              else : '$boosted'
                                          }
                                      },
                                      "reportedStatus": 1,
                                      "insight": {
                                          "shares": "$shares",
                                          "comments": "$comments",
                                          "views": "$views",
                                          "likes": "$likes",
                                          
                                      },
                                       "views": "$views",
                                      "comments": "$comments",
                                      "likes": "$likes",
                                      "scorePict": 1,
                                      "_id": 1,
                                      "postID": 1,
                                      "createdAt": 1,
                                      "updatedAt": 1,
                                      "email": 1,
                                      "postType": 1,
                                      "description": 1,
                                      "active": 1,
                                      "metadata": 1,
                                      "location": 1,
                                      "isOwned": 1,
                                      "visibility": 1,
                                      "isViewed": 1,
                                      "allowComments": 1,
                                      "saleAmount": 1,
                                      
                                  }
                              },
                              {
                                    $sort: {
                                        scorePict: - 1,
                                        comments: - 1,
                                        likes: - 1,
                                        views:  -1
                                    }
                                },
                                {
                                    $skip:skip
                                },
                                {
                                    $limit: limit
                                },
                          ],
                          as: "pict"
                      },
                      
                  },
                
                  {
                      $unwind: {
                          path: "$pict",
                          preserveNullAndEmptyArrays: true
                      }
                  },
                  
                  {
                      $project: {
                          "scorePict": "$pict.scorePict",
                          "boosted": "$pict.boosted",
                          "reportedStatus": "$pict.reportedStatus",
                          "_id": "$pict._id",
                          "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                          {
                              "$concat": ["/thumb/", "$pict.postID"]
                          },
                          mediaEndpoint:{
                           "$cond":
                           {
                               if:
                               {
                                   "$eq":
                                       [
                                         "$pict.postType", "pict"
                                       ]
                               },
                               then:
                               {
                                   "$concat":
                                       [
                                           "/pict/",
                                           "$pict.postID"
                                       ]
                               },
                               else:
                               {
                                   "$concat":
                                       [
                                           "/stream/",
                                           "$pict.postID"
                                       ]
                               }
                           }
                       },
                          "mediaType": {
                              $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                          },
                          "createdAt": "$pict.createdAt",
                          "updatedAt": "$pict.updatedAt",
                          "postID": "$pict.postID",
                          "email": "$pict.email",
                          "postType": "$pict.postType",
                          "description": "$pict.description",
                          "active": "$pict.active",
                          "metadata": "$pict.metadata",
                          "location": "$pict.location",
                          "isOwned": "$pict.isOwned",
                          "visibility": "$pict.visibility",
                          "isViewed": "$pict.isViewed",
                          "allowComments": "$pict.allowComments",
                          "saleAmount": "$pict.saleAmount",
                          "monetize": 
                          {
                              $cond: {
                                  if : {
                                      $gte: ["$pict.saleAmount", 1]
                                  },
                                  then: true,
                                  else : "$taslimKONAG"
                              }
                          },
                          "comments": "$pict.comments",
                          "likes": "$pict.likes",
                          "insight": 
                          {
                              $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                          },
                          "apsaraId": {
                              $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                          },
                          "isApsara": {
                              $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                          },
                          "viewed": "$pict.insight.views",
                      }
                  },
                  {
                      $sort: {
                          scorePict: - 1,
                          comments: - 1,
                          likes: - 1,
                          viewed:  -1
                      }
                  },
                  
              ],
          },

        },
        {
          $project: {
            user:
            {
              $cond: {
                if: {
                  $eq: [{
                    $arrayElemAt: ["$user.dodol", 0]
                  }, "kosong"]
                },
                then: "$saassaas",
                else: "$user"
              }
            },
            pict: "$pict",
            diary: "$diary",

          }
        });
    }
    else if (pict === false && vid === true && diary === true && user === true && tag === false) {
      pipeline.push(

        {
          $facet:
          {
            "user":
              [
                {
                  $lookup: {
                    from: "newUserBasics",
                    let: {
                      name: "$dedy"
                    },
                    pipeline: [
                      {
                        $match: {
                          $expr: {
                            $regexMatch: {
                              input: "$username",
                              regex: "$$name",
                              options: "i"
                            }
                          }
                        }
                      }
                    ],
                    as: "userAuth"
                  },

                },
                {
                  $unwind: {
                    path: "$userAuth",
                    preserveNullAndEmptyArrays: true
                  }
                },
                {
                  $project: {
                    "fullName": "$userAuth.fullName",
                    "profilePict": "$userAuth.profilePict",
                    "username": "$userAuth.username",
                    "email": "$userAuth.email",
                    "avatar":
                      [{
                        "mediaBasePath": "$userAuth.mediaBasePath",
                        "mediaUri": "$userAuth.mediaUri",
                        "originalName": "$userAuth.originalName",
                        "fsSourceUri": "$userAuth.fsSourceUri",
                        "fsSourceName": "$userBasic.fsSourceName",
                        "fsTargetUri": "$userAuth.fsTargetUri",
                        "mediaType": "$userAuth.mediaType",
                        //"mediaEndpoint": {
                        //"$concat": ["/profilepict/", "$mediaUri"]
                        //}
                      }],
                    //"idUserAuth": "$userAuth._id",
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$filter":
                            {
                              input:
                              {
                                "$arrayElemAt":
                                  [
                                    "$userAuth.userBadge",
                                    0
                                  ]
                              },
                              as: "listbadge",
                              cond:
                              {
                                "$and":
                                  [
                                    {
                                      "$eq":
                                        [
                                          "$$listbadge.isActive",
                                          true
                                        ]
                                    },
                                    {
                                      "$lte": [
                                        {
                                          "$dateToString": {
                                            "format": "%Y-%m-%d %H:%M:%S",
                                            "date": {
                                              "$add": [
                                                new Date(),
                                                25200000
                                              ]
                                            }
                                          }
                                        },
                                        "$$listbadge.endDatetime"
                                      ]
                                    }
                                  ]
                              }
                            }
                          },
                          []
                        ]
                    },
                  }
                },
                {
                  $project: {
                    "fullName": 1,
                    "profilePict": 1,
                    "username": 1,
                    "email": 1,
                    "avatar": 1,
                    //"idUserAuth": "$userAuth._id",
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$arrayElemAt":
                              [
                                "$urluserBadge",
                                0
                              ]
                          },
                          null
                        ]
                    }
                  }
                },
                {
                  $skip: skip
                },
                {
                  $limit: limit
                },
              ],
              "vid": 
              [
                  {
                      $lookup: {
                          from: "newPosts",
                          pipeline: [
                              {
                                  $match: 
                                  {
                                      $and: [
                                          {
                                              $text: {
                                                  $search: key,
                                                  
                                              }
                                          },
                                          {
                                              "reportedStatus": {
                                                  $ne: "OWNED"
                                              }
                                          },
                                          {
                                              "visibility": "PUBLIC"
                                          },
                                          {
                                              "active": true
                                          },
                                          {
                                              "postType": "vid"
                                          },
                                          {
                                              "reportedUser.email": {
                                                  $not: {
                                                      $regex: email
                                                  }
                                              }
                                          },
                                          
                                      ]
                                  },
                                  
                              },
                              {
                                  $set: {
                                      scorePict: {
                                          $meta: "textScore"
                                      }
                                  }
                              },
                              {
                                  $project: {
                                      mediaSource:1,
                                      "boosted": 
                                      {
                                          $cond: {
                                              if : {
                                                  $gt: [{
                                                      "$dateToString": {
                                                          "format": "%Y-%m-%d %H:%M:%S",
                                                          "date": {
                                                              $add: [new Date(), 25200000]
                                                          }
                                                      }
                                                  }, "$boosted.boostSession.timeEnd"]
                                              },
                                              then: [],
                                              else : '$boosted'
                                          }
                                      },
                                      "reportedStatus": 1,
                                      "insight": {
                                          "shares": "$shares",
                                          "comments": "$comments",
                                          "views": "$views",
                                          "likes": "$likes",
                                          
                                      },
                                       "views": "$views",
                                      "comments": "$comments",
                                      "likes": "$likes",
                                      "scorePict": 1,
                                      "_id": 1,
                                      "postID": 1,
                                      "createdAt": 1,
                                      "updatedAt": 1,
                                      "email": 1,
                                      "postType": 1,
                                      "description": 1,
                                      "active": 1,
                                      "metadata": 1,
                                      "location": 1,
                                      "isOwned": 1,
                                      "visibility": 1,
                                      "isViewed": 1,
                                      "allowComments": 1,
                                      "saleAmount": 1,
                                      
                                  }
                              },
                              {
                                    $sort: {
                                        scorePict: - 1,
                                        comments: - 1,
                                        likes: - 1,
                                        views:  -1
                                    }
                                },
                                {
                                    $skip: skip
                                },
                                {
                                    $limit: limit
                                },
                          ],
                          as: "pict"
                      },
                      
                  },
                
                  {
                      $unwind: {
                          path: "$pict",
                          preserveNullAndEmptyArrays: true
                      }
                  },
                  
                  {
                      $project: {
                          "scorePict": "$pict.scorePict",
                          "boosted": "$pict.boosted",
                          "reportedStatus": "$pict.reportedStatus",
                          "_id": "$pict._id",
                          "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                          {
                              "$concat": ["/thumb/", "$pict.postID"]
                          },
                          mediaEndpoint:{
                           "$cond":
                           {
                               if:
                               {
                                   "$eq":
                                       [
                                         "$pict.postType", "pict"
                                       ]
                               },
                               then:
                               {
                                   "$concat":
                                       [
                                           "/pict/",
                                           "$pict.postID"
                                       ]
                               },
                               else:
                               {
                                   "$concat":
                                       [
                                           "/stream/",
                                           "$pict.postID"
                                       ]
                               }
                           }
                       },
                          "mediaType": {
                              $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                          },
                          "createdAt": "$pict.createdAt",
                          "updatedAt": "$pict.updatedAt",
                          "postID": "$pict.postID",
                          "email": "$pict.email",
                          "postType": "$pict.postType",
                          "description": "$pict.description",
                          "active": "$pict.active",
                          "metadata": "$pict.metadata",
                          "location": "$pict.location",
                          "isOwned": "$pict.isOwned",
                          "visibility": "$pict.visibility",
                          "isViewed": "$pict.isViewed",
                          "allowComments": "$pict.allowComments",
                          "saleAmount": "$pict.saleAmount",
                          "monetize": 
                          {
                              $cond: {
                                  if : {
                                      $gte: ["$pict.saleAmount", 1]
                                  },
                                  then: true,
                                  else : "$taslimKONAG"
                              }
                          },
                          "comments": "$pict.comments",
                          "likes": "$pict.likes",
                          "insight": 
                          {
                              $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                          },
                          "apsaraId": {
                              $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                          },
                          "isApsara": {
                              $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                          },
                          "viewed": "$pict.insight.views",
                      }
                  },
                  {
                      $sort: {
                          scorePict: - 1,
                          comments: - 1,
                          likes: - 1,
                          viewed:  -1
                      }
                  },
                  
              ],

              "diary": 
              [
                  {
                      $lookup: {
                          from: "newPosts",
                          pipeline: [
                              {
                                  $match: 
                                  {
                                      $and: [
                                          {
                                              $text: {
                                                  $search: key,
                                                  
                                              }
                                          },
                                          {
                                              "reportedStatus": {
                                                  $ne: "OWNED"
                                              }
                                          },
                                          {
                                              "visibility": "PUBLIC"
                                          },
                                          {
                                              "active": true
                                          },
                                          {
                                              "postType": "diary"
                                          },
                                          {
                                              "reportedUser.email": {
                                                  $not: {
                                                      $regex: email
                                                  }
                                              }
                                          },
                                          
                                      ]
                                  },
                                  
                              },
                              {
                                  $set: {
                                      scorePict: {
                                          $meta: "textScore"
                                      }
                                  }
                              },
                              {
                                  $project: {
                                      mediaSource:1,
                                      "boosted": 
                                      {
                                          $cond: {
                                              if : {
                                                  $gt: [{
                                                      "$dateToString": {
                                                          "format": "%Y-%m-%d %H:%M:%S",
                                                          "date": {
                                                              $add: [new Date(), 25200000]
                                                          }
                                                      }
                                                  }, "$boosted.boostSession.timeEnd"]
                                              },
                                              then: [],
                                              else : '$boosted'
                                          }
                                      },
                                      "reportedStatus": 1,
                                      "insight": {
                                          "shares": "$shares",
                                          "comments": "$comments",
                                          "views": "$views",
                                          "likes": "$likes",
                                          
                                      },
                                       "views": "$views",
                                      "comments": "$comments",
                                      "likes": "$likes",
                                      "scorePict": 1,
                                      "_id": 1,
                                      "postID": 1,
                                      "createdAt": 1,
                                      "updatedAt": 1,
                                      "email": 1,
                                      "postType": 1,
                                      "description": 1,
                                      "active": 1,
                                      "metadata": 1,
                                      "location": 1,
                                      "isOwned": 1,
                                      "visibility": 1,
                                      "isViewed": 1,
                                      "allowComments": 1,
                                      "saleAmount": 1,
                                      
                                  }
                              },
                              {
                                    $sort: {
                                        scorePict: - 1,
                                        comments: - 1,
                                        likes: - 1,
                                        views:  -1
                                    }
                                },
                                {
                                    $skip:skip
                                },
                                {
                                    $limit: limit
                                },
                          ],
                          as: "pict"
                      },
                      
                  },
                
                  {
                      $unwind: {
                          path: "$pict",
                          preserveNullAndEmptyArrays: true
                      }
                  },
                  
                  {
                      $project: {
                          "scorePict": "$pict.scorePict",
                          "boosted": "$pict.boosted",
                          "reportedStatus": "$pict.reportedStatus",
                          "_id": "$pict._id",
                          "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                          {
                              "$concat": ["/thumb/", "$pict.postID"]
                          },
                          mediaEndpoint:{
                           "$cond":
                           {
                               if:
                               {
                                   "$eq":
                                       [
                                         "$pict.postType", "pict"
                                       ]
                               },
                               then:
                               {
                                   "$concat":
                                       [
                                           "/pict/",
                                           "$pict.postID"
                                       ]
                               },
                               else:
                               {
                                   "$concat":
                                       [
                                           "/stream/",
                                           "$pict.postID"
                                       ]
                               }
                           }
                       },
                          "mediaType": {
                              $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                          },
                          "createdAt": "$pict.createdAt",
                          "updatedAt": "$pict.updatedAt",
                          "postID": "$pict.postID",
                          "email": "$pict.email",
                          "postType": "$pict.postType",
                          "description": "$pict.description",
                          "active": "$pict.active",
                          "metadata": "$pict.metadata",
                          "location": "$pict.location",
                          "isOwned": "$pict.isOwned",
                          "visibility": "$pict.visibility",
                          "isViewed": "$pict.isViewed",
                          "allowComments": "$pict.allowComments",
                          "saleAmount": "$pict.saleAmount",
                          "monetize": 
                          {
                              $cond: {
                                  if : {
                                      $gte: ["$pict.saleAmount", 1]
                                  },
                                  then: true,
                                  else : "$taslimKONAG"
                              }
                          },
                          "comments": "$pict.comments",
                          "likes": "$pict.likes",
                          "insight": 
                          {
                              $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                          },
                          "apsaraId": {
                              $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                          },
                          "isApsara": {
                              $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                          },
                          "viewed": "$pict.insight.views",
                      }
                  },
                  {
                      $sort: {
                          scorePict: - 1,
                          comments: - 1,
                          likes: - 1,
                          viewed:  -1
                      }
                  },
                  
              ],
          },

        },
        {
          $project: {
            user:
            {
              $cond: {
                if: {
                  $eq: [{
                    $arrayElemAt: ["$user.dodol", 0]
                  }, "kosong"]
                },
                then: "$saassaas",
                else: "$user"
              }
            },
            vid: "$vid",
            diary: "$diary",

          }
        });
    }
    else if (pict === true && vid === true && diary === true && user === true && tag === false) {
      pipeline.push(

        {
          $facet:
          {
            "user":
              [
                {
                  $lookup: {
                    from: "newUserBasics",
                    let: {
                      name: "$dedy"
                    },
                    pipeline: [
                      {
                        $match: {
                          $expr: {
                            $regexMatch: {
                              input: "$username",
                              regex: "$$name",
                              options: "i"
                            }
                          }
                        }
                      }
                    ],
                    as: "userAuth"
                  },

                },
                {
                  $unwind: {
                    path: "$userAuth",
                    preserveNullAndEmptyArrays: true
                  }
                },
                {
                  $project: {
                    "fullName": "$userAuth.fullName",
                    "profilePict": "$userAuth.profilePict",
                    "username": "$userAuth.username",
                    "email": "$userAuth.email",
                    "avatar":
                      [{
                        "mediaBasePath": "$userAuth.mediaBasePath",
                        "mediaUri": "$userAuth.mediaUri",
                        "originalName": "$userAuth.originalName",
                        "fsSourceUri": "$userAuth.fsSourceUri",
                        "fsSourceName": "$userBasic.fsSourceName",
                        "fsTargetUri": "$userAuth.fsTargetUri",
                        "mediaType": "$userAuth.mediaType",
                        //"mediaEndpoint": {
                        //"$concat": ["/profilepict/", "$mediaUri"]
                        //}
                      }],
                    //"idUserAuth": "$userAuth._id",
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$filter":
                            {
                              input:
                              {
                                "$arrayElemAt":
                                  [
                                    "$userAuth.userBadge",
                                    0
                                  ]
                              },
                              as: "listbadge",
                              cond:
                              {
                                "$and":
                                  [
                                    {
                                      "$eq":
                                        [
                                          "$$listbadge.isActive",
                                          true
                                        ]
                                    },
                                    {
                                      "$lte": [
                                        {
                                          "$dateToString": {
                                            "format": "%Y-%m-%d %H:%M:%S",
                                            "date": {
                                              "$add": [
                                                new Date(),
                                                25200000
                                              ]
                                            }
                                          }
                                        },
                                        "$$listbadge.endDatetime"
                                      ]
                                    }
                                  ]
                              }
                            }
                          },
                          []
                        ]
                    },
                  }
                },
                {
                  $project: {
                    "fullName": 1,
                    "profilePict": 1,
                    "username": 1,
                    "email": 1,
                    "avatar": 1,
                    //"idUserAuth": "$userAuth._id",
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$arrayElemAt":
                              [
                                "$urluserBadge",
                                0
                              ]
                          },
                          null
                        ]
                    }
                  }
                },
                {
                  $skip: skip
                },
                {
                  $limit: limit
                },
              ],
            //pict
            "pict": 
            [
                {
                    $lookup: {
                        from: "newPosts",
                        pipeline: [
                            {
                                $match: 
                                {
                                    $and: [
                                        {
                                            $text: {
                                                $search: key,
                                                
                                            }
                                        },
                                        {
                                            "reportedStatus": {
                                                $ne: "OWNED"
                                            }
                                        },
                                        {
                                            "visibility": "PUBLIC"
                                        },
                                        {
                                            "active": true
                                        },
                                        {
                                            "postType": "pict"
                                        },
                                        {
                                            "reportedUser.email": {
                                                $not: {
                                                    $regex: email
                                                }
                                            }
                                        },
                                        
                                    ]
                                },
                                
                            },
                            {
                                $set: {
                                    scorePict: {
                                        $meta: "textScore"
                                    }
                                }
                            },
                            {
                                $project: {
                                    mediaSource:1,
                                    "boosted": 
                                    {
                                        $cond: {
                                            if : {
                                                $gt: [{
                                                    "$dateToString": {
                                                        "format": "%Y-%m-%d %H:%M:%S",
                                                        "date": {
                                                            $add: [new Date(), 25200000]
                                                        }
                                                    }
                                                }, "$boosted.boostSession.timeEnd"]
                                            },
                                            then: [],
                                            else : '$boosted'
                                        }
                                    },
                                    "reportedStatus": 1,
                                    "insight": {
                                        "shares": "$shares",
                                        "comments": "$comments",
                                        "views": "$views",
                                        "likes": "$likes",
                                        
                                    },
                                     "views": "$views",
                                    "comments": "$comments",
                                    "likes": "$likes",
                                    "scorePict": 1,
                                    "_id": 1,
                                    "postID": 1,
                                    "createdAt": 1,
                                    "updatedAt": 1,
                                    "email": 1,
                                    "postType": 1,
                                    "description": 1,
                                    "active": 1,
                                    "metadata": 1,
                                    "location": 1,
                                    "isOwned": 1,
                                    "visibility": 1,
                                    "isViewed": 1,
                                    "allowComments": 1,
                                    "saleAmount": 1,
                                    
                                }
                            },
                            {
                                  $sort: {
                                      scorePict: - 1,
                                      comments: - 1,
                                      likes: - 1,
                                      views:  -1
                                  }
                              },
                              {
                               $skip: skip
                             },
                             {
                               $limit: limit
                             },
                        ],
                        as: "pict"
                    },
                    
                },
              
                {
                    $unwind: {
                        path: "$pict",
                        preserveNullAndEmptyArrays: true
                    }
                },
                
                {
                    $project: {
                        "scorePict": "$pict.scorePict",
                        "boosted": "$pict.boosted",
                        "reportedStatus": "$pict.reportedStatus",
                        "_id": "$pict._id",
                        "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                        {
                            "$concat": ["/thumb/", "$pict.postID"]
                        },
                        mediaEndpoint:{
                         "$cond":
                         {
                             if:
                             {
                                 "$eq":
                                     [
                                       "$pict.postType", "pict"
                                     ]
                             },
                             then:
                             {
                                 "$concat":
                                     [
                                         "/pict/",
                                         "$pict.postID"
                                     ]
                             },
                             else:
                             {
                                 "$concat":
                                     [
                                         "/stream/",
                                         "$pict.postID"
                                     ]
                             }
                         }
                     },
                        "mediaType": {
                            $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                        },
                        "createdAt": "$pict.createdAt",
                        "updatedAt": "$pict.updatedAt",
                        "postID": "$pict.postID",
                        "email": "$pict.email",
                        "postType": "$pict.postType",
                        "description": "$pict.description",
                        "active": "$pict.active",
                        "metadata": "$pict.metadata",
                        "location": "$pict.location",
                        "isOwned": "$pict.isOwned",
                        "visibility": "$pict.visibility",
                        "isViewed": "$pict.isViewed",
                        "allowComments": "$pict.allowComments",
                        "saleAmount": "$pict.saleAmount",
                        "monetize": 
                        {
                            $cond: {
                                if : {
                                    $gte: ["$pict.saleAmount", 1]
                                },
                                then: true,
                                else : "$taslimKONAG"
                            }
                        },
                        "comments": "$pict.comments",
                        "likes": "$pict.likes",
                        "insight": 
                        {
                            $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                        },
                        "apsaraId": {
                            $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                        },
                        "isApsara": {
                            $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                        },
                        "viewed": "$pict.insight.views",
                    }
                },
                {
                    $sort: {
                        scorePict: - 1,
                        comments: - 1,
                        likes: - 1,
                        viewed:  -1
                    }
                },
                
            ],
            "vid": 
            [
                {
                    $lookup: {
                        from: "newPosts",
                        pipeline: [
                            {
                                $match: 
                                {
                                    $and: [
                                        {
                                            $text: {
                                                $search: key,
                                                
                                            }
                                        },
                                        {
                                            "reportedStatus": {
                                                $ne: "OWNED"
                                            }
                                        },
                                        {
                                            "visibility": "PUBLIC"
                                        },
                                        {
                                            "active": true
                                        },
                                        {
                                            "postType": "vid"
                                        },
                                        {
                                            "reportedUser.email": {
                                                $not: {
                                                    $regex: email
                                                }
                                            }
                                        },
                                        
                                    ]
                                },
                                
                            },
                            {
                                $set: {
                                    scorePict: {
                                        $meta: "textScore"
                                    }
                                }
                            },
                            {
                                $project: {
                                    mediaSource:1,
                                    "boosted": 
                                    {
                                        $cond: {
                                            if : {
                                                $gt: [{
                                                    "$dateToString": {
                                                        "format": "%Y-%m-%d %H:%M:%S",
                                                        "date": {
                                                            $add: [new Date(), 25200000]
                                                        }
                                                    }
                                                }, "$boosted.boostSession.timeEnd"]
                                            },
                                            then: [],
                                            else : '$boosted'
                                        }
                                    },
                                    "reportedStatus": 1,
                                    "insight": {
                                        "shares": "$shares",
                                        "comments": "$comments",
                                        "views": "$views",
                                        "likes": "$likes",
                                        
                                    },
                                     "views": "$views",
                                    "comments": "$comments",
                                    "likes": "$likes",
                                    "scorePict": 1,
                                    "_id": 1,
                                    "postID": 1,
                                    "createdAt": 1,
                                    "updatedAt": 1,
                                    "email": 1,
                                    "postType": 1,
                                    "description": 1,
                                    "active": 1,
                                    "metadata": 1,
                                    "location": 1,
                                    "isOwned": 1,
                                    "visibility": 1,
                                    "isViewed": 1,
                                    "allowComments": 1,
                                    "saleAmount": 1,
                                    
                                }
                            },
                            {
                                  $sort: {
                                      scorePict: - 1,
                                      comments: - 1,
                                      likes: - 1,
                                      views:  -1
                                  }
                              },
                              {
                                  $skip: skip
                              },
                              {
                                  $limit: limit
                              },
                        ],
                        as: "pict"
                    },
                    
                },
              
                {
                    $unwind: {
                        path: "$pict",
                        preserveNullAndEmptyArrays: true
                    }
                },
                
                {
                    $project: {
                        "scorePict": "$pict.scorePict",
                        "boosted": "$pict.boosted",
                        "reportedStatus": "$pict.reportedStatus",
                        "_id": "$pict._id",
                        "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                        {
                            "$concat": ["/thumb/", "$pict.postID"]
                        },
                        mediaEndpoint:{
                         "$cond":
                         {
                             if:
                             {
                                 "$eq":
                                     [
                                       "$pict.postType", "pict"
                                     ]
                             },
                             then:
                             {
                                 "$concat":
                                     [
                                         "/pict/",
                                         "$pict.postID"
                                     ]
                             },
                             else:
                             {
                                 "$concat":
                                     [
                                         "/stream/",
                                         "$pict.postID"
                                     ]
                             }
                         }
                     },
                        "mediaType": {
                            $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                        },
                        "createdAt": "$pict.createdAt",
                        "updatedAt": "$pict.updatedAt",
                        "postID": "$pict.postID",
                        "email": "$pict.email",
                        "postType": "$pict.postType",
                        "description": "$pict.description",
                        "active": "$pict.active",
                        "metadata": "$pict.metadata",
                        "location": "$pict.location",
                        "isOwned": "$pict.isOwned",
                        "visibility": "$pict.visibility",
                        "isViewed": "$pict.isViewed",
                        "allowComments": "$pict.allowComments",
                        "saleAmount": "$pict.saleAmount",
                        "monetize": 
                        {
                            $cond: {
                                if : {
                                    $gte: ["$pict.saleAmount", 1]
                                },
                                then: true,
                                else : "$taslimKONAG"
                            }
                        },
                        "comments": "$pict.comments",
                        "likes": "$pict.likes",
                        "insight": 
                        {
                            $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                        },
                        "apsaraId": {
                            $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                        },
                        "isApsara": {
                            $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                        },
                        "viewed": "$pict.insight.views",
                    }
                },
                {
                    $sort: {
                        scorePict: - 1,
                        comments: - 1,
                        likes: - 1,
                        viewed:  -1
                    }
                },
                
            ],
            "diary": 
            [
                {
                    $lookup: {
                        from: "newPosts",
                        pipeline: [
                            {
                                $match: 
                                {
                                    $and: [
                                        {
                                            $text: {
                                                $search: key,
                                                
                                            }
                                        },
                                        {
                                            "reportedStatus": {
                                                $ne: "OWNED"
                                            }
                                        },
                                        {
                                            "visibility": "PUBLIC"
                                        },
                                        {
                                            "active": true
                                        },
                                        {
                                            "postType": "diary"
                                        },
                                        {
                                            "reportedUser.email": {
                                                $not: {
                                                    $regex: email
                                                }
                                            }
                                        },
                                        
                                    ]
                                },
                                
                            },
                            {
                                $set: {
                                    scorePict: {
                                        $meta: "textScore"
                                    }
                                }
                            },
                            {
                                $project: {
                                    mediaSource:1,
                                    "boosted": 
                                    {
                                        $cond: {
                                            if : {
                                                $gt: [{
                                                    "$dateToString": {
                                                        "format": "%Y-%m-%d %H:%M:%S",
                                                        "date": {
                                                            $add: [new Date(), 25200000]
                                                        }
                                                    }
                                                }, "$boosted.boostSession.timeEnd"]
                                            },
                                            then: [],
                                            else : '$boosted'
                                        }
                                    },
                                    "reportedStatus": 1,
                                    "insight": {
                                        "shares": "$shares",
                                        "comments": "$comments",
                                        "views": "$views",
                                        "likes": "$likes",
                                        
                                    },
                                     "views": "$views",
                                    "comments": "$comments",
                                    "likes": "$likes",
                                    "scorePict": 1,
                                    "_id": 1,
                                    "postID": 1,
                                    "createdAt": 1,
                                    "updatedAt": 1,
                                    "email": 1,
                                    "postType": 1,
                                    "description": 1,
                                    "active": 1,
                                    "metadata": 1,
                                    "location": 1,
                                    "isOwned": 1,
                                    "visibility": 1,
                                    "isViewed": 1,
                                    "allowComments": 1,
                                    "saleAmount": 1,
                                    
                                }
                            },
                            {
                                  $sort: {
                                      scorePict: - 1,
                                      comments: - 1,
                                      likes: - 1,
                                      views:  -1
                                  }
                              },
                              {
                                  $skip:skip
                              },
                              {
                                  $limit: limit
                              },
                        ],
                        as: "pict"
                    },
                    
                },
              
                {
                    $unwind: {
                        path: "$pict",
                        preserveNullAndEmptyArrays: true
                    }
                },
                
                {
                    $project: {
                        "scorePict": "$pict.scorePict",
                        "boosted": "$pict.boosted",
                        "reportedStatus": "$pict.reportedStatus",
                        "_id": "$pict._id",
                        "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                        {
                            "$concat": ["/thumb/", "$pict.postID"]
                        },
                        mediaEndpoint:{
                         "$cond":
                         {
                             if:
                             {
                                 "$eq":
                                     [
                                       "$pict.postType", "pict"
                                     ]
                             },
                             then:
                             {
                                 "$concat":
                                     [
                                         "/pict/",
                                         "$pict.postID"
                                     ]
                             },
                             else:
                             {
                                 "$concat":
                                     [
                                         "/stream/",
                                         "$pict.postID"
                                     ]
                             }
                         }
                     },
                        "mediaType": {
                            $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                        },
                        "createdAt": "$pict.createdAt",
                        "updatedAt": "$pict.updatedAt",
                        "postID": "$pict.postID",
                        "email": "$pict.email",
                        "postType": "$pict.postType",
                        "description": "$pict.description",
                        "active": "$pict.active",
                        "metadata": "$pict.metadata",
                        "location": "$pict.location",
                        "isOwned": "$pict.isOwned",
                        "visibility": "$pict.visibility",
                        "isViewed": "$pict.isViewed",
                        "allowComments": "$pict.allowComments",
                        "saleAmount": "$pict.saleAmount",
                        "monetize": 
                        {
                            $cond: {
                                if : {
                                    $gte: ["$pict.saleAmount", 1]
                                },
                                then: true,
                                else : "$taslimKONAG"
                            }
                        },
                        "comments": "$pict.comments",
                        "likes": "$pict.likes",
                        "insight": 
                        {
                            $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                        },
                        "apsaraId": {
                            $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                        },
                        "isApsara": {
                            $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                        },
                        "viewed": "$pict.insight.views",
                    }
                },
                {
                    $sort: {
                        scorePict: - 1,
                        comments: - 1,
                        likes: - 1,
                        viewed:  -1
                    }
                },
                
            ],

          },

        },
        {
          $project: {
            user:
            {
              $cond: {
                if: {
                  $eq: [{
                    $arrayElemAt: ["$user.dodol", 0]
                  }, "kosong"]
                },
                then: "$saassaas",
                else: "$user"
              }
            },
            pict: "$pict",
            vid: "$vid",
            diary: "$diary",

          }
        });
    }
    else if (pict === false && vid === false && diary === false && user === true && tag === false) {
      pipeline.push(

        {
          $facet:
          {
            "user":
              [
                {
                  $lookup: {
                    from: "newUserBasics",
                    let: {
                      name: "$dedy"
                    },
                    pipeline: [
                      {
                        $match: {
                          $expr: {
                            $regexMatch: {
                              input: "$username",
                              regex: "$$name",
                              options: "i"
                            }
                          }
                        }
                      }
                    ],
                    as: "userAuth"
                  },

                },
                {
                  $unwind: {
                    path: "$userAuth",
                    preserveNullAndEmptyArrays: true
                  }
                },
                {
                  $project: {
                    "fullName": "$userAuth.fullName",
                    "profilePict": "$userAuth.profilePict",
                    "username": "$userAuth.username",
                    "email": "$userAuth.email",
                    "avatar":
                      [{
                        "mediaBasePath": "$userAuth.mediaBasePath",
                        "mediaUri": "$userAuth.mediaUri",
                        "originalName": "$userAuth.originalName",
                        "fsSourceUri": "$userAuth.fsSourceUri",
                        "fsSourceName": "$userBasic.fsSourceName",
                        "fsTargetUri": "$userAuth.fsTargetUri",
                        "mediaType": "$userAuth.mediaType",
                        //"mediaEndpoint": {
                        //"$concat": ["/profilepict/", "$mediaUri"]
                        //}
                      }],
                    //"idUserAuth": "$userAuth._id",
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$filter":
                            {
                              input:
                              {
                                "$arrayElemAt":
                                  [
                                    "$userAuth.userBadge",
                                    0
                                  ]
                              },
                              as: "listbadge",
                              cond:
                              {
                                "$and":
                                  [
                                    {
                                      "$eq":
                                        [
                                          "$$listbadge.isActive",
                                          true
                                        ]
                                    },
                                    {
                                      "$lte": [
                                        {
                                          "$dateToString": {
                                            "format": "%Y-%m-%d %H:%M:%S",
                                            "date": {
                                              "$add": [
                                                new Date(),
                                                25200000
                                              ]
                                            }
                                          }
                                        },
                                        "$$listbadge.endDatetime"
                                      ]
                                    }
                                  ]
                              }
                            }
                          },
                          []
                        ]
                    },
                  }
                },
                {
                  $project: {
                    "fullName": 1,
                    "profilePict": 1,
                    "username": 1,
                    "email": 1,
                    "avatar": 1,
                    //"idUserAuth": "$userAuth._id",
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$arrayElemAt":
                              [
                                "$urluserBadge",
                                0
                              ]
                          },
                          null
                        ]
                    }
                  }
                },
                {
                  $skip: skip
                },
                {
                  $limit: limit
                },
              ],
          },

        },
        {
          $project: {
            user:
            {
              $cond: {
                if: {
                  $eq: [{
                    $arrayElemAt: ["$user.dodol", 0]
                  }, "kosong"]
                },
                then: "$saassaas",
                else: "$user"
              }
            },
          }
        });
    }
    else if (pict === false && vid === true && diary === false && user === false && tag === false) {
      pipeline.push(

        {
          $facet:
          {

            "vid": 
            [
                {
                    $lookup: {
                        from: "newPosts",
                        pipeline: [
                            {
                                $match: 
                                {
                                    $and: [
                                        {
                                            $text: {
                                                $search: key,
                                                
                                            }
                                        },
                                        {
                                            "reportedStatus": {
                                                $ne: "OWNED"
                                            }
                                        },
                                        {
                                            "visibility": "PUBLIC"
                                        },
                                        {
                                            "active": true
                                        },
                                        {
                                            "postType": "vid"
                                        },
                                        {
                                            "reportedUser.email": {
                                                $not: {
                                                    $regex: email
                                                }
                                            }
                                        },
                                        
                                    ]
                                },
                                
                            },
                            {
                                $set: {
                                    scorePict: {
                                        $meta: "textScore"
                                    }
                                }
                            },
                            {
                                $project: {
                                    mediaSource:1,
                                    "boosted": 
                                    {
                                        $cond: {
                                            if : {
                                                $gt: [{
                                                    "$dateToString": {
                                                        "format": "%Y-%m-%d %H:%M:%S",
                                                        "date": {
                                                            $add: [new Date(), 25200000]
                                                        }
                                                    }
                                                }, "$boosted.boostSession.timeEnd"]
                                            },
                                            then: [],
                                            else : '$boosted'
                                        }
                                    },
                                    "reportedStatus": 1,
                                    "insight": {
                                        "shares": "$shares",
                                        "comments": "$comments",
                                        "views": "$views",
                                        "likes": "$likes",
                                        
                                    },
                                     "views": "$views",
                                    "comments": "$comments",
                                    "likes": "$likes",
                                    "scorePict": 1,
                                    "_id": 1,
                                    "postID": 1,
                                    "createdAt": 1,
                                    "updatedAt": 1,
                                    "email": 1,
                                    "postType": 1,
                                    "description": 1,
                                    "active": 1,
                                    "metadata": 1,
                                    "location": 1,
                                    "isOwned": 1,
                                    "visibility": 1,
                                    "isViewed": 1,
                                    "allowComments": 1,
                                    "saleAmount": 1,
                                    
                                }
                            },
                            {
                                  $sort: {
                                      scorePict: - 1,
                                      comments: - 1,
                                      likes: - 1,
                                      views:  -1
                                  }
                              },
                              {
                                  $skip: skip
                              },
                              {
                                  $limit: limit
                              },
                        ],
                        as: "pict"
                    },
                    
                },
              
                {
                    $unwind: {
                        path: "$pict",
                        preserveNullAndEmptyArrays: true
                    }
                },
                
                {
                    $project: {
                        "scorePict": "$pict.scorePict",
                        "boosted": "$pict.boosted",
                        "reportedStatus": "$pict.reportedStatus",
                        "_id": "$pict._id",
                        "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                        {
                            "$concat": ["/thumb/", "$pict.postID"]
                        },
                        mediaEndpoint:{
                         "$cond":
                         {
                             if:
                             {
                                 "$eq":
                                     [
                                       "$pict.postType", "pict"
                                     ]
                             },
                             then:
                             {
                                 "$concat":
                                     [
                                         "/pict/",
                                         "$pict.postID"
                                     ]
                             },
                             else:
                             {
                                 "$concat":
                                     [
                                         "/stream/",
                                         "$pict.postID"
                                     ]
                             }
                         }
                     },
                        "mediaType": {
                            $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                        },
                        "createdAt": "$pict.createdAt",
                        "updatedAt": "$pict.updatedAt",
                        "postID": "$pict.postID",
                        "email": "$pict.email",
                        "postType": "$pict.postType",
                        "description": "$pict.description",
                        "active": "$pict.active",
                        "metadata": "$pict.metadata",
                        "location": "$pict.location",
                        "isOwned": "$pict.isOwned",
                        "visibility": "$pict.visibility",
                        "isViewed": "$pict.isViewed",
                        "allowComments": "$pict.allowComments",
                        "saleAmount": "$pict.saleAmount",
                        "monetize": 
                        {
                            $cond: {
                                if : {
                                    $gte: ["$pict.saleAmount", 1]
                                },
                                then: true,
                                else : "$taslimKONAG"
                            }
                        },
                        "comments": "$pict.comments",
                        "likes": "$pict.likes",
                        "insight": 
                        {
                            $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                        },
                        "apsaraId": {
                            $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                        },
                        "isApsara": {
                            $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                        },
                        "viewed": "$pict.insight.views",
                    }
                },
                {
                    $sort: {
                        scorePict: - 1,
                        comments: - 1,
                        likes: - 1,
                        viewed:  -1
                    }
                },
                
            ],

          },

        },
        {
          $project: {

            vid: "$vid",

          }
        });
    }
    else if (pict === true && vid === false && diary === false && user === false && tag === false) {
      pipeline.push(

        {
          $facet:
          {
            //pict
            "pict": 
            [
                {
                    $lookup: {
                        from: "newPosts",
                        pipeline: [
                            {
                                $match: 
                                {
                                    $and: [
                                        {
                                            $text: {
                                                $search: key,
                                                
                                            }
                                        },
                                        {
                                            "reportedStatus": {
                                                $ne: "OWNED"
                                            }
                                        },
                                        {
                                            "visibility": "PUBLIC"
                                        },
                                        {
                                            "active": true
                                        },
                                        {
                                            "postType": "pict"
                                        },
                                        {
                                            "reportedUser.email": {
                                                $not: {
                                                    $regex: email
                                                }
                                            }
                                        },
                                        
                                    ]
                                },
                                
                            },
                            {
                                $set: {
                                    scorePict: {
                                        $meta: "textScore"
                                    }
                                }
                            },
                            {
                                $project: {
                                    mediaSource:1,
                                    "boosted": 
                                    {
                                        $cond: {
                                            if : {
                                                $gt: [{
                                                    "$dateToString": {
                                                        "format": "%Y-%m-%d %H:%M:%S",
                                                        "date": {
                                                            $add: [new Date(), 25200000]
                                                        }
                                                    }
                                                }, "$boosted.boostSession.timeEnd"]
                                            },
                                            then: [],
                                            else : '$boosted'
                                        }
                                    },
                                    "reportedStatus": 1,
                                    "insight": {
                                        "shares": "$shares",
                                        "comments": "$comments",
                                        "views": "$views",
                                        "likes": "$likes",
                                        
                                    },
                                     "views": "$views",
                                    "comments": "$comments",
                                    "likes": "$likes",
                                    "scorePict": 1,
                                    "_id": 1,
                                    "postID": 1,
                                    "createdAt": 1,
                                    "updatedAt": 1,
                                    "email": 1,
                                    "postType": 1,
                                    "description": 1,
                                    "active": 1,
                                    "metadata": 1,
                                    "location": 1,
                                    "isOwned": 1,
                                    "visibility": 1,
                                    "isViewed": 1,
                                    "allowComments": 1,
                                    "saleAmount": 1,
                                    
                                }
                            },
                            {
                                  $sort: {
                                      scorePict: - 1,
                                      comments: - 1,
                                      likes: - 1,
                                      views:  -1
                                  }
                              },
                              {
                               $skip: skip
                             },
                             {
                               $limit: limit
                             },
                        ],
                        as: "pict"
                    },
                    
                },
              
                {
                    $unwind: {
                        path: "$pict",
                        preserveNullAndEmptyArrays: true
                    }
                },
                
                {
                    $project: {
                        "scorePict": "$pict.scorePict",
                        "boosted": "$pict.boosted",
                        "reportedStatus": "$pict.reportedStatus",
                        "_id": "$pict._id",
                        "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                        {
                            "$concat": ["/thumb/", "$pict.postID"]
                        },
                        mediaEndpoint:{
                         "$cond":
                         {
                             if:
                             {
                                 "$eq":
                                     [
                                       "$pict.postType", "pict"
                                     ]
                             },
                             then:
                             {
                                 "$concat":
                                     [
                                         "/pict/",
                                         "$pict.postID"
                                     ]
                             },
                             else:
                             {
                                 "$concat":
                                     [
                                         "/stream/",
                                         "$pict.postID"
                                     ]
                             }
                         }
                     },
                        "mediaType": {
                            $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                        },
                        "createdAt": "$pict.createdAt",
                        "updatedAt": "$pict.updatedAt",
                        "postID": "$pict.postID",
                        "email": "$pict.email",
                        "postType": "$pict.postType",
                        "description": "$pict.description",
                        "active": "$pict.active",
                        "metadata": "$pict.metadata",
                        "location": "$pict.location",
                        "isOwned": "$pict.isOwned",
                        "visibility": "$pict.visibility",
                        "isViewed": "$pict.isViewed",
                        "allowComments": "$pict.allowComments",
                        "saleAmount": "$pict.saleAmount",
                        "monetize": 
                        {
                            $cond: {
                                if : {
                                    $gte: ["$pict.saleAmount", 1]
                                },
                                then: true,
                                else : "$taslimKONAG"
                            }
                        },
                        "comments": "$pict.comments",
                        "likes": "$pict.likes",
                        "insight": 
                        {
                            $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                        },
                        "apsaraId": {
                            $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                        },
                        "isApsara": {
                            $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                        },
                        "viewed": "$pict.insight.views",
                    }
                },
                {
                    $sort: {
                        scorePict: - 1,
                        comments: - 1,
                        likes: - 1,
                        viewed:  -1
                    }
                },
                
            ],
          },

        },
        {
          $project: {

            pict: "$pict"
          }
        });
    }
    else if (pict === false && vid === false && diary === true && user === false && tag === false) {
      pipeline.push(

        {
          $facet:
          {

            "diary": 
            [
                {
                    $lookup: {
                        from: "newPosts",
                        pipeline: [
                            {
                                $match: 
                                {
                                    $and: [
                                        {
                                            $text: {
                                                $search: key,
                                                
                                            }
                                        },
                                        {
                                            "reportedStatus": {
                                                $ne: "OWNED"
                                            }
                                        },
                                        {
                                            "visibility": "PUBLIC"
                                        },
                                        {
                                            "active": true
                                        },
                                        {
                                            "postType": "diary"
                                        },
                                        {
                                            "reportedUser.email": {
                                                $not: {
                                                    $regex: email
                                                }
                                            }
                                        },
                                        
                                    ]
                                },
                                
                            },
                            {
                                $set: {
                                    scorePict: {
                                        $meta: "textScore"
                                    }
                                }
                            },
                            {
                                $project: {
                                    mediaSource:1,
                                    "boosted": 
                                    {
                                        $cond: {
                                            if : {
                                                $gt: [{
                                                    "$dateToString": {
                                                        "format": "%Y-%m-%d %H:%M:%S",
                                                        "date": {
                                                            $add: [new Date(), 25200000]
                                                        }
                                                    }
                                                }, "$boosted.boostSession.timeEnd"]
                                            },
                                            then: [],
                                            else : '$boosted'
                                        }
                                    },
                                    "reportedStatus": 1,
                                    "insight": {
                                        "shares": "$shares",
                                        "comments": "$comments",
                                        "views": "$views",
                                        "likes": "$likes",
                                        
                                    },
                                     "views": "$views",
                                    "comments": "$comments",
                                    "likes": "$likes",
                                    "scorePict": 1,
                                    "_id": 1,
                                    "postID": 1,
                                    "createdAt": 1,
                                    "updatedAt": 1,
                                    "email": 1,
                                    "postType": 1,
                                    "description": 1,
                                    "active": 1,
                                    "metadata": 1,
                                    "location": 1,
                                    "isOwned": 1,
                                    "visibility": 1,
                                    "isViewed": 1,
                                    "allowComments": 1,
                                    "saleAmount": 1,
                                    
                                }
                            },
                            {
                                  $sort: {
                                      scorePict: - 1,
                                      comments: - 1,
                                      likes: - 1,
                                      views:  -1
                                  }
                              },
                              {
                                  $skip:skip
                              },
                              {
                                  $limit: limit
                              },
                        ],
                        as: "pict"
                    },
                    
                },
              
                {
                    $unwind: {
                        path: "$pict",
                        preserveNullAndEmptyArrays: true
                    }
                },
                
                {
                    $project: {
                        "scorePict": "$pict.scorePict",
                        "boosted": "$pict.boosted",
                        "reportedStatus": "$pict.reportedStatus",
                        "_id": "$pict._id",
                        "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                        {
                            "$concat": ["/thumb/", "$pict.postID"]
                        },
                        mediaEndpoint:{
                         "$cond":
                         {
                             if:
                             {
                                 "$eq":
                                     [
                                       "$pict.postType", "pict"
                                     ]
                             },
                             then:
                             {
                                 "$concat":
                                     [
                                         "/pict/",
                                         "$pict.postID"
                                     ]
                             },
                             else:
                             {
                                 "$concat":
                                     [
                                         "/stream/",
                                         "$pict.postID"
                                     ]
                             }
                         }
                     },
                        "mediaType": {
                            $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                        },
                        "createdAt": "$pict.createdAt",
                        "updatedAt": "$pict.updatedAt",
                        "postID": "$pict.postID",
                        "email": "$pict.email",
                        "postType": "$pict.postType",
                        "description": "$pict.description",
                        "active": "$pict.active",
                        "metadata": "$pict.metadata",
                        "location": "$pict.location",
                        "isOwned": "$pict.isOwned",
                        "visibility": "$pict.visibility",
                        "isViewed": "$pict.isViewed",
                        "allowComments": "$pict.allowComments",
                        "saleAmount": "$pict.saleAmount",
                        "monetize": 
                        {
                            $cond: {
                                if : {
                                    $gte: ["$pict.saleAmount", 1]
                                },
                                then: true,
                                else : "$taslimKONAG"
                            }
                        },
                        "comments": "$pict.comments",
                        "likes": "$pict.likes",
                        "insight": 
                        {
                            $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                        },
                        "apsaraId": {
                            $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                        },
                        "isApsara": {
                            $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                        },
                        "viewed": "$pict.insight.views",
                    }
                },
                {
                    $sort: {
                        scorePict: - 1,
                        comments: - 1,
                        likes: - 1,
                        viewed:  -1
                    }
                },
                
            ],
          },

        },
        {
          $project: {

            diary: "$diary",

          }
        });
    }
    else if (pict === false && vid === false && diary === false && user === false && tag === true) {
      pipeline.push(

        {
          $facet:
          {
            "tags":
              [
                {
                  $lookup: {
                    from: "tag_count",
                    pipeline: [
                      {
                        $match:
                        {
                          "_id": {
                            $regex: key, $options: 'i'
                          }
                        }
                      },
                      {
                        $set: {
                          score: {
                            $indexOfCP: ["$_id", "de"]
                          }
                        }
                      },
                      {
                        $set: {
                          length: {
                            $strLenCP: "$_id"
                          }
                        }
                      },
                      {
                        $set: {
                          dodol: "kancut"
                        }
                      },
                      {
                        $project: {
                          name: "$_id",
                          total: 1,
                          score: 1,
                          length: 1,
                          dodol: {
                            $ifNull: ["$_id", "kosong"]
                          },

                        }
                      },

                    ],
                    as: "tag"
                  },

                },
                {
                  $unwind: {
                    path: "$tag",
                    preserveNullAndEmptyArrays: true
                  }
                },
                {
                  $project: {
                    tag: "$tag.name",
                    total: "$tag.total",
                    score: "$tag.score",
                    length: "$tag.length",
                    dodol: "$tag.dodol",

                  },

                },
                {
                  $sort: {
                    score: 1,
                    length: 1,
                    total: - 1
                  }
                },
                {
                  $skip: skip
                },
                {
                  $limit: limit
                },

              ]
          },

        },
        {
          $project: {
            dodol: "$tags.dodol",
            tags:
            {
              $cond: {
                if: {
                  $gt: [{ $size: "$tags.dodol" }, 0]
                },
                then: "$tags",
                else: "$tagsssdsd"
              }
            },

          }
        });
    }
    //sampai sini
    else if (pict === false && vid === false && diary === false && user === true && tag === true) {
      pipeline.push(

        {
          $facet:
          {
            "user":
              [
                {
                  $lookup: {
                    from: "newUserBasics",
                    let: {
                      name: "$dedy"
                    },
                    pipeline: [
                      {
                        $match: {
                          $expr: {
                            $regexMatch: {
                              input: "$username",
                              regex: "$$name",
                              options: "i"
                            }
                          }
                        }
                      }
                    ],
                    as: "userAuth"
                  },

                },
                {
                  $unwind: {
                    path: "$userAuth",
                    preserveNullAndEmptyArrays: true
                  }
                },
                {
                  $project: {
                    "fullName": "$userAuth.fullName",
                    "profilePict": "$userAuth.profilePict",
                    "username": "$userAuth.username",
                    "email": "$userAuth.email",
                    "avatar":
                      [{
                        "mediaBasePath": "$userAuth.mediaBasePath",
                        "mediaUri": "$userAuth.mediaUri",
                        "originalName": "$userAuth.originalName",
                        "fsSourceUri": "$userAuth.fsSourceUri",
                        "fsSourceName": "$userBasic.fsSourceName",
                        "fsTargetUri": "$userAuth.fsTargetUri",
                        "mediaType": "$userAuth.mediaType",
                        //"mediaEndpoint": {
                        //"$concat": ["/profilepict/", "$mediaUri"]
                        //}
                      }],
                    //"idUserAuth": "$userAuth._id",
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$filter":
                            {
                              input:
                              {
                                "$arrayElemAt":
                                  [
                                    "$userAuth.userBadge",
                                    0
                                  ]
                              },
                              as: "listbadge",
                              cond:
                              {
                                "$and":
                                  [
                                    {
                                      "$eq":
                                        [
                                          "$$listbadge.isActive",
                                          true
                                        ]
                                    },
                                    {
                                      "$lte": [
                                        {
                                          "$dateToString": {
                                            "format": "%Y-%m-%d %H:%M:%S",
                                            "date": {
                                              "$add": [
                                                new Date(),
                                                25200000
                                              ]
                                            }
                                          }
                                        },
                                        "$$listbadge.endDatetime"
                                      ]
                                    }
                                  ]
                              }
                            }
                          },
                          []
                        ]
                    },
                  }
                },
                {
                  $project: {
                    "fullName": 1,
                    "profilePict": 1,
                    "username": 1,
                    "email": 1,
                    "avatar": 1,
                    //"idUserAuth": "$userAuth._id",
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$arrayElemAt":
                              [
                                "$urluserBadge",
                                0
                              ]
                          },
                          null
                        ]
                    }
                  }
                },
                {
                  $skip: skip
                },
                {
                  $limit: limit
                },
              ],
            "tags":
              [
                {
                  $lookup: {
                    from: "tag_count",
                    pipeline: [
                      {
                        $match:
                        {
                          "_id": {
                            $regex: key, $options: 'i'
                          }
                        }
                      },
                      {
                        $set: {
                          score: {
                            $indexOfCP: ["$_id", "de"]
                          }
                        }
                      },
                      {
                        $set: {
                          length: {
                            $strLenCP: "$_id"
                          }
                        }
                      },
                      {
                        $set: {
                          dodol: "kancut"
                        }
                      },
                      {
                        $project: {
                          name: "$_id",
                          total: 1,
                          score: 1,
                          length: 1,
                          dodol: {
                            $ifNull: ["$_id", "kosong"]
                          },

                        }
                      },

                    ],
                    as: "tag"
                  },

                },
                {
                  $unwind: {
                    path: "$tag",
                    preserveNullAndEmptyArrays: true
                  }
                },
                {
                  $project: {
                    tag: "$tag.name",
                    total: "$tag.total",
                    score: "$tag.score",
                    length: "$tag.length",
                    dodol: "$tag.dodol",

                  },

                },
                {
                  $sort: {
                    score: 1,
                    length: 1,
                    total: - 1
                  }
                },
                {
                  $skip: skip
                },
                {
                  $limit: limit
                },

              ]
          },

        },
        {
          $project: {
            user:
            {
              $cond: {
                if: {
                  $eq: [{
                    $arrayElemAt: ["$user.dodol", 0]
                  }, "kosong"]
                },
                then: "$saassaas",
                else: "$user"
              }
            },
            dodol: "$tags.dodol",
            tags:
            {
              $cond: {
                if: {
                  $gt: [{ $size: "$tags.dodol" }, 0]
                },
                then: "$tags",
                else: "$tagsssdsd"
              }
            },
          }
        });
    }
    else if (pict === false && vid === false && diary === true && user === false && tag === true) {
      pipeline.push(

        {
          $facet:
          {
            "diary": 
            [
                {
                    $lookup: {
                        from: "newPosts",
                        pipeline: [
                            {
                                $match: 
                                {
                                    $and: [
                                        {
                                            $text: {
                                                $search: key,
                                                
                                            }
                                        },
                                        {
                                            "reportedStatus": {
                                                $ne: "OWNED"
                                            }
                                        },
                                        {
                                            "visibility": "PUBLIC"
                                        },
                                        {
                                            "active": true
                                        },
                                        {
                                            "postType": "diary"
                                        },
                                        {
                                            "reportedUser.email": {
                                                $not: {
                                                    $regex: email
                                                }
                                            }
                                        },
                                        
                                    ]
                                },
                                
                            },
                            {
                                $set: {
                                    scorePict: {
                                        $meta: "textScore"
                                    }
                                }
                            },
                            {
                                $project: {
                                    mediaSource:1,
                                    "boosted": 
                                    {
                                        $cond: {
                                            if : {
                                                $gt: [{
                                                    "$dateToString": {
                                                        "format": "%Y-%m-%d %H:%M:%S",
                                                        "date": {
                                                            $add: [new Date(), 25200000]
                                                        }
                                                    }
                                                }, "$boosted.boostSession.timeEnd"]
                                            },
                                            then: [],
                                            else : '$boosted'
                                        }
                                    },
                                    "reportedStatus": 1,
                                    "insight": {
                                        "shares": "$shares",
                                        "comments": "$comments",
                                        "views": "$views",
                                        "likes": "$likes",
                                        
                                    },
                                     "views": "$views",
                                    "comments": "$comments",
                                    "likes": "$likes",
                                    "scorePict": 1,
                                    "_id": 1,
                                    "postID": 1,
                                    "createdAt": 1,
                                    "updatedAt": 1,
                                    "email": 1,
                                    "postType": 1,
                                    "description": 1,
                                    "active": 1,
                                    "metadata": 1,
                                    "location": 1,
                                    "isOwned": 1,
                                    "visibility": 1,
                                    "isViewed": 1,
                                    "allowComments": 1,
                                    "saleAmount": 1,
                                    
                                }
                            },
                            {
                                  $sort: {
                                      scorePict: - 1,
                                      comments: - 1,
                                      likes: - 1,
                                      views:  -1
                                  }
                              },
                              {
                                  $skip:skip
                              },
                              {
                                  $limit: limit
                              },
                        ],
                        as: "pict"
                    },
                    
                },
              
                {
                    $unwind: {
                        path: "$pict",
                        preserveNullAndEmptyArrays: true
                    }
                },
                
                {
                    $project: {
                        "scorePict": "$pict.scorePict",
                        "boosted": "$pict.boosted",
                        "reportedStatus": "$pict.reportedStatus",
                        "_id": "$pict._id",
                        "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                        {
                            "$concat": ["/thumb/", "$pict.postID"]
                        },
                        mediaEndpoint:{
                         "$cond":
                         {
                             if:
                             {
                                 "$eq":
                                     [
                                       "$pict.postType", "pict"
                                     ]
                             },
                             then:
                             {
                                 "$concat":
                                     [
                                         "/pict/",
                                         "$pict.postID"
                                     ]
                             },
                             else:
                             {
                                 "$concat":
                                     [
                                         "/stream/",
                                         "$pict.postID"
                                     ]
                             }
                         }
                     },
                        "mediaType": {
                            $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                        },
                        "createdAt": "$pict.createdAt",
                        "updatedAt": "$pict.updatedAt",
                        "postID": "$pict.postID",
                        "email": "$pict.email",
                        "postType": "$pict.postType",
                        "description": "$pict.description",
                        "active": "$pict.active",
                        "metadata": "$pict.metadata",
                        "location": "$pict.location",
                        "isOwned": "$pict.isOwned",
                        "visibility": "$pict.visibility",
                        "isViewed": "$pict.isViewed",
                        "allowComments": "$pict.allowComments",
                        "saleAmount": "$pict.saleAmount",
                        "monetize": 
                        {
                            $cond: {
                                if : {
                                    $gte: ["$pict.saleAmount", 1]
                                },
                                then: true,
                                else : "$taslimKONAG"
                            }
                        },
                        "comments": "$pict.comments",
                        "likes": "$pict.likes",
                        "insight": 
                        {
                            $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                        },
                        "apsaraId": {
                            $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                        },
                        "isApsara": {
                            $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                        },
                        "viewed": "$pict.insight.views",
                    }
                },
                {
                    $sort: {
                        scorePict: - 1,
                        comments: - 1,
                        likes: - 1,
                        viewed:  -1
                    }
                },
                
            ],

            "tags":
              [
                {
                  $lookup: {
                    from: "tag_count",
                    pipeline: [
                      {
                        $match:
                        {
                          "_id": {
                            $regex: key, $options: 'i'
                          }
                        }
                      },
                      {
                        $set: {
                          score: {
                            $indexOfCP: ["$_id", "de"]
                          }
                        }
                      },
                      {
                        $set: {
                          length: {
                            $strLenCP: "$_id"
                          }
                        }
                      },
                      {
                        $set: {
                          dodol: "kancut"
                        }
                      },
                      {
                        $project: {
                          name: "$_id",
                          total: 1,
                          score: 1,
                          length: 1,
                          dodol: {
                            $ifNull: ["$_id", "kosong"]
                          },

                        }
                      },

                    ],
                    as: "tag"
                  },

                },
                {
                  $unwind: {
                    path: "$tag",
                    preserveNullAndEmptyArrays: true
                  }
                },
                {
                  $project: {
                    tag: "$tag.name",
                    total: "$tag.total",
                    score: "$tag.score",
                    length: "$tag.length",
                    dodol: "$tag.dodol",

                  },

                },
                {
                  $sort: {
                    score: 1,
                    length: 1,
                    total: - 1
                  }
                },
                {
                  $skip: skip
                },
                {
                  $limit: limit
                },

              ]
          },

        },
        {
          $project: {

            diary: "$diary",
            dodol: "$tags.dodol",
            tags:
            {
              $cond: {
                if: {
                  $gt: [{ $size: "$tags.dodol" }, 0]
                },
                then: "$tags",
                else: "$tagsssdsd"
              }
            },

          }
        });
    }
    else if (pict === false && vid === true && diary === false && user === false && tag === true) {
      pipeline.push(

        {
          $facet:
          {
            "vid": 
            [
                {
                    $lookup: {
                        from: "newPosts",
                        pipeline: [
                            {
                                $match: 
                                {
                                    $and: [
                                        {
                                            $text: {
                                                $search: key,
                                                
                                            }
                                        },
                                        {
                                            "reportedStatus": {
                                                $ne: "OWNED"
                                            }
                                        },
                                        {
                                            "visibility": "PUBLIC"
                                        },
                                        {
                                            "active": true
                                        },
                                        {
                                            "postType": "vid"
                                        },
                                        {
                                            "reportedUser.email": {
                                                $not: {
                                                    $regex: email
                                                }
                                            }
                                        },
                                        
                                    ]
                                },
                                
                            },
                            {
                                $set: {
                                    scorePict: {
                                        $meta: "textScore"
                                    }
                                }
                            },
                            {
                                $project: {
                                    mediaSource:1,
                                    "boosted": 
                                    {
                                        $cond: {
                                            if : {
                                                $gt: [{
                                                    "$dateToString": {
                                                        "format": "%Y-%m-%d %H:%M:%S",
                                                        "date": {
                                                            $add: [new Date(), 25200000]
                                                        }
                                                    }
                                                }, "$boosted.boostSession.timeEnd"]
                                            },
                                            then: [],
                                            else : '$boosted'
                                        }
                                    },
                                    "reportedStatus": 1,
                                    "insight": {
                                        "shares": "$shares",
                                        "comments": "$comments",
                                        "views": "$views",
                                        "likes": "$likes",
                                        
                                    },
                                     "views": "$views",
                                    "comments": "$comments",
                                    "likes": "$likes",
                                    "scorePict": 1,
                                    "_id": 1,
                                    "postID": 1,
                                    "createdAt": 1,
                                    "updatedAt": 1,
                                    "email": 1,
                                    "postType": 1,
                                    "description": 1,
                                    "active": 1,
                                    "metadata": 1,
                                    "location": 1,
                                    "isOwned": 1,
                                    "visibility": 1,
                                    "isViewed": 1,
                                    "allowComments": 1,
                                    "saleAmount": 1,
                                    
                                }
                            },
                            {
                                  $sort: {
                                      scorePict: - 1,
                                      comments: - 1,
                                      likes: - 1,
                                      views:  -1
                                  }
                              },
                              {
                                  $skip: skip
                              },
                              {
                                  $limit: limit
                              },
                        ],
                        as: "pict"
                    },
                    
                },
              
                {
                    $unwind: {
                        path: "$pict",
                        preserveNullAndEmptyArrays: true
                    }
                },
                
                {
                    $project: {
                        "scorePict": "$pict.scorePict",
                        "boosted": "$pict.boosted",
                        "reportedStatus": "$pict.reportedStatus",
                        "_id": "$pict._id",
                        "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                        {
                            "$concat": ["/thumb/", "$pict.postID"]
                        },
                        mediaEndpoint:{
                         "$cond":
                         {
                             if:
                             {
                                 "$eq":
                                     [
                                       "$pict.postType", "pict"
                                     ]
                             },
                             then:
                             {
                                 "$concat":
                                     [
                                         "/pict/",
                                         "$pict.postID"
                                     ]
                             },
                             else:
                             {
                                 "$concat":
                                     [
                                         "/stream/",
                                         "$pict.postID"
                                     ]
                             }
                         }
                     },
                        "mediaType": {
                            $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                        },
                        "createdAt": "$pict.createdAt",
                        "updatedAt": "$pict.updatedAt",
                        "postID": "$pict.postID",
                        "email": "$pict.email",
                        "postType": "$pict.postType",
                        "description": "$pict.description",
                        "active": "$pict.active",
                        "metadata": "$pict.metadata",
                        "location": "$pict.location",
                        "isOwned": "$pict.isOwned",
                        "visibility": "$pict.visibility",
                        "isViewed": "$pict.isViewed",
                        "allowComments": "$pict.allowComments",
                        "saleAmount": "$pict.saleAmount",
                        "monetize": 
                        {
                            $cond: {
                                if : {
                                    $gte: ["$pict.saleAmount", 1]
                                },
                                then: true,
                                else : "$taslimKONAG"
                            }
                        },
                        "comments": "$pict.comments",
                        "likes": "$pict.likes",
                        "insight": 
                        {
                            $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                        },
                        "apsaraId": {
                            $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                        },
                        "isApsara": {
                            $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                        },
                        "viewed": "$pict.insight.views",
                    }
                },
                {
                    $sort: {
                        scorePict: - 1,
                        comments: - 1,
                        likes: - 1,
                        viewed:  -1
                    }
                },
                
            ],

            "tags":
              [
                {
                  $lookup: {
                    from: "tag_count",
                    pipeline: [
                      {
                        $match:
                        {
                          "_id": {
                            $regex: key, $options: 'i'
                          }
                        }
                      },
                      {
                        $set: {
                          score: {
                            $indexOfCP: ["$_id", "de"]
                          }
                        }
                      },
                      {
                        $set: {
                          length: {
                            $strLenCP: "$_id"
                          }
                        }
                      },
                      {
                        $set: {
                          dodol: "kancut"
                        }
                      },
                      {
                        $project: {
                          name: "$_id",
                          total: 1,
                          score: 1,
                          length: 1,
                          dodol: {
                            $ifNull: ["$_id", "kosong"]
                          },

                        }
                      },

                    ],
                    as: "tag"
                  },

                },
                {
                  $unwind: {
                    path: "$tag",
                    preserveNullAndEmptyArrays: true
                  }
                },
                {
                  $project: {
                    tag: "$tag.name",
                    total: "$tag.total",
                    score: "$tag.score",
                    length: "$tag.length",
                    dodol: "$tag.dodol",

                  },

                },
                {
                  $sort: {
                    score: 1,
                    length: 1,
                    total: - 1
                  }
                },
                {
                  $skip: skip
                },
                {
                  $limit: limit
                },

              ]
          },

        },
        {
          $project: {

            vid: "$vid",
            dodol: "$tags.dodol",
            tags:
            {
              $cond: {
                if: {
                  $gt: [{ $size: "$tags.dodol" }, 0]
                },
                then: "$tags",
                else: "$tagsssdsd"
              }
            },

          }
        });
    }
    //sampai sini 2
    else if (pict === true && vid === false && diary === false && user === false && tag === true) {
      pipeline.push(

        {
          $facet:
          {
            //pict
            "pict": 
            [
                {
                    $lookup: {
                        from: "newPosts",
                        pipeline: [
                            {
                                $match: 
                                {
                                    $and: [
                                        {
                                            $text: {
                                                $search: key,
                                                
                                            }
                                        },
                                        {
                                            "reportedStatus": {
                                                $ne: "OWNED"
                                            }
                                        },
                                        {
                                            "visibility": "PUBLIC"
                                        },
                                        {
                                            "active": true
                                        },
                                        {
                                            "postType": "pict"
                                        },
                                        {
                                            "reportedUser.email": {
                                                $not: {
                                                    $regex: email
                                                }
                                            }
                                        },
                                        
                                    ]
                                },
                                
                            },
                            {
                                $set: {
                                    scorePict: {
                                        $meta: "textScore"
                                    }
                                }
                            },
                            {
                                $project: {
                                    mediaSource:1,
                                    "boosted": 
                                    {
                                        $cond: {
                                            if : {
                                                $gt: [{
                                                    "$dateToString": {
                                                        "format": "%Y-%m-%d %H:%M:%S",
                                                        "date": {
                                                            $add: [new Date(), 25200000]
                                                        }
                                                    }
                                                }, "$boosted.boostSession.timeEnd"]
                                            },
                                            then: [],
                                            else : '$boosted'
                                        }
                                    },
                                    "reportedStatus": 1,
                                    "insight": {
                                        "shares": "$shares",
                                        "comments": "$comments",
                                        "views": "$views",
                                        "likes": "$likes",
                                        
                                    },
                                     "views": "$views",
                                    "comments": "$comments",
                                    "likes": "$likes",
                                    "scorePict": 1,
                                    "_id": 1,
                                    "postID": 1,
                                    "createdAt": 1,
                                    "updatedAt": 1,
                                    "email": 1,
                                    "postType": 1,
                                    "description": 1,
                                    "active": 1,
                                    "metadata": 1,
                                    "location": 1,
                                    "isOwned": 1,
                                    "visibility": 1,
                                    "isViewed": 1,
                                    "allowComments": 1,
                                    "saleAmount": 1,
                                    
                                }
                            },
                            {
                                  $sort: {
                                      scorePict: - 1,
                                      comments: - 1,
                                      likes: - 1,
                                      views:  -1
                                  }
                              },
                              {
                               $skip: skip
                             },
                             {
                               $limit: limit
                             },
                        ],
                        as: "pict"
                    },
                    
                },
              
                {
                    $unwind: {
                        path: "$pict",
                        preserveNullAndEmptyArrays: true
                    }
                },
                
                {
                    $project: {
                        "scorePict": "$pict.scorePict",
                        "boosted": "$pict.boosted",
                        "reportedStatus": "$pict.reportedStatus",
                        "_id": "$pict._id",
                        "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                        {
                            "$concat": ["/thumb/", "$pict.postID"]
                        },
                        mediaEndpoint:{
                         "$cond":
                         {
                             if:
                             {
                                 "$eq":
                                     [
                                       "$pict.postType", "pict"
                                     ]
                             },
                             then:
                             {
                                 "$concat":
                                     [
                                         "/pict/",
                                         "$pict.postID"
                                     ]
                             },
                             else:
                             {
                                 "$concat":
                                     [
                                         "/stream/",
                                         "$pict.postID"
                                     ]
                             }
                         }
                     },
                        "mediaType": {
                            $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                        },
                        "createdAt": "$pict.createdAt",
                        "updatedAt": "$pict.updatedAt",
                        "postID": "$pict.postID",
                        "email": "$pict.email",
                        "postType": "$pict.postType",
                        "description": "$pict.description",
                        "active": "$pict.active",
                        "metadata": "$pict.metadata",
                        "location": "$pict.location",
                        "isOwned": "$pict.isOwned",
                        "visibility": "$pict.visibility",
                        "isViewed": "$pict.isViewed",
                        "allowComments": "$pict.allowComments",
                        "saleAmount": "$pict.saleAmount",
                        "monetize": 
                        {
                            $cond: {
                                if : {
                                    $gte: ["$pict.saleAmount", 1]
                                },
                                then: true,
                                else : "$taslimKONAG"
                            }
                        },
                        "comments": "$pict.comments",
                        "likes": "$pict.likes",
                        "insight": 
                        {
                            $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                        },
                        "apsaraId": {
                            $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                        },
                        "isApsara": {
                            $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                        },
                        "viewed": "$pict.insight.views",
                    }
                },
                {
                    $sort: {
                        scorePict: - 1,
                        comments: - 1,
                        likes: - 1,
                        viewed:  -1
                    }
                },
                
            ],
            "tags":
              [
                {
                  $lookup: {
                    from: "tag_count",
                    pipeline: [
                      {
                        $match:
                        {
                          "_id": {
                            $regex: key, $options: 'i'
                          }
                        }
                      },
                      {
                        $set: {
                          score: {
                            $indexOfCP: ["$_id", "de"]
                          }
                        }
                      },
                      {
                        $set: {
                          length: {
                            $strLenCP: "$_id"
                          }
                        }
                      },
                      {
                        $set: {
                          dodol: "kancut"
                        }
                      },
                      {
                        $project: {
                          name: "$_id",
                          total: 1,
                          score: 1,
                          length: 1,
                          dodol: {
                            $ifNull: ["$_id", "kosong"]
                          },

                        }
                      },

                    ],
                    as: "tag"
                  },

                },
                {
                  $unwind: {
                    path: "$tag",
                    preserveNullAndEmptyArrays: true
                  }
                },
                {
                  $project: {
                    tag: "$tag.name",
                    total: "$tag.total",
                    score: "$tag.score",
                    length: "$tag.length",
                    dodol: "$tag.dodol",

                  },

                },
                {
                  $sort: {
                    score: 1,
                    length: 1,
                    total: - 1
                  }
                },
                {
                  $skip: skip
                },
                {
                  $limit: limit
                },

              ]
          },

        },
        {
          $project: {

            pict: "$pict",
            dodol: "$tags.dodol",
            tags:
            {
              $cond: {
                if: {
                  $gt: [{ $size: "$tags.dodol" }, 0]
                },
                then: "$tags",
                else: "$tagsssdsd"
              }
            },

          }
        });
    }
    else if (pict === true && vid === true && diary === false && user === false && tag === true) {
      pipeline.push(

        {
          $facet:
          {
            //pict
            "pict": 
            [
                {
                    $lookup: {
                        from: "newPosts",
                        pipeline: [
                            {
                                $match: 
                                {
                                    $and: [
                                        {
                                            $text: {
                                                $search: key,
                                                
                                            }
                                        },
                                        {
                                            "reportedStatus": {
                                                $ne: "OWNED"
                                            }
                                        },
                                        {
                                            "visibility": "PUBLIC"
                                        },
                                        {
                                            "active": true
                                        },
                                        {
                                            "postType": "pict"
                                        },
                                        {
                                            "reportedUser.email": {
                                                $not: {
                                                    $regex: email
                                                }
                                            }
                                        },
                                        
                                    ]
                                },
                                
                            },
                            {
                                $set: {
                                    scorePict: {
                                        $meta: "textScore"
                                    }
                                }
                            },
                            {
                                $project: {
                                    mediaSource:1,
                                    "boosted": 
                                    {
                                        $cond: {
                                            if : {
                                                $gt: [{
                                                    "$dateToString": {
                                                        "format": "%Y-%m-%d %H:%M:%S",
                                                        "date": {
                                                            $add: [new Date(), 25200000]
                                                        }
                                                    }
                                                }, "$boosted.boostSession.timeEnd"]
                                            },
                                            then: [],
                                            else : '$boosted'
                                        }
                                    },
                                    "reportedStatus": 1,
                                    "insight": {
                                        "shares": "$shares",
                                        "comments": "$comments",
                                        "views": "$views",
                                        "likes": "$likes",
                                        
                                    },
                                     "views": "$views",
                                    "comments": "$comments",
                                    "likes": "$likes",
                                    "scorePict": 1,
                                    "_id": 1,
                                    "postID": 1,
                                    "createdAt": 1,
                                    "updatedAt": 1,
                                    "email": 1,
                                    "postType": 1,
                                    "description": 1,
                                    "active": 1,
                                    "metadata": 1,
                                    "location": 1,
                                    "isOwned": 1,
                                    "visibility": 1,
                                    "isViewed": 1,
                                    "allowComments": 1,
                                    "saleAmount": 1,
                                    
                                }
                            },
                            {
                                  $sort: {
                                      scorePict: - 1,
                                      comments: - 1,
                                      likes: - 1,
                                      views:  -1
                                  }
                              },
                              {
                               $skip: skip
                             },
                             {
                               $limit: limit
                             },
                        ],
                        as: "pict"
                    },
                    
                },
              
                {
                    $unwind: {
                        path: "$pict",
                        preserveNullAndEmptyArrays: true
                    }
                },
                
                {
                    $project: {
                        "scorePict": "$pict.scorePict",
                        "boosted": "$pict.boosted",
                        "reportedStatus": "$pict.reportedStatus",
                        "_id": "$pict._id",
                        "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                        {
                            "$concat": ["/thumb/", "$pict.postID"]
                        },
                        mediaEndpoint:{
                         "$cond":
                         {
                             if:
                             {
                                 "$eq":
                                     [
                                       "$pict.postType", "pict"
                                     ]
                             },
                             then:
                             {
                                 "$concat":
                                     [
                                         "/pict/",
                                         "$pict.postID"
                                     ]
                             },
                             else:
                             {
                                 "$concat":
                                     [
                                         "/stream/",
                                         "$pict.postID"
                                     ]
                             }
                         }
                     },
                        "mediaType": {
                            $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                        },
                        "createdAt": "$pict.createdAt",
                        "updatedAt": "$pict.updatedAt",
                        "postID": "$pict.postID",
                        "email": "$pict.email",
                        "postType": "$pict.postType",
                        "description": "$pict.description",
                        "active": "$pict.active",
                        "metadata": "$pict.metadata",
                        "location": "$pict.location",
                        "isOwned": "$pict.isOwned",
                        "visibility": "$pict.visibility",
                        "isViewed": "$pict.isViewed",
                        "allowComments": "$pict.allowComments",
                        "saleAmount": "$pict.saleAmount",
                        "monetize": 
                        {
                            $cond: {
                                if : {
                                    $gte: ["$pict.saleAmount", 1]
                                },
                                then: true,
                                else : "$taslimKONAG"
                            }
                        },
                        "comments": "$pict.comments",
                        "likes": "$pict.likes",
                        "insight": 
                        {
                            $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                        },
                        "apsaraId": {
                            $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                        },
                        "isApsara": {
                            $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                        },
                        "viewed": "$pict.insight.views",
                    }
                },
                {
                    $sort: {
                        scorePict: - 1,
                        comments: - 1,
                        likes: - 1,
                        viewed:  -1
                    }
                },
                
            ],
            "vid": 
            [
                {
                    $lookup: {
                        from: "newPosts",
                        pipeline: [
                            {
                                $match: 
                                {
                                    $and: [
                                        {
                                            $text: {
                                                $search: key,
                                                
                                            }
                                        },
                                        {
                                            "reportedStatus": {
                                                $ne: "OWNED"
                                            }
                                        },
                                        {
                                            "visibility": "PUBLIC"
                                        },
                                        {
                                            "active": true
                                        },
                                        {
                                            "postType": "vid"
                                        },
                                        {
                                            "reportedUser.email": {
                                                $not: {
                                                    $regex: email
                                                }
                                            }
                                        },
                                        
                                    ]
                                },
                                
                            },
                            {
                                $set: {
                                    scorePict: {
                                        $meta: "textScore"
                                    }
                                }
                            },
                            {
                                $project: {
                                    mediaSource:1,
                                    "boosted": 
                                    {
                                        $cond: {
                                            if : {
                                                $gt: [{
                                                    "$dateToString": {
                                                        "format": "%Y-%m-%d %H:%M:%S",
                                                        "date": {
                                                            $add: [new Date(), 25200000]
                                                        }
                                                    }
                                                }, "$boosted.boostSession.timeEnd"]
                                            },
                                            then: [],
                                            else : '$boosted'
                                        }
                                    },
                                    "reportedStatus": 1,
                                    "insight": {
                                        "shares": "$shares",
                                        "comments": "$comments",
                                        "views": "$views",
                                        "likes": "$likes",
                                        
                                    },
                                     "views": "$views",
                                    "comments": "$comments",
                                    "likes": "$likes",
                                    "scorePict": 1,
                                    "_id": 1,
                                    "postID": 1,
                                    "createdAt": 1,
                                    "updatedAt": 1,
                                    "email": 1,
                                    "postType": 1,
                                    "description": 1,
                                    "active": 1,
                                    "metadata": 1,
                                    "location": 1,
                                    "isOwned": 1,
                                    "visibility": 1,
                                    "isViewed": 1,
                                    "allowComments": 1,
                                    "saleAmount": 1,
                                    
                                }
                            },
                            {
                                  $sort: {
                                      scorePict: - 1,
                                      comments: - 1,
                                      likes: - 1,
                                      views:  -1
                                  }
                              },
                              {
                                  $skip: skip
                              },
                              {
                                  $limit: limit
                              },
                        ],
                        as: "pict"
                    },
                    
                },
              
                {
                    $unwind: {
                        path: "$pict",
                        preserveNullAndEmptyArrays: true
                    }
                },
                
                {
                    $project: {
                        "scorePict": "$pict.scorePict",
                        "boosted": "$pict.boosted",
                        "reportedStatus": "$pict.reportedStatus",
                        "_id": "$pict._id",
                        "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                        {
                            "$concat": ["/thumb/", "$pict.postID"]
                        },
                        mediaEndpoint:{
                         "$cond":
                         {
                             if:
                             {
                                 "$eq":
                                     [
                                       "$pict.postType", "pict"
                                     ]
                             },
                             then:
                             {
                                 "$concat":
                                     [
                                         "/pict/",
                                         "$pict.postID"
                                     ]
                             },
                             else:
                             {
                                 "$concat":
                                     [
                                         "/stream/",
                                         "$pict.postID"
                                     ]
                             }
                         }
                     },
                        "mediaType": {
                            $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                        },
                        "createdAt": "$pict.createdAt",
                        "updatedAt": "$pict.updatedAt",
                        "postID": "$pict.postID",
                        "email": "$pict.email",
                        "postType": "$pict.postType",
                        "description": "$pict.description",
                        "active": "$pict.active",
                        "metadata": "$pict.metadata",
                        "location": "$pict.location",
                        "isOwned": "$pict.isOwned",
                        "visibility": "$pict.visibility",
                        "isViewed": "$pict.isViewed",
                        "allowComments": "$pict.allowComments",
                        "saleAmount": "$pict.saleAmount",
                        "monetize": 
                        {
                            $cond: {
                                if : {
                                    $gte: ["$pict.saleAmount", 1]
                                },
                                then: true,
                                else : "$taslimKONAG"
                            }
                        },
                        "comments": "$pict.comments",
                        "likes": "$pict.likes",
                        "insight": 
                        {
                            $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                        },
                        "apsaraId": {
                            $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                        },
                        "isApsara": {
                            $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                        },
                        "viewed": "$pict.insight.views",
                    }
                },
                {
                    $sort: {
                        scorePict: - 1,
                        comments: - 1,
                        likes: - 1,
                        viewed:  -1
                    }
                },
                
            ],
            "tags":
              [
                {
                  $lookup: {
                    from: "tag_count",
                    pipeline: [
                      {
                        $match:
                        {
                          "_id": {
                            $regex: key, $options: 'i'
                          }
                        }
                      },
                      {
                        $set: {
                          score: {
                            $indexOfCP: ["$_id", "de"]
                          }
                        }
                      },
                      {
                        $set: {
                          length: {
                            $strLenCP: "$_id"
                          }
                        }
                      },
                      {
                        $set: {
                          dodol: "kancut"
                        }
                      },
                      {
                        $project: {
                          name: "$_id",
                          total: 1,
                          score: 1,
                          length: 1,
                          dodol: {
                            $ifNull: ["$_id", "kosong"]
                          },

                        }
                      },

                    ],
                    as: "tag"
                  },

                },
                {
                  $unwind: {
                    path: "$tag",
                    preserveNullAndEmptyArrays: true
                  }
                },
                {
                  $project: {
                    tag: "$tag.name",
                    total: "$tag.total",
                    score: "$tag.score",
                    length: "$tag.length",
                    dodol: "$tag.dodol",

                  },

                },
                {
                  $sort: {
                    score: 1,
                    length: 1,
                    total: - 1
                  }
                },
                {
                  $skip: skip
                },
                {
                  $limit: limit
                },

              ]
          },

        },
        {
          $project: {

            pict: "$pict",
            vid: "$vid",
            dodol: "$tags.dodol",
            tags:
            {
              $cond: {
                if: {
                  $gt: [{ $size: "$tags.dodol" }, 0]
                },
                then: "$tags",
                else: "$tagsssdsd"
              }
            },

          }
        });
    }
    else if (pict === true && vid === true && diary === true && user === false && tag === true) {
      pipeline.push(

        {
          $facet:
          {
            //pict
            "pict": 
            [
                {
                    $lookup: {
                        from: "newPosts",
                        pipeline: [
                            {
                                $match: 
                                {
                                    $and: [
                                        {
                                            $text: {
                                                $search: key,
                                                
                                            }
                                        },
                                        {
                                            "reportedStatus": {
                                                $ne: "OWNED"
                                            }
                                        },
                                        {
                                            "visibility": "PUBLIC"
                                        },
                                        {
                                            "active": true
                                        },
                                        {
                                            "postType": "pict"
                                        },
                                        {
                                            "reportedUser.email": {
                                                $not: {
                                                    $regex: email
                                                }
                                            }
                                        },
                                        
                                    ]
                                },
                                
                            },
                            {
                                $set: {
                                    scorePict: {
                                        $meta: "textScore"
                                    }
                                }
                            },
                            {
                                $project: {
                                    mediaSource:1,
                                    "boosted": 
                                    {
                                        $cond: {
                                            if : {
                                                $gt: [{
                                                    "$dateToString": {
                                                        "format": "%Y-%m-%d %H:%M:%S",
                                                        "date": {
                                                            $add: [new Date(), 25200000]
                                                        }
                                                    }
                                                }, "$boosted.boostSession.timeEnd"]
                                            },
                                            then: [],
                                            else : '$boosted'
                                        }
                                    },
                                    "reportedStatus": 1,
                                    "insight": {
                                        "shares": "$shares",
                                        "comments": "$comments",
                                        "views": "$views",
                                        "likes": "$likes",
                                        
                                    },
                                     "views": "$views",
                                    "comments": "$comments",
                                    "likes": "$likes",
                                    "scorePict": 1,
                                    "_id": 1,
                                    "postID": 1,
                                    "createdAt": 1,
                                    "updatedAt": 1,
                                    "email": 1,
                                    "postType": 1,
                                    "description": 1,
                                    "active": 1,
                                    "metadata": 1,
                                    "location": 1,
                                    "isOwned": 1,
                                    "visibility": 1,
                                    "isViewed": 1,
                                    "allowComments": 1,
                                    "saleAmount": 1,
                                    
                                }
                            },
                            {
                                  $sort: {
                                      scorePict: - 1,
                                      comments: - 1,
                                      likes: - 1,
                                      views:  -1
                                  }
                              },
                              {
                               $skip: skip
                             },
                             {
                               $limit: limit
                             },
                        ],
                        as: "pict"
                    },
                    
                },
              
                {
                    $unwind: {
                        path: "$pict",
                        preserveNullAndEmptyArrays: true
                    }
                },
                
                {
                    $project: {
                        "scorePict": "$pict.scorePict",
                        "boosted": "$pict.boosted",
                        "reportedStatus": "$pict.reportedStatus",
                        "_id": "$pict._id",
                        "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                        {
                            "$concat": ["/thumb/", "$pict.postID"]
                        },
                        mediaEndpoint:{
                         "$cond":
                         {
                             if:
                             {
                                 "$eq":
                                     [
                                       "$pict.postType", "pict"
                                     ]
                             },
                             then:
                             {
                                 "$concat":
                                     [
                                         "/pict/",
                                         "$pict.postID"
                                     ]
                             },
                             else:
                             {
                                 "$concat":
                                     [
                                         "/stream/",
                                         "$pict.postID"
                                     ]
                             }
                         }
                     },
                        "mediaType": {
                            $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                        },
                        "createdAt": "$pict.createdAt",
                        "updatedAt": "$pict.updatedAt",
                        "postID": "$pict.postID",
                        "email": "$pict.email",
                        "postType": "$pict.postType",
                        "description": "$pict.description",
                        "active": "$pict.active",
                        "metadata": "$pict.metadata",
                        "location": "$pict.location",
                        "isOwned": "$pict.isOwned",
                        "visibility": "$pict.visibility",
                        "isViewed": "$pict.isViewed",
                        "allowComments": "$pict.allowComments",
                        "saleAmount": "$pict.saleAmount",
                        "monetize": 
                        {
                            $cond: {
                                if : {
                                    $gte: ["$pict.saleAmount", 1]
                                },
                                then: true,
                                else : "$taslimKONAG"
                            }
                        },
                        "comments": "$pict.comments",
                        "likes": "$pict.likes",
                        "insight": 
                        {
                            $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                        },
                        "apsaraId": {
                            $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                        },
                        "isApsara": {
                            $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                        },
                        "viewed": "$pict.insight.views",
                    }
                },
                {
                    $sort: {
                        scorePict: - 1,
                        comments: - 1,
                        likes: - 1,
                        viewed:  -1
                    }
                },
                
            ],
            "vid": 
            [
                {
                    $lookup: {
                        from: "newPosts",
                        pipeline: [
                            {
                                $match: 
                                {
                                    $and: [
                                        {
                                            $text: {
                                                $search: key,
                                                
                                            }
                                        },
                                        {
                                            "reportedStatus": {
                                                $ne: "OWNED"
                                            }
                                        },
                                        {
                                            "visibility": "PUBLIC"
                                        },
                                        {
                                            "active": true
                                        },
                                        {
                                            "postType": "vid"
                                        },
                                        {
                                            "reportedUser.email": {
                                                $not: {
                                                    $regex: email
                                                }
                                            }
                                        },
                                        
                                    ]
                                },
                                
                            },
                            {
                                $set: {
                                    scorePict: {
                                        $meta: "textScore"
                                    }
                                }
                            },
                            {
                                $project: {
                                    mediaSource:1,
                                    "boosted": 
                                    {
                                        $cond: {
                                            if : {
                                                $gt: [{
                                                    "$dateToString": {
                                                        "format": "%Y-%m-%d %H:%M:%S",
                                                        "date": {
                                                            $add: [new Date(), 25200000]
                                                        }
                                                    }
                                                }, "$boosted.boostSession.timeEnd"]
                                            },
                                            then: [],
                                            else : '$boosted'
                                        }
                                    },
                                    "reportedStatus": 1,
                                    "insight": {
                                        "shares": "$shares",
                                        "comments": "$comments",
                                        "views": "$views",
                                        "likes": "$likes",
                                        
                                    },
                                     "views": "$views",
                                    "comments": "$comments",
                                    "likes": "$likes",
                                    "scorePict": 1,
                                    "_id": 1,
                                    "postID": 1,
                                    "createdAt": 1,
                                    "updatedAt": 1,
                                    "email": 1,
                                    "postType": 1,
                                    "description": 1,
                                    "active": 1,
                                    "metadata": 1,
                                    "location": 1,
                                    "isOwned": 1,
                                    "visibility": 1,
                                    "isViewed": 1,
                                    "allowComments": 1,
                                    "saleAmount": 1,
                                    
                                }
                            },
                            {
                                  $sort: {
                                      scorePict: - 1,
                                      comments: - 1,
                                      likes: - 1,
                                      views:  -1
                                  }
                              },
                              {
                                  $skip: skip
                              },
                              {
                                  $limit: limit
                              },
                        ],
                        as: "pict"
                    },
                    
                },
              
                {
                    $unwind: {
                        path: "$pict",
                        preserveNullAndEmptyArrays: true
                    }
                },
                
                {
                    $project: {
                        "scorePict": "$pict.scorePict",
                        "boosted": "$pict.boosted",
                        "reportedStatus": "$pict.reportedStatus",
                        "_id": "$pict._id",
                        "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                        {
                            "$concat": ["/thumb/", "$pict.postID"]
                        },
                        mediaEndpoint:{
                         "$cond":
                         {
                             if:
                             {
                                 "$eq":
                                     [
                                       "$pict.postType", "pict"
                                     ]
                             },
                             then:
                             {
                                 "$concat":
                                     [
                                         "/pict/",
                                         "$pict.postID"
                                     ]
                             },
                             else:
                             {
                                 "$concat":
                                     [
                                         "/stream/",
                                         "$pict.postID"
                                     ]
                             }
                         }
                     },
                        "mediaType": {
                            $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                        },
                        "createdAt": "$pict.createdAt",
                        "updatedAt": "$pict.updatedAt",
                        "postID": "$pict.postID",
                        "email": "$pict.email",
                        "postType": "$pict.postType",
                        "description": "$pict.description",
                        "active": "$pict.active",
                        "metadata": "$pict.metadata",
                        "location": "$pict.location",
                        "isOwned": "$pict.isOwned",
                        "visibility": "$pict.visibility",
                        "isViewed": "$pict.isViewed",
                        "allowComments": "$pict.allowComments",
                        "saleAmount": "$pict.saleAmount",
                        "monetize": 
                        {
                            $cond: {
                                if : {
                                    $gte: ["$pict.saleAmount", 1]
                                },
                                then: true,
                                else : "$taslimKONAG"
                            }
                        },
                        "comments": "$pict.comments",
                        "likes": "$pict.likes",
                        "insight": 
                        {
                            $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                        },
                        "apsaraId": {
                            $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                        },
                        "isApsara": {
                            $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                        },
                        "viewed": "$pict.insight.views",
                    }
                },
                {
                    $sort: {
                        scorePict: - 1,
                        comments: - 1,
                        likes: - 1,
                        viewed:  -1
                    }
                },
                
            ],

            "diary": 
            [
                {
                    $lookup: {
                        from: "newPosts",
                        pipeline: [
                            {
                                $match: 
                                {
                                    $and: [
                                        {
                                            $text: {
                                                $search: key,
                                                
                                            }
                                        },
                                        {
                                            "reportedStatus": {
                                                $ne: "OWNED"
                                            }
                                        },
                                        {
                                            "visibility": "PUBLIC"
                                        },
                                        {
                                            "active": true
                                        },
                                        {
                                            "postType": "diary"
                                        },
                                        {
                                            "reportedUser.email": {
                                                $not: {
                                                    $regex: email
                                                }
                                            }
                                        },
                                        
                                    ]
                                },
                                
                            },
                            {
                                $set: {
                                    scorePict: {
                                        $meta: "textScore"
                                    }
                                }
                            },
                            {
                                $project: {
                                    mediaSource:1,
                                    "boosted": 
                                    {
                                        $cond: {
                                            if : {
                                                $gt: [{
                                                    "$dateToString": {
                                                        "format": "%Y-%m-%d %H:%M:%S",
                                                        "date": {
                                                            $add: [new Date(), 25200000]
                                                        }
                                                    }
                                                }, "$boosted.boostSession.timeEnd"]
                                            },
                                            then: [],
                                            else : '$boosted'
                                        }
                                    },
                                    "reportedStatus": 1,
                                    "insight": {
                                        "shares": "$shares",
                                        "comments": "$comments",
                                        "views": "$views",
                                        "likes": "$likes",
                                        
                                    },
                                     "views": "$views",
                                    "comments": "$comments",
                                    "likes": "$likes",
                                    "scorePict": 1,
                                    "_id": 1,
                                    "postID": 1,
                                    "createdAt": 1,
                                    "updatedAt": 1,
                                    "email": 1,
                                    "postType": 1,
                                    "description": 1,
                                    "active": 1,
                                    "metadata": 1,
                                    "location": 1,
                                    "isOwned": 1,
                                    "visibility": 1,
                                    "isViewed": 1,
                                    "allowComments": 1,
                                    "saleAmount": 1,
                                    
                                }
                            },
                            {
                                  $sort: {
                                      scorePict: - 1,
                                      comments: - 1,
                                      likes: - 1,
                                      views:  -1
                                  }
                              },
                              {
                                  $skip:skip
                              },
                              {
                                  $limit: limit
                              },
                        ],
                        as: "pict"
                    },
                    
                },
              
                {
                    $unwind: {
                        path: "$pict",
                        preserveNullAndEmptyArrays: true
                    }
                },
                
                {
                    $project: {
                        "scorePict": "$pict.scorePict",
                        "boosted": "$pict.boosted",
                        "reportedStatus": "$pict.reportedStatus",
                        "_id": "$pict._id",
                        "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                        {
                            "$concat": ["/thumb/", "$pict.postID"]
                        },
                        mediaEndpoint:{
                         "$cond":
                         {
                             if:
                             {
                                 "$eq":
                                     [
                                       "$pict.postType", "pict"
                                     ]
                             },
                             then:
                             {
                                 "$concat":
                                     [
                                         "/pict/",
                                         "$pict.postID"
                                     ]
                             },
                             else:
                             {
                                 "$concat":
                                     [
                                         "/stream/",
                                         "$pict.postID"
                                     ]
                             }
                         }
                     },
                        "mediaType": {
                            $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                        },
                        "createdAt": "$pict.createdAt",
                        "updatedAt": "$pict.updatedAt",
                        "postID": "$pict.postID",
                        "email": "$pict.email",
                        "postType": "$pict.postType",
                        "description": "$pict.description",
                        "active": "$pict.active",
                        "metadata": "$pict.metadata",
                        "location": "$pict.location",
                        "isOwned": "$pict.isOwned",
                        "visibility": "$pict.visibility",
                        "isViewed": "$pict.isViewed",
                        "allowComments": "$pict.allowComments",
                        "saleAmount": "$pict.saleAmount",
                        "monetize": 
                        {
                            $cond: {
                                if : {
                                    $gte: ["$pict.saleAmount", 1]
                                },
                                then: true,
                                else : "$taslimKONAG"
                            }
                        },
                        "comments": "$pict.comments",
                        "likes": "$pict.likes",
                        "insight": 
                        {
                            $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                        },
                        "apsaraId": {
                            $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                        },
                        "isApsara": {
                            $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                        },
                        "viewed": "$pict.insight.views",
                    }
                },
                {
                    $sort: {
                        scorePict: - 1,
                        comments: - 1,
                        likes: - 1,
                        viewed:  -1
                    }
                },
                
            ],
            "tags":
              [
                {
                  $lookup: {
                    from: "tag_count",
                    pipeline: [
                      {
                        $match:
                        {
                          "_id": {
                            $regex: key, $options: 'i'
                          }
                        }
                      },
                      {
                        $set: {
                          score: {
                            $indexOfCP: ["$_id", "de"]
                          }
                        }
                      },
                      {
                        $set: {
                          length: {
                            $strLenCP: "$_id"
                          }
                        }
                      },
                      {
                        $set: {
                          dodol: "kancut"
                        }
                      },
                      {
                        $project: {
                          name: "$_id",
                          total: 1,
                          score: 1,
                          length: 1,
                          dodol: {
                            $ifNull: ["$_id", "kosong"]
                          },

                        }
                      },

                    ],
                    as: "tag"
                  },

                },
                {
                  $unwind: {
                    path: "$tag",
                    preserveNullAndEmptyArrays: true
                  }
                },
                {
                  $project: {
                    tag: "$tag.name",
                    total: "$tag.total",
                    score: "$tag.score",
                    length: "$tag.length",
                    dodol: "$tag.dodol",

                  },

                },
                {
                  $sort: {
                    score: 1,
                    length: 1,
                    total: - 1
                  }
                },
                {
                  $skip: skip
                },
                {
                  $limit: limit
                },

              ]
          },

        },
        {
          $project: {
            pict: "$pict",
            vid: "$vid",
            diary: "$diary",
            dodol: "$tags.dodol",
            tags:
            {
              $cond: {
                if: {
                  $gt: [{ $size: "$tags.dodol" }, 0]
                },
                then: "$tags",
                else: "$tagsssdsd"
              }
            },

          }
        });
    }
    else if (pict === true && vid === false && diary === true && user === false && tag === true) {
      pipeline.push(

        {
          $facet:
          {
          //pict
          "pict": 
          [
              {
                  $lookup: {
                      from: "newPosts",
                      pipeline: [
                          {
                              $match: 
                              {
                                  $and: [
                                      {
                                          $text: {
                                              $search: key,
                                              
                                          }
                                      },
                                      {
                                          "reportedStatus": {
                                              $ne: "OWNED"
                                          }
                                      },
                                      {
                                          "visibility": "PUBLIC"
                                      },
                                      {
                                          "active": true
                                      },
                                      {
                                          "postType": "pict"
                                      },
                                      {
                                          "reportedUser.email": {
                                              $not: {
                                                  $regex: email
                                              }
                                          }
                                      },
                                      
                                  ]
                              },
                              
                          },
                          {
                              $set: {
                                  scorePict: {
                                      $meta: "textScore"
                                  }
                              }
                          },
                          {
                              $project: {
                                  mediaSource:1,
                                  "boosted": 
                                  {
                                      $cond: {
                                          if : {
                                              $gt: [{
                                                  "$dateToString": {
                                                      "format": "%Y-%m-%d %H:%M:%S",
                                                      "date": {
                                                          $add: [new Date(), 25200000]
                                                      }
                                                  }
                                              }, "$boosted.boostSession.timeEnd"]
                                          },
                                          then: [],
                                          else : '$boosted'
                                      }
                                  },
                                  "reportedStatus": 1,
                                  "insight": {
                                      "shares": "$shares",
                                      "comments": "$comments",
                                      "views": "$views",
                                      "likes": "$likes",
                                      
                                  },
                                   "views": "$views",
                                  "comments": "$comments",
                                  "likes": "$likes",
                                  "scorePict": 1,
                                  "_id": 1,
                                  "postID": 1,
                                  "createdAt": 1,
                                  "updatedAt": 1,
                                  "email": 1,
                                  "postType": 1,
                                  "description": 1,
                                  "active": 1,
                                  "metadata": 1,
                                  "location": 1,
                                  "isOwned": 1,
                                  "visibility": 1,
                                  "isViewed": 1,
                                  "allowComments": 1,
                                  "saleAmount": 1,
                                  
                              }
                          },
                          {
                                $sort: {
                                    scorePict: - 1,
                                    comments: - 1,
                                    likes: - 1,
                                    views:  -1
                                }
                            },
                            {
                             $skip: skip
                           },
                           {
                             $limit: limit
                           },
                      ],
                      as: "pict"
                  },
                  
              },
            
              {
                  $unwind: {
                      path: "$pict",
                      preserveNullAndEmptyArrays: true
                  }
              },
              
              {
                  $project: {
                      "scorePict": "$pict.scorePict",
                      "boosted": "$pict.boosted",
                      "reportedStatus": "$pict.reportedStatus",
                      "_id": "$pict._id",
                      "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                      {
                          "$concat": ["/thumb/", "$pict.postID"]
                      },
                      mediaEndpoint:{
                       "$cond":
                       {
                           if:
                           {
                               "$eq":
                                   [
                                     "$pict.postType", "pict"
                                   ]
                           },
                           then:
                           {
                               "$concat":
                                   [
                                       "/pict/",
                                       "$pict.postID"
                                   ]
                           },
                           else:
                           {
                               "$concat":
                                   [
                                       "/stream/",
                                       "$pict.postID"
                                   ]
                           }
                       }
                   },
                      "mediaType": {
                          $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                      },
                      "createdAt": "$pict.createdAt",
                      "updatedAt": "$pict.updatedAt",
                      "postID": "$pict.postID",
                      "email": "$pict.email",
                      "postType": "$pict.postType",
                      "description": "$pict.description",
                      "active": "$pict.active",
                      "metadata": "$pict.metadata",
                      "location": "$pict.location",
                      "isOwned": "$pict.isOwned",
                      "visibility": "$pict.visibility",
                      "isViewed": "$pict.isViewed",
                      "allowComments": "$pict.allowComments",
                      "saleAmount": "$pict.saleAmount",
                      "monetize": 
                      {
                          $cond: {
                              if : {
                                  $gte: ["$pict.saleAmount", 1]
                              },
                              then: true,
                              else : "$taslimKONAG"
                          }
                      },
                      "comments": "$pict.comments",
                      "likes": "$pict.likes",
                      "insight": 
                      {
                          $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                      },
                      "apsaraId": {
                          $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                      },
                      "isApsara": {
                          $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                      },
                      "viewed": "$pict.insight.views",
                  }
              },
              {
                  $sort: {
                      scorePict: - 1,
                      comments: - 1,
                      likes: - 1,
                      viewed:  -1
                  }
              },
              
          ],
          "diary": 
          [
              {
                  $lookup: {
                      from: "newPosts",
                      pipeline: [
                          {
                              $match: 
                              {
                                  $and: [
                                      {
                                          $text: {
                                              $search: key,
                                              
                                          }
                                      },
                                      {
                                          "reportedStatus": {
                                              $ne: "OWNED"
                                          }
                                      },
                                      {
                                          "visibility": "PUBLIC"
                                      },
                                      {
                                          "active": true
                                      },
                                      {
                                          "postType": "diary"
                                      },
                                      {
                                          "reportedUser.email": {
                                              $not: {
                                                  $regex: email
                                              }
                                          }
                                      },
                                      
                                  ]
                              },
                              
                          },
                          {
                              $set: {
                                  scorePict: {
                                      $meta: "textScore"
                                  }
                              }
                          },
                          {
                              $project: {
                                  mediaSource:1,
                                  "boosted": 
                                  {
                                      $cond: {
                                          if : {
                                              $gt: [{
                                                  "$dateToString": {
                                                      "format": "%Y-%m-%d %H:%M:%S",
                                                      "date": {
                                                          $add: [new Date(), 25200000]
                                                      }
                                                  }
                                              }, "$boosted.boostSession.timeEnd"]
                                          },
                                          then: [],
                                          else : '$boosted'
                                      }
                                  },
                                  "reportedStatus": 1,
                                  "insight": {
                                      "shares": "$shares",
                                      "comments": "$comments",
                                      "views": "$views",
                                      "likes": "$likes",
                                      
                                  },
                                   "views": "$views",
                                  "comments": "$comments",
                                  "likes": "$likes",
                                  "scorePict": 1,
                                  "_id": 1,
                                  "postID": 1,
                                  "createdAt": 1,
                                  "updatedAt": 1,
                                  "email": 1,
                                  "postType": 1,
                                  "description": 1,
                                  "active": 1,
                                  "metadata": 1,
                                  "location": 1,
                                  "isOwned": 1,
                                  "visibility": 1,
                                  "isViewed": 1,
                                  "allowComments": 1,
                                  "saleAmount": 1,
                                  
                              }
                          },
                          {
                                $sort: {
                                    scorePict: - 1,
                                    comments: - 1,
                                    likes: - 1,
                                    views:  -1
                                }
                            },
                            {
                                $skip:skip
                            },
                            {
                                $limit: limit
                            },
                      ],
                      as: "pict"
                  },
                  
              },
            
              {
                  $unwind: {
                      path: "$pict",
                      preserveNullAndEmptyArrays: true
                  }
              },
              
              {
                  $project: {
                      "scorePict": "$pict.scorePict",
                      "boosted": "$pict.boosted",
                      "reportedStatus": "$pict.reportedStatus",
                      "_id": "$pict._id",
                      "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                      {
                          "$concat": ["/thumb/", "$pict.postID"]
                      },
                      mediaEndpoint:{
                       "$cond":
                       {
                           if:
                           {
                               "$eq":
                                   [
                                     "$pict.postType", "pict"
                                   ]
                           },
                           then:
                           {
                               "$concat":
                                   [
                                       "/pict/",
                                       "$pict.postID"
                                   ]
                           },
                           else:
                           {
                               "$concat":
                                   [
                                       "/stream/",
                                       "$pict.postID"
                                   ]
                           }
                       }
                   },
                      "mediaType": {
                          $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                      },
                      "createdAt": "$pict.createdAt",
                      "updatedAt": "$pict.updatedAt",
                      "postID": "$pict.postID",
                      "email": "$pict.email",
                      "postType": "$pict.postType",
                      "description": "$pict.description",
                      "active": "$pict.active",
                      "metadata": "$pict.metadata",
                      "location": "$pict.location",
                      "isOwned": "$pict.isOwned",
                      "visibility": "$pict.visibility",
                      "isViewed": "$pict.isViewed",
                      "allowComments": "$pict.allowComments",
                      "saleAmount": "$pict.saleAmount",
                      "monetize": 
                      {
                          $cond: {
                              if : {
                                  $gte: ["$pict.saleAmount", 1]
                              },
                              then: true,
                              else : "$taslimKONAG"
                          }
                      },
                      "comments": "$pict.comments",
                      "likes": "$pict.likes",
                      "insight": 
                      {
                          $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                      },
                      "apsaraId": {
                          $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                      },
                      "isApsara": {
                          $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                      },
                      "viewed": "$pict.insight.views",
                  }
              },
              {
                  $sort: {
                      scorePict: - 1,
                      comments: - 1,
                      likes: - 1,
                      viewed:  -1
                  }
              },
              
          ],
            "tags":
              [
                {
                  $lookup: {
                    from: "tag_count",
                    pipeline: [
                      {
                        $match:
                        {
                          "_id": {
                            $regex: key, $options: 'i'
                          }
                        }
                      },
                      {
                        $set: {
                          score: {
                            $indexOfCP: ["$_id", "de"]
                          }
                        }
                      },
                      {
                        $set: {
                          length: {
                            $strLenCP: "$_id"
                          }
                        }
                      },
                      {
                        $set: {
                          dodol: "kancut"
                        }
                      },
                      {
                        $project: {
                          name: "$_id",
                          total: 1,
                          score: 1,
                          length: 1,
                          dodol: {
                            $ifNull: ["$_id", "kosong"]
                          },

                        }
                      },

                    ],
                    as: "tag"
                  },

                },
                {
                  $unwind: {
                    path: "$tag",
                    preserveNullAndEmptyArrays: true
                  }
                },
                {
                  $project: {
                    tag: "$tag.name",
                    total: "$tag.total",
                    score: "$tag.score",
                    length: "$tag.length",
                    dodol: "$tag.dodol",

                  },

                },
                {
                  $sort: {
                    score: 1,
                    length: 1,
                    total: - 1
                  }
                },
                {
                  $skip: skip
                },
                {
                  $limit: limit
                },

              ]
          },

        },
        {
          $project: {

            pict: "$pict",
            diary: "$diary",
            dodol: "$tags.dodol",
            tags:
            {
              $cond: {
                if: {
                  $gt: [{ $size: "$tags.dodol" }, 0]
                },
                then: "$tags",
                else: "$tagsssdsd"
              }
            },

          }
        });
    }
    else if (pict === true && vid === false && diary === false && user === true && tag === true) {
      pipeline.push(

        {
          $facet:
          {
            "user":
              [
                {
                  $lookup: {
                    from: "newUserBasics",
                    let: {
                      name: "$dedy"
                    },
                    pipeline: [
                      {
                        $match: {
                          $expr: {
                            $regexMatch: {
                              input: "$username",
                              regex: "$$name",
                              options: "i"
                            }
                          }
                        }
                      }
                    ],
                    as: "userAuth"
                  },

                },
                {
                  $unwind: {
                    path: "$userAuth",
                    preserveNullAndEmptyArrays: true
                  }
                },
                {
                  $project: {
                    "fullName": "$userAuth.fullName",
                    "profilePict": "$userAuth.profilePict",
                    "username": "$userAuth.username",
                    "email": "$userAuth.email",
                    "avatar":
                      [{
                        "mediaBasePath": "$userAuth.mediaBasePath",
                        "mediaUri": "$userAuth.mediaUri",
                        "originalName": "$userAuth.originalName",
                        "fsSourceUri": "$userAuth.fsSourceUri",
                        "fsSourceName": "$userBasic.fsSourceName",
                        "fsTargetUri": "$userAuth.fsTargetUri",
                        "mediaType": "$userAuth.mediaType",
                        //"mediaEndpoint": {
                        //"$concat": ["/profilepict/", "$mediaUri"]
                        //}
                      }],
                    //"idUserAuth": "$userAuth._id",
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$filter":
                            {
                              input:
                              {
                                "$arrayElemAt":
                                  [
                                    "$userAuth.userBadge",
                                    0
                                  ]
                              },
                              as: "listbadge",
                              cond:
                              {
                                "$and":
                                  [
                                    {
                                      "$eq":
                                        [
                                          "$$listbadge.isActive",
                                          true
                                        ]
                                    },
                                    {
                                      "$lte": [
                                        {
                                          "$dateToString": {
                                            "format": "%Y-%m-%d %H:%M:%S",
                                            "date": {
                                              "$add": [
                                                new Date(),
                                                25200000
                                              ]
                                            }
                                          }
                                        },
                                        "$$listbadge.endDatetime"
                                      ]
                                    }
                                  ]
                              }
                            }
                          },
                          []
                        ]
                    },
                  }
                },
                {
                  $project: {
                    "fullName": 1,
                    "profilePict": 1,
                    "username": 1,
                    "email": 1,
                    "avatar": 1,
                    //"idUserAuth": "$userAuth._id",
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$arrayElemAt":
                              [
                                "$urluserBadge",
                                0
                              ]
                          },
                          null
                        ]
                    }
                  }
                },
                {
                  $skip: skip
                },
                {
                  $limit: limit
                },
              ],
            //pict
            "pict": 
            [
                {
                    $lookup: {
                        from: "newPosts",
                        pipeline: [
                            {
                                $match: 
                                {
                                    $and: [
                                        {
                                            $text: {
                                                $search: key,
                                                
                                            }
                                        },
                                        {
                                            "reportedStatus": {
                                                $ne: "OWNED"
                                            }
                                        },
                                        {
                                            "visibility": "PUBLIC"
                                        },
                                        {
                                            "active": true
                                        },
                                        {
                                            "postType": "pict"
                                        },
                                        {
                                            "reportedUser.email": {
                                                $not: {
                                                    $regex: email
                                                }
                                            }
                                        },
                                        
                                    ]
                                },
                                
                            },
                            {
                                $set: {
                                    scorePict: {
                                        $meta: "textScore"
                                    }
                                }
                            },
                            {
                                $project: {
                                    mediaSource:1,
                                    "boosted": 
                                    {
                                        $cond: {
                                            if : {
                                                $gt: [{
                                                    "$dateToString": {
                                                        "format": "%Y-%m-%d %H:%M:%S",
                                                        "date": {
                                                            $add: [new Date(), 25200000]
                                                        }
                                                    }
                                                }, "$boosted.boostSession.timeEnd"]
                                            },
                                            then: [],
                                            else : '$boosted'
                                        }
                                    },
                                    "reportedStatus": 1,
                                    "insight": {
                                        "shares": "$shares",
                                        "comments": "$comments",
                                        "views": "$views",
                                        "likes": "$likes",
                                        
                                    },
                                     "views": "$views",
                                    "comments": "$comments",
                                    "likes": "$likes",
                                    "scorePict": 1,
                                    "_id": 1,
                                    "postID": 1,
                                    "createdAt": 1,
                                    "updatedAt": 1,
                                    "email": 1,
                                    "postType": 1,
                                    "description": 1,
                                    "active": 1,
                                    "metadata": 1,
                                    "location": 1,
                                    "isOwned": 1,
                                    "visibility": 1,
                                    "isViewed": 1,
                                    "allowComments": 1,
                                    "saleAmount": 1,
                                    
                                }
                            },
                            {
                                  $sort: {
                                      scorePict: - 1,
                                      comments: - 1,
                                      likes: - 1,
                                      views:  -1
                                  }
                              },
                              {
                               $skip: skip
                             },
                             {
                               $limit: limit
                             },
                        ],
                        as: "pict"
                    },
                    
                },
              
                {
                    $unwind: {
                        path: "$pict",
                        preserveNullAndEmptyArrays: true
                    }
                },
                
                {
                    $project: {
                        "scorePict": "$pict.scorePict",
                        "boosted": "$pict.boosted",
                        "reportedStatus": "$pict.reportedStatus",
                        "_id": "$pict._id",
                        "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                        {
                            "$concat": ["/thumb/", "$pict.postID"]
                        },
                        mediaEndpoint:{
                         "$cond":
                         {
                             if:
                             {
                                 "$eq":
                                     [
                                       "$pict.postType", "pict"
                                     ]
                             },
                             then:
                             {
                                 "$concat":
                                     [
                                         "/pict/",
                                         "$pict.postID"
                                     ]
                             },
                             else:
                             {
                                 "$concat":
                                     [
                                         "/stream/",
                                         "$pict.postID"
                                     ]
                             }
                         }
                     },
                        "mediaType": {
                            $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                        },
                        "createdAt": "$pict.createdAt",
                        "updatedAt": "$pict.updatedAt",
                        "postID": "$pict.postID",
                        "email": "$pict.email",
                        "postType": "$pict.postType",
                        "description": "$pict.description",
                        "active": "$pict.active",
                        "metadata": "$pict.metadata",
                        "location": "$pict.location",
                        "isOwned": "$pict.isOwned",
                        "visibility": "$pict.visibility",
                        "isViewed": "$pict.isViewed",
                        "allowComments": "$pict.allowComments",
                        "saleAmount": "$pict.saleAmount",
                        "monetize": 
                        {
                            $cond: {
                                if : {
                                    $gte: ["$pict.saleAmount", 1]
                                },
                                then: true,
                                else : "$taslimKONAG"
                            }
                        },
                        "comments": "$pict.comments",
                        "likes": "$pict.likes",
                        "insight": 
                        {
                            $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                        },
                        "apsaraId": {
                            $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                        },
                        "isApsara": {
                            $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                        },
                        "viewed": "$pict.insight.views",
                    }
                },
                {
                    $sort: {
                        scorePict: - 1,
                        comments: - 1,
                        likes: - 1,
                        viewed:  -1
                    }
                },
                
            ],
            "tags":
              [
                {
                  $lookup: {
                    from: "tag_count",
                    pipeline: [
                      {
                        $match:
                        {
                          "_id": {
                            $regex: key, $options: 'i'
                          }
                        }
                      },
                      {
                        $set: {
                          score: {
                            $indexOfCP: ["$_id", "de"]
                          }
                        }
                      },
                      {
                        $set: {
                          length: {
                            $strLenCP: "$_id"
                          }
                        }
                      },
                      {
                        $set: {
                          dodol: "kancut"
                        }
                      },
                      {
                        $project: {
                          name: "$_id",
                          total: 1,
                          score: 1,
                          length: 1,
                          dodol: {
                            $ifNull: ["$_id", "kosong"]
                          },

                        }
                      },

                    ],
                    as: "tag"
                  },

                },
                {
                  $unwind: {
                    path: "$tag",
                    preserveNullAndEmptyArrays: true
                  }
                },
                {
                  $project: {
                    tag: "$tag.name",
                    total: "$tag.total",
                    score: "$tag.score",
                    length: "$tag.length",
                    dodol: "$tag.dodol",

                  },

                },
                {
                  $sort: {
                    score: 1,
                    length: 1,
                    total: - 1
                  }
                },
                {
                  $skip: skip
                },
                {
                  $limit: limit
                },

              ]
          },

        },
        {
          $project: {
            user:
            {
              $cond: {
                if: {
                  $eq: [{
                    $arrayElemAt: ["$user.dodol", 0]
                  }, "kosong"]
                },
                then: "$saassaas",
                else: "$user"
              }
            },
            pict: "$pict",
            dodol: "$tags.dodol",
            tags:
            {
              $cond: {
                if: {
                  $gt: [{ $size: "$tags.dodol" }, 0]
                },
                then: "$tags",
                else: "$tagsssdsd"
              }
            },
          }
        });
    }

    else if (pict === true && vid === true && diary === false && user === true && tag === true) {
      pipeline.push(

        {
          $facet:
          {
            "user":
              [
                {
                  $lookup: {
                    from: "newUserBasics",
                    let: {
                      name: "$dedy"
                    },
                    pipeline: [
                      {
                        $match: {
                          $expr: {
                            $regexMatch: {
                              input: "$username",
                              regex: "$$name",
                              options: "i"
                            }
                          }
                        }
                      }
                    ],
                    as: "userAuth"
                  },

                },
                {
                  $unwind: {
                    path: "$userAuth",
                    preserveNullAndEmptyArrays: true
                  }
                },
                {
                  $project: {
                    "fullName": "$userAuth.fullName",
                    "profilePict": "$userAuth.profilePict",
                    "username": "$userAuth.username",
                    "email": "$userAuth.email",
                    "avatar":
                      [{
                        "mediaBasePath": "$userAuth.mediaBasePath",
                        "mediaUri": "$userAuth.mediaUri",
                        "originalName": "$userAuth.originalName",
                        "fsSourceUri": "$userAuth.fsSourceUri",
                        "fsSourceName": "$userBasic.fsSourceName",
                        "fsTargetUri": "$userAuth.fsTargetUri",
                        "mediaType": "$userAuth.mediaType",
                        //"mediaEndpoint": {
                        //"$concat": ["/profilepict/", "$mediaUri"]
                        //}
                      }],
                    //"idUserAuth": "$userAuth._id",
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$filter":
                            {
                              input:
                              {
                                "$arrayElemAt":
                                  [
                                    "$userAuth.userBadge",
                                    0
                                  ]
                              },
                              as: "listbadge",
                              cond:
                              {
                                "$and":
                                  [
                                    {
                                      "$eq":
                                        [
                                          "$$listbadge.isActive",
                                          true
                                        ]
                                    },
                                    {
                                      "$lte": [
                                        {
                                          "$dateToString": {
                                            "format": "%Y-%m-%d %H:%M:%S",
                                            "date": {
                                              "$add": [
                                                new Date(),
                                                25200000
                                              ]
                                            }
                                          }
                                        },
                                        "$$listbadge.endDatetime"
                                      ]
                                    }
                                  ]
                              }
                            }
                          },
                          []
                        ]
                    },
                  }
                },
                {
                  $project: {
                    "fullName": 1,
                    "profilePict": 1,
                    "username": 1,
                    "email": 1,
                    "avatar": 1,
                    //"idUserAuth": "$userAuth._id",
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$arrayElemAt":
                              [
                                "$urluserBadge",
                                0
                              ]
                          },
                          null
                        ]
                    }
                  }
                },
                {
                  $skip: skip
                },
                {
                  $limit: limit
                },
              ],
            //pict
            "pict": 
            [
                {
                    $lookup: {
                        from: "newPosts",
                        pipeline: [
                            {
                                $match: 
                                {
                                    $and: [
                                        {
                                            $text: {
                                                $search: key,
                                                
                                            }
                                        },
                                        {
                                            "reportedStatus": {
                                                $ne: "OWNED"
                                            }
                                        },
                                        {
                                            "visibility": "PUBLIC"
                                        },
                                        {
                                            "active": true
                                        },
                                        {
                                            "postType": "pict"
                                        },
                                        {
                                            "reportedUser.email": {
                                                $not: {
                                                    $regex: email
                                                }
                                            }
                                        },
                                        
                                    ]
                                },
                                
                            },
                            {
                                $set: {
                                    scorePict: {
                                        $meta: "textScore"
                                    }
                                }
                            },
                            {
                                $project: {
                                    mediaSource:1,
                                    "boosted": 
                                    {
                                        $cond: {
                                            if : {
                                                $gt: [{
                                                    "$dateToString": {
                                                        "format": "%Y-%m-%d %H:%M:%S",
                                                        "date": {
                                                            $add: [new Date(), 25200000]
                                                        }
                                                    }
                                                }, "$boosted.boostSession.timeEnd"]
                                            },
                                            then: [],
                                            else : '$boosted'
                                        }
                                    },
                                    "reportedStatus": 1,
                                    "insight": {
                                        "shares": "$shares",
                                        "comments": "$comments",
                                        "views": "$views",
                                        "likes": "$likes",
                                        
                                    },
                                     "views": "$views",
                                    "comments": "$comments",
                                    "likes": "$likes",
                                    "scorePict": 1,
                                    "_id": 1,
                                    "postID": 1,
                                    "createdAt": 1,
                                    "updatedAt": 1,
                                    "email": 1,
                                    "postType": 1,
                                    "description": 1,
                                    "active": 1,
                                    "metadata": 1,
                                    "location": 1,
                                    "isOwned": 1,
                                    "visibility": 1,
                                    "isViewed": 1,
                                    "allowComments": 1,
                                    "saleAmount": 1,
                                    
                                }
                            },
                            {
                                  $sort: {
                                      scorePict: - 1,
                                      comments: - 1,
                                      likes: - 1,
                                      views:  -1
                                  }
                              },
                              {
                               $skip: skip
                             },
                             {
                               $limit: limit
                             },
                        ],
                        as: "pict"
                    },
                    
                },
              
                {
                    $unwind: {
                        path: "$pict",
                        preserveNullAndEmptyArrays: true
                    }
                },
                
                {
                    $project: {
                        "scorePict": "$pict.scorePict",
                        "boosted": "$pict.boosted",
                        "reportedStatus": "$pict.reportedStatus",
                        "_id": "$pict._id",
                        "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                        {
                            "$concat": ["/thumb/", "$pict.postID"]
                        },
                        mediaEndpoint:{
                         "$cond":
                         {
                             if:
                             {
                                 "$eq":
                                     [
                                       "$pict.postType", "pict"
                                     ]
                             },
                             then:
                             {
                                 "$concat":
                                     [
                                         "/pict/",
                                         "$pict.postID"
                                     ]
                             },
                             else:
                             {
                                 "$concat":
                                     [
                                         "/stream/",
                                         "$pict.postID"
                                     ]
                             }
                         }
                     },
                        "mediaType": {
                            $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                        },
                        "createdAt": "$pict.createdAt",
                        "updatedAt": "$pict.updatedAt",
                        "postID": "$pict.postID",
                        "email": "$pict.email",
                        "postType": "$pict.postType",
                        "description": "$pict.description",
                        "active": "$pict.active",
                        "metadata": "$pict.metadata",
                        "location": "$pict.location",
                        "isOwned": "$pict.isOwned",
                        "visibility": "$pict.visibility",
                        "isViewed": "$pict.isViewed",
                        "allowComments": "$pict.allowComments",
                        "saleAmount": "$pict.saleAmount",
                        "monetize": 
                        {
                            $cond: {
                                if : {
                                    $gte: ["$pict.saleAmount", 1]
                                },
                                then: true,
                                else : "$taslimKONAG"
                            }
                        },
                        "comments": "$pict.comments",
                        "likes": "$pict.likes",
                        "insight": 
                        {
                            $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                        },
                        "apsaraId": {
                            $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                        },
                        "isApsara": {
                            $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                        },
                        "viewed": "$pict.insight.views",
                    }
                },
                {
                    $sort: {
                        scorePict: - 1,
                        comments: - 1,
                        likes: - 1,
                        viewed:  -1
                    }
                },
                
            ],
            "vid": 
            [
                {
                    $lookup: {
                        from: "newPosts",
                        pipeline: [
                            {
                                $match: 
                                {
                                    $and: [
                                        {
                                            $text: {
                                                $search: key,
                                                
                                            }
                                        },
                                        {
                                            "reportedStatus": {
                                                $ne: "OWNED"
                                            }
                                        },
                                        {
                                            "visibility": "PUBLIC"
                                        },
                                        {
                                            "active": true
                                        },
                                        {
                                            "postType": "vid"
                                        },
                                        {
                                            "reportedUser.email": {
                                                $not: {
                                                    $regex: email
                                                }
                                            }
                                        },
                                        
                                    ]
                                },
                                
                            },
                            {
                                $set: {
                                    scorePict: {
                                        $meta: "textScore"
                                    }
                                }
                            },
                            {
                                $project: {
                                    mediaSource:1,
                                    "boosted": 
                                    {
                                        $cond: {
                                            if : {
                                                $gt: [{
                                                    "$dateToString": {
                                                        "format": "%Y-%m-%d %H:%M:%S",
                                                        "date": {
                                                            $add: [new Date(), 25200000]
                                                        }
                                                    }
                                                }, "$boosted.boostSession.timeEnd"]
                                            },
                                            then: [],
                                            else : '$boosted'
                                        }
                                    },
                                    "reportedStatus": 1,
                                    "insight": {
                                        "shares": "$shares",
                                        "comments": "$comments",
                                        "views": "$views",
                                        "likes": "$likes",
                                        
                                    },
                                     "views": "$views",
                                    "comments": "$comments",
                                    "likes": "$likes",
                                    "scorePict": 1,
                                    "_id": 1,
                                    "postID": 1,
                                    "createdAt": 1,
                                    "updatedAt": 1,
                                    "email": 1,
                                    "postType": 1,
                                    "description": 1,
                                    "active": 1,
                                    "metadata": 1,
                                    "location": 1,
                                    "isOwned": 1,
                                    "visibility": 1,
                                    "isViewed": 1,
                                    "allowComments": 1,
                                    "saleAmount": 1,
                                    
                                }
                            },
                            {
                                  $sort: {
                                      scorePict: - 1,
                                      comments: - 1,
                                      likes: - 1,
                                      views:  -1
                                  }
                              },
                              {
                                  $skip: skip
                              },
                              {
                                  $limit: limit
                              },
                        ],
                        as: "pict"
                    },
                    
                },
              
                {
                    $unwind: {
                        path: "$pict",
                        preserveNullAndEmptyArrays: true
                    }
                },
                
                {
                    $project: {
                        "scorePict": "$pict.scorePict",
                        "boosted": "$pict.boosted",
                        "reportedStatus": "$pict.reportedStatus",
                        "_id": "$pict._id",
                        "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                        {
                            "$concat": ["/thumb/", "$pict.postID"]
                        },
                        mediaEndpoint:{
                         "$cond":
                         {
                             if:
                             {
                                 "$eq":
                                     [
                                       "$pict.postType", "pict"
                                     ]
                             },
                             then:
                             {
                                 "$concat":
                                     [
                                         "/pict/",
                                         "$pict.postID"
                                     ]
                             },
                             else:
                             {
                                 "$concat":
                                     [
                                         "/stream/",
                                         "$pict.postID"
                                     ]
                             }
                         }
                     },
                        "mediaType": {
                            $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                        },
                        "createdAt": "$pict.createdAt",
                        "updatedAt": "$pict.updatedAt",
                        "postID": "$pict.postID",
                        "email": "$pict.email",
                        "postType": "$pict.postType",
                        "description": "$pict.description",
                        "active": "$pict.active",
                        "metadata": "$pict.metadata",
                        "location": "$pict.location",
                        "isOwned": "$pict.isOwned",
                        "visibility": "$pict.visibility",
                        "isViewed": "$pict.isViewed",
                        "allowComments": "$pict.allowComments",
                        "saleAmount": "$pict.saleAmount",
                        "monetize": 
                        {
                            $cond: {
                                if : {
                                    $gte: ["$pict.saleAmount", 1]
                                },
                                then: true,
                                else : "$taslimKONAG"
                            }
                        },
                        "comments": "$pict.comments",
                        "likes": "$pict.likes",
                        "insight": 
                        {
                            $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                        },
                        "apsaraId": {
                            $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                        },
                        "isApsara": {
                            $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                        },
                        "viewed": "$pict.insight.views",
                    }
                },
                {
                    $sort: {
                        scorePict: - 1,
                        comments: - 1,
                        likes: - 1,
                        viewed:  -1
                    }
                },
                
            ],
            "tags":
              [
                {
                  $lookup: {
                    from: "tag_count",
                    pipeline: [
                      {
                        $match:
                        {
                          "_id": {
                            $regex: key, $options: 'i'
                          }
                        }
                      },
                      {
                        $set: {
                          score: {
                            $indexOfCP: ["$_id", "de"]
                          }
                        }
                      },
                      {
                        $set: {
                          length: {
                            $strLenCP: "$_id"
                          }
                        }
                      },
                      {
                        $set: {
                          dodol: "kancut"
                        }
                      },
                      {
                        $project: {
                          name: "$_id",
                          total: 1,
                          score: 1,
                          length: 1,
                          dodol: {
                            $ifNull: ["$_id", "kosong"]
                          },

                        }
                      },

                    ],
                    as: "tag"
                  },

                },
                {
                  $unwind: {
                    path: "$tag",
                    preserveNullAndEmptyArrays: true
                  }
                },
                {
                  $project: {
                    tag: "$tag.name",
                    total: "$tag.total",
                    score: "$tag.score",
                    length: "$tag.length",
                    dodol: "$tag.dodol",

                  },

                },
                {
                  $sort: {
                    score: 1,
                    length: 1,
                    total: - 1
                  }
                },
                {
                  $skip: skip
                },
                {
                  $limit: limit
                },

              ]
          },

        },
        {
          $project: {
            user:
            {
              $cond: {
                if: {
                  $eq: [{
                    $arrayElemAt: ["$user.dodol", 0]
                  }, "kosong"]
                },
                then: "$saassaas",
                else: "$user"
              }
            },
            pict: "$pict",
            vid: "$vid",
            dodol: "$tags.dodol",
            tags:
            {
              $cond: {
                if: {
                  $gt: [{ $size: "$tags.dodol" }, 0]
                },
                then: "$tags",
                else: "$tagsssdsd"
              }
            },

          }
        });
    }
    else if (pict === false && vid === true && diary === true && user === true && tag === true) {
      pipeline.push(

        {
          $facet:
          {
            "user":
              [
                {
                  $lookup: {
                    from: "newUserBasics",
                    let: {
                      name: "$dedy"
                    },
                    pipeline: [
                      {
                        $match: {
                          $expr: {
                            $regexMatch: {
                              input: "$username",
                              regex: "$$name",
                              options: "i"
                            }
                          }
                        }
                      }
                    ],
                    as: "userAuth"
                  },

                },
                {
                  $unwind: {
                    path: "$userAuth",
                    preserveNullAndEmptyArrays: true
                  }
                },
                {
                  $project: {
                    "fullName": "$userAuth.fullName",
                    "profilePict": "$userAuth.profilePict",
                    "username": "$userAuth.username",
                    "email": "$userAuth.email",
                    "avatar":
                      [{
                        "mediaBasePath": "$userAuth.mediaBasePath",
                        "mediaUri": "$userAuth.mediaUri",
                        "originalName": "$userAuth.originalName",
                        "fsSourceUri": "$userAuth.fsSourceUri",
                        "fsSourceName": "$userBasic.fsSourceName",
                        "fsTargetUri": "$userAuth.fsTargetUri",
                        "mediaType": "$userAuth.mediaType",
                        //"mediaEndpoint": {
                        //"$concat": ["/profilepict/", "$mediaUri"]
                        //}
                      }],
                    //"idUserAuth": "$userAuth._id",
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$filter":
                            {
                              input:
                              {
                                "$arrayElemAt":
                                  [
                                    "$userAuth.userBadge",
                                    0
                                  ]
                              },
                              as: "listbadge",
                              cond:
                              {
                                "$and":
                                  [
                                    {
                                      "$eq":
                                        [
                                          "$$listbadge.isActive",
                                          true
                                        ]
                                    },
                                    {
                                      "$lte": [
                                        {
                                          "$dateToString": {
                                            "format": "%Y-%m-%d %H:%M:%S",
                                            "date": {
                                              "$add": [
                                                new Date(),
                                                25200000
                                              ]
                                            }
                                          }
                                        },
                                        "$$listbadge.endDatetime"
                                      ]
                                    }
                                  ]
                              }
                            }
                          },
                          []
                        ]
                    },
                  }
                },
                {
                  $project: {
                    "fullName": 1,
                    "profilePict": 1,
                    "username": 1,
                    "email": 1,
                    "avatar": 1,
                    //"idUserAuth": "$userAuth._id",
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$arrayElemAt":
                              [
                                "$urluserBadge",
                                0
                              ]
                          },
                          null
                        ]
                    }
                  }
                },
                {
                  $skip: skip
                },
                {
                  $limit: limit
                },
              ],
              "vid": 
              [
                  {
                      $lookup: {
                          from: "newPosts",
                          pipeline: [
                              {
                                  $match: 
                                  {
                                      $and: [
                                          {
                                              $text: {
                                                  $search: key,
                                                  
                                              }
                                          },
                                          {
                                              "reportedStatus": {
                                                  $ne: "OWNED"
                                              }
                                          },
                                          {
                                              "visibility": "PUBLIC"
                                          },
                                          {
                                              "active": true
                                          },
                                          {
                                              "postType": "vid"
                                          },
                                          {
                                              "reportedUser.email": {
                                                  $not: {
                                                      $regex: email
                                                  }
                                              }
                                          },
                                          
                                      ]
                                  },
                                  
                              },
                              {
                                  $set: {
                                      scorePict: {
                                          $meta: "textScore"
                                      }
                                  }
                              },
                              {
                                  $project: {
                                      mediaSource:1,
                                      "boosted": 
                                      {
                                          $cond: {
                                              if : {
                                                  $gt: [{
                                                      "$dateToString": {
                                                          "format": "%Y-%m-%d %H:%M:%S",
                                                          "date": {
                                                              $add: [new Date(), 25200000]
                                                          }
                                                      }
                                                  }, "$boosted.boostSession.timeEnd"]
                                              },
                                              then: [],
                                              else : '$boosted'
                                          }
                                      },
                                      "reportedStatus": 1,
                                      "insight": {
                                          "shares": "$shares",
                                          "comments": "$comments",
                                          "views": "$views",
                                          "likes": "$likes",
                                          
                                      },
                                       "views": "$views",
                                      "comments": "$comments",
                                      "likes": "$likes",
                                      "scorePict": 1,
                                      "_id": 1,
                                      "postID": 1,
                                      "createdAt": 1,
                                      "updatedAt": 1,
                                      "email": 1,
                                      "postType": 1,
                                      "description": 1,
                                      "active": 1,
                                      "metadata": 1,
                                      "location": 1,
                                      "isOwned": 1,
                                      "visibility": 1,
                                      "isViewed": 1,
                                      "allowComments": 1,
                                      "saleAmount": 1,
                                      
                                  }
                              },
                              {
                                    $sort: {
                                        scorePict: - 1,
                                        comments: - 1,
                                        likes: - 1,
                                        views:  -1
                                    }
                                },
                                {
                                    $skip: skip
                                },
                                {
                                    $limit: limit
                                },
                          ],
                          as: "pict"
                      },
                      
                  },
                
                  {
                      $unwind: {
                          path: "$pict",
                          preserveNullAndEmptyArrays: true
                      }
                  },
                  
                  {
                      $project: {
                          "scorePict": "$pict.scorePict",
                          "boosted": "$pict.boosted",
                          "reportedStatus": "$pict.reportedStatus",
                          "_id": "$pict._id",
                          "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                          {
                              "$concat": ["/thumb/", "$pict.postID"]
                          },
                          mediaEndpoint:{
                           "$cond":
                           {
                               if:
                               {
                                   "$eq":
                                       [
                                         "$pict.postType", "pict"
                                       ]
                               },
                               then:
                               {
                                   "$concat":
                                       [
                                           "/pict/",
                                           "$pict.postID"
                                       ]
                               },
                               else:
                               {
                                   "$concat":
                                       [
                                           "/stream/",
                                           "$pict.postID"
                                       ]
                               }
                           }
                       },
                          "mediaType": {
                              $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                          },
                          "createdAt": "$pict.createdAt",
                          "updatedAt": "$pict.updatedAt",
                          "postID": "$pict.postID",
                          "email": "$pict.email",
                          "postType": "$pict.postType",
                          "description": "$pict.description",
                          "active": "$pict.active",
                          "metadata": "$pict.metadata",
                          "location": "$pict.location",
                          "isOwned": "$pict.isOwned",
                          "visibility": "$pict.visibility",
                          "isViewed": "$pict.isViewed",
                          "allowComments": "$pict.allowComments",
                          "saleAmount": "$pict.saleAmount",
                          "monetize": 
                          {
                              $cond: {
                                  if : {
                                      $gte: ["$pict.saleAmount", 1]
                                  },
                                  then: true,
                                  else : "$taslimKONAG"
                              }
                          },
                          "comments": "$pict.comments",
                          "likes": "$pict.likes",
                          "insight": 
                          {
                              $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                          },
                          "apsaraId": {
                              $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                          },
                          "isApsara": {
                              $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                          },
                          "viewed": "$pict.insight.views",
                      }
                  },
                  {
                      $sort: {
                          scorePict: - 1,
                          comments: - 1,
                          likes: - 1,
                          viewed:  -1
                      }
                  },
                  
              ],
              "diary": 
              [
                  {
                      $lookup: {
                          from: "newPosts",
                          pipeline: [
                              {
                                  $match: 
                                  {
                                      $and: [
                                          {
                                              $text: {
                                                  $search: key,
                                                  
                                              }
                                          },
                                          {
                                              "reportedStatus": {
                                                  $ne: "OWNED"
                                              }
                                          },
                                          {
                                              "visibility": "PUBLIC"
                                          },
                                          {
                                              "active": true
                                          },
                                          {
                                              "postType": "diary"
                                          },
                                          {
                                              "reportedUser.email": {
                                                  $not: {
                                                      $regex: email
                                                  }
                                              }
                                          },
                                          
                                      ]
                                  },
                                  
                              },
                              {
                                  $set: {
                                      scorePict: {
                                          $meta: "textScore"
                                      }
                                  }
                              },
                              {
                                  $project: {
                                      mediaSource:1,
                                      "boosted": 
                                      {
                                          $cond: {
                                              if : {
                                                  $gt: [{
                                                      "$dateToString": {
                                                          "format": "%Y-%m-%d %H:%M:%S",
                                                          "date": {
                                                              $add: [new Date(), 25200000]
                                                          }
                                                      }
                                                  }, "$boosted.boostSession.timeEnd"]
                                              },
                                              then: [],
                                              else : '$boosted'
                                          }
                                      },
                                      "reportedStatus": 1,
                                      "insight": {
                                          "shares": "$shares",
                                          "comments": "$comments",
                                          "views": "$views",
                                          "likes": "$likes",
                                          
                                      },
                                       "views": "$views",
                                      "comments": "$comments",
                                      "likes": "$likes",
                                      "scorePict": 1,
                                      "_id": 1,
                                      "postID": 1,
                                      "createdAt": 1,
                                      "updatedAt": 1,
                                      "email": 1,
                                      "postType": 1,
                                      "description": 1,
                                      "active": 1,
                                      "metadata": 1,
                                      "location": 1,
                                      "isOwned": 1,
                                      "visibility": 1,
                                      "isViewed": 1,
                                      "allowComments": 1,
                                      "saleAmount": 1,
                                      
                                  }
                              },
                              {
                                    $sort: {
                                        scorePict: - 1,
                                        comments: - 1,
                                        likes: - 1,
                                        views:  -1
                                    }
                                },
                                {
                                    $skip:skip
                                },
                                {
                                    $limit: limit
                                },
                          ],
                          as: "pict"
                      },
                      
                  },
                
                  {
                      $unwind: {
                          path: "$pict",
                          preserveNullAndEmptyArrays: true
                      }
                  },
                  
                  {
                      $project: {
                          "scorePict": "$pict.scorePict",
                          "boosted": "$pict.boosted",
                          "reportedStatus": "$pict.reportedStatus",
                          "_id": "$pict._id",
                          "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                          {
                              "$concat": ["/thumb/", "$pict.postID"]
                          },
                          mediaEndpoint:{
                           "$cond":
                           {
                               if:
                               {
                                   "$eq":
                                       [
                                         "$pict.postType", "pict"
                                       ]
                               },
                               then:
                               {
                                   "$concat":
                                       [
                                           "/pict/",
                                           "$pict.postID"
                                       ]
                               },
                               else:
                               {
                                   "$concat":
                                       [
                                           "/stream/",
                                           "$pict.postID"
                                       ]
                               }
                           }
                       },
                          "mediaType": {
                              $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                          },
                          "createdAt": "$pict.createdAt",
                          "updatedAt": "$pict.updatedAt",
                          "postID": "$pict.postID",
                          "email": "$pict.email",
                          "postType": "$pict.postType",
                          "description": "$pict.description",
                          "active": "$pict.active",
                          "metadata": "$pict.metadata",
                          "location": "$pict.location",
                          "isOwned": "$pict.isOwned",
                          "visibility": "$pict.visibility",
                          "isViewed": "$pict.isViewed",
                          "allowComments": "$pict.allowComments",
                          "saleAmount": "$pict.saleAmount",
                          "monetize": 
                          {
                              $cond: {
                                  if : {
                                      $gte: ["$pict.saleAmount", 1]
                                  },
                                  then: true,
                                  else : "$taslimKONAG"
                              }
                          },
                          "comments": "$pict.comments",
                          "likes": "$pict.likes",
                          "insight": 
                          {
                              $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                          },
                          "apsaraId": {
                              $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                          },
                          "isApsara": {
                              $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                          },
                          "viewed": "$pict.insight.views",
                      }
                  },
                  {
                      $sort: {
                          scorePict: - 1,
                          comments: - 1,
                          likes: - 1,
                          viewed:  -1
                      }
                  },
                  
              ],
            "tags":
              [
                {
                  $lookup: {
                    from: "tag_count",
                    pipeline: [
                      {
                        $match:
                        {
                          "_id": {
                            $regex: key, $options: 'i'
                          }
                        }
                      },
                      {
                        $set: {
                          score: {
                            $indexOfCP: ["$_id", "de"]
                          }
                        }
                      },
                      {
                        $set: {
                          length: {
                            $strLenCP: "$_id"
                          }
                        }
                      },
                      {
                        $set: {
                          dodol: "kancut"
                        }
                      },
                      {
                        $project: {
                          name: "$_id",
                          total: 1,
                          score: 1,
                          length: 1,
                          dodol: {
                            $ifNull: ["$_id", "kosong"]
                          },

                        }
                      },

                    ],
                    as: "tag"
                  },

                },
                {
                  $unwind: {
                    path: "$tag",
                    preserveNullAndEmptyArrays: true
                  }
                },
                {
                  $project: {
                    tag: "$tag.name",
                    total: "$tag.total",
                    score: "$tag.score",
                    length: "$tag.length",
                    dodol: "$tag.dodol",

                  },

                },
                {
                  $sort: {
                    score: 1,
                    length: 1,
                    total: - 1
                  }
                },
                {
                  $skip: skip
                },
                {
                  $limit: limit
                },

              ]
          },

        },
        {
          $project: {
            user:
            {
              $cond: {
                if: {
                  $eq: [{
                    $arrayElemAt: ["$user.dodol", 0]
                  }, "kosong"]
                },
                then: "$saassaas",
                else: "$user"
              }
            },
            vid: "$vid",
            diary: "$diary",
            dodol: "$tags.dodol",
            tags:
            {
              $cond: {
                if: {
                  $gt: [{ $size: "$tags.dodol" }, 0]
                },
                then: "$tags",
                else: "$tagsssdsd"
              }
            },

          }
        });
    }
    else if (pict === true && vid === true && diary === true && user === false && tag === true) {
      pipeline.push(

        {
          $facet:
          {

          //pict
          "pict": 
          [
              {
                  $lookup: {
                      from: "newPosts",
                      pipeline: [
                          {
                              $match: 
                              {
                                  $and: [
                                      {
                                          $text: {
                                              $search: key,
                                              
                                          }
                                      },
                                      {
                                          "reportedStatus": {
                                              $ne: "OWNED"
                                          }
                                      },
                                      {
                                          "visibility": "PUBLIC"
                                      },
                                      {
                                          "active": true
                                      },
                                      {
                                          "postType": "pict"
                                      },
                                      {
                                          "reportedUser.email": {
                                              $not: {
                                                  $regex: email
                                              }
                                          }
                                      },
                                      
                                  ]
                              },
                              
                          },
                          {
                              $set: {
                                  scorePict: {
                                      $meta: "textScore"
                                  }
                              }
                          },
                          {
                              $project: {
                                  mediaSource:1,
                                  "boosted": 
                                  {
                                      $cond: {
                                          if : {
                                              $gt: [{
                                                  "$dateToString": {
                                                      "format": "%Y-%m-%d %H:%M:%S",
                                                      "date": {
                                                          $add: [new Date(), 25200000]
                                                      }
                                                  }
                                              }, "$boosted.boostSession.timeEnd"]
                                          },
                                          then: [],
                                          else : '$boosted'
                                      }
                                  },
                                  "reportedStatus": 1,
                                  "insight": {
                                      "shares": "$shares",
                                      "comments": "$comments",
                                      "views": "$views",
                                      "likes": "$likes",
                                      
                                  },
                                   "views": "$views",
                                  "comments": "$comments",
                                  "likes": "$likes",
                                  "scorePict": 1,
                                  "_id": 1,
                                  "postID": 1,
                                  "createdAt": 1,
                                  "updatedAt": 1,
                                  "email": 1,
                                  "postType": 1,
                                  "description": 1,
                                  "active": 1,
                                  "metadata": 1,
                                  "location": 1,
                                  "isOwned": 1,
                                  "visibility": 1,
                                  "isViewed": 1,
                                  "allowComments": 1,
                                  "saleAmount": 1,
                                  
                              }
                          },
                          {
                                $sort: {
                                    scorePict: - 1,
                                    comments: - 1,
                                    likes: - 1,
                                    views:  -1
                                }
                            },
                            {
                             $skip: skip
                           },
                           {
                             $limit: limit
                           },
                      ],
                      as: "pict"
                  },
                  
              },
            
              {
                  $unwind: {
                      path: "$pict",
                      preserveNullAndEmptyArrays: true
                  }
              },
              
              {
                  $project: {
                      "scorePict": "$pict.scorePict",
                      "boosted": "$pict.boosted",
                      "reportedStatus": "$pict.reportedStatus",
                      "_id": "$pict._id",
                      "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                      {
                          "$concat": ["/thumb/", "$pict.postID"]
                      },
                      mediaEndpoint:{
                       "$cond":
                       {
                           if:
                           {
                               "$eq":
                                   [
                                     "$pict.postType", "pict"
                                   ]
                           },
                           then:
                           {
                               "$concat":
                                   [
                                       "/pict/",
                                       "$pict.postID"
                                   ]
                           },
                           else:
                           {
                               "$concat":
                                   [
                                       "/stream/",
                                       "$pict.postID"
                                   ]
                           }
                       }
                   },
                      "mediaType": {
                          $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                      },
                      "createdAt": "$pict.createdAt",
                      "updatedAt": "$pict.updatedAt",
                      "postID": "$pict.postID",
                      "email": "$pict.email",
                      "postType": "$pict.postType",
                      "description": "$pict.description",
                      "active": "$pict.active",
                      "metadata": "$pict.metadata",
                      "location": "$pict.location",
                      "isOwned": "$pict.isOwned",
                      "visibility": "$pict.visibility",
                      "isViewed": "$pict.isViewed",
                      "allowComments": "$pict.allowComments",
                      "saleAmount": "$pict.saleAmount",
                      "monetize": 
                      {
                          $cond: {
                              if : {
                                  $gte: ["$pict.saleAmount", 1]
                              },
                              then: true,
                              else : "$taslimKONAG"
                          }
                      },
                      "comments": "$pict.comments",
                      "likes": "$pict.likes",
                      "insight": 
                      {
                          $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                      },
                      "apsaraId": {
                          $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                      },
                      "isApsara": {
                          $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                      },
                      "viewed": "$pict.insight.views",
                  }
              },
              {
                  $sort: {
                      scorePict: - 1,
                      comments: - 1,
                      likes: - 1,
                      viewed:  -1
                  }
              },
              
          ],
          "vid": 
          [
              {
                  $lookup: {
                      from: "newPosts",
                      pipeline: [
                          {
                              $match: 
                              {
                                  $and: [
                                      {
                                          $text: {
                                              $search: key,
                                              
                                          }
                                      },
                                      {
                                          "reportedStatus": {
                                              $ne: "OWNED"
                                          }
                                      },
                                      {
                                          "visibility": "PUBLIC"
                                      },
                                      {
                                          "active": true
                                      },
                                      {
                                          "postType": "vid"
                                      },
                                      {
                                          "reportedUser.email": {
                                              $not: {
                                                  $regex: email
                                              }
                                          }
                                      },
                                      
                                  ]
                              },
                              
                          },
                          {
                              $set: {
                                  scorePict: {
                                      $meta: "textScore"
                                  }
                              }
                          },
                          {
                              $project: {
                                  mediaSource:1,
                                  "boosted": 
                                  {
                                      $cond: {
                                          if : {
                                              $gt: [{
                                                  "$dateToString": {
                                                      "format": "%Y-%m-%d %H:%M:%S",
                                                      "date": {
                                                          $add: [new Date(), 25200000]
                                                      }
                                                  }
                                              }, "$boosted.boostSession.timeEnd"]
                                          },
                                          then: [],
                                          else : '$boosted'
                                      }
                                  },
                                  "reportedStatus": 1,
                                  "insight": {
                                      "shares": "$shares",
                                      "comments": "$comments",
                                      "views": "$views",
                                      "likes": "$likes",
                                      
                                  },
                                   "views": "$views",
                                  "comments": "$comments",
                                  "likes": "$likes",
                                  "scorePict": 1,
                                  "_id": 1,
                                  "postID": 1,
                                  "createdAt": 1,
                                  "updatedAt": 1,
                                  "email": 1,
                                  "postType": 1,
                                  "description": 1,
                                  "active": 1,
                                  "metadata": 1,
                                  "location": 1,
                                  "isOwned": 1,
                                  "visibility": 1,
                                  "isViewed": 1,
                                  "allowComments": 1,
                                  "saleAmount": 1,
                                  
                              }
                          },
                          {
                                $sort: {
                                    scorePict: - 1,
                                    comments: - 1,
                                    likes: - 1,
                                    views:  -1
                                }
                            },
                            {
                                $skip: skip
                            },
                            {
                                $limit: limit
                            },
                      ],
                      as: "pict"
                  },
                  
              },
            
              {
                  $unwind: {
                      path: "$pict",
                      preserveNullAndEmptyArrays: true
                  }
              },
              
              {
                  $project: {
                      "scorePict": "$pict.scorePict",
                      "boosted": "$pict.boosted",
                      "reportedStatus": "$pict.reportedStatus",
                      "_id": "$pict._id",
                      "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                      {
                          "$concat": ["/thumb/", "$pict.postID"]
                      },
                      mediaEndpoint:{
                       "$cond":
                       {
                           if:
                           {
                               "$eq":
                                   [
                                     "$pict.postType", "pict"
                                   ]
                           },
                           then:
                           {
                               "$concat":
                                   [
                                       "/pict/",
                                       "$pict.postID"
                                   ]
                           },
                           else:
                           {
                               "$concat":
                                   [
                                       "/stream/",
                                       "$pict.postID"
                                   ]
                           }
                       }
                   },
                      "mediaType": {
                          $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                      },
                      "createdAt": "$pict.createdAt",
                      "updatedAt": "$pict.updatedAt",
                      "postID": "$pict.postID",
                      "email": "$pict.email",
                      "postType": "$pict.postType",
                      "description": "$pict.description",
                      "active": "$pict.active",
                      "metadata": "$pict.metadata",
                      "location": "$pict.location",
                      "isOwned": "$pict.isOwned",
                      "visibility": "$pict.visibility",
                      "isViewed": "$pict.isViewed",
                      "allowComments": "$pict.allowComments",
                      "saleAmount": "$pict.saleAmount",
                      "monetize": 
                      {
                          $cond: {
                              if : {
                                  $gte: ["$pict.saleAmount", 1]
                              },
                              then: true,
                              else : "$taslimKONAG"
                          }
                      },
                      "comments": "$pict.comments",
                      "likes": "$pict.likes",
                      "insight": 
                      {
                          $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                      },
                      "apsaraId": {
                          $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                      },
                      "isApsara": {
                          $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                      },
                      "viewed": "$pict.insight.views",
                  }
              },
              {
                  $sort: {
                      scorePict: - 1,
                      comments: - 1,
                      likes: - 1,
                      viewed:  -1
                  }
              },
              
          ],
          "diary": 
          [
              {
                  $lookup: {
                      from: "newPosts",
                      pipeline: [
                          {
                              $match: 
                              {
                                  $and: [
                                      {
                                          $text: {
                                              $search: key,
                                              
                                          }
                                      },
                                      {
                                          "reportedStatus": {
                                              $ne: "OWNED"
                                          }
                                      },
                                      {
                                          "visibility": "PUBLIC"
                                      },
                                      {
                                          "active": true
                                      },
                                      {
                                          "postType": "diary"
                                      },
                                      {
                                          "reportedUser.email": {
                                              $not: {
                                                  $regex: email
                                              }
                                          }
                                      },
                                      
                                  ]
                              },
                              
                          },
                          {
                              $set: {
                                  scorePict: {
                                      $meta: "textScore"
                                  }
                              }
                          },
                          {
                              $project: {
                                  mediaSource:1,
                                  "boosted": 
                                  {
                                      $cond: {
                                          if : {
                                              $gt: [{
                                                  "$dateToString": {
                                                      "format": "%Y-%m-%d %H:%M:%S",
                                                      "date": {
                                                          $add: [new Date(), 25200000]
                                                      }
                                                  }
                                              }, "$boosted.boostSession.timeEnd"]
                                          },
                                          then: [],
                                          else : '$boosted'
                                      }
                                  },
                                  "reportedStatus": 1,
                                  "insight": {
                                      "shares": "$shares",
                                      "comments": "$comments",
                                      "views": "$views",
                                      "likes": "$likes",
                                      
                                  },
                                   "views": "$views",
                                  "comments": "$comments",
                                  "likes": "$likes",
                                  "scorePict": 1,
                                  "_id": 1,
                                  "postID": 1,
                                  "createdAt": 1,
                                  "updatedAt": 1,
                                  "email": 1,
                                  "postType": 1,
                                  "description": 1,
                                  "active": 1,
                                  "metadata": 1,
                                  "location": 1,
                                  "isOwned": 1,
                                  "visibility": 1,
                                  "isViewed": 1,
                                  "allowComments": 1,
                                  "saleAmount": 1,
                                  
                              }
                          },
                          {
                                $sort: {
                                    scorePict: - 1,
                                    comments: - 1,
                                    likes: - 1,
                                    views:  -1
                                }
                            },
                            {
                                $skip:skip
                            },
                            {
                                $limit: limit
                            },
                      ],
                      as: "pict"
                  },
                  
              },
            
              {
                  $unwind: {
                      path: "$pict",
                      preserveNullAndEmptyArrays: true
                  }
              },
              
              {
                  $project: {
                      "scorePict": "$pict.scorePict",
                      "boosted": "$pict.boosted",
                      "reportedStatus": "$pict.reportedStatus",
                      "_id": "$pict._id",
                      "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                      {
                          "$concat": ["/thumb/", "$pict.postID"]
                      },
                      mediaEndpoint:{
                       "$cond":
                       {
                           if:
                           {
                               "$eq":
                                   [
                                     "$pict.postType", "pict"
                                   ]
                           },
                           then:
                           {
                               "$concat":
                                   [
                                       "/pict/",
                                       "$pict.postID"
                                   ]
                           },
                           else:
                           {
                               "$concat":
                                   [
                                       "/stream/",
                                       "$pict.postID"
                                   ]
                           }
                       }
                   },
                      "mediaType": {
                          $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                      },
                      "createdAt": "$pict.createdAt",
                      "updatedAt": "$pict.updatedAt",
                      "postID": "$pict.postID",
                      "email": "$pict.email",
                      "postType": "$pict.postType",
                      "description": "$pict.description",
                      "active": "$pict.active",
                      "metadata": "$pict.metadata",
                      "location": "$pict.location",
                      "isOwned": "$pict.isOwned",
                      "visibility": "$pict.visibility",
                      "isViewed": "$pict.isViewed",
                      "allowComments": "$pict.allowComments",
                      "saleAmount": "$pict.saleAmount",
                      "monetize": 
                      {
                          $cond: {
                              if : {
                                  $gte: ["$pict.saleAmount", 1]
                              },
                              then: true,
                              else : "$taslimKONAG"
                          }
                      },
                      "comments": "$pict.comments",
                      "likes": "$pict.likes",
                      "insight": 
                      {
                          $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                      },
                      "apsaraId": {
                          $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                      },
                      "isApsara": {
                          $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                      },
                      "viewed": "$pict.insight.views",
                  }
              },
              {
                  $sort: {
                      scorePict: - 1,
                      comments: - 1,
                      likes: - 1,
                      viewed:  -1
                  }
              },
              
          ],
            "tags":
              [
                {
                  $lookup: {
                    from: "tag_count",
                    pipeline: [
                      {
                        $match:
                        {
                          "_id": {
                            $regex: key, $options: 'i'
                          }
                        }
                      },
                      {
                        $set: {
                          score: {
                            $indexOfCP: ["$_id", "de"]
                          }
                        }
                      },
                      {
                        $set: {
                          length: {
                            $strLenCP: "$_id"
                          }
                        }
                      },
                      {
                        $set: {
                          dodol: "kancut"
                        }
                      },
                      {
                        $project: {
                          name: "$_id",
                          total: 1,
                          score: 1,
                          length: 1,
                          dodol: {
                            $ifNull: ["$_id", "kosong"]
                          },

                        }
                      },

                    ],
                    as: "tag"
                  },

                },
                {
                  $unwind: {
                    path: "$tag",
                    preserveNullAndEmptyArrays: true
                  }
                },
                {
                  $project: {
                    tag: "$tag.name",
                    total: "$tag.total",
                    score: "$tag.score",
                    length: "$tag.length",
                    dodol: "$tag.dodol",

                  },

                },
                {
                  $sort: {
                    score: 1,
                    length: 1,
                    total: - 1
                  }
                },
                {
                  $skip: skip
                },
                {
                  $limit: limit
                },

              ]
          },

        },
        {
          $project: {

            pict: "$pict",
            vid: "$vid",
            diary: "$diary",
            dodol: "$tags.dodol",
            tags:
            {
              $cond: {
                if: {
                  $gt: [{ $size: "$tags.dodol" }, 0]
                },
                then: "$tags",
                else: "$tagsssdsd"
              }
            },

          }
        });
    }
    else if (pict === true && vid === true && diary === true && user === true && tag === true) {
      pipeline.push(

        {
          $facet:
          {
            "user":
              [
                {
                  $lookup: {
                    from: "newUserBasics",
                    let: {
                      name: "$dedy"
                    },
                    pipeline: [
                      {
                        $match: {
                          $expr: {
                            $regexMatch: {
                              input: "$username",
                              regex: "$$name",
                              options: "i"
                            }
                          }
                        }
                      }
                    ],
                    as: "userAuth"
                  },

                },
                {
                  $unwind: {
                    path: "$userAuth",
                    preserveNullAndEmptyArrays: true
                  }
                },
                {
                  $project: {
                    "fullName": "$userAuth.fullName",
                    "profilePict": "$userAuth.profilePict",
                    "username": "$userAuth.username",
                    "email": "$userAuth.email",
                    "avatar":
                      [{
                        "mediaBasePath": "$userAuth.mediaBasePath",
                        "mediaUri": "$userAuth.mediaUri",
                        "originalName": "$userAuth.originalName",
                        "fsSourceUri": "$userAuth.fsSourceUri",
                        "fsSourceName": "$userBasic.fsSourceName",
                        "fsTargetUri": "$userAuth.fsTargetUri",
                        "mediaType": "$userAuth.mediaType",
                        //"mediaEndpoint": {
                        //"$concat": ["/profilepict/", "$mediaUri"]
                        //}
                      }],
                    //"idUserAuth": "$userAuth._id",
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$filter":
                            {
                              input:
                              {
                                "$arrayElemAt":
                                  [
                                    "$userAuth.userBadge",
                                    0
                                  ]
                              },
                              as: "listbadge",
                              cond:
                              {
                                "$and":
                                  [
                                    {
                                      "$eq":
                                        [
                                          "$$listbadge.isActive",
                                          true
                                        ]
                                    },
                                    {
                                      "$lte": [
                                        {
                                          "$dateToString": {
                                            "format": "%Y-%m-%d %H:%M:%S",
                                            "date": {
                                              "$add": [
                                                new Date(),
                                                25200000
                                              ]
                                            }
                                          }
                                        },
                                        "$$listbadge.endDatetime"
                                      ]
                                    }
                                  ]
                              }
                            }
                          },
                          []
                        ]
                    },
                  }
                },
                {
                  $project: {
                    "fullName": 1,
                    "profilePict": 1,
                    "username": 1,
                    "email": 1,
                    "avatar": 1,
                    //"idUserAuth": "$userAuth._id",
                    "urluserBadge":
                    {
                      "$ifNull":
                        [
                          {
                            "$arrayElemAt":
                              [
                                "$urluserBadge",
                                0
                              ]
                          },
                          null
                        ]
                    }
                  }
                },
                {
                  $skip: skip
                },
                {
                  $limit: limit
                },
              ],
            //pict
            "pict": 
            [
                {
                    $lookup: {
                        from: "newPosts",
                        pipeline: [
                            {
                                $match: 
                                {
                                    $and: [
                                        {
                                            $text: {
                                                $search: key,
                                                
                                            }
                                        },
                                        {
                                            "reportedStatus": {
                                                $ne: "OWNED"
                                            }
                                        },
                                        {
                                            "visibility": "PUBLIC"
                                        },
                                        {
                                            "active": true
                                        },
                                        {
                                            "postType": "pict"
                                        },
                                        {
                                            "reportedUser.email": {
                                                $not: {
                                                    $regex: email
                                                }
                                            }
                                        },
                                        
                                    ]
                                },
                                
                            },
                            {
                                $set: {
                                    scorePict: {
                                        $meta: "textScore"
                                    }
                                }
                            },
                            {
                                $project: {
                                    mediaSource:1,
                                    "boosted": 
                                    {
                                        $cond: {
                                            if : {
                                                $gt: [{
                                                    "$dateToString": {
                                                        "format": "%Y-%m-%d %H:%M:%S",
                                                        "date": {
                                                            $add: [new Date(), 25200000]
                                                        }
                                                    }
                                                }, "$boosted.boostSession.timeEnd"]
                                            },
                                            then: [],
                                            else : '$boosted'
                                        }
                                    },
                                    "reportedStatus": 1,
                                    "insight": {
                                        "shares": "$shares",
                                        "comments": "$comments",
                                        "views": "$views",
                                        "likes": "$likes",
                                        
                                    },
                                     "views": "$views",
                                    "comments": "$comments",
                                    "likes": "$likes",
                                    "scorePict": 1,
                                    "_id": 1,
                                    "postID": 1,
                                    "createdAt": 1,
                                    "updatedAt": 1,
                                    "email": 1,
                                    "postType": 1,
                                    "description": 1,
                                    "active": 1,
                                    "metadata": 1,
                                    "location": 1,
                                    "isOwned": 1,
                                    "visibility": 1,
                                    "isViewed": 1,
                                    "allowComments": 1,
                                    "saleAmount": 1,
                                    
                                }
                            },
                            {
                                  $sort: {
                                      scorePict: - 1,
                                      comments: - 1,
                                      likes: - 1,
                                      views:  -1
                                  }
                              },
                              {
                               $skip: skip
                             },
                             {
                               $limit: limit
                             },
                        ],
                        as: "pict"
                    },
                    
                },
              
                {
                    $unwind: {
                        path: "$pict",
                        preserveNullAndEmptyArrays: true
                    }
                },
                
                {
                    $project: {
                        "scorePict": "$pict.scorePict",
                        "boosted": "$pict.boosted",
                        "reportedStatus": "$pict.reportedStatus",
                        "_id": "$pict._id",
                        "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                        {
                            "$concat": ["/thumb/", "$pict.postID"]
                        },
                        mediaEndpoint:{
                         "$cond":
                         {
                             if:
                             {
                                 "$eq":
                                     [
                                       "$pict.postType", "pict"
                                     ]
                             },
                             then:
                             {
                                 "$concat":
                                     [
                                         "/pict/",
                                         "$pict.postID"
                                     ]
                             },
                             else:
                             {
                                 "$concat":
                                     [
                                         "/stream/",
                                         "$pict.postID"
                                     ]
                             }
                         }
                     },
                        "mediaType": {
                            $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                        },
                        "createdAt": "$pict.createdAt",
                        "updatedAt": "$pict.updatedAt",
                        "postID": "$pict.postID",
                        "email": "$pict.email",
                        "postType": "$pict.postType",
                        "description": "$pict.description",
                        "active": "$pict.active",
                        "metadata": "$pict.metadata",
                        "location": "$pict.location",
                        "isOwned": "$pict.isOwned",
                        "visibility": "$pict.visibility",
                        "isViewed": "$pict.isViewed",
                        "allowComments": "$pict.allowComments",
                        "saleAmount": "$pict.saleAmount",
                        "monetize": 
                        {
                            $cond: {
                                if : {
                                    $gte: ["$pict.saleAmount", 1]
                                },
                                then: true,
                                else : "$taslimKONAG"
                            }
                        },
                        "comments": "$pict.comments",
                        "likes": "$pict.likes",
                        "insight": 
                        {
                            $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                        },
                        "apsaraId": {
                            $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                        },
                        "isApsara": {
                            $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                        },
                        "viewed": "$pict.insight.views",
                    }
                },
                {
                    $sort: {
                        scorePict: - 1,
                        comments: - 1,
                        likes: - 1,
                        viewed:  -1
                    }
                },
                
            ],
            "vid": 
            [
                {
                    $lookup: {
                        from: "newPosts",
                        pipeline: [
                            {
                                $match: 
                                {
                                    $and: [
                                        {
                                            $text: {
                                                $search: key,
                                                
                                            }
                                        },
                                        {
                                            "reportedStatus": {
                                                $ne: "OWNED"
                                            }
                                        },
                                        {
                                            "visibility": "PUBLIC"
                                        },
                                        {
                                            "active": true
                                        },
                                        {
                                            "postType": "vid"
                                        },
                                        {
                                            "reportedUser.email": {
                                                $not: {
                                                    $regex: email
                                                }
                                            }
                                        },
                                        
                                    ]
                                },
                                
                            },
                            {
                                $set: {
                                    scorePict: {
                                        $meta: "textScore"
                                    }
                                }
                            },
                            {
                                $project: {
                                    mediaSource:1,
                                    "boosted": 
                                    {
                                        $cond: {
                                            if : {
                                                $gt: [{
                                                    "$dateToString": {
                                                        "format": "%Y-%m-%d %H:%M:%S",
                                                        "date": {
                                                            $add: [new Date(), 25200000]
                                                        }
                                                    }
                                                }, "$boosted.boostSession.timeEnd"]
                                            },
                                            then: [],
                                            else : '$boosted'
                                        }
                                    },
                                    "reportedStatus": 1,
                                    "insight": {
                                        "shares": "$shares",
                                        "comments": "$comments",
                                        "views": "$views",
                                        "likes": "$likes",
                                        
                                    },
                                     "views": "$views",
                                    "comments": "$comments",
                                    "likes": "$likes",
                                    "scorePict": 1,
                                    "_id": 1,
                                    "postID": 1,
                                    "createdAt": 1,
                                    "updatedAt": 1,
                                    "email": 1,
                                    "postType": 1,
                                    "description": 1,
                                    "active": 1,
                                    "metadata": 1,
                                    "location": 1,
                                    "isOwned": 1,
                                    "visibility": 1,
                                    "isViewed": 1,
                                    "allowComments": 1,
                                    "saleAmount": 1,
                                    
                                }
                            },
                            {
                                  $sort: {
                                      scorePict: - 1,
                                      comments: - 1,
                                      likes: - 1,
                                      views:  -1
                                  }
                              },
                              {
                                  $skip: skip
                              },
                              {
                                  $limit: limit
                              },
                        ],
                        as: "pict"
                    },
                    
                },
              
                {
                    $unwind: {
                        path: "$pict",
                        preserveNullAndEmptyArrays: true
                    }
                },
                
                {
                    $project: {
                        "scorePict": "$pict.scorePict",
                        "boosted": "$pict.boosted",
                        "reportedStatus": "$pict.reportedStatus",
                        "_id": "$pict._id",
                        "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                        {
                            "$concat": ["/thumb/", "$pict.postID"]
                        },
                        mediaEndpoint:{
                         "$cond":
                         {
                             if:
                             {
                                 "$eq":
                                     [
                                       "$pict.postType", "pict"
                                     ]
                             },
                             then:
                             {
                                 "$concat":
                                     [
                                         "/pict/",
                                         "$pict.postID"
                                     ]
                             },
                             else:
                             {
                                 "$concat":
                                     [
                                         "/stream/",
                                         "$pict.postID"
                                     ]
                             }
                         }
                     },
                        "mediaType": {
                            $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                        },
                        "createdAt": "$pict.createdAt",
                        "updatedAt": "$pict.updatedAt",
                        "postID": "$pict.postID",
                        "email": "$pict.email",
                        "postType": "$pict.postType",
                        "description": "$pict.description",
                        "active": "$pict.active",
                        "metadata": "$pict.metadata",
                        "location": "$pict.location",
                        "isOwned": "$pict.isOwned",
                        "visibility": "$pict.visibility",
                        "isViewed": "$pict.isViewed",
                        "allowComments": "$pict.allowComments",
                        "saleAmount": "$pict.saleAmount",
                        "monetize": 
                        {
                            $cond: {
                                if : {
                                    $gte: ["$pict.saleAmount", 1]
                                },
                                then: true,
                                else : "$taslimKONAG"
                            }
                        },
                        "comments": "$pict.comments",
                        "likes": "$pict.likes",
                        "insight": 
                        {
                            $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                        },
                        "apsaraId": {
                            $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                        },
                        "isApsara": {
                            $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                        },
                        "viewed": "$pict.insight.views",
                    }
                },
                {
                    $sort: {
                        scorePict: - 1,
                        comments: - 1,
                        likes: - 1,
                        viewed:  -1
                    }
                },
                
            ],
            "diary": 
            [
                {
                    $lookup: {
                        from: "newPosts",
                        pipeline: [
                            {
                                $match: 
                                {
                                    $and: [
                                        {
                                            $text: {
                                                $search: key,
                                                
                                            }
                                        },
                                        {
                                            "reportedStatus": {
                                                $ne: "OWNED"
                                            }
                                        },
                                        {
                                            "visibility": "PUBLIC"
                                        },
                                        {
                                            "active": true
                                        },
                                        {
                                            "postType": "diary"
                                        },
                                        {
                                            "reportedUser.email": {
                                                $not: {
                                                    $regex: email
                                                }
                                            }
                                        },
                                        
                                    ]
                                },
                                
                            },
                            {
                                $set: {
                                    scorePict: {
                                        $meta: "textScore"
                                    }
                                }
                            },
                            {
                                $project: {
                                    mediaSource:1,
                                    "boosted": 
                                    {
                                        $cond: {
                                            if : {
                                                $gt: [{
                                                    "$dateToString": {
                                                        "format": "%Y-%m-%d %H:%M:%S",
                                                        "date": {
                                                            $add: [new Date(), 25200000]
                                                        }
                                                    }
                                                }, "$boosted.boostSession.timeEnd"]
                                            },
                                            then: [],
                                            else : '$boosted'
                                        }
                                    },
                                    "reportedStatus": 1,
                                    "insight": {
                                        "shares": "$shares",
                                        "comments": "$comments",
                                        "views": "$views",
                                        "likes": "$likes",
                                        
                                    },
                                     "views": "$views",
                                    "comments": "$comments",
                                    "likes": "$likes",
                                    "scorePict": 1,
                                    "_id": 1,
                                    "postID": 1,
                                    "createdAt": 1,
                                    "updatedAt": 1,
                                    "email": 1,
                                    "postType": 1,
                                    "description": 1,
                                    "active": 1,
                                    "metadata": 1,
                                    "location": 1,
                                    "isOwned": 1,
                                    "visibility": 1,
                                    "isViewed": 1,
                                    "allowComments": 1,
                                    "saleAmount": 1,
                                    
                                }
                            },
                            {
                                  $sort: {
                                      scorePict: - 1,
                                      comments: - 1,
                                      likes: - 1,
                                      views:  -1
                                  }
                              },
                              {
                                  $skip:skip
                              },
                              {
                                  $limit: limit
                              },
                        ],
                        as: "pict"
                    },
                    
                },
              
                {
                    $unwind: {
                        path: "$pict",
                        preserveNullAndEmptyArrays: true
                    }
                },
                
                {
                    $project: {
                        "scorePict": "$pict.scorePict",
                        "boosted": "$pict.boosted",
                        "reportedStatus": "$pict.reportedStatus",
                        "_id": "$pict._id",
                        "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                        {
                            "$concat": ["/thumb/", "$pict.postID"]
                        },
                        mediaEndpoint:{
                         "$cond":
                         {
                             if:
                             {
                                 "$eq":
                                     [
                                       "$pict.postType", "pict"
                                     ]
                             },
                             then:
                             {
                                 "$concat":
                                     [
                                         "/pict/",
                                         "$pict.postID"
                                     ]
                             },
                             else:
                             {
                                 "$concat":
                                     [
                                         "/stream/",
                                         "$pict.postID"
                                     ]
                             }
                         }
                     },
                        "mediaType": {
                            $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                        },
                        "createdAt": "$pict.createdAt",
                        "updatedAt": "$pict.updatedAt",
                        "postID": "$pict.postID",
                        "email": "$pict.email",
                        "postType": "$pict.postType",
                        "description": "$pict.description",
                        "active": "$pict.active",
                        "metadata": "$pict.metadata",
                        "location": "$pict.location",
                        "isOwned": "$pict.isOwned",
                        "visibility": "$pict.visibility",
                        "isViewed": "$pict.isViewed",
                        "allowComments": "$pict.allowComments",
                        "saleAmount": "$pict.saleAmount",
                        "monetize": 
                        {
                            $cond: {
                                if : {
                                    $gte: ["$pict.saleAmount", 1]
                                },
                                then: true,
                                else : "$taslimKONAG"
                            }
                        },
                        "comments": "$pict.comments",
                        "likes": "$pict.likes",
                        "insight": 
                        {
                            $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                        },
                        "apsaraId": {
                            $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                        },
                        "isApsara": {
                            $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                        },
                        "viewed": "$pict.insight.views",
                    }
                },
                {
                    $sort: {
                        scorePict: - 1,
                        comments: - 1,
                        likes: - 1,
                        viewed:  -1
                    }
                },
                
            ],
            "tags":
              [
                {
                  $lookup: {
                    from: "tag_count",
                    pipeline: [
                      {
                        $match:
                        {
                          "_id": {
                            $regex: key, $options: 'i'
                          }
                        }
                      },
                      {
                        $set: {
                          score: {
                            $indexOfCP: ["$_id", "de"]
                          }
                        }
                      },
                      {
                        $set: {
                          length: {
                            $strLenCP: "$_id"
                          }
                        }
                      },
                      {
                        $set: {
                          dodol: "kancut"
                        }
                      },
                      {
                        $project: {
                          name: "$_id",
                          total: 1,
                          score: 1,
                          length: 1,
                          dodol: {
                            $ifNull: ["$_id", "kosong"]
                          },

                        }
                      },

                    ],
                    as: "tag"
                  },

                },
                {
                  $unwind: {
                    path: "$tag",
                    preserveNullAndEmptyArrays: true
                  }
                },
                {
                  $project: {
                    tag: "$tag.name",
                    total: "$tag.total",
                    score: "$tag.score",
                    length: "$tag.length",
                    dodol: "$tag.dodol",

                  },

                },
                {
                  $sort: {
                    score: 1,
                    length: 1,
                    total: - 1
                  }
                },
                {
                  $skip: skip
                },
                {
                  $limit: limit
                },

              ]
          },

        },
        {
          $project: {
            user:
            {
              $cond: {
                if: {
                  $eq: [{
                    $arrayElemAt: ["$user.dodol", 0]
                  }, "kosong"]
                },
                then: "$saassaas",
                else: "$user"
              }
            },
            pict: "$pict",
            vid: "$vid",
            diary: "$diary",
            dodol: "$tags.dodol",
            tags:
            {
              $cond: {
                if: {
                  $gt: [{ $size: "$tags.dodol" }, 0]
                },
                then: "$tags",
                else: "$tagsssdsd"
              }
            },

          }
        });
    }
    else if (pict === true && vid === true && diary === true && user === false && tag === false) {
      pipeline.push(

        {
          $facet:
          {

           //pict
           "pict": 
           [
               {
                   $lookup: {
                       from: "newPosts",
                       pipeline: [
                           {
                               $match: 
                               {
                                   $and: [
                                       {
                                           $text: {
                                               $search: key,
                                               
                                           }
                                       },
                                       {
                                           "reportedStatus": {
                                               $ne: "OWNED"
                                           }
                                       },
                                       {
                                           "visibility": "PUBLIC"
                                       },
                                       {
                                           "active": true
                                       },
                                       {
                                           "postType": "pict"
                                       },
                                       {
                                           "reportedUser.email": {
                                               $not: {
                                                   $regex: email
                                               }
                                           }
                                       },
                                       
                                   ]
                               },
                               
                           },
                           {
                               $set: {
                                   scorePict: {
                                       $meta: "textScore"
                                   }
                               }
                           },
                           {
                               $project: {
                                   mediaSource:1,
                                   "boosted": 
                                   {
                                       $cond: {
                                           if : {
                                               $gt: [{
                                                   "$dateToString": {
                                                       "format": "%Y-%m-%d %H:%M:%S",
                                                       "date": {
                                                           $add: [new Date(), 25200000]
                                                       }
                                                   }
                                               }, "$boosted.boostSession.timeEnd"]
                                           },
                                           then: [],
                                           else : '$boosted'
                                       }
                                   },
                                   "reportedStatus": 1,
                                   "insight": {
                                       "shares": "$shares",
                                       "comments": "$comments",
                                       "views": "$views",
                                       "likes": "$likes",
                                       
                                   },
                                    "views": "$views",
                                   "comments": "$comments",
                                   "likes": "$likes",
                                   "scorePict": 1,
                                   "_id": 1,
                                   "postID": 1,
                                   "createdAt": 1,
                                   "updatedAt": 1,
                                   "email": 1,
                                   "postType": 1,
                                   "description": 1,
                                   "active": 1,
                                   "metadata": 1,
                                   "location": 1,
                                   "isOwned": 1,
                                   "visibility": 1,
                                   "isViewed": 1,
                                   "allowComments": 1,
                                   "saleAmount": 1,
                                   
                               }
                           },
                           {
                                 $sort: {
                                     scorePict: - 1,
                                     comments: - 1,
                                     likes: - 1,
                                     views:  -1
                                 }
                             },
                             {
                              $skip: skip
                            },
                            {
                              $limit: limit
                            },
                       ],
                       as: "pict"
                   },
                   
               },
             
               {
                   $unwind: {
                       path: "$pict",
                       preserveNullAndEmptyArrays: true
                   }
               },
               
               {
                   $project: {
                       "scorePict": "$pict.scorePict",
                       "boosted": "$pict.boosted",
                       "reportedStatus": "$pict.reportedStatus",
                       "_id": "$pict._id",
                       "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                       {
                           "$concat": ["/thumb/", "$pict.postID"]
                       },
                       mediaEndpoint:{
                        "$cond":
                        {
                            if:
                            {
                                "$eq":
                                    [
                                      "$pict.postType", "pict"
                                    ]
                            },
                            then:
                            {
                                "$concat":
                                    [
                                        "/pict/",
                                        "$pict.postID"
                                    ]
                            },
                            else:
                            {
                                "$concat":
                                    [
                                        "/stream/",
                                        "$pict.postID"
                                    ]
                            }
                        }
                    },
                       "mediaType": {
                           $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                       },
                       "createdAt": "$pict.createdAt",
                       "updatedAt": "$pict.updatedAt",
                       "postID": "$pict.postID",
                       "email": "$pict.email",
                       "postType": "$pict.postType",
                       "description": "$pict.description",
                       "active": "$pict.active",
                       "metadata": "$pict.metadata",
                       "location": "$pict.location",
                       "isOwned": "$pict.isOwned",
                       "visibility": "$pict.visibility",
                       "isViewed": "$pict.isViewed",
                       "allowComments": "$pict.allowComments",
                       "saleAmount": "$pict.saleAmount",
                       "monetize": 
                       {
                           $cond: {
                               if : {
                                   $gte: ["$pict.saleAmount", 1]
                               },
                               then: true,
                               else : "$taslimKONAG"
                           }
                       },
                       "comments": "$pict.comments",
                       "likes": "$pict.likes",
                       "insight": 
                       {
                           $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                       },
                       "apsaraId": {
                           $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                       },
                       "isApsara": {
                           $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                       },
                       "viewed": "$pict.insight.views",
                   }
               },
               {
                   $sort: {
                       scorePict: - 1,
                       comments: - 1,
                       likes: - 1,
                       viewed:  -1
                   }
               },
               
           ],
           "vid": 
           [
               {
                   $lookup: {
                       from: "newPosts",
                       pipeline: [
                           {
                               $match: 
                               {
                                   $and: [
                                       {
                                           $text: {
                                               $search: key,
                                               
                                           }
                                       },
                                       {
                                           "reportedStatus": {
                                               $ne: "OWNED"
                                           }
                                       },
                                       {
                                           "visibility": "PUBLIC"
                                       },
                                       {
                                           "active": true
                                       },
                                       {
                                           "postType": "vid"
                                       },
                                       {
                                           "reportedUser.email": {
                                               $not: {
                                                   $regex: email
                                               }
                                           }
                                       },
                                       
                                   ]
                               },
                               
                           },
                           {
                               $set: {
                                   scorePict: {
                                       $meta: "textScore"
                                   }
                               }
                           },
                           {
                               $project: {
                                   mediaSource:1,
                                   "boosted": 
                                   {
                                       $cond: {
                                           if : {
                                               $gt: [{
                                                   "$dateToString": {
                                                       "format": "%Y-%m-%d %H:%M:%S",
                                                       "date": {
                                                           $add: [new Date(), 25200000]
                                                       }
                                                   }
                                               }, "$boosted.boostSession.timeEnd"]
                                           },
                                           then: [],
                                           else : '$boosted'
                                       }
                                   },
                                   "reportedStatus": 1,
                                   "insight": {
                                       "shares": "$shares",
                                       "comments": "$comments",
                                       "views": "$views",
                                       "likes": "$likes",
                                       
                                   },
                                    "views": "$views",
                                   "comments": "$comments",
                                   "likes": "$likes",
                                   "scorePict": 1,
                                   "_id": 1,
                                   "postID": 1,
                                   "createdAt": 1,
                                   "updatedAt": 1,
                                   "email": 1,
                                   "postType": 1,
                                   "description": 1,
                                   "active": 1,
                                   "metadata": 1,
                                   "location": 1,
                                   "isOwned": 1,
                                   "visibility": 1,
                                   "isViewed": 1,
                                   "allowComments": 1,
                                   "saleAmount": 1,
                                   
                               }
                           },
                           {
                                 $sort: {
                                     scorePict: - 1,
                                     comments: - 1,
                                     likes: - 1,
                                     views:  -1
                                 }
                             },
                             {
                                 $skip: skip
                             },
                             {
                                 $limit: limit
                             },
                       ],
                       as: "pict"
                   },
                   
               },
             
               {
                   $unwind: {
                       path: "$pict",
                       preserveNullAndEmptyArrays: true
                   }
               },
               
               {
                   $project: {
                       "scorePict": "$pict.scorePict",
                       "boosted": "$pict.boosted",
                       "reportedStatus": "$pict.reportedStatus",
                       "_id": "$pict._id",
                       "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                       {
                           "$concat": ["/thumb/", "$pict.postID"]
                       },
                       mediaEndpoint:{
                        "$cond":
                        {
                            if:
                            {
                                "$eq":
                                    [
                                      "$pict.postType", "pict"
                                    ]
                            },
                            then:
                            {
                                "$concat":
                                    [
                                        "/pict/",
                                        "$pict.postID"
                                    ]
                            },
                            else:
                            {
                                "$concat":
                                    [
                                        "/stream/",
                                        "$pict.postID"
                                    ]
                            }
                        }
                    },
                       "mediaType": {
                           $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                       },
                       "createdAt": "$pict.createdAt",
                       "updatedAt": "$pict.updatedAt",
                       "postID": "$pict.postID",
                       "email": "$pict.email",
                       "postType": "$pict.postType",
                       "description": "$pict.description",
                       "active": "$pict.active",
                       "metadata": "$pict.metadata",
                       "location": "$pict.location",
                       "isOwned": "$pict.isOwned",
                       "visibility": "$pict.visibility",
                       "isViewed": "$pict.isViewed",
                       "allowComments": "$pict.allowComments",
                       "saleAmount": "$pict.saleAmount",
                       "monetize": 
                       {
                           $cond: {
                               if : {
                                   $gte: ["$pict.saleAmount", 1]
                               },
                               then: true,
                               else : "$taslimKONAG"
                           }
                       },
                       "comments": "$pict.comments",
                       "likes": "$pict.likes",
                       "insight": 
                       {
                           $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                       },
                       "apsaraId": {
                           $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                       },
                       "isApsara": {
                           $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                       },
                       "viewed": "$pict.insight.views",
                   }
               },
               {
                   $sort: {
                       scorePict: - 1,
                       comments: - 1,
                       likes: - 1,
                       viewed:  -1
                   }
               },
               
           ],

           "diary": 
           [
               {
                   $lookup: {
                       from: "newPosts",
                       pipeline: [
                           {
                               $match: 
                               {
                                   $and: [
                                       {
                                           $text: {
                                               $search: key,
                                               
                                           }
                                       },
                                       {
                                           "reportedStatus": {
                                               $ne: "OWNED"
                                           }
                                       },
                                       {
                                           "visibility": "PUBLIC"
                                       },
                                       {
                                           "active": true
                                       },
                                       {
                                           "postType": "diary"
                                       },
                                       {
                                           "reportedUser.email": {
                                               $not: {
                                                   $regex: email
                                               }
                                           }
                                       },
                                       
                                   ]
                               },
                               
                           },
                           {
                               $set: {
                                   scorePict: {
                                       $meta: "textScore"
                                   }
                               }
                           },
                           {
                               $project: {
                                   mediaSource:1,
                                   "boosted": 
                                   {
                                       $cond: {
                                           if : {
                                               $gt: [{
                                                   "$dateToString": {
                                                       "format": "%Y-%m-%d %H:%M:%S",
                                                       "date": {
                                                           $add: [new Date(), 25200000]
                                                       }
                                                   }
                                               }, "$boosted.boostSession.timeEnd"]
                                           },
                                           then: [],
                                           else : '$boosted'
                                       }
                                   },
                                   "reportedStatus": 1,
                                   "insight": {
                                       "shares": "$shares",
                                       "comments": "$comments",
                                       "views": "$views",
                                       "likes": "$likes",
                                       
                                   },
                                    "views": "$views",
                                   "comments": "$comments",
                                   "likes": "$likes",
                                   "scorePict": 1,
                                   "_id": 1,
                                   "postID": 1,
                                   "createdAt": 1,
                                   "updatedAt": 1,
                                   "email": 1,
                                   "postType": 1,
                                   "description": 1,
                                   "active": 1,
                                   "metadata": 1,
                                   "location": 1,
                                   "isOwned": 1,
                                   "visibility": 1,
                                   "isViewed": 1,
                                   "allowComments": 1,
                                   "saleAmount": 1,
                                   
                               }
                           },
                           {
                                 $sort: {
                                     scorePict: - 1,
                                     comments: - 1,
                                     likes: - 1,
                                     views:  -1
                                 }
                             },
                             {
                                 $skip:skip
                             },
                             {
                                 $limit: limit
                             },
                       ],
                       as: "pict"
                   },
                   
               },
             
               {
                   $unwind: {
                       path: "$pict",
                       preserveNullAndEmptyArrays: true
                   }
               },
               
               {
                   $project: {
                       "scorePict": "$pict.scorePict",
                       "boosted": "$pict.boosted",
                       "reportedStatus": "$pict.reportedStatus",
                       "_id": "$pict._id",
                       "mediaThumbEndpoint": //{ $arrayElemAt: ['$pict.mediaSource.mediaThumbEndpoint', 0] },
                       {
                           "$concat": ["/thumb/", "$pict.postID"]
                       },
                       mediaEndpoint:{
                        "$cond":
                        {
                            if:
                            {
                                "$eq":
                                    [
                                      "$pict.postType", "pict"
                                    ]
                            },
                            then:
                            {
                                "$concat":
                                    [
                                        "/pict/",
                                        "$pict.postID"
                                    ]
                            },
                            else:
                            {
                                "$concat":
                                    [
                                        "/stream/",
                                        "$pict.postID"
                                    ]
                            }
                        }
                    },
                       "mediaType": {
                           $arrayElemAt: ['$pict.mediaSource.mediaType', 0]
                       },
                       "createdAt": "$pict.createdAt",
                       "updatedAt": "$pict.updatedAt",
                       "postID": "$pict.postID",
                       "email": "$pict.email",
                       "postType": "$pict.postType",
                       "description": "$pict.description",
                       "active": "$pict.active",
                       "metadata": "$pict.metadata",
                       "location": "$pict.location",
                       "isOwned": "$pict.isOwned",
                       "visibility": "$pict.visibility",
                       "isViewed": "$pict.isViewed",
                       "allowComments": "$pict.allowComments",
                       "saleAmount": "$pict.saleAmount",
                       "monetize": 
                       {
                           $cond: {
                               if : {
                                   $gte: ["$pict.saleAmount", 1]
                               },
                               then: true,
                               else : "$taslimKONAG"
                           }
                       },
                       "comments": "$pict.comments",
                       "likes": "$pict.likes",
                       "insight": 
                       {
                           $ifNull: ["$pict.insight", "$TaslimKAMPRET"]
                       },
                       "apsaraId": {
                           $arrayElemAt: ['$pict.mediaSource.apsaraId', 0]
                       },
                       "isApsara": {
                           $arrayElemAt: ['$pict.mediaSource.apsara', 0]
                       },
                       "viewed": "$pict.insight.views",
                   }
               },
               {
                   $sort: {
                       scorePict: - 1,
                       comments: - 1,
                       likes: - 1,
                       viewed:  -1
                   }
               },
               
           ],
          },

        },
        {
          $project: {

            pict: "$pict",
            vid: "$vid",
            diary: "$diary",


          }
        });
    }
    const query = await this.loaddata.aggregate(pipeline);
    return query;
  }

  async landingpageMigration(email: string, emailLogin: string, type: string, skip: number, limit: number) {
    var mongo = require('mongoose');
    var pipeline = [];
    if (email == emailLogin) {
      pipeline.push(
        {
          "$match": {
            "$and": [
              {
                "active": true
              },
              {
                "postType": type
              },
              {
                "email": email
              },
              {
                "$or": [
                  {
                    "reportedUser": {
                      "$elemMatch": {
                        "email": email,
                        "active": false
                      }
                    }
                  },
                  {
                    "reportedUser.email": {
                      "$not": {
                        "$regex": email
                      }
                    }
                  }
                ]
              }
            ]
          }
        },
      );
    } else {
      pipeline.push(
        {
          "$match": {
            "$and": [
              {
                "active": true
              },
              {
                "postType": type
              },
              {
                "email": email
              },
              {
                "reportedStatus": {
                  $ne: "OWNED"
                }
              },
              {
                "$or": [
                  {
                    "reportedUser": {
                      "$elemMatch": {
                        "email": emailLogin,
                        "active": false
                      }
                    }
                  },
                  {
                    "reportedUser.email": {
                      "$not": {
                        "$regex": emailLogin
                      }
                    }
                  }
                ]
              }
            ]
          }
        },
      );
    }

    pipeline.push(
      {
        $sort: {
          createdAt: - 1,
        }
      },
      {
        $skip: ((skip - 1) * limit)
      },
      {
        $limit: limit
      },
      {
        "$lookup": {
          from: "disquslogs",
          let: {
            localID: '$postID',
          },
          as: "comment",
          pipeline: [
            {
              $match:
              {
                $and: [
                  {
                    $expr: {
                      $eq: ['$postID', '$$localID']
                    }
                  },
                  {
                    "active": {
                      $ne: false
                    }
                  },
                ]
              }
            },
            {
              "$lookup": {
                from: "newUserBasics",
                as: "userComment",
                let: {
                  localID: '$sender'
                },
                pipeline: [
                  {
                    $match:
                    {
                      $expr: {
                        $eq: ['$email', '$$localID']
                      }
                    }
                  },
                  {
                    $project: {
                      "username": 1
                    }
                  }
                ],
              }
            },
            {
              $unwind: {
                path: "$userComment"
              }
            },
            {
              $sort: {
                createdAt: - 1
              }
            },

          ]
        },
      },
      {
        "$lookup":
        {
          from:"newUserBasics",
          localField:"email",
          foreignField:"email",
          as:"userBasic"
        }
      },
      {
        "$lookup": {
          from: "mediamusic",
          as: "music",
          let: {
            localID: '$musicId'
          },
          pipeline: [
            {
              $match:
              {
                $expr: {
                  $eq: ['$_id', '$$localID']
                }
              }
            },
            //lookup dengan genre, theme dan mood
            {
              "$lookup":
              {
                from: "genre",
                localField: "genre",
                foreignField: "_id",
                as: "genre_data"
              }
            },
            {
              "$lookup":
              {
                from: "theme",
                localField: "theme",
                foreignField: "_id",
                as: "theme_data"
              }
            },
            {
              "$lookup":
              {
                from: "mood",
                localField: "mood",
                foreignField: "_id",
                as: "mood_data"
              }
            },
            {
              $project: {
                "musicTitle": 1,
                "artistName": 1,
                "albumName": 1,
                "apsaraMusic": 1,
                "apsaraThumnail": 1,
                "genre":
                {
                  "$arrayElemAt":
                    [
                      "$genre_data.name", 0
                    ]
                },
                "theme":
                {
                  "$arrayElemAt":
                    [
                      "$theme_data.name", 0
                    ]
                },
                "mood":
                {
                  "$arrayElemAt":
                    [
                      "$mood_data.name", 0
                    ]
                },
              }
            },
          ],
        }
      },
      {
        "$lookup": {
          from: "newUserBasics",
          as: "userTag",
          let: {
            localID: '$tagPeople.$id',
            localID2: '$tagPeople'
          },
          pipeline: [
            {
              $match:
              {
                $or: [
                  {
                    $expr: {
                      $in: ['$_id', "$$localID2"]
                    }
                  },
                  {
                    $expr: {
                      $in: ['$_id', "$$localID"]
                    }
                  },
                  {
                    $expr: {
                      $in: ['$_idAuth', "$$localID"]
                    }
                  },

                ]
              },

            },
            {
              $project: {
                "_id": 1,
                "username": 1,
                "email":1,
                "avatar":
                {
                  "$ifNull":
                  [
                    {
                      "mediaBasePath": "$mediaBasePath",
                      "mediaUri": "$mediaUri",
                      "originalName": "$originalName",
                      "fsSourceUri": "$fsSourceUri",
                      "fsSourceName": "$fsSourceName",
                      "fsTargetUri": "$fsTargetUri",
                      "mediaType": "$mediaType",
                      "mediaEndpoint": "$mediaEndpoint",
                    },
                    null
                  ]
                },
                "urluserBadge":
                {
                  "$ifNull":
                    [
                      {
                        "$arrayElemAt":
                          [
                            {
                              "$filter":
                              {
                                input: "$userBadge",
                                as: "listbadge",
                                cond:
                                {
                                  "$and":
                                    [
                                      {
                                        "$eq":
                                          [
                                            "$$listbadge.isActive", true
                                          ]
                                      },
                                      {
                                        "$lte":
                                          [
                                            {
                                              "$dateToString": {
                                                "format": "%Y-%m-%d %H:%M:%S",
                                                "date": {
                                                  "$add": [
                                                    new Date(),
                                                    25200000
                                                  ]
                                                }
                                              }
                                            },
                                            "$$listbadge.endDatetime"
                                          ]
                                      }
                                    ]
                                }
                              }
                            }, 0
                          ]
                      },
                      []
                    ]
                  },
              }
            },
            {
              "$project":
              {
                "_id": 1,
                "username": 1,
                "email":1,
                "avatar": 1,
                "urluserBadge":
                {
                  "$ifNull":
                  [
                    {
                      "$arrayElemAt":
                      [
                        "$urluserBadge", 0
                      ]
                    },
                    null
                  ]
                }
              }
            }
          ],

        }
      },
      {
        '$lookup': {
            from: 'interests_repo',
            as: 'cats',
            let: {
                localID: '$category.$id'
            },
            pipeline: [
                {
                    '$match': {
                        '$expr': {
                            '$and': [
                                {
                                    '$in': ['$_id', {
                                        '$ifNull': ['$$localID', []]
                                    }]
                                }
                            ]
                        }
                    }
                },
                {
                    '$project': {
                        interestName: 1,
                        langIso: 1,
                        icon: 1,
                        createdAt: 1,
                        updatedAt: 1
                    }
                }
            ]
        }
      },
      {
        "$lookup": {
          "from": "settings",
          "as": "setting",
          "pipeline": [
            {
              "$match": {
                "$or": [
                  {
                    "_id": new mongo.Types.ObjectId("62bbdb4ba7520000050077a7")
                  },
                  {
                    "_id": new mongo.Types.ObjectId("64d06e5c451e0000bd006c62")
                  },
                  {
                    "_id": new mongo.Types.ObjectId("645da79c295b0000520048c2")
                  }
                ]
              }
            }
          ]
        }
      },
      {
        "$addFields":
        {
          "cleanUri":
            {
              "$cond":
              {
              if:
              {
                  "$eq":
                  [
                      {
                        "$arrayElemAt":
                          [
                          "$mediaSource.apsara", 0
                          ]
                      },
                      true
                  ]
              },
              then: "$postID",
              else:
              {
                  "$substr":
                  [
                      {
                      "$arrayElemAt":
                          [
                          "$mediaSource.mediaUri", 0
                          ]
                      },
                      0,
                      36
                  ]
              }
              }
          },
          "tempboost":
          {
            $filter: {
              input: "$boosted",
              as: "item",
              cond: {
                $gte: [
                  "$$item.boostSession.end",
                  {
                    "$dateToString": {
                      "format": "%Y-%m-%d %H:%M:%S",
                      "date": {
                        $add: [new Date(), 25200000]
                      }
                    }
                  } 
                ]
              }
            }
          },
          "isLiked":
          {
            "$ifNull":
              [
                {
                  "$filter":
                  {
                    input: "$userLike",
                    as: "list",
                    cond:
                    {
                      $eq:
                        [
                          "$$list", emailLogin
                        ]
                    }
                  }
                },
                []
              ]
          },
        },
      },
      { 
        "$project" : 
        {
          version: {
              '$arrayElemAt': ['$setting.value', 0]
          },
          "postID": 1,
          "tagPeople": "$userTag",
          "mediaType": 1,
          "postType": 1,
          "description": 1,
          "active": 1,
          "createdAt": 1,
          "updatedAt": 1,
          "expiration": 1,
          "visibility": 1,
          "location": 1,
          "tags": 1,
          "allowComments": 1,
          "isSafe": 1,
          "isOwned": 1,
          "certified": 1,
          "saleAmount": 1,
          "saleLike": 1,
          "saleView": 1,
          "isShared": 1,
          "likes": 1,
          "views": 1,
          "shares": 1,
          "userView": 1,
          "userLike": 1,
          "uploadSource": {
            $arrayElemAt: ["$uploadSource.uploadSource", 0]
          },
          comments: {
            $cond: {
              if: {
                $eq: ["$comment", []]
              },
              then: 0,
              else: {
                $size: "$comment"
              }
            }
          },
          email: 1,
          viewer: 1,
          viewerCount: 1,
          oldDate: "$oldDate",
          selfContent: 1,
          official:
          {
            $cond: {
              if: {
                $eq: ["$email", "hyppers@hyppe.id"]
              },
              then: 1,
              else: 0
            }
          },
          music:
          {
            "$cond":
            {
              if:
              {
                "$eq":
                [
                  "$music",
                  []
                ]
              },
              then:null,
              else:
              {
                "musicTitle": {
                  $arrayElemAt: ["$music.musicTitle", 0]
                },
                "artistName": {
                  $arrayElemAt: ["$music.artistName", 0]
                },
                "albumName": {
                  $arrayElemAt: ["$music.albumName", 0]
                },
                "apsaraMusic": {
                  $arrayElemAt: ["$music.apsaraMusic", 0]
                },
                "apsaraThumnail": {
                  $arrayElemAt: ["$music.apsaraThumnail", 0]
                },
                "genre": {
                  $arrayElemAt: ["$music.genre", 0]
                },
                "theme": {
                  $arrayElemAt: ["$music.theme", 0]
                },
                "mood": {
                  $arrayElemAt: ["$music.mood", 0]
                },
              }
            }
          },
          comment: "$comment",
          interest: "$categoryInt",
          friends: {
            $arrayElemAt: ["$friend.friend", 0]
          },
          "insight":
          {
            "likes": "$likes",
            "views": "$views",
            "shares": "$shares",
            "comments": "$comments",

          },
          "userProfile": "$userProfile",
          "contentMedias": "$contentMedias",
          "cats": "$cats",
          "tagDescription": "$tagDescription",
          "metadata": "$metadata",
          "boostDate": "$boostDate",
          "end": "$tempboost.boostSession.end",
          "start": "$tempboost.boostSession.start",
          "isBoost": "$isBoost",
          "datenow": "$datenow",
          "tempboost":1,
          "boostJangkauan":{
            "$size": "$tempboost.boostViewer"
          },
          "boostViewer": {
            $arrayElemAt: ["$tempboost.boostViewer", 0]
          },
          "boostCount": 1,
          "boosted":"$tempboost",
          "statusBoost":
          {
            $switch: {
              branches: [
                {
                  case: {
                    $and: [{
                      $lte: [{
                        $arrayElemAt: ["$tempboost.boostSession.start", 0]
                      }, {
                        "$dateToString": {
                          "format": "%Y-%m-%d %H:%M:%S",
                          "date": {
                            $add: [new Date(), 25200000]
                          }
                        }
                      }]
                    }, {
                      $gte: [{
                        $arrayElemAt: ["$tempboost.boostSession.end", 0]
                      }, {
                        "$dateToString": {
                          "format": "%Y-%m-%d %H:%M:%S",
                          "date": {
                            $add: [new Date(), 25200000]
                          }
                        }
                      }] }] }, then: "BERLANGSUNG" },
                { case: { $and: [{ $gte: [{
                  $arrayElemAt: ["$tempboost.boostSession.start", 0]
                      }, {
                    "$dateToString": {
                      "format": "%Y-%m-%d %H:%M:%S",
                      "date": {
                        $add: [new Date(), 25200000]
                      }
                    }
                }]
                }, {
                  $gte: [{
                    $arrayElemAt: ["$tempboost.boostSession.end", 0]
                  }, {
                    "$dateToString": {
                      "format": "%Y-%m-%d %H:%M:%S",
                      "date": {
                        $add: [new Date(), 25200000]
                      }
                    }
                  }] }] }, then: "AKAN DATANG" }
              ],
              "default": "SELESAI"
            }
          },
          "contentModeration": "$contentModeration",
          "reportedStatus": "$reportedStatus",
          "reportedUserCount": "$reportedUserCount",
          "contentModerationResponse": "$contentModerationResponse",
          "reportedUser": "$reportedUser",
          "timeStart": "$timeStart",
          "timeEnd": "$timeEnd",
          "stiker": "$stiker",
          "apsaraId": {
            $arrayElemAt: ["$mediaSource.apsaraId", 0]
          },
          "isApsara": {
            $arrayElemAt: ["$mediaSource.apsara", 0]
          },
          "apsaraThumbId": {
            $arrayElemAt: ["$mediaSource.apsaraThumbId", 0]
          },
          "mediaEndpoint": {
              "$cond":
              {
                  if:
                  {
                      "$eq":
                      [
                          "$postType", "pict"
                      ]
                  },
                  then:
                  {
                      "$concat":
                      [
                          "/pict/",
                          "$cleanUri"
                      ]
                  },
                  else:
                  {
                      "$concat":
                      [
                          "/stream/",
                          "$cleanUri"
                      ]
                  }
              }
          },
          "mediaUri": {
            $arrayElemAt: ["$mediaSource.mediaUri", 0]
          },
          "mediaThumbEndpoint": {
            "$ifNull":
            [
              {
                $arrayElemAt: ["$mediaSource.mediaThumbEndpoint", 0]
              },
              {
                "$concat":
                [
                  "/thumb/",
                  "$postID"
                ]
              }
            ]
          },
          "mediaThumbUri": {
            $arrayElemAt: ["$mediaSource.mediaThumbUri", 0]
          },
          "fullName": {
            $arrayElemAt: ["$userBasic.fullName", 0]
          },
          "username": {
            $arrayElemAt: ["$userBasic.username", 0]
          },
          "avatar":
          {
            "mediaBasePath": { $arrayElemAt: ["$userBasic.mediaBasePath", 0] },
            "mediaUri": { $arrayElemAt: ["$userBasic.mediaUri", 0] },
            "originalName": { $arrayElemAt: ["$userBasic.originalName", 0] },
            "fsSourceUri": { $arrayElemAt: ["$userBasic.fsSourceUri", 0] },
            "fsSourceName": { $arrayElemAt: ["$userBasic.fsSourceName", 0] },
            "fsTargetUri": { $arrayElemAt: ["$userBasic.fsTargetUri", 0] },
            "mediaType": { $arrayElemAt: ["$userBasic.mediaType", 0] },
            "mediaEndpoint": { $arrayElemAt: ["$userBasic.mediaEndpoint", 0] },
          },
          "privacy": {
            "isCelebrity": {
              $arrayElemAt: ["$userBasic.isCelebrity", 0]
            },
            "isIdVerified": {
              $arrayElemAt: ["$userBasic.isIdVerified", 0]
            },
            "isPrivate": {
              $arrayElemAt: ["$userBasic.isPrivate", 0]
            },
            "isFollowPrivate": {
              $arrayElemAt: ["$userBasic.isFollowPrivate", 0]
            },
            "isPostPrivate": {
              $arrayElemAt: ["$userBasic.isPostPrivate", 0]
            },

          },
          "verified": {
            $arrayElemAt: ["$userBasic.fullName", 0]
          },
          "urluserBadge":
          {
            "$ifNull":
              [
                {
                  "$filter":
                  {
                    input: {
                      $arrayElemAt: ["$userBasic.userBadge", 0]
                    },
                    as: "listbadge",
                    cond:
                    {
                      "$and":
                        [
                          {
                            "$eq":
                              [
                                "$$listbadge.isActive",
                                true
                              ]
                          },
                          {
                            "$lte": [
                              {
                                "$dateToString": {
                                  "format": "%Y-%m-%d %H:%M:%S",
                                  "date": {
                                    "$add": [
                                      new Date(),
                                      25200000
                                    ]
                                  }
                                }
                              },
                              "$$listbadge.endDatetime"
                            ]
                          }
                        ]
                    }
                  }
                },
                null
              ]
          },
          mailViewer: "$mailViewer",
          userInterested: {
            $arrayElemAt: ["$userBasic.userInterests.$id", 0]
          },
          tutor: {
            $arrayElemAt: ["$userBasic.tutor", 0]
          },
          "isLiked":
          {
            "$cond":
            {
              if:
              {
                "$eq":
                  [
                    {
                      "$size": "$isLiked"
                    },
                    0
                  ]
              },
              then: false,
              else: true
            }
          },
        }
      },
    );

    // var util = require('util');
    // console.log(util.inspect(pipeline, { depth: null, showHidden: false }));

    var data = await this.loaddata.aggregate(pipeline);
    return data;
  }

  //punya mas yose
  async updateBoostViewer(id: string, email: string) {
    console.log("post id: " + id);
    this.loaddata.findOne({ _id: id }).exec().then((ps) => {
      if (ps != null) {
        console.log("post boost: " + ps.postID);
        let bs = ps.boosted;
        if (bs != undefined) {
          for (let i = 0; i < bs.length; i++) {
            let bbs = bs[i];
            if (bbs.boostSession != undefined) {
              let bootSession = bbs.boostSession;
              let today = new Date().getTime();
              let st = new Date(String(bootSession.start)).getTime();
              let ed = new Date(String(bootSession.end)).getTime();

              if (st <= today && ed >= today) {
                let interval = Number(bbs.boostInterval.value);
                interval = interval * 60 * 1000;
                let a = (today - st);
                console.log("today: " + a + " interval: " + interval);
                let c = Math.ceil(a / interval);
                console.log("round today: " + c);
                let d = st + (interval * c);

                //let ted = d + (7 * 3600 * 1000);
                let ted = d;

                let td = new Date(ted);
                let stoday = new Date(td.getTime() - (td.getTimezoneOffset() * 60000)).toISOString().replace('T', ' ');
                stoday = stoday.substring(0, 19);
                console.log(st + " " + d + " " + ted + " " + stoday);

                let tdx = new Date(today);
                let xtoday = new Date(tdx.getTime() - (tdx.getTimezoneOffset() * 60000)).toISOString().replace('T', ' ');
                xtoday = xtoday.substring(0, 19);

                let bv: any[] = bbs.boostViewer;
                if (bv != undefined) {
                  if (bv.length > 0) {
                    for (let x = 0; x < bv.length; x++) {
                      let bbv = bv[x];
                      if (String(bbv.email) == email) {
                        if (bbv.isLast == true) {
                          bbv.isLast = false;
                        }
                      }
                    }

                    let o = {
                      email: email,
                      createAt: xtoday,
                      timeEnd: stoday,
                      isLast: true
                    };

                    bv.push(o);
                  } else {
                    let o = {
                      email: email,
                      createAt: xtoday,
                      timeEnd: stoday,
                      isLast: true
                    };

                    bv.push(o);
                  }
                }
              }
            }

          }

          console.log(JSON.stringify(bs));

          this.loaddata.updateOne(
            {
              "_id": id,
            },
            {
              $set: {
                "boosted": bs
              }
            },
            function (err, docs) {
              if (err) {
                console.log(err);
              } else {
                console.log(docs);
              }
            }
          );
        }
      }
    });
  }

  async updateBoostCount(id: string, countBoost: number) {
    let data = await this.loaddata.updateOne({ "_id": id },
      {
        $set: {
          "boostCount": countBoost,
        },

      });
    return data;
  }

  async getpostquery(email: string, search: string, visibility: string, postids: string, tipepost: string, activestatus: string, exptime: string, page: number, skip: number, insight: string, sorttime: string) {
    var pipeline = [];
    var postmatch = [];

    var sortingdata = null;
    if (sorttime == 'true') {
      sortingdata = -1;
    }
    else {
      sortingdata = 1;
    }

    if (tipepost != null && tipepost != undefined) {
      postmatch.push(
        {
          "postType": tipepost
        }
      );
    }

    if (activestatus != null && activestatus != undefined) {
      if (activestatus == "true") {
        postmatch.push(
          {
            "active": true
          }
        );
      }
      else {
        postmatch.push(
          {
            "active": false
          }
        );
      }
    }

    if (exptime != null && exptime != undefined && exptime == 'true') {
      pipeline.push(
        {
          "$set":
          {
            "yesterday":
            {
              "$dateToString": {
                "format": "%Y-%m-%d %H:%M:%S",
                "date": {
                  $add: [
                    new Date(),
                    -61200000
                  ]
                }
              }
            },
          }
        }
      );

      postmatch.push(
        {
          "$expr":
          {
            "$gte":
              [
                "$createdAt", "$yesterday"
              ]
          }
        },
      );
    }

    if (postids != null && postids != undefined) {
      postmatch.push(
        {
          "postID": postids
        }
      );
    }

    if (visibility != null && visibility != undefined && visibility == "PRIVATE" && search == email) {
      postmatch.push(
        {
          "email": email
        }
      );
    }
    else {
      postmatch.push(
        {
          "$or":
            [
              {
                "$and":
                  [
                    {
                      "reportedUser.email": email
                    },
                    {
                      "reportedUser.active": false
                    },
                  ]
              },
              {
                "reportedUser.email":
                {
                  $not:
                  {
                    $regex: email
                  }
                }
              },
            ]
        },
      );
    }

    if (search != null && search != undefined && search != email && search != "") {
      postmatch.push(
        {
          "email": search
        }
      );
    }

    pipeline.push(
      {
        "$match":
        {
          "$and": postmatch
        }
      },
      {
        "$sort":
        {
          "createdAt": sortingdata
        }
      }
    );

    if(postids == null || postids == undefined)
    {
      if (skip != null && skip != undefined && page != null && page != undefined) {
        pipeline.push(
          {
            "$skip": (skip * page)
          },
          {
            "$limit": page
          },
        );
      }
    }

    pipeline.push(
      {
        "$set":
        {
          "cleanUri":
          {
            "$cond":
            {
              if:
              {
                "$eq":
                  [
                    {
                      "$arrayElemAt":
                        [
                          "$mediaSource.apsara", 0
                        ]
                    },
                    true
                  ]
              },
              then: null,
              else:
              {
                "$substr":
                  [
                    {
                      "$arrayElemAt":
                        [
                          "$mediaSource.mediaUri", 0
                        ]
                    },
                    0,
                    36
                  ]
              }
            }
          },
          "tempmediaSource":
          {
            "$arrayElemAt":
              [
                "$mediaSource", 0
              ]
          },
        }
      },
      {
        "$project":
        {
          "postID": 1,
          "certified": 1,
          "metadata": 1,
          "category": 1,
          "email": 1,
          "active": 1,
          "createdAt": 1,
          "updatedAt": 1,
          "description": 1,
          "stiker": 1,
          "location": 1,
          "isShared": 1,
          "visibility": 1,
          "allowComments": 1,
          "postType": 1,
          "isLiked":
          {
            "$ifNull":
              [
                {
                  "$filter":
                  {
                    input: "$userLike",
                    as: "list",
                    cond:
                    {
                      $eq:
                        [
                          "$$list", email
                        ]
                    }
                  }
                },
                []
              ]
          },
          "isViewed":
          {
            "$ifNull":
              [
                {
                  "$filter":
                  {
                    input: "$userLike",
                    as: "list",
                    cond:
                    {
                      $eq:
                        [
                          "$$list", email
                        ]
                    }
                  }
                },
                []
              ]
          },
          "insight":
          {
            "likes":
            {
              "$ifNull":
                [
                  "$likes",
                  0
                ]
            },
            "views":
            {
              "$ifNull":
                [
                  "$views",
                  0
                ]
            },
            "shares":
            {
              "$ifNull":
                [
                  "$shares",
                  0
                ]
            },
            "comments":
            {
              "$ifNull":
                [
                  "$comments",
                  0
                ]
            },
          },
          "reportedStatus": 1,
          "saleAmount": 1,
          "saleLike": 1,
          "saleView": 1,
          isApsara:
          {
            "$ifNull":
              [
                "$tempmediaSource.apsara",
                false
              ]
          },
          apsaraId:
          {
            "$ifNull":
              [
                "$tempmediaSource.apsaraId",
                null
              ]
          },
          mediaBasePath:
          {
            "$ifNull":
              [
                "$tempmediaSource.mediaBasePath",
                null
              ]
          },
          mediaUri:
          {
            "$ifNull":
              [
                "$tempmediaSource.mediaUri",
                null
              ]
          },
          mediaType:
          {
            "$ifNull":
              [
                "$tempmediaSource.mediaType",
                null
              ]
          },
          mediaMime:
          {
            "$ifNull":
              [
                "$tempmediaSource.mediaMime",
                null
              ]
          },
          mediaThumbEndpoint:
          {
            "$ifNull":
              [
                "$tempmediaSource.mediaThumbEndpoint",
                {
                  "$concat":
                    [
                      "/thumb/",
                      "$cleanUri"
                    ]
                }
              ]
          },
          mediaEndpoint:
          {
            "$ifNull":
              [
                "$tempmediaSource.mediaEndpoint",
                {
                  "$cond":
                  {
                    if:
                    {
                      "$eq":
                        [
                          "$tempmediaSource.mediaType", "image"
                        ]
                    },
                    then:
                    {
                      "$concat":
                        [
                          "/pict/",
                          "$cleanUri"
                        ]
                    },
                    else:
                    {
                      "$concat":
                        [
                          "/stream/",
                          "$cleanUri"
                        ]
                    }
                  }
                }
              ]
          },
          mediaThumbUri:
          {
            "$ifNull":
              [
                "$tempmediaSource.mediaThumbUri",
                null
              ]
          }
        }
      },
      {
        "$lookup":
        {
          from: "newUserBasics",
          as: "basic_data",
          let:
          {
            email_fk: "$email"
          },
          pipeline:
            [
              {
                "$match":
                {
                  "$expr":
                  {
                    "$eq":
                      [
                        "$email", "$$email_fk"
                      ]
                  }
                }
              },
              {
                "$project":
                {
                  "username": 1,
                  "isIdVerified": 1,
                  "privacy":
                  {
                    "isPostPrivate": "$isPostPrivate",
                    "isPrivate": "$isPrivate",
                    "isCelebrity": "$isCelebrity",
                    "isIdVerified": "$isIdVerified",
                  },
                  "avatar":
                  {
                    "mediaBasePath":
                    {
                      "$ifNull":
                        [
                          "$mediaBasePath",
                          null,
                        ]
                    },
                    "mediaType":
                    {
                      "$ifNull":
                        [
                          "$mediaType",
                          null,
                        ]
                    },
                    "mediaUri":
                    {
                      "$ifNull":
                        [
                          "$mediaUri",
                          null,
                        ]
                    },
                    "mediaEndpoint":
                    {
                      "$ifNull":
                        [
                          "$mediaEndpoint",
                          null,
                        ]
                    },
                  },
                  "urluserBadge":
                  {
                    "$ifNull":
                      [
                        {
                          "$filter":
                          {
                            input: "$userBadge",
                            as: "listbadge",
                            cond:
                            {
                              "$and":
                                [
                                  {
                                    "$eq":
                                      [
                                        "$$listbadge.isActive", true
                                      ]
                                  },
                                  {
                                    "$lte":
                                      [
                                        {
                                          "$dateToString":
                                          {
                                            "format": "%Y-%m-%d %H:%M:%S",
                                            "date":
                                            {
                                              "$add":
                                                [
                                                  new Date(),
                                                  25200000
                                                ]
                                            }
                                          }
                                        },
                                        "$$listbadge.endDatetime"
                                      ]
                                  }
                                ]
                            }
                          }
                        },
                        []
                      ]
                  },
                  "following":
                  {
                    "$ifNull":
                      [
                        {
                          "$filter":
                          {
                            input: "$following",
                            as: "list",
                            cond:
                            {
                              "$eq":
                                [
                                  "$$list", email
                                ]
                            }
                          }
                        },
                        []
                      ]
                  }
                }
              },
              {
                "$project":
                {
                  "username": 1,
                  "isIdVerified": 1,
                  "privacy": 1,
                  "avatar": 1,
                  "urluserBadge":
                  {
                    "$ifNull":
                      [
                        {
                          "$arrayElemAt":
                            [
                              "$urluserBadge", 0
                            ]
                        },
                        null
                      ]
                  },
                  "following":
                  {
                    "$cond":
                    {
                      "if":
                      {
                        "$eq":
                          [
                            {
                              "$size": "$following"
                            },
                            0
                          ]
                      },
                      "then": false,
                      "else": true
                    }
                  }
                }
              }
            ]
        }
      },
      {
        "$project":
        {
          "isShared": 1,
          "postID": 1,
          "email": 1,
          "active": 1,
          "createdAt": 1,
          "updatedAt": 1,
          "description": 1,
          "stiker": 1,
          "location": 1,
          "visibility": 1,
          "allowComments": 1,
          "postType": 1,
          "isLiked":
          {
            "$cond":
            {
              if:
              {
                "$eq":
                  [
                    {
                      "$size": "$isLiked"
                    },
                    0
                  ]
              },
              then: false,
              else: true
            }
          },
          "isViewed":
          {
            "$cond":
            {
              if:
              {
                "$eq":
                  [
                    {
                      "$size": "$isLiked"
                    },
                    0
                  ]
              },
              then: false,
              else: true
            }
          },
          "insight": (insight == 'true' ? 1 : "$$REMOVE"),
          "reportedStatus": 1,
          "saleAmount": 1,
          "saleLike": 1,
          "saleView": 1,
          "isApsara": 1,
          "apsaraId": 1,
          "mediaBasePath": 1,
          "mediaUri": 1,
          "mediaType": 1,
          "mediaMime": 1,
          "mediaThumbEndpoint": 1,
          "mediaEndpoint": 1,
          "mediaThumbUri": 1,
          "certified": 1,
          "metadata": 1,
          "cats": "$cats",
          "username":
          {
            "$arrayElemAt":
              [
                "$basic_data.username", 0
              ]
          },
          "isIdVerified":
          {
            "$arrayElemAt":
              [
                "$basic_data.isIdVerified", 0
              ]
          },
          "privacy":
          {
            "$arrayElemAt":
              [
                "$basic_data.privacy", 0
              ]
          },
          "avatar":
          {
            "$arrayElemAt":
              [
                "$basic_data.avatar", 0
              ]
          },
          "urluserBadge":
          {
            "$arrayElemAt":
              [
                "$basic_data.urluserBadge", 0
              ]
          },
          "following":
          {
            "$arrayElemAt":
              [
                "$basic_data.following", 0
              ]
          },
        }
      }
    );

    // var util = require('util');
    // console.log(util.inspect(pipeline, { showHidden:false, depth:null }));
    // console.log(JSON.stringify(pipeline))
    var result = await this.loaddata.aggregate(pipeline);
    return result;
  }

  async detailinterestmigration(key: string, email: string, skip: number, limit: number, pict: any, vid: any, diary: any)
  {
    var mongo = require('mongoose');

    var renderfacet = {};

    if(pict == true)
    {
      renderfacet['pict'] = [
        {
          '$match': {
            '$and': [
              { reportedStatus: { '$ne': 'OWNED' } },
              { visibility: 'PUBLIC' },
              { active: true },
              {
                'reportedUser.email': { '$not': { '$regex': email } }
              },
              {
                'category.$id': new mongo.Types.ObjectId(key)
              },
              { postType: 'pict' }
            ]
          }
        },
        {
          '$sort': {
            isApsara: -1,
            scorePict: -1,
            comments: -1,
            likes: -1,
            createdAt: -1
          }
        },
        { '$skip': (skip * limit) },
        { '$limit': limit },
        {
            $set:{
                media:{
                      apsara: {$arrayElemAt:["$mediaSource.apsara",0]},
                      apsaraId: {$arrayElemAt:["$mediaSource.apsaraId",0]},
                      apsaraThumbId: {$arrayElemAt:["$mediaSource.apsaraThumId",0]},
                      mediaEndpoint: { '$concat': [ '/pict/', "$postID" ] },
                      mediaUri: {$arrayElemAt:["$mediaSource.mediaUri",0]},
                      mediaThumbEndpoint: { '$concat': [ '/thumb/', "$postID"  ] },
                      mediaThumbUri: {$arrayElemAt:["$mediaSource.mediaThumUri",0]},
                      mediaType: {$arrayElemAt:["$mediaSource.mediaType",0]},
                      uploadSource: {$arrayElemAt:["$mediaSource.uploadSource",0]},
                }
            }
        },
        {
          '$project': {
            scorePict: '$scorePict',
            boosted: '$boosted',
            reportedStatus: '$reportedStatus',
            _id: '$_id',
            mediaThumbEndpoint: '$media.mediaThumbEndpoint',
           mediaEndpoint: '$media.mediaEndpoint',
           mediaType:'$media.mediaType',
           createdAt: '$createdAt',
           updatedAt: '$updatedAt',
           postID: '$postID',
           email: '$email',
           postType: '$postType',
           description: '$description',
           active: '$active',
           metadata: '$metadata',
           location: '$location',
           isOwned: '$isOwned',
           visibility: '$visibility',
           isViewed: '$isViewed',
           allowComments: '$allowComments',
           saleAmount: '$saleAmount',
           uploadSource: '$media.uploadSource',
           monetize: {
             '$cond': {
               if: { '$gte': [ '$saleAmount', 1 ] },
               then: true,
               else: '$taslimKONAG'
             }
           },
           comments: '$comments',
           likes: '$likes',
           insight: { '$ifNull': [ '$insight', '$TaslimKAMPRET' ] },
           apsaraId:  '$media.apsaraId',
           isApsara: {
             '$ifNull': [
                   '$media.apsara', false
             ]
           },
           apsaraThumbId: '$media.apsaraThumbId', 
           dodolipet: 1
          }
        },
        {
          '$sort': {
            isApsara: -1,
            scorePict: -1,
            comments: -1,
            likes: -1,
            createdAt: -1
          }
        }
      ]
    }

    if(vid == true)
    {
      renderfacet['vid'] = [
        {
          '$match': {
            '$and': [
              { reportedStatus: { '$ne': 'OWNED' } },
              { visibility: 'PUBLIC' },
              { active: true },
              {
                'reportedUser.email': { '$not': { '$regex': email } }
              },
              {
                'category.$id': new mongo.Types.ObjectId(key)
              },
              { postType: 'vid' }
            ]
          }
        },
        {
          '$sort': {
            isApsara: -1,
            scorePict: -1,
            comments: -1,
            likes: -1,
            createdAt: -1
          }
        },
        { '$skip': (skip * limit) },
        { '$limit': limit },
        {
            $set:{
                media:{
                      apsara: {$arrayElemAt:["$mediaSource.apsara",0]},
                      apsaraId: {$arrayElemAt:["$mediaSource.apsaraId",0]},
                      apsaraThumbId: {$arrayElemAt:["$mediaSource.apsaraThumId",0]},
                      mediaEndpoint: { '$concat': [ '/pict/', "$postID" ] },
                      mediaUri: {$arrayElemAt:["$mediaSource.mediaUri",0]},
                      mediaThumbEndpoint: { '$concat': [ '/thumb/', "$postID"  ] },
                      mediaThumbUri: {$arrayElemAt:["$mediaSource.mediaThumUri",0]},
                      mediaType: {$arrayElemAt:["$mediaSource.mediaType",0]},
                      uploadSource: {$arrayElemAt:["$mediaSource.uploadSource",0]},
                }
            }
        },
        {
          '$project': {
            scorePict: '$scorePict',
            boosted: '$boosted',
            reportedStatus: '$reportedStatus',
            _id: '$_id',
            mediaThumbEndpoint: '$media.mediaThumbEndpoint',
           mediaEndpoint: '$media.mediaEndpoint',
           mediaType:'$media.mediaType',
           createdAt: '$createdAt',
           updatedAt: '$updatedAt',
           postID: '$postID',
           email: '$email',
           postType: '$postType',
           description: '$description',
           active: '$active',
           metadata: '$metadata',
           location: '$location',
           isOwned: '$isOwned',
           visibility: '$visibility',
           isViewed: '$isViewed',
           allowComments: '$allowComments',
           saleAmount: '$saleAmount',
           uploadSource: '$media.uploadSource',
           monetize: {
             '$cond': {
               if: { '$gte': [ '$saleAmount', 1 ] },
               then: true,
               else: '$taslimKONAG'
             }
           },
           comments: '$comments',
           likes: '$likes',
           insight: { '$ifNull': [ '$insight', '$TaslimKAMPRET' ] },
           apsaraId:  '$media.apsaraId',
           isApsara: {
             '$ifNull': [
                   '$media.apsara', false
             ]
           },
           apsaraThumbId: '$media.apsaraThumbId', 
           dodolipet: 1
          }
        },
        {
          '$sort': {
            isApsara: -1,
            scorePict: -1,
            comments: -1,
            likes: -1,
            createdAt: -1
          }
        }
      ]
    }

    if(diary == true)
    {
      renderfacet['diary'] = [
        {
          '$match': {
            '$and': [
              { reportedStatus: { '$ne': 'OWNED' } },
              { visibility: 'PUBLIC' },
              { active: true },
              {
                'reportedUser.email': { '$not': { '$regex': email } }
              },
              {
                'category.$id': new mongo.Types.ObjectId(key)
              },
              { postType: 'diary' }
            ]
          }
        },
        {
          '$sort': {
            isApsara: -1,
            scorePict: -1,
            comments: -1,
            likes: -1,
            createdAt: -1
          }
        },
        { '$skip': (skip * limit) },
        { '$limit': limit },
        {
            $set:{
                media:{
                      apsara: {$arrayElemAt:["$mediaSource.apsara",0]},
                      apsaraId: {$arrayElemAt:["$mediaSource.apsaraId",0]},
                      apsaraThumbId: {$arrayElemAt:["$mediaSource.apsaraThumId",0]},
                      mediaEndpoint: { '$concat': [ '/pict/', "$postID" ] },
                      mediaUri: {$arrayElemAt:["$mediaSource.mediaUri",0]},
                      mediaThumbEndpoint: { '$concat': [ '/thumb/', "$postID"  ] },
                      mediaThumbUri: {$arrayElemAt:["$mediaSource.mediaThumUri",0]},
                      mediaType: {$arrayElemAt:["$mediaSource.mediaType",0]},
                      uploadSource: {$arrayElemAt:["$mediaSource.uploadSource",0]},
                }
            }
        },
        {
          '$project': {
            scorePict: '$scorePict',
            boosted: '$boosted',
            reportedStatus: '$reportedStatus',
            _id: '$_id',
            mediaThumbEndpoint: '$media.mediaThumbEndpoint',
           mediaEndpoint: '$media.mediaEndpoint',
           mediaType:'$media.mediaType',
           createdAt: '$createdAt',
           updatedAt: '$updatedAt',
           postID: '$postID',
           email: '$email',
           postType: '$postType',
           description: '$description',
           active: '$active',
           metadata: '$metadata',
           location: '$location',
           isOwned: '$isOwned',
           visibility: '$visibility',
           isViewed: '$isViewed',
           allowComments: '$allowComments',
           saleAmount: '$saleAmount',
           uploadSource: '$media.uploadSource',
           monetize: {
             '$cond': {
               if: { '$gte': [ '$saleAmount', 1 ] },
               then: true,
               else: '$taslimKONAG'
             }
           },
           comments: '$comments',
           likes: '$likes',
           insight: { '$ifNull': [ '$insight', '$TaslimKAMPRET' ] },
           apsaraId:  '$media.apsaraId',
           isApsara: {
             '$ifNull': [
                   '$media.apsara', false
             ]
           },
           apsaraThumbId: '$media.apsaraThumbId', 
           dodolipet: 1
          }
        },
        {
          '$sort': {
            isApsara: -1,
            scorePict: -1,
            comments: -1,
            likes: -1,
            createdAt: -1
          }
        }
      ]
    }

    renderfacet['interest'] = [
      {
        '$lookup': {
          from: 'interests_repo',
          as: 'interest',
          let: { localID: new mongo.Types.ObjectId(key) },
          pipeline: [
            {
              '$match': { '$expr': { '$eq': [ '$_id', '$$localID' ] } }
            },
            {
              '$lookup': {
                from: 'interest_count',
                as: 'count',
                let: { localID: new mongo.Types.ObjectId(key) },
                pipeline: [
                  {
                    '$match': { '$expr': { '$eq': [ '$_id', '$$localID' ] } }
                  },
                  { '$project': { total: 1 } }
                ]
              }
            },
            {
              '$unwind': { path: '$count', preserveNullAndEmptyArrays: true }
            }
          ]
        }
      },
      { '$limit': 1 },
      {
        '$project': {
          _id: { '$arrayElemAt': [ '$interest._id', 0 ] },
          tag: { '$arrayElemAt': [ '$interest._id', 0 ] },
          interestNameId: { '$arrayElemAt': [ '$interest.interestNameId', 0 ] },
          interestNameEn: { '$arrayElemAt': [ '$interest.interestName', 0 ] },
          total: { '$arrayElemAt': [ '$interest.count.total', 0 ] }
        }
      }
    ];

    var result = await this.loaddata.aggregate([
      {
        "$facet":renderfacet
      }
    ]);

    return result;
  }

  async detailinterestmigration2(key: string, email: string, skip: number, limit: number, pict: any, vid: any, diary: any)
  {
    var mongo = require('mongoose');
    var renderfacet = {};

    if(pict == true)
    {
      renderfacet['pict'] = [
          {
            '$match': 
            {
                $and:[
                    {
                        'category.$id': new mongo.Types.ObjectId(key)
                    },
                    {
                        "postType": "pict",
                    },
                ]
            },
            //{
            //    '$expr': {
            //        '$in': [ObjectId("613bc4da9ec319617aa6c38d"), '$category.$id']
            //    }
            //},
        },

        {
            '$sort': {
                createdAt: - 1
            }
        },
        {
            '$unwind': {
                path: '$boosted',
                preserveNullAndEmptyArrays: true
            }
        },
        {
            '$unwind': {
                path: '$boosted.boostSession',
                preserveNullAndEmptyArrays: true
            }
        },
        {
            '$set': {
                timeStart: {
                    '$concat': [
                        {
                            '$dateToString': {
                                format: '%Y-%m-%d',
                                date: new Date()
                            }
                        },
                        ' ',
                        '$boosted.boostSession.timeStart'
                    ]
                }
            }
        },
        {
            '$set': {
                timeEnd: {
                    '$concat': [
                        {
                            '$dateToString': {
                                format: '%Y-%m-%d',
                                date: new Date()
                            }
                        },
                        ' ',
                        '$boosted.boostSession.timeEnd'
                    ]
                }
            }
        },
        {
            '$set': {
                lastTime: {
                    '$concat': [
                        {
                            '$dateToString': {
                                format: '%Y-%m-%d',
                                date: new Date()
                            }
                        },
                        ' 08:00:00'
                    ]
                }
            }
        },
        {
            '$set': {
                timeEnd: {
                    '$cond': {
                        if : {
                            '$lt': ['$timeEnd', '$lastTime']
                        },
                        then: {
                            '$concat': [
                                {
                                    '$dateToString': {
                                        format: '%Y-%m-%d',
                                        date: {
                                            '$dateAdd': {
                                                startDate: new Date(),
                                                unit: 'day',
                                                amount: 1
                                            }
                                        }
                                    }
                                },
                                ' ',
                                '$boosted.boostSession.timeEnd'
                            ]
                        },
                        else : '$timeEnd'
                    }
                }
            }
        },
        {
            '$set': {
                testDate: {
                    '$dateToString': {
                        format: '%Y-%m-%d %H:%M:%S',
                        date: {
                            '$add': [new Date(), 25200000]
                        }
                    }
                }
            }
        },
        {
            '$set': {
                oldDate: {
                    '$dateToString': {
                        format: '%Y-%m-%d %H:%M:%S',
                        date: {
                            '$add': [new Date(), - 30600000]
                        }
                    }
                }
            }
        },
        {
            '$set': {
                selfContents: {
                    '$cond': {
                        if : {
                            '$and': [
                                {
                                    '$eq': ['$email', email]
                                },
                                {
                                    '$gt': ['$createdAt', '$oldDate']
                                }
                            ]
                        },
                        then: 1,
                        else : 0
                    }
                }
            }
        },
        {
            '$set': {
                kancuts: {
                    '$concatArrays': ['$viewer', [email]]
                }
            }
        },
        {
            '$set': {
                mailViewer: {
                    '$filter': {
                        input: '$kancuts',
                        cond: {
                            '$eq': ['$$this', email]
                        }
                    }
                }
            }
        },
        {
            '$set': {
                dodolCount: {
                    '$filter': {
                        input: '$kancuts',
                        cond: {
                            '$eq': ['$$this', email]
                        }
                    }
                }
            }
        },
        {
            '$set': {
                viewerCounts: {
                    '$cond': {
                        if : {
                            '$isArray': '$dodolCount'
                        },
                        then: {
                            '$size': '$dodolCount'
                        },
                        else : 1
                    }
                }
            }
        },
        {
            '$match': {
                '$or': [
                    {
                        '$and': [
                            {
                                reportedStatus: {
                                    '$ne': 'OWNED'
                                }
                            },
                            {
                                visibility: 'PUBLIC'
                            },
                            {
                                active: true
                            },
                            {
                                postType: 'pict'
                            },
                            {
                                '$expr': {
                                    '$lte': ['$boosted.boostSession.start', '$testDate']
                                }
                            },
                            {
                                '$expr': {
                                    '$gt': ['$boosted.boostSession.end', '$testDate']
                                }
                            },
                            {
                                '$expr': {
                                    '$lte': ['$timeStart', '$testDate']
                                }
                            },
                            {
                                '$expr': {
                                    '$gt': ['$timeEnd', '$testDate']
                                }
                            },
                            {
                                timeStart: {
                                    '$ne': null
                                }
                            },
                            {
                                timeEnd: {
                                    '$ne': null
                                }
                            },
                            {
                                '$or': [
                                    {
                                        reportedUser: {
                                            '$elemMatch': {
                                                email: email,
                                                active: false
                                            }
                                        }
                                    },
                                    {
                                        'reportedUser.email': {
                                            '$not': {
                                                '$regex': email
                                            }
                                        }
                                    }
                                ]
                            },
                            {
                                '$or': [
                                    {
                                        'boosted.boostViewer': {
                                            '$elemMatch': {
                                                email: email,
                                                isLast: true,
                                                timeEnd: {
                                                    '$lte': {
                                                        '$add': [new Date(), 25200000]
                                                    }
                                                }
                                            }
                                        }
                                    },
                                    {
                                        '$and': [
                                            {
                                                'boosted.boostViewer.email': {
                                                    '$ne': email
                                                }
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        '$and': [
                            {
                                reportedStatus: {
                                    '$ne': 'OWNED'
                                }
                            },
                            {
                                visibility: 'PUBLIC'
                            },
                            {
                                active: true
                            },
                            {
                                postType: 'pict'
                            },
                            {
                                timeStart: null
                            },
                            {
                                '$or': [
                                    {
                                        reportedUser: {
                                            '$elemMatch': {
                                                email: email,
                                                active: false
                                            }
                                        }
                                    },
                                    {
                                        'reportedUser.email': {
                                            '$not': {
                                                '$regex': email
                                            }
                                        }
                                    }
                                ]
                            }
                        ]
                    }
                ]
            }
        },
        {
            '$skip': (skip * limit)
        },
        {
            '$limit': limit
        },
        {
          '$lookup': {
              from: 'disquslogs',
              let: {
                  localID: '$postID'
              },
              as: 'comment',
              pipeline: [
                  {
                      '$match': {
                          '$and': [
                              {
                                  '$expr': {
                                      '$eq': ['$postID', '$$localID']
                                  }
                              },
                              {
                                  active: {
                                      '$ne': false
                                  }
                              }
                          ]
                      }
                  },
                  {
                      '$lookup': {
                          from: 'newUserBasics',
                          as: 'userComment',
                          let: {
                              localID: '$sender'
                          },
                          pipeline: [
                              {
                                  '$match': {
                                      '$expr': {
                                          '$eq': ['$email', '$$localID']
                                      }
                                  }
                              },
                              {
                                  '$project': {
                                      username: 1
                                  }
                              }
                          ]
                      }
                  },
                  {
                      '$unwind': {
                          path: '$userComment'
                      }
                  },
                  {
                      '$sort': {
                          createdAt: - 1
                      }
                  },
                  {
                      '$group': {
                          _id: '$postID',
                          komentar: {
                              '$push': '$$ROOT'
                          }
                      }
                  }
              ]
          }
      },
      {
          '$lookup': {
              from: 'newUserBasics',
              as: 'following',
              let: {
                  localID: '$email',
                  user:email
              },
              pipeline: [
                  {
                      '$match': {
                          '$and': [
                              {
                                  '$expr': {
                                      '$eq': ['$email', '$$localID']
                                  }
                              },
                              {
                                  '$expr': {
                                      '$in': [ '$$user','$follower']
                                  }
                              },
                              
                          ]
                      }
                  },
                  {
                      '$project': {
                          senderParty: email,
                          following: {
                              '$cond': {
                                  if : {
                                      '$eq': ["$email", null]
                                  },
                                  else : true,
                                  then: false
                              }
                          }
                      }
                  }
              ]
          }
      },
      {
        $set:{
            media:{
                  apsara: {$arrayElemAt:["$mediaSource.apsara",0]},
                  apsaraId: {$arrayElemAt:["$mediaSource.apsaraId",0]},
                  apsaraThumbId: {$arrayElemAt:["$mediaSource.apsaraThumId",0]},
                  mediaEndpoint: { '$concat': [ '/pict/', "$postID" ] },
                  mediaUri: {$arrayElemAt:["$mediaSource.mediaUri",0]},
                  mediaThumbEndpoint: { '$concat': [ '/thumb/', "$postID"  ] },
                  mediaThumbUri: {$arrayElemAt:["$mediaSource.mediaThumUri",0]},
                  mediaType: {$arrayElemAt:["$mediaSource.mediaType",0]},
                  uploadSource: {$arrayElemAt:["$mediaSource.uploadSource",0]},
            }
        }
      },
      {
          '$addFields': {
              category: {
                  '$reduce': {
                      input: '$categories',
                      initialValue: [],
                      in: {
                          '$concatArrays': ['$$this', '$$value']
                      }
                  }
              }
          }
      },
      {
          '$lookup': {
              from: 'interests_repo',
              as: 'cats',
              let: {
                  localID: '$category'
              },
              pipeline: [
                  {
                      '$match': {
                          '$expr': {
                              '$and': [
                                  {
                                      '$in': ['$_id', {
                                          '$ifNull': ['$$localID', []]
                                      }]
                                  }
                              ]
                          }
                      }
                  },
                  {
                      '$project': {
                          interestName: 1,
                          langIso: 1,
                          icon: 1,
                          createdAt: 1,
                          updatedAt: 1
                      }
                  }
              ]
          }
      },
      {
          '$lookup': {
              from: 'newUserBasics',
              as: 'userInterest',
              let: {
                  localID: email
              },
              pipeline: [
                  {
                      '$match': {
                          '$expr': {
                              '$and': [{
                                  '$eq': ['$email', '$$localID']
                              }]
                          }
                      }
                  },
                  {
                      '$project': {
                          userInterests: '$userInterests.$id',
                          email: 1
                      }
                  }
              ]
          }
      },
      {
          $set: {
              userTag: {
                  username: "$username"
              }
          }
      },
      {
          '$lookup': {
              from: 'newUserBasics',
              as: 'userBasic',
              let: {
                  localID: '$email'
              },
              pipeline: [
                  {
                      '$match': {
                          '$expr': {
                              '$eq': ['$email', '$$localID']
                          }
                      }
                  },
                  {
                      '$project': {
                          fullName: 1,
                          profilePict: 1,
                          isCelebrity: 1,
                          isIdVerified: 1,
                          isPrivate: 1,
                          isFollowPrivate: 1,
                          isPostPrivate: 1,
                          email: 1,
                          mediaBasePath: 1,
                          mediaUri: 1,
                          originalName: 1,
                          fsSourceUri: 1,
                          fsSourceName: 1,
                          fsTargetUri: 1,
                          mediaType: 1,
                          friend:
                          {
                                "$ifNull":
                                [
                                    {
                                        "$filter":
                                        {
                                            input:"$friend",
                                            as:"listFriend",
                                            cond:
                                            {
                                                "$eq":
                                                [
                                                    "$$listFriend.email", email
                                                ]
                                            }
                                        }
                                    },
                                    []  
                                ]
                          },
                          mediaEndpoint: 1
                      }
                  }
              ]
          }
      },
      {
          $set: {
              avatar: {
                  mediaBasePath: {
                      $arrayElemAt: ["$userBasic.mediaBasePath", 0]
                  },
                  mediaUri: {
                      $arrayElemAt: ["$userBasic.mediaUri", 0]
                  },
                  originalName: {
                      $arrayElemAt: ["$userBasic.originalName", 0]
                  },
                  fsSourceUri: {
                      $arrayElemAt: ["$userBasic.fsSourceUri", 0]
                  },
                  fsSourceName: {
                      $arrayElemAt: ["$userBasic.fsSourceName", 0]
                  },
                  fsTargetUri: {
                      $arrayElemAt: ["$userBasic.fsTargetUri", 0]
                  },
                  mediaType: {
                      $arrayElemAt: ["$userBasic.mediaType", 0]
                  },
                  mediaEndpoint: {
                      $arrayElemAt: ["$userBasic.mediaEndpoint", 0]
                  },
                  
              }
          }
      },
      {
          '$lookup': {
              from: 'mediamusic',
              as: 'music',
              let: {
                  localID: '$musicId'
              },
              pipeline: [
                  {
                      '$match': {
                          '$expr': {
                              '$eq': ['$_id', '$$localID']
                          }
                      }
                  },
                  {
                      '$project': {
                          musicTitle: 1,
                          artistName: 1,
                          albumName: 1,
                          apsaraMusic: 1,
                          apsaraThumnail: 1,
                          genre: '$genre.name',
                          theme: '$theme.name',
                          mood: '$mood.name'
                      }
                  },
                  {
                      '$unwind': {
                          path: '$genre',
                          preserveNullAndEmptyArrays: true
                      }
                  },
                  {
                      '$unwind': {
                          path: '$theme',
                          preserveNullAndEmptyArrays: true
                      }
                  },
                  {
                      '$unwind': {
                          path: '$mood',
                          preserveNullAndEmptyArrays: true
                      }
                  }
              ]
          }
      },
      {
          $set: {
              isLike: 
              {
                  isLiked: 
                  {
                      '$cond': {
                          if : {
                              $isArray: [{
                                  '$in': [ email,'$userLike']
                              }]
                          },
                          else : false,
                          then: true
                      }
                  },
                  
              }
          }
      },
      {
          '$lookup': {
              from: 'disquslogs',
              as: 'countLogs',
              let: {
                  localID: '$postID'
              },
              pipeline: [
                  {
                      '$match': {
                          '$and': [
                              {
                                  '$expr': {
                                      '$eq': ['$$localID','$postID']
                                  }
                              },
                              {
                                  active: true
                              }
                          ]
                      }
                  }
              ]
          }
      },
      {
          '$unwind': {
              path: '$avatar',
              preserveNullAndEmptyArrays: true
          }
      },
      {
          '$project': {
              _id: 1,
              musicTitle: '$musicNih.musicTitle',
              postID: 1,
              artistName: '$musicNih.artistName',
              albumName: '$musicNih.albumName',
              apsaraMusic: '$musicNih.apsaraMusic',
              apsaraThumnail: '$musicNih.apsaraThumnail',
              genre: '$musicNih.genre',
              theme: '$musicNih.theme',
              mood: '$musicNih.mood',
              testDate: '$testDate',
              tagPeople: '$userTag.username',
              mediaType: '$media.mediaType',
              postType: '$postType',
              description: '$description',
              active: '$active',
              createdAt: '$createdAt',
              updatedAt: '$updatedAt',
              expiration: '$expiration',
              visibility: '$visibility',
              location: '$location',
              tags: '$tags',
              allowComments: '$allowComments',
              isSafe: '$isSafe',
              isOwned: '$isOwned',
              certified: '$certified',
              saleAmount: '$saleAmount',
              saleLike: '$saleLike',
              saleView: '$saleView',
              isShared: '$isShared',
              likes: '$likes',
              views: '$views',
              shares: '$shares',
              uploadSource: '$media.uploadSource',
                comments: {
                    '$size': '$comment'
                },
              email: '$email',
              viewer: '$viewer',
              viewerCount: {
                  '$size': '$userView',
                  
              },
              selfContents: '$selfContents',
              selfContent: {
                  '$cond': {
                      if : {
                          '$eq': [
                              '$email',
                              email
                          ]
                      },
                      then: 1,
                      else : 0
                  }
              },
              official: {
                  '$cond': {
                      if : {
                          '$eq': [
                              '$email',
                              'hyppers@hyppe.id'
                          ]
                      },
                      then: 1,
                      else : 0
                  }
              },
              musik: '$musicNih',
              isLike: '$liked.isLiked',
              comment: '$ded',
              interest: {
                  '$filter': {
                      input: '$category',
                      as: 'stud',
                      cond: {
                          '$in': [
                              '$$stud',
                              {
                                  '$ifNull': ['$userInterest.userInterests', []]
                              }
                          ]
                      }
                  }
              },
              friends: 
              {
                    "$ifNull":
                    [
                        {
                            "$arrayElemAt":
                            [
                                "$userBasic.friend", 0
                            ]
                        },
                        null
                    ]
              },
              following: '$followings.following',
              insight: {
                  likes: '$likes',
                  views: '$views',
                  shares: '$shares',
                  comments: '$comments',
                  
              },
              userProfile: '$userProfile',
              contentMedias: '$contentMedias',
              cats: {
                  '$filter': {
                      input: '$cats',
                      as: 'nonok',
                      cond: {
                          '$in': [
                              '$$nonok._id',
                              {
                                  '$ifNull': [
                                      '$categories',
                                      []
                                  ]
                              }
                          ]
                      }
                  }
              },
              tagDescription: '$tagDescription',
              metadata: '$metadata',
              boostDate: '$boostDate',
              end: '$boosted.boostSession.end',
              start: '$boosted.boostSession.start',
              isBoost: {
                  '$ifNull': [
                      '$isBoost',
                      0
                  ]
              },
              boostViewer: '$boostViewer',
              boostCount: '$boostCount',
              boosted: [
                  {
                      '$cond': {
                          if : {
                              '$gt': [
                                  {
                                      '$dateToString': {
                                          format: '%Y-%m-%d %H:%M:%S',
                                          date: {
                                              '$add': [new Date(), 25200000]
                                          }
                                      }
                                  },
                                  '$boosted.boostSession.end'
                              ]
                          },
                          then: '$ilang',
                          else : '$boosted',
                          
                      }
                  }
              ],
              contentModeration: '$contentModeration',
              reportedStatus: '$reportedStatus',
              reportedUserCount: '$reportedUserCount',
              contentModerationResponse: '$contentModerationResponse',
              reportedUser: '$reportedUser',
              timeStart: '$timeStart',
              timeEnd: '$timeEnd',
              apsaraId: '$media.apsaraId',
              isApsara: '$media.isApsara',
              apsaraThumbId: '$media.apsaraThumbId',
              mediaEndpoint: '$media.mediaEndpoint',
              mediaUri: '$media.mediaUri',
              mediaThumbEndpoint: '$media.mediaThumbEndpoint',
              mediaThumbUri: '$media.mediaThumbUri',
              fullName: 
              {
                "$arrayElemAt":
                [
                  '$userBasic.fullName', 0
                ]
              },
              username:
              {
                "$arrayElemAt":
                [
                  '$userBasic.username', 0
                ]
              },
              avatar: '$avatar',
              privacy: {
                  isCelebrity: 
                  {
                    "$arrayElemAt":
                    [
                      '$userBasic.isCelebrity', 0
                    ]
                  },
                  isIdVerified: 
                  {
                    "$arrayElemAt":
                    [
                      '$userBasic.isIdVerified', 0
                    ]
                  },
                  isPrivate:
                  {
                    "$arrayElemAt":
                    [
                      '$userBasic.isPrivate', 0
                    ]
                  },
                  isFollowPrivate:
                  {
                    "$arrayElemAt":
                    [
                      '$userBasic.isFollowPrivate', 0
                    ]
                  },
                  isPostPrivate:
                  {
                    "$arrayElemAt":
                    [
                      '$userBasic.isPostPrivate', 0
                    ]
                  }
              },
              verified:
              {
                "$arrayElemAt":
                [
                  '$userBasic.fullName', 0
                ]
              },
              mailViewer: '$mailViewer',
              userInterested: 
              {
                "$arrayElemAt":
                [
                  '$userInterest.userInterests', 0
                ]
              },
              
          }
      },
      {
          '$lookup': {
              from: 'settings',
              as: 'setting',
              pipeline: [
                  {
                      '$match': {
                          '$or': [
                              {
                                  _id: new mongo.Types.ObjectId("62bbdb4ba7520000050077a7")
                              },
                              {
                                  _id: new mongo.Types.ObjectId("64d06e5c451e0000bd006c62")
                              }
                          ]
                      }
                  }
              ]
          }
      },
    {
          '$project': {
              mailViewer: 1,
              viewerCount: 1,
              viewer: 1,
              version: {
                  '$arrayElemAt': ['$setting.value', 0]
              },
              limitLandingpage: {
                  '$arrayElemAt': ['$setting.value', 1]
              },
              oldDate: 1,
              selfContents: 1,
              official: 1,
              selfContent: 1,
              music: '$musik',
              isLiked: {
                  '$ifNull': ['$isLike', false]
              },
              comment: {
                  '$cond': {
                      if : {
                          '$eq': ['$comment', [null]]
                      },
                      then: [],
                      else : '$comment'
                  }
              },
              intScore: {
                  '$cond': {
                      if : {
                          '$isArray': '$interest'
                      },
                      then: {
                          '$size': '$interest'
                      },
                      else : 0
                  }
              },
              verified: 1,
              friend: 1,
              following: 1,
              musicTitle: 1,
              postID: 1,
              artistName: 1,
              albumName: 1,
              apsaraMusic: 1,
              apsaraThumnail: 1,
              genre: 1,
              theme: 1,
              mood: 1,
              testDate: 1,
              musicId: 1,
              tagPeople: 1,
              mediaType: 1,
              email: 1,
              postType: 1,
              description: 1,
              active: 1,
              createdAt: 1,
              updatedAt: 1,
              expiration: 1,
              visibility: 1,
              location: 1,
              tags: 1,
              allowComments: 1,
              isSafe: 1,
              isOwned: 1,
              certified: 1,
              saleAmount: 1,
              saleLike: 1,
              saleView: 1,
              isShared: 1,
              likes: 1,
              views: 1,
              shares: 1,
              comments: 1,
              insight: 1,
              userProfile: 1,
              contentMedias: 1,
              cats: '$cats',
              tagDescription: 1,
              metadata: 1,
              boostDate: 1,
              end: 1,
              start: 1,
              isBoost: 1,
              boostViewer: 1,
              boostCount: 1,
              uploadSource: 1,
              boosted: {
                  '$cond': {
                      if : {
                          '$gt': [{
                              '$size': '$boosted.boostSession'
                          }, 0]
                      },
                      else : [],
                      then: '$boosted'
                  }
              },
              contentModeration: 1,
              reportedStatus: 1,
              reportedUserCount: 1,
              contentModerationResponse: 1,
              reportedUser: 1,
              timeStart: 1,
              timeEnd: 1,
              isApsara: 1,
              apsaraId: 1,
              apsaraThumbId: 1,
              mediaEndpoint: 1,
              mediaUri: 1,
              mediaThumbEndpoint: 1,
              mediaThumbUri: 1,
              fullName: 1,
              username: 1,
              avatar: 1,
              statusCB: 1,
              privacy: 1,
              mediaThumUri: 1,
              category: 1,
              userInterested: 1
          }
      }
      ];
    }

    if(vid == true)
    {
      renderfacet['video'] = [
          {
            '$match': 
            {
                $and:[
                    {
                        'category.$id': new mongo.Types.ObjectId(key)
                    },
                    {
                        "postType": "vid",
                    },
                ]
            },
            //{
            //    '$expr': {
            //        '$in': [ObjectId("613bc4da9ec319617aa6c38d"), '$category.$id']
            //    }
            //},
        },

        {
            '$sort': {
                createdAt: - 1
            }
        },
        {
            '$unwind': {
                path: '$boosted',
                preserveNullAndEmptyArrays: true
            }
        },
        {
            '$unwind': {
                path: '$boosted.boostSession',
                preserveNullAndEmptyArrays: true
            }
        },
        {
            '$set': {
                timeStart: {
                    '$concat': [
                        {
                            '$dateToString': {
                                format: '%Y-%m-%d',
                                date: new Date()
                            }
                        },
                        ' ',
                        '$boosted.boostSession.timeStart'
                    ]
                }
            }
        },
        {
            '$set': {
                timeEnd: {
                    '$concat': [
                        {
                            '$dateToString': {
                                format: '%Y-%m-%d',
                                date: new Date()
                            }
                        },
                        ' ',
                        '$boosted.boostSession.timeEnd'
                    ]
                }
            }
        },
        {
            '$set': {
                lastTime: {
                    '$concat': [
                        {
                            '$dateToString': {
                                format: '%Y-%m-%d',
                                date: new Date()
                            }
                        },
                        ' 08:00:00'
                    ]
                }
            }
        },
        {
            '$set': {
                timeEnd: {
                    '$cond': {
                        if : {
                            '$lt': ['$timeEnd', '$lastTime']
                        },
                        then: {
                            '$concat': [
                                {
                                    '$dateToString': {
                                        format: '%Y-%m-%d',
                                        date: {
                                            '$dateAdd': {
                                                startDate: new Date(),
                                                unit: 'day',
                                                amount: 1
                                            }
                                        }
                                    }
                                },
                                ' ',
                                '$boosted.boostSession.timeEnd'
                            ]
                        },
                        else : '$timeEnd'
                    }
                }
            }
        },
        {
            '$set': {
                testDate: {
                    '$dateToString': {
                        format: '%Y-%m-%d %H:%M:%S',
                        date: {
                            '$add': [new Date(), 25200000]
                        }
                    }
                }
            }
        },
        {
            '$set': {
                oldDate: {
                    '$dateToString': {
                        format: '%Y-%m-%d %H:%M:%S',
                        date: {
                            '$add': [new Date(), - 30600000]
                        }
                    }
                }
            }
        },
        {
            '$set': {
                selfContents: {
                    '$cond': {
                        if : {
                            '$and': [
                                {
                                    '$eq': ['$email', email]
                                },
                                {
                                    '$gt': ['$createdAt', '$oldDate']
                                }
                            ]
                        },
                        then: 1,
                        else : 0
                    }
                }
            }
        },
        {
            '$set': {
                kancuts: {
                    '$concatArrays': ['$viewer', [email]]
                }
            }
        },
        {
            '$set': {
                mailViewer: {
                    '$filter': {
                        input: '$kancuts',
                        cond: {
                            '$eq': ['$$this', email]
                        }
                    }
                }
            }
        },
        {
            '$set': {
                dodolCount: {
                    '$filter': {
                        input: '$kancuts',
                        cond: {
                            '$eq': ['$$this', email]
                        }
                    }
                }
            }
        },
        {
            '$set': {
                viewerCounts: {
                    '$cond': {
                        if : {
                            '$isArray': '$dodolCount'
                        },
                        then: {
                            '$size': '$dodolCount'
                        },
                        else : 1
                    }
                }
            }
        },
        {
            '$match': {
                '$or': [
                    {
                        '$and': [
                            {
                                reportedStatus: {
                                    '$ne': 'OWNED'
                                }
                            },
                            {
                                visibility: 'PUBLIC'
                            },
                            {
                                active: true
                            },
                            {
                                postType: 'vid'
                            },
                            {
                                '$expr': {
                                    '$lte': ['$boosted.boostSession.start', '$testDate']
                                }
                            },
                            {
                                '$expr': {
                                    '$gt': ['$boosted.boostSession.end', '$testDate']
                                }
                            },
                            {
                                '$expr': {
                                    '$lte': ['$timeStart', '$testDate']
                                }
                            },
                            {
                                '$expr': {
                                    '$gt': ['$timeEnd', '$testDate']
                                }
                            },
                            {
                                timeStart: {
                                    '$ne': null
                                }
                            },
                            {
                                timeEnd: {
                                    '$ne': null
                                }
                            },
                            {
                                '$or': [
                                    {
                                        reportedUser: {
                                            '$elemMatch': {
                                                email: email,
                                                active: false
                                            }
                                        }
                                    },
                                    {
                                        'reportedUser.email': {
                                            '$not': {
                                                '$regex': email
                                            }
                                        }
                                    }
                                ]
                            },
                            {
                                '$or': [
                                    {
                                        'boosted.boostViewer': {
                                            '$elemMatch': {
                                                email: email,
                                                isLast: true,
                                                timeEnd: {
                                                    '$lte': {
                                                        '$add': [new Date(), 25200000]
                                                    }
                                                }
                                            }
                                        }
                                    },
                                    {
                                        '$and': [
                                            {
                                                'boosted.boostViewer.email': {
                                                    '$ne': email
                                                }
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        '$and': [
                            {
                                reportedStatus: {
                                    '$ne': 'OWNED'
                                }
                            },
                            {
                                visibility: 'PUBLIC'
                            },
                            {
                                active: true
                            },
                            {
                                postType: 'vid'
                            },
                            {
                                timeStart: null
                            },
                            {
                                '$or': [
                                    {
                                        reportedUser: {
                                            '$elemMatch': {
                                                email: email,
                                                active: false
                                            }
                                        }
                                    },
                                    {
                                        'reportedUser.email': {
                                            '$not': {
                                                '$regex': email
                                            }
                                        }
                                    }
                                ]
                            }
                        ]
                    }
                ]
            }
        },
        {
            '$skip': (skip * limit)
        },
        {
            '$limit': limit
        },
        {
          '$lookup': {
              from: 'disquslogs',
              let: {
                  localID: '$postID'
              },
              as: 'comment',
              pipeline: [
                  {
                      '$match': {
                          '$and': [
                              {
                                  '$expr': {
                                      '$eq': ['$postID', '$$localID']
                                  }
                              },
                              {
                                  active: {
                                      '$ne': false
                                  }
                              }
                          ]
                      }
                  },
                  {
                      '$lookup': {
                          from: 'newUserBasics',
                          as: 'userComment',
                          let: {
                              localID: '$sender'
                          },
                          pipeline: [
                              {
                                  '$match': {
                                      '$expr': {
                                          '$eq': ['$email', '$$localID']
                                      }
                                  }
                              },
                              {
                                  '$project': {
                                      username: 1
                                  }
                              }
                          ]
                      }
                  },
                  {
                      '$unwind': {
                          path: '$userComment'
                      }
                  },
                  {
                      '$sort': {
                          createdAt: - 1
                      }
                  },
                  {
                      '$group': {
                          _id: '$postID',
                          komentar: {
                              '$push': '$$ROOT'
                          }
                      }
                  }
              ]
          }
      },
      {
          '$lookup': {
              from: 'newUserBasics',
              as: 'following',
              let: {
                  localID: '$email',
                  user:email
              },
              pipeline: [
                  {
                      '$match': {
                          '$and': [
                              {
                                  '$expr': {
                                      '$eq': ['$email', '$$localID']
                                  }
                              },
                              {
                                  '$expr': {
                                      '$in': [ '$$user','$follower']
                                  }
                              },
                              
                          ]
                      }
                  },
                  {
                      '$project': {
                          senderParty: email,
                          following: {
                              '$cond': {
                                  if : {
                                      '$eq': ["$email", null]
                                  },
                                  else : true,
                                  then: false
                              }
                          }
                      }
                  }
              ]
          }
      },
      {
        $set:{
            media:{
                  apsara: {$arrayElemAt:["$mediaSource.apsara",0]},
                  apsaraId: {$arrayElemAt:["$mediaSource.apsaraId",0]},
                  apsaraThumbId: {$arrayElemAt:["$mediaSource.apsaraThumId",0]},
                  mediaEndpoint: { '$concat': [ '/stream/', "$postID" ] },
                  mediaUri: {$arrayElemAt:["$mediaSource.mediaUri",0]},
                  mediaThumbEndpoint: { '$concat': [ '/thumb/', "$postID"  ] },
                  mediaThumbUri: {$arrayElemAt:["$mediaSource.mediaThumUri",0]},
                  mediaType: {$arrayElemAt:["$mediaSource.mediaType",0]},
                  uploadSource: {$arrayElemAt:["$mediaSource.uploadSource",0]},
            }
        }
      },
      {
          '$addFields': {
              category: {
                  '$reduce': {
                      input: '$categories',
                      initialValue: [],
                      in: {
                          '$concatArrays': ['$$this', '$$value']
                      }
                  }
              }
          }
      },
      {
          '$lookup': {
              from: 'interests_repo',
              as: 'cats',
              let: {
                  localID: '$category'
              },
              pipeline: [
                  {
                      '$match': {
                          '$expr': {
                              '$and': [
                                  {
                                      '$in': ['$_id', {
                                          '$ifNull': ['$$localID', []]
                                      }]
                                  }
                              ]
                          }
                      }
                  },
                  {
                      '$project': {
                          interestName: 1,
                          langIso: 1,
                          icon: 1,
                          createdAt: 1,
                          updatedAt: 1
                      }
                  }
              ]
          }
      },
      {
          '$lookup': {
              from: 'newUserBasics',
              as: 'userInterest',
              let: {
                  localID: email
              },
              pipeline: [
                  {
                      '$match': {
                          '$expr': {
                              '$and': [{
                                  '$eq': ['$email', '$$localID']
                              }]
                          }
                      }
                  },
                  {
                      '$project': {
                          userInterests: '$userInterests.$id',
                          email: 1
                      }
                  }
              ]
          }
      },
      {
          $set: {
              userTag: {
                  username: "$username"
              }
          }
      },
      {
          '$lookup': {
              from: 'newUserBasics',
              as: 'userBasic',
              let: {
                  localID: '$email'
              },
              pipeline: [
                  {
                      '$match': {
                          '$expr': {
                              '$eq': ['$email', '$$localID']
                          }
                      }
                  },
                  {
                      '$project': {
                          fullName: 1,
                          profilePict: 1,
                          isCelebrity: 1,
                          isIdVerified: 1,
                          isPrivate: 1,
                          isFollowPrivate: 1,
                          isPostPrivate: 1,
                          email: 1,
                          mediaBasePath: 1,
                          mediaUri: 1,
                          originalName: 1,
                          fsSourceUri: 1,
                          fsSourceName: 1,
                          fsTargetUri: 1,
                          mediaType: 1,
                          friend:
                          {
                                "$ifNull":
                                [
                                    {
                                        "$filter":
                                        {
                                            input:"$friend",
                                            as:"listFriend",
                                            cond:
                                            {
                                                "$eq":
                                                [
                                                    "$$listFriend.email", email
                                                ]
                                            }
                                        }
                                    },
                                    []  
                                ]
                          },
                          mediaEndpoint: 1
                      }
                  }
              ]
          }
      },
      {
          $set: {
              avatar: {
                  mediaBasePath: {
                      $arrayElemAt: ["$userBasic.mediaBasePath", 0]
                  },
                  mediaUri: {
                      $arrayElemAt: ["$userBasic.mediaUri", 0]
                  },
                  originalName: {
                      $arrayElemAt: ["$userBasic.originalName", 0]
                  },
                  fsSourceUri: {
                      $arrayElemAt: ["$userBasic.fsSourceUri", 0]
                  },
                  fsSourceName: {
                      $arrayElemAt: ["$userBasic.fsSourceName", 0]
                  },
                  fsTargetUri: {
                      $arrayElemAt: ["$userBasic.fsTargetUri", 0]
                  },
                  mediaType: {
                      $arrayElemAt: ["$userBasic.mediaType", 0]
                  },
                  mediaEndpoint: {
                      $arrayElemAt: ["$userBasic.mediaEndpoint", 0]
                  },
                  
              }
          }
      },
      {
          '$lookup': {
              from: 'mediamusic',
              as: 'music',
              let: {
                  localID: '$musicId'
              },
              pipeline: [
                  {
                      '$match': {
                          '$expr': {
                              '$eq': ['$_id', '$$localID']
                          }
                      }
                  },
                  {
                      '$project': {
                          musicTitle: 1,
                          artistName: 1,
                          albumName: 1,
                          apsaraMusic: 1,
                          apsaraThumnail: 1,
                          genre: '$genre.name',
                          theme: '$theme.name',
                          mood: '$mood.name'
                      }
                  },
                  {
                      '$unwind': {
                          path: '$genre',
                          preserveNullAndEmptyArrays: true
                      }
                  },
                  {
                      '$unwind': {
                          path: '$theme',
                          preserveNullAndEmptyArrays: true
                      }
                  },
                  {
                      '$unwind': {
                          path: '$mood',
                          preserveNullAndEmptyArrays: true
                      }
                  }
              ]
          }
      },
      {
          $set: {
              isLike: 
              {
                  isLiked: 
                  {
                      '$cond': {
                          if : {
                              $isArray: [{
                                  '$in': [ email,'$userLike']
                              }]
                          },
                          else : false,
                          then: true
                      }
                  },
                  
              }
          }
      },
      {
          '$lookup': {
              from: 'disquslogs',
              as: 'countLogs',
              let: {
                  localID: '$postID'
              },
              pipeline: [
                  {
                      '$match': {
                          '$and': [
                              {
                                  '$expr': {
                                      '$eq': ['$$localID','$postID']
                                  }
                              },
                              {
                                  active: true
                              }
                          ]
                      }
                  }
              ]
          }
      },
      {
          '$unwind': {
              path: '$avatar',
              preserveNullAndEmptyArrays: true
          }
      },
      {
          '$project': {
              _id: 1,
              musicTitle: '$musicNih.musicTitle',
              postID: 1,
              artistName: '$musicNih.artistName',
              albumName: '$musicNih.albumName',
              apsaraMusic: '$musicNih.apsaraMusic',
              apsaraThumnail: '$musicNih.apsaraThumnail',
              genre: '$musicNih.genre',
              theme: '$musicNih.theme',
              mood: '$musicNih.mood',
              testDate: '$testDate',
              tagPeople: '$userTag.username',
              mediaType: '$media.mediaType',
              postType: '$postType',
              description: '$description',
              active: '$active',
              createdAt: '$createdAt',
              updatedAt: '$updatedAt',
              expiration: '$expiration',
              visibility: '$visibility',
              location: '$location',
              tags: '$tags',
              allowComments: '$allowComments',
              isSafe: '$isSafe',
              isOwned: '$isOwned',
              certified: '$certified',
              saleAmount: '$saleAmount',
              saleLike: '$saleLike',
              saleView: '$saleView',
              isShared: '$isShared',
              likes: '$likes',
              views: '$views',
              shares: '$shares',
              uploadSource: '$media.uploadSource',
                comments: {
                    '$size': '$comment'
                },
              email: '$email',
              viewer: '$viewer',
              viewerCount: {
                  '$size': '$userView',
                  
              },
              selfContents: '$selfContents',
              selfContent: {
                  '$cond': {
                      if : {
                          '$eq': [
                              '$email',
                              email
                          ]
                      },
                      then: 1,
                      else : 0
                  }
              },
              official: {
                  '$cond': {
                      if : {
                          '$eq': [
                              '$email',
                              'hyppers@hyppe.id'
                          ]
                      },
                      then: 1,
                      else : 0
                  }
              },
              musik: '$musicNih',
              isLike: '$liked.isLiked',
              comment: '$ded',
              interest: {
                  '$filter': {
                      input: '$category',
                      as: 'stud',
                      cond: {
                          '$in': [
                              '$$stud',
                              {
                                  '$ifNull': ['$userInterest.userInterests', []]
                              }
                          ]
                      }
                  }
              },
              friends: 
              {
                    "$ifNull":
                    [
                        {
                            "$arrayElemAt":
                            [
                                "$userBasic.friend", 0
                            ]
                        },
                        null
                    ]
              },
              following: '$followings.following',
              insight: {
                  likes: '$likes',
                  views: '$views',
                  shares: '$shares',
                  comments: '$comments',
                  
              },
              userProfile: '$userProfile',
              contentMedias: '$contentMedias',
              cats: {
                  '$filter': {
                      input: '$cats',
                      as: 'nonok',
                      cond: {
                          '$in': [
                              '$$nonok._id',
                              {
                                  '$ifNull': [
                                      '$categories',
                                      []
                                  ]
                              }
                          ]
                      }
                  }
              },
              tagDescription: '$tagDescription',
              metadata: '$metadata',
              boostDate: '$boostDate',
              end: '$boosted.boostSession.end',
              start: '$boosted.boostSession.start',
              isBoost: {
                  '$ifNull': [
                      '$isBoost',
                      0
                  ]
              },
              boostViewer: '$boostViewer',
              boostCount: '$boostCount',
              boosted: [
                  {
                      '$cond': {
                          if : {
                              '$gt': [
                                  {
                                      '$dateToString': {
                                          format: '%Y-%m-%d %H:%M:%S',
                                          date: {
                                              '$add': [new Date(), 25200000]
                                          }
                                      }
                                  },
                                  '$boosted.boostSession.end'
                              ]
                          },
                          then: '$ilang',
                          else : '$boosted',
                          
                      }
                  }
              ],
              contentModeration: '$contentModeration',
              reportedStatus: '$reportedStatus',
              reportedUserCount: '$reportedUserCount',
              contentModerationResponse: '$contentModerationResponse',
              reportedUser: '$reportedUser',
              timeStart: '$timeStart',
              timeEnd: '$timeEnd',
              apsaraId: '$media.apsaraId',
              isApsara: '$media.isApsara',
              apsaraThumbId: '$media.apsaraThumbId',
              mediaEndpoint: '$media.mediaEndpoint',
              mediaUri: '$media.mediaUri',
              mediaThumbEndpoint: '$media.mediaThumbEndpoint',
              mediaThumbUri: '$media.mediaThumbUri',
              fullName: 
              {
                "$arrayElemAt":
                [
                  '$userBasic.fullName', 0
                ]
              },
              username:
              {
                "$arrayElemAt":
                [
                  '$userBasic.username', 0
                ]
              },
              avatar: '$avatar',
              privacy: {
                  isCelebrity: 
                  {
                    "$arrayElemAt":
                    [
                      '$userBasic.isCelebrity', 0
                    ]
                  },
                  isIdVerified: 
                  {
                    "$arrayElemAt":
                    [
                      '$userBasic.isIdVerified', 0
                    ]
                  },
                  isPrivate:
                  {
                    "$arrayElemAt":
                    [
                      '$userBasic.isPrivate', 0
                    ]
                  },
                  isFollowPrivate:
                  {
                    "$arrayElemAt":
                    [
                      '$userBasic.isFollowPrivate', 0
                    ]
                  },
                  isPostPrivate:
                  {
                    "$arrayElemAt":
                    [
                      '$userBasic.isPostPrivate', 0
                    ]
                  }
              },
              verified:
              {
                "$arrayElemAt":
                [
                  '$userBasic.fullName', 0
                ]
              },
              mailViewer: '$mailViewer',
              userInterested: 
              {
                "$arrayElemAt":
                [
                  '$userInterest.userInterests', 0
                ]
              },
              
          }
      },
      {
          '$lookup': {
              from: 'settings',
              as: 'setting',
              pipeline: [
                  {
                      '$match': {
                          '$or': [
                              {
                                  _id: new mongo.Types.ObjectId("62bbdb4ba7520000050077a7")
                              },
                              {
                                  _id: new mongo.Types.ObjectId("64d06e5c451e0000bd006c62")
                              }
                          ]
                      }
                  }
              ]
          }
      },
    {
          '$project': {
              mailViewer: 1,
              viewerCount: 1,
              viewer: 1,
              version: {
                  '$arrayElemAt': ['$setting.value', 0]
              },
              limitLandingpage: {
                  '$arrayElemAt': ['$setting.value', 1]
              },
              oldDate: 1,
              selfContents: 1,
              official: 1,
              selfContent: 1,
              music: '$musik',
              isLiked: {
                  '$ifNull': ['$isLike', false]
              },
              comment: {
                  '$cond': {
                      if : {
                          '$eq': ['$comment', [null]]
                      },
                      then: [],
                      else : '$comment'
                  }
              },
              intScore: {
                  '$cond': {
                      if : {
                          '$isArray': '$interest'
                      },
                      then: {
                          '$size': '$interest'
                      },
                      else : 0
                  }
              },
              verified: 1,
              friend: 1,
              following: 1,
              musicTitle: 1,
              postID: 1,
              artistName: 1,
              albumName: 1,
              apsaraMusic: 1,
              apsaraThumnail: 1,
              genre: 1,
              theme: 1,
              mood: 1,
              testDate: 1,
              musicId: 1,
              tagPeople: 1,
              mediaType: 1,
              email: 1,
              postType: 1,
              description: 1,
              active: 1,
              createdAt: 1,
              updatedAt: 1,
              expiration: 1,
              visibility: 1,
              location: 1,
              tags: 1,
              allowComments: 1,
              isSafe: 1,
              isOwned: 1,
              certified: 1,
              saleAmount: 1,
              saleLike: 1,
              saleView: 1,
              isShared: 1,
              likes: 1,
              views: 1,
              shares: 1,
              comments: 1,
              insight: 1,
              userProfile: 1,
              contentMedias: 1,
              cats: '$cats',
              tagDescription: 1,
              metadata: 1,
              boostDate: 1,
              end: 1,
              start: 1,
              isBoost: 1,
              boostViewer: 1,
              boostCount: 1,
              uploadSource: 1,
              boosted: {
                  '$cond': {
                      if : {
                          '$gt': [{
                              '$size': '$boosted.boostSession'
                          }, 0]
                      },
                      else : [],
                      then: '$boosted'
                  }
              },
              contentModeration: 1,
              reportedStatus: 1,
              reportedUserCount: 1,
              contentModerationResponse: 1,
              reportedUser: 1,
              timeStart: 1,
              timeEnd: 1,
              isApsara: 1,
              apsaraId: 1,
              apsaraThumbId: 1,
              mediaEndpoint: 1,
              mediaUri: 1,
              mediaThumbEndpoint: 1,
              mediaThumbUri: 1,
              fullName: 1,
              username: 1,
              avatar: 1,
              statusCB: 1,
              privacy: 1,
              mediaThumUri: 1,
              category: 1,
              userInterested: 1
          }
      }
      ];
    }

    if(diary == true)
    {
      renderfacet['diary'] = [
          {
            '$match': 
            {
                $and:[
                    {
                        'category.$id': new mongo.Types.ObjectId(key)
                    },
                    {
                        "postType": "diary",
                    },
                ]
            },
            //{
            //    '$expr': {
            //        '$in': [ObjectId("613bc4da9ec319617aa6c38d"), '$category.$id']
            //    }
            //},
        },

        {
            '$sort': {
                createdAt: - 1
            }
        },
        {
            '$unwind': {
                path: '$boosted',
                preserveNullAndEmptyArrays: true
            }
        },
        {
            '$unwind': {
                path: '$boosted.boostSession',
                preserveNullAndEmptyArrays: true
            }
        },
        {
            '$set': {
                timeStart: {
                    '$concat': [
                        {
                            '$dateToString': {
                                format: '%Y-%m-%d',
                                date: new Date()
                            }
                        },
                        ' ',
                        '$boosted.boostSession.timeStart'
                    ]
                }
            }
        },
        {
            '$set': {
                timeEnd: {
                    '$concat': [
                        {
                            '$dateToString': {
                                format: '%Y-%m-%d',
                                date: new Date()
                            }
                        },
                        ' ',
                        '$boosted.boostSession.timeEnd'
                    ]
                }
            }
        },
        {
            '$set': {
                lastTime: {
                    '$concat': [
                        {
                            '$dateToString': {
                                format: '%Y-%m-%d',
                                date: new Date()
                            }
                        },
                        ' 08:00:00'
                    ]
                }
            }
        },
        {
            '$set': {
                timeEnd: {
                    '$cond': {
                        if : {
                            '$lt': ['$timeEnd', '$lastTime']
                        },
                        then: {
                            '$concat': [
                                {
                                    '$dateToString': {
                                        format: '%Y-%m-%d',
                                        date: {
                                            '$dateAdd': {
                                                startDate: new Date(),
                                                unit: 'day',
                                                amount: 1
                                            }
                                        }
                                    }
                                },
                                ' ',
                                '$boosted.boostSession.timeEnd'
                            ]
                        },
                        else : '$timeEnd'
                    }
                }
            }
        },
        {
            '$set': {
                testDate: {
                    '$dateToString': {
                        format: '%Y-%m-%d %H:%M:%S',
                        date: {
                            '$add': [new Date(), 25200000]
                        }
                    }
                }
            }
        },
        {
            '$set': {
                oldDate: {
                    '$dateToString': {
                        format: '%Y-%m-%d %H:%M:%S',
                        date: {
                            '$add': [new Date(), - 30600000]
                        }
                    }
                }
            }
        },
        {
            '$set': {
                selfContents: {
                    '$cond': {
                        if : {
                            '$and': [
                                {
                                    '$eq': ['$email', email]
                                },
                                {
                                    '$gt': ['$createdAt', '$oldDate']
                                }
                            ]
                        },
                        then: 1,
                        else : 0
                    }
                }
            }
        },
        {
            '$set': {
                kancuts: {
                    '$concatArrays': ['$viewer', [email]]
                }
            }
        },
        {
            '$set': {
                mailViewer: {
                    '$filter': {
                        input: '$kancuts',
                        cond: {
                            '$eq': ['$$this', email]
                        }
                    }
                }
            }
        },
        {
            '$set': {
                dodolCount: {
                    '$filter': {
                        input: '$kancuts',
                        cond: {
                            '$eq': ['$$this', email]
                        }
                    }
                }
            }
        },
        {
            '$set': {
                viewerCounts: {
                    '$cond': {
                        if : {
                            '$isArray': '$dodolCount'
                        },
                        then: {
                            '$size': '$dodolCount'
                        },
                        else : 1
                    }
                }
            }
        },
        {
            '$match': {
                '$or': [
                    {
                        '$and': [
                            {
                                reportedStatus: {
                                    '$ne': 'OWNED'
                                }
                            },
                            {
                                visibility: 'PUBLIC'
                            },
                            {
                                active: true
                            },
                            {
                                postType: 'diary'
                            },
                            {
                                '$expr': {
                                    '$lte': ['$boosted.boostSession.start', '$testDate']
                                }
                            },
                            {
                                '$expr': {
                                    '$gt': ['$boosted.boostSession.end', '$testDate']
                                }
                            },
                            {
                                '$expr': {
                                    '$lte': ['$timeStart', '$testDate']
                                }
                            },
                            {
                                '$expr': {
                                    '$gt': ['$timeEnd', '$testDate']
                                }
                            },
                            {
                                timeStart: {
                                    '$ne': null
                                }
                            },
                            {
                                timeEnd: {
                                    '$ne': null
                                }
                            },
                            {
                                '$or': [
                                    {
                                        reportedUser: {
                                            '$elemMatch': {
                                                email: email,
                                                active: false
                                            }
                                        }
                                    },
                                    {
                                        'reportedUser.email': {
                                            '$not': {
                                                '$regex': email
                                            }
                                        }
                                    }
                                ]
                            },
                            {
                                '$or': [
                                    {
                                        'boosted.boostViewer': {
                                            '$elemMatch': {
                                                email: email,
                                                isLast: true,
                                                timeEnd: {
                                                    '$lte': {
                                                        '$add': [new Date(), 25200000]
                                                    }
                                                }
                                            }
                                        }
                                    },
                                    {
                                        '$and': [
                                            {
                                                'boosted.boostViewer.email': {
                                                    '$ne': email
                                                }
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        '$and': [
                            {
                                reportedStatus: {
                                    '$ne': 'OWNED'
                                }
                            },
                            {
                                visibility: 'PUBLIC'
                            },
                            {
                                active: true
                            },
                            {
                                postType: 'diary'
                            },
                            {
                                timeStart: null
                            },
                            {
                                '$or': [
                                    {
                                        reportedUser: {
                                            '$elemMatch': {
                                                email: email,
                                                active: false
                                            }
                                        }
                                    },
                                    {
                                        'reportedUser.email': {
                                            '$not': {
                                                '$regex': email
                                            }
                                        }
                                    }
                                ]
                            }
                        ]
                    }
                ]
            }
        },
        {
            '$skip': (skip * limit)
        },
        {
            '$limit': limit
        },
        {
          '$lookup': {
              from: 'disquslogs',
              let: {
                  localID: '$postID'
              },
              as: 'comment',
              pipeline: [
                  {
                      '$match': {
                          '$and': [
                              {
                                  '$expr': {
                                      '$eq': ['$postID', '$$localID']
                                  }
                              },
                              {
                                  active: {
                                      '$ne': false
                                  }
                              }
                          ]
                      }
                  },
                  {
                      '$lookup': {
                          from: 'newUserBasics',
                          as: 'userComment',
                          let: {
                              localID: '$sender'
                          },
                          pipeline: [
                              {
                                  '$match': {
                                      '$expr': {
                                          '$eq': ['$email', '$$localID']
                                      }
                                  }
                              },
                              {
                                  '$project': {
                                      username: 1
                                  }
                              }
                          ]
                      }
                  },
                  {
                      '$unwind': {
                          path: '$userComment'
                      }
                  },
                  {
                      '$sort': {
                          createdAt: - 1
                      }
                  },
                  {
                      '$group': {
                          _id: '$postID',
                          komentar: {
                              '$push': '$$ROOT'
                          }
                      }
                  }
              ]
          }
      },
      {
          '$lookup': {
              from: 'newUserBasics',
              as: 'following',
              let: {
                  localID: '$email',
                  user:email
              },
              pipeline: [
                  {
                      '$match': {
                          '$and': [
                              {
                                  '$expr': {
                                      '$eq': ['$email', '$$localID']
                                  }
                              },
                              {
                                  '$expr': {
                                      '$in': [ '$$user','$follower']
                                  }
                              },
                              
                          ]
                      }
                  },
                  {
                      '$project': {
                          senderParty: email,
                          following: {
                              '$cond': {
                                  if : {
                                      '$eq': ["$email", null]
                                  },
                                  else : true,
                                  then: false
                              }
                          }
                      }
                  }
              ]
          }
      },
      {
        $set:{
            media:{
                  apsara: {$arrayElemAt:["$mediaSource.apsara",0]},
                  apsaraId: {$arrayElemAt:["$mediaSource.apsaraId",0]},
                  apsaraThumbId: {$arrayElemAt:["$mediaSource.apsaraThumId",0]},
                  mediaEndpoint: { '$concat': [ '/stream/', "$postID" ] },
                  mediaUri: {$arrayElemAt:["$mediaSource.mediaUri",0]},
                  mediaThumbEndpoint: { '$concat': [ '/thumb/', "$postID"  ] },
                  mediaThumbUri: {$arrayElemAt:["$mediaSource.mediaThumUri",0]},
                  mediaType: {$arrayElemAt:["$mediaSource.mediaType",0]},
                  uploadSource: {$arrayElemAt:["$mediaSource.uploadSource",0]},
            }
        }
      },
      {
          '$addFields': {
              category: {
                  '$reduce': {
                      input: '$categories',
                      initialValue: [],
                      in: {
                          '$concatArrays': ['$$this', '$$value']
                      }
                  }
              }
          }
      },
      {
          '$lookup': {
              from: 'interests_repo',
              as: 'cats',
              let: {
                  localID: '$category'
              },
              pipeline: [
                  {
                      '$match': {
                          '$expr': {
                              '$and': [
                                  {
                                      '$in': ['$_id', {
                                          '$ifNull': ['$$localID', []]
                                      }]
                                  }
                              ]
                          }
                      }
                  },
                  {
                      '$project': {
                          interestName: 1,
                          langIso: 1,
                          icon: 1,
                          createdAt: 1,
                          updatedAt: 1
                      }
                  }
              ]
          }
      },
      {
          '$lookup': {
              from: 'newUserBasics',
              as: 'userInterest',
              let: {
                  localID: email
              },
              pipeline: [
                  {
                      '$match': {
                          '$expr': {
                              '$and': [{
                                  '$eq': ['$email', '$$localID']
                              }]
                          }
                      }
                  },
                  {
                      '$project': {
                          userInterests: '$userInterests.$id',
                          email: 1
                      }
                  }
              ]
          }
      },
      {
          $set: {
              userTag: {
                  username: "$username"
              }
          }
      },
      {
          '$lookup': {
              from: 'newUserBasics',
              as: 'userBasic',
              let: {
                  localID: '$email'
              },
              pipeline: [
                  {
                      '$match': {
                          '$expr': {
                              '$eq': ['$email', '$$localID']
                          }
                      }
                  },
                  {
                      '$project': {
                          fullName: 1,
                          profilePict: 1,
                          isCelebrity: 1,
                          isIdVerified: 1,
                          isPrivate: 1,
                          isFollowPrivate: 1,
                          isPostPrivate: 1,
                          email: 1,
                          mediaBasePath: 1,
                          mediaUri: 1,
                          originalName: 1,
                          fsSourceUri: 1,
                          fsSourceName: 1,
                          fsTargetUri: 1,
                          mediaType: 1,
                          friend:
                          {
                                "$ifNull":
                                [
                                    {
                                        "$filter":
                                        {
                                            input:"$friend",
                                            as:"listFriend",
                                            cond:
                                            {
                                                "$eq":
                                                [
                                                    "$$listFriend.email", email
                                                ]
                                            }
                                        }
                                    },
                                    []  
                                ]
                          },
                          mediaEndpoint: 1
                      }
                  }
              ]
          }
      },
      {
          $set: {
              avatar: {
                  mediaBasePath: {
                      $arrayElemAt: ["$userBasic.mediaBasePath", 0]
                  },
                  mediaUri: {
                      $arrayElemAt: ["$userBasic.mediaUri", 0]
                  },
                  originalName: {
                      $arrayElemAt: ["$userBasic.originalName", 0]
                  },
                  fsSourceUri: {
                      $arrayElemAt: ["$userBasic.fsSourceUri", 0]
                  },
                  fsSourceName: {
                      $arrayElemAt: ["$userBasic.fsSourceName", 0]
                  },
                  fsTargetUri: {
                      $arrayElemAt: ["$userBasic.fsTargetUri", 0]
                  },
                  mediaType: {
                      $arrayElemAt: ["$userBasic.mediaType", 0]
                  },
                  mediaEndpoint: {
                      $arrayElemAt: ["$userBasic.mediaEndpoint", 0]
                  },
                  
              }
          }
      },
      {
          '$lookup': {
              from: 'mediamusic',
              as: 'music',
              let: {
                  localID: '$musicId'
              },
              pipeline: [
                  {
                      '$match': {
                          '$expr': {
                              '$eq': ['$_id', '$$localID']
                          }
                      }
                  },
                  {
                      '$project': {
                          musicTitle: 1,
                          artistName: 1,
                          albumName: 1,
                          apsaraMusic: 1,
                          apsaraThumnail: 1,
                          genre: '$genre.name',
                          theme: '$theme.name',
                          mood: '$mood.name'
                      }
                  },
                  {
                      '$unwind': {
                          path: '$genre',
                          preserveNullAndEmptyArrays: true
                      }
                  },
                  {
                      '$unwind': {
                          path: '$theme',
                          preserveNullAndEmptyArrays: true
                      }
                  },
                  {
                      '$unwind': {
                          path: '$mood',
                          preserveNullAndEmptyArrays: true
                      }
                  }
              ]
          }
      },
      {
          $set: {
              isLike: 
              {
                  isLiked: 
                  {
                      '$cond': {
                          if : {
                              $isArray: [{
                                  '$in': [ email,'$userLike']
                              }]
                          },
                          else : false,
                          then: true
                      }
                  },
                  
              }
          }
      },
      {
          '$lookup': {
              from: 'disquslogs',
              as: 'countLogs',
              let: {
                  localID: '$postID'
              },
              pipeline: [
                  {
                      '$match': {
                          '$and': [
                              {
                                  '$expr': {
                                      '$eq': ['$$localID','$postID']
                                  }
                              },
                              {
                                  active: true
                              }
                          ]
                      }
                  }
              ]
          }
      },
      {
          '$unwind': {
              path: '$avatar',
              preserveNullAndEmptyArrays: true
          }
      },
      {
          '$project': {
              _id: 1,
              musicTitle: '$musicNih.musicTitle',
              postID: 1,
              artistName: '$musicNih.artistName',
              albumName: '$musicNih.albumName',
              apsaraMusic: '$musicNih.apsaraMusic',
              apsaraThumnail: '$musicNih.apsaraThumnail',
              genre: '$musicNih.genre',
              theme: '$musicNih.theme',
              mood: '$musicNih.mood',
              testDate: '$testDate',
              tagPeople: '$userTag.username',
              mediaType: '$media.mediaType',
              postType: '$postType',
              description: '$description',
              active: '$active',
              createdAt: '$createdAt',
              updatedAt: '$updatedAt',
              expiration: '$expiration',
              visibility: '$visibility',
              location: '$location',
              tags: '$tags',
              allowComments: '$allowComments',
              isSafe: '$isSafe',
              isOwned: '$isOwned',
              certified: '$certified',
              saleAmount: '$saleAmount',
              saleLike: '$saleLike',
              saleView: '$saleView',
              isShared: '$isShared',
              likes: '$likes',
              views: '$views',
              shares: '$shares',
              uploadSource: '$media.uploadSource',
                comments: {
                    '$size': '$comment'
                },
              email: '$email',
              viewer: '$viewer',
              viewerCount: {
                  '$size': '$userView',
                  
              },
              selfContents: '$selfContents',
              selfContent: {
                  '$cond': {
                      if : {
                          '$eq': [
                              '$email',
                              email
                          ]
                      },
                      then: 1,
                      else : 0
                  }
              },
              official: {
                  '$cond': {
                      if : {
                          '$eq': [
                              '$email',
                              'hyppers@hyppe.id'
                          ]
                      },
                      then: 1,
                      else : 0
                  }
              },
              musik: '$musicNih',
              isLike: '$liked.isLiked',
              comment: '$ded',
              interest: {
                  '$filter': {
                      input: '$category',
                      as: 'stud',
                      cond: {
                          '$in': [
                              '$$stud',
                              {
                                  '$ifNull': ['$userInterest.userInterests', []]
                              }
                          ]
                      }
                  }
              },
              friends: 
              {
                    "$ifNull":
                    [
                        {
                            "$arrayElemAt":
                            [
                                "$userBasic.friend", 0
                            ]
                        },
                        null
                    ]
              },
              following: '$followings.following',
              insight: {
                  likes: '$likes',
                  views: '$views',
                  shares: '$shares',
                  comments: '$comments',
                  
              },
              userProfile: '$userProfile',
              contentMedias: '$contentMedias',
              cats: {
                  '$filter': {
                      input: '$cats',
                      as: 'nonok',
                      cond: {
                          '$in': [
                              '$$nonok._id',
                              {
                                  '$ifNull': [
                                      '$categories',
                                      []
                                  ]
                              }
                          ]
                      }
                  }
              },
              tagDescription: '$tagDescription',
              metadata: '$metadata',
              boostDate: '$boostDate',
              end: '$boosted.boostSession.end',
              start: '$boosted.boostSession.start',
              isBoost: {
                  '$ifNull': [
                      '$isBoost',
                      0
                  ]
              },
              boostViewer: '$boostViewer',
              boostCount: '$boostCount',
              boosted: [
                  {
                      '$cond': {
                          if : {
                              '$gt': [
                                  {
                                      '$dateToString': {
                                          format: '%Y-%m-%d %H:%M:%S',
                                          date: {
                                              '$add': [new Date(), 25200000]
                                          }
                                      }
                                  },
                                  '$boosted.boostSession.end'
                              ]
                          },
                          then: '$ilang',
                          else : '$boosted',
                          
                      }
                  }
              ],
              contentModeration: '$contentModeration',
              reportedStatus: '$reportedStatus',
              reportedUserCount: '$reportedUserCount',
              contentModerationResponse: '$contentModerationResponse',
              reportedUser: '$reportedUser',
              timeStart: '$timeStart',
              timeEnd: '$timeEnd',
              apsaraId: '$media.apsaraId',
              isApsara: '$media.isApsara',
              apsaraThumbId: '$media.apsaraThumbId',
              mediaEndpoint: '$media.mediaEndpoint',
              mediaUri: '$media.mediaUri',
              mediaThumbEndpoint: '$media.mediaThumbEndpoint',
              mediaThumbUri: '$media.mediaThumbUri',
              fullName: 
              {
                "$arrayElemAt":
                [
                  '$userBasic.fullName', 0
                ]
              },
              username:
              {
                "$arrayElemAt":
                [
                  '$userBasic.username', 0
                ]
              },
              avatar: '$avatar',
              privacy: {
                  isCelebrity: 
                  {
                    "$arrayElemAt":
                    [
                      '$userBasic.isCelebrity', 0
                    ]
                  },
                  isIdVerified: 
                  {
                    "$arrayElemAt":
                    [
                      '$userBasic.isIdVerified', 0
                    ]
                  },
                  isPrivate:
                  {
                    "$arrayElemAt":
                    [
                      '$userBasic.isPrivate', 0
                    ]
                  },
                  isFollowPrivate:
                  {
                    "$arrayElemAt":
                    [
                      '$userBasic.isFollowPrivate', 0
                    ]
                  },
                  isPostPrivate:
                  {
                    "$arrayElemAt":
                    [
                      '$userBasic.isPostPrivate', 0
                    ]
                  }
              },
              verified:
              {
                "$arrayElemAt":
                [
                  '$userBasic.fullName', 0
                ]
              },
              mailViewer: '$mailViewer',
              userInterested: 
              {
                "$arrayElemAt":
                [
                  '$userInterest.userInterests', 0
                ]
              },
              
          }
      },
      {
          '$lookup': {
              from: 'settings',
              as: 'setting',
              pipeline: [
                  {
                      '$match': {
                          '$or': [
                              {
                                  _id: new mongo.Types.ObjectId("62bbdb4ba7520000050077a7")
                              },
                              {
                                  _id: new mongo.Types.ObjectId("64d06e5c451e0000bd006c62")
                              }
                          ]
                      }
                  }
              ]
          }
      },
    {
          '$project': {
              mailViewer: 1,
              viewerCount: 1,
              viewer: 1,
              version: {
                  '$arrayElemAt': ['$setting.value', 0]
              },
              limitLandingpage: {
                  '$arrayElemAt': ['$setting.value', 1]
              },
              oldDate: 1,
              selfContents: 1,
              official: 1,
              selfContent: 1,
              music: '$musik',
              isLiked: {
                  '$ifNull': ['$isLike', false]
              },
              comment: {
                  '$cond': {
                      if : {
                          '$eq': ['$comment', [null]]
                      },
                      then: [],
                      else : '$comment'
                  }
              },
              intScore: {
                  '$cond': {
                      if : {
                          '$isArray': '$interest'
                      },
                      then: {
                          '$size': '$interest'
                      },
                      else : 0
                  }
              },
              verified: 1,
              friend: 1,
              following: 1,
              musicTitle: 1,
              postID: 1,
              artistName: 1,
              albumName: 1,
              apsaraMusic: 1,
              apsaraThumnail: 1,
              genre: 1,
              theme: 1,
              mood: 1,
              testDate: 1,
              musicId: 1,
              tagPeople: 1,
              mediaType: 1,
              email: 1,
              postType: 1,
              description: 1,
              active: 1,
              createdAt: 1,
              updatedAt: 1,
              expiration: 1,
              visibility: 1,
              location: 1,
              tags: 1,
              allowComments: 1,
              isSafe: 1,
              isOwned: 1,
              certified: 1,
              saleAmount: 1,
              saleLike: 1,
              saleView: 1,
              isShared: 1,
              likes: 1,
              views: 1,
              shares: 1,
              comments: 1,
              insight: 1,
              userProfile: 1,
              contentMedias: 1,
              cats: '$cats',
              tagDescription: 1,
              metadata: 1,
              boostDate: 1,
              end: 1,
              start: 1,
              isBoost: 1,
              boostViewer: 1,
              boostCount: 1,
              uploadSource: 1,
              boosted: {
                  '$cond': {
                      if : {
                          '$gt': [{
                              '$size': '$boosted.boostSession'
                          }, 0]
                      },
                      else : [],
                      then: '$boosted'
                  }
              },
              contentModeration: 1,
              reportedStatus: 1,
              reportedUserCount: 1,
              contentModerationResponse: 1,
              reportedUser: 1,
              timeStart: 1,
              timeEnd: 1,
              isApsara: 1,
              apsaraId: 1,
              apsaraThumbId: 1,
              mediaEndpoint: 1,
              mediaUri: 1,
              mediaThumbEndpoint: 1,
              mediaThumbUri: 1,
              fullName: 1,
              username: 1,
              avatar: 1,
              statusCB: 1,
              privacy: 1,
              mediaThumUri: 1,
              category: 1,
              userInterested: 1
          }
      }
      ];
    }

    renderfacet['interest'] = [
      {
        '$lookup': {
          from: 'interests_repo',
          as: 'interest',
          let: { localID: new mongo.Types.ObjectId(key) },
          pipeline: [
            {
              '$match': { '$expr': { '$eq': [ '$_id', '$$localID' ] } }
            },
            {
              '$lookup': {
                from: 'interest_count',
                as: 'count',
                let: { localID: new mongo.Types.ObjectId(key) },
                pipeline: [
                  {
                    '$match': { '$expr': { '$eq': [ '$_id', '$$localID' ] } }
                  },
                  { '$project': { total: 1 } }
                ]
              }
            },
            {
              '$unwind': { path: '$count', preserveNullAndEmptyArrays: true }
            }
          ]
        }
      },
      { '$limit': 1 },
      {
        '$project': {
          _id: { '$arrayElemAt': [ '$interest._id', 0 ] },
          tag: { '$arrayElemAt': [ '$interest._id', 0 ] },
          interestNameId: { '$arrayElemAt': [ '$interest.interestNameId', 0 ] },
          interestNameEn: { '$arrayElemAt': [ '$interest.interestName', 0 ] },
          total: { '$arrayElemAt': [ '$interest.count.total', 0 ] }
        }
      }
    ];

    // var util = require('util');
    // console.log(util.inspect(renderfacet, { depth:null, showHidden:false }));

    var data = await this.loaddata.aggregate([
      {
        "$facet":renderfacet
      }
    ]);

    return data;
  }

  async updateStatusCB(id: string, cb: string) {
    let data = await this.loaddata.updateOne({ "_id": id },
      {
        $set: {
          "statusCB": cb,
        }
      });
    return data;
  }

  async updateDitangguhkan(id: string, reason: string, updatedAt: string, reasonId: ObjectId) {
    let data = await this.loaddata.updateMany({ "_id": id },
      { $set: { "reportedStatus": "OWNED", "updatedAt": updatedAt, "reportedUserHandle.$[].reasonId": reasonId, "reportedUserHandle.$[].reasonAdmin": reason, "reportedUserHandle.$[].status": "DITANGGUHKAN", "reportedUserHandle.$[].updatedAt": updatedAt } });
    return data;
  }

  async updateDitangguhkanEmpty(id: string, updatedAt: string, reportedUserHandle: any[]) {
    let data = await this.loaddata.updateMany({ "_id": id },
      { $set: { "reportedStatus": "OWNED", "updatedAt": updatedAt, "reportedUserHandle": reportedUserHandle } });
    return data;
  }

  async updateTidakditangguhkan(id: string, updatedAt: string) {
    let data = await this.loaddata.updateMany({ "_id": id },
      { $set: { "reportedStatus": "ALL", "updatedAt": updatedAt, "reportedUserCount": 0, "reportedUserHandle.$[].status": "TIDAK DITANGGUHKAN", "reportedUserHandle.$[].updatedAt": updatedAt } });
    return data;
  }

  async updateFlaging(id: string, updatedAt: string) {
    let data = await this.loaddata.updateMany({ "_id": id },
      { $set: { "reportedStatus": "BLURRED", "updatedAt": updatedAt, "reportedUserHandle.$[].status": "FLAGING", "reportedUserHandle.$[].updatedAt": updatedAt } });
    return data;
  }
  async updateFlagingEmpty(id: string, updatedAt: string, reportedUserHandle: any[]) {
    let data = await this.loaddata.updateMany({ "_id": id },
      { $set: { "reportedStatus": "BLURRED", "updatedAt": updatedAt, "reportedUserHandle": reportedUserHandle } });
    return data;
  }
  async nonactive(id: string, updatedAt: string) {
    let data = await this.loaddata.updateMany({ "_id": id },
      {
        $set: {
          "reportedUser.$[].active": false, "reportedUser.$[].updatedAt": updatedAt
        }


      });
    return data;
  }

  async updateBuyBoostToNoBoost(id: string, boosted: any) {
    let data = await this.loaddata.updateOne({ "_id": id },
      {
        $set: {
          "boosted": boosted,
        },
        $unset: { isBoost: 1 }
      });
    return data;
  }

  async noneActiveAllDiscusLog(postID: string, idtransaction: string) {
    var query = await this.disquslogsService.noneActiveAllDiscusLog(postID, idtransaction);
    return query;
  }

  async noneActiveAllDiscus(postID: string, idtransaction: string) {
    var query = await this.disqusService.noneActiveAllDiscus(postID, idtransaction);
    return query;
  }
  async updateemail(id: string, email: string, iduser: {
    "$oid": string
  }, createdAt: string): Promise<Object> {
    let data = await this.loaddata.updateOne({ "_id": id },
      {
        $set: {
          "email": email, "userProfile": {
            "$ref": "userbasics",
            "$id": iduser,
            "$db": "hyppe_trans_db"
          },
          "saleAmount": 0,
          "comments": 0,
          "certified": true,
          "createdAt": createdAt,
          "updatedAt": createdAt,
          "metadata.email": email
        }
      });
    return data;
  }
  async updatesalelike(id: string): Promise<Object> {
    let data = await this.loaddata.updateOne({ "_id": id },
      {
        $set: {
          "salelike": false,
          "saleAmount": 0
        }
      });
    return data;
  }

  async updateeventlike(postid: string) {
    let data = await this.contentEventService.updatesalelike(postid)
    return data;
  }

  async updatesaleview(id: string): Promise<Object> {
    let data = await this.loaddata.updateOne({ "_id": id },
      {
        $set: {
          "saleview": false,
          "saleAmount": 0
        }
      });
    return data;
  }

  async updateeventview(postid: string) {
    let data = await this.contentEventService.updatesaleview(postid);
    return data;
  }
}
